import{playWave as s1,setWaveVolume as $1,stopMidi as B1,setMidiVolume as J1,playMidi as v1}from"./deps.js";var G0=document.getElementById("canvas"),y=G0.getContext("2d",{willReadFrequently:!0}),g0=document.createElement("canvas"),z0=document.createElement("img"),d0=g0.getContext("2d",{willReadFrequently:!0});class A0{key=0n;next=null;prev=null;unlink(){if(this.prev!=null){if(this.prev.next=this.next,this.next)this.next.prev=this.prev;this.next=null,this.prev=null}}}class V0 extends A0{next2=null;prev2=null;unlink2(){if(this.prev2!==null){if(this.prev2.next2=this.next2,this.next2)this.next2.prev2=this.prev2;this.next2=null,this.prev2=null}}}class F extends V0{static pixels=new Int32Array;static width2d=0;static height2d=0;static top=0;static bottom=0;static left=0;static right=0;static boundX=0;static centerX2d=0;static centerY2d=0;static bind(_,u,R){this.pixels=_,this.width2d=u,this.height2d=R,this.setBounds(0,0,u,R)}static resetBounds(){this.left=0,this.top=0,this.right=this.width2d,this.bottom=this.height2d,this.boundX=this.right-1,this.centerX2d=this.right/2|0}static setBounds(_,u,R,b){if(_<0)_=0;if(u<0)u=0;if(R>this.width2d)R=this.width2d;if(b>this.height2d)b=this.height2d;this.top=u,this.bottom=b,this.left=_,this.right=R,this.boundX=this.right-1,this.centerX2d=this.right/2|0,this.centerY2d=this.bottom/2|0}static clear(){let _=this.width2d*this.height2d;for(let u=0;u<_;u++)this.pixels[u]=0}static drawRect(_,u,R,b,m){this.drawHorizontalLine(_,u,m,R),this.drawHorizontalLine(_,u+b-1,m,R),this.drawVerticalLine(_,u,m,b),this.drawVerticalLine(_+R-1,u,m,b)}static drawRectAlpha(_,u,R,b,m,E){if(this.drawHorizontalLineAlpha(_,u,m,R,E),this.drawHorizontalLineAlpha(_,u+b-1,m,R,E),b>=3)this.drawVerticalLineAlpha(_,u,m,b,E),this.drawVerticalLineAlpha(_+R-1,u,m,b,E)}static drawHorizontalLine(_,u,R,b){if(u<this.top||u>=this.bottom)return;if(_<this.left)b-=this.left-_,_=this.left;if(_+b>this.right)b=this.right-_;let m=_+u*this.width2d;for(let E=0;E<b;E++)this.pixels[m+E]=R}static drawHorizontalLineAlpha=(_,u,R,b,m)=>{if(u<this.top||u>=this.bottom)return;if(_<this.left)b-=this.left-_,_=this.left;if(_+b>this.right)b=this.right-_;let E=256-m,O=(R>>16&255)*m,I=(R>>8&255)*m,L=(R&255)*m,H=this.width2d-b,G=_+u*this.width2d;for(let N=0;N<b;N++){let T=(this.pixels[G]>>16&255)*E,K=(this.pixels[G]>>8&255)*E,Q=(this.pixels[G]&255)*E,U=(O+T>>8<<16)+(I+K>>8<<8)+(L+Q>>8);this.pixels[G++]=U}};static drawVerticalLine(_,u,R,b){if(_<this.left||_>=this.right)return;if(u<this.top)b-=this.top-u,u=this.top;if(u+b>this.bottom)b=this.bottom-u;let m=_+u*this.width2d;for(let E=0;E<b;E++)this.pixels[m+E*this.width2d]=R}static drawVerticalLineAlpha=(_,u,R,b,m)=>{if(_<this.left||_>=this.right)return;if(u<this.top)b-=this.top-u,u=this.top;if(u+b>this.bottom)b=this.bottom-u;let E=256-m,O=(R>>16&255)*m,I=(R>>8&255)*m,L=(R&255)*m,H=_+u*this.width2d;for(let G=0;G<b;G++){let N=(this.pixels[H]>>16&255)*E,T=(this.pixels[H]>>8&255)*E,K=(this.pixels[H]&255)*E,Q=(O+N>>8<<16)+(I+T>>8<<8)+(L+K>>8);this.pixels[H]=Q,H+=this.width2d}};static drawLine(_,u,R,b,m){let E=Math.abs(R-_),O=Math.abs(b-u),I=_<R?1:-1,L=u<b?1:-1,H=E-O;while(!0){if(_>=this.left&&_<this.right&&u>=this.top&&u<this.bottom)this.pixels[_+u*this.width2d]=m;if(_===R&&u===b)break;let G=2*H;if(G>-O)H=H-O,_=_+I;if(G<E)H=H+E,u=u+L}}static fillRect2d(_,u,R,b,m){if(_<this.left)R-=this.left-_,_=this.left;if(u<this.top)b-=this.top-u,u=this.top;if(_+R>this.right)R=this.right-_;if(u+b>this.bottom)b=this.bottom-u;let E=this.width2d-R,O=_+u*this.width2d;for(let I=-b;I<0;I++){for(let L=-R;L<0;L++)this.pixels[O++]=m;O+=E}}static fillRectAlpha(_,u,R,b,m,E){if(_<this.left)R-=this.left-_,_=this.left;if(u<this.top)b-=this.top-u,u=this.top;if(_+R>this.right)R=this.right-_;if(u+b>this.bottom)b=this.bottom-u;let O=256-E,I=(m>>16&255)*E,L=(m>>8&255)*E,H=(m&255)*E,G=this.width2d-R,N=_+u*this.width2d;for(let T=0;T<b;T++){for(let K=-R;K<0;K++){let Q=(this.pixels[N]>>16&255)*O,U=(this.pixels[N]>>8&255)*O,J=(this.pixels[N]&255)*O,q=(I+Q>>8<<16)+(L+U>>8<<8)+(H+J>>8);this.pixels[N++]=q}N+=G}}static fillCircle(_,u,R,b,m){let E=256-m,O=(b>>16&255)*m,I=(b>>8&255)*m,L=(b&255)*m,H=u-R;if(H<0)H=0;let G=u+R;if(G>=this.height2d)G=this.height2d-1;for(let N=H;N<=G;N++){let T=N-u,K=Math.sqrt(R*R-T*T)|0,Q=_-K;if(Q<0)Q=0;let U=_+K;if(U>=this.width2d)U=this.width2d-1;let J=Q+N*this.width2d;for(let q=Q;q<=U;q++){let w=(this.pixels[J]>>16&255)*E,V=(this.pixels[J]>>8&255)*E,Y=(this.pixels[J]&255)*E,n=(O+w>>8<<16)+(I+V>>8<<8)+(L+Y>>8);this.pixels[J++]=n}}}static setPixel(_,u,R){if(_<this.left||_>=this.right||u<this.top||u>=this.bottom)return;this.pixels[_+u*this.width2d]=R}}class $0{sentinel=new A0;cursor=null;constructor(){this.sentinel.next=this.sentinel,this.sentinel.prev=this.sentinel}push(_){if(_.prev)_.unlink();if(_.prev=this.sentinel.prev,_.next=this.sentinel,_.prev)_.prev.next=_;_.next.prev=_}addHead(_){if(_.prev)_.unlink();if(_.prev=this.sentinel,_.next=this.sentinel.next,_.prev.next=_,_.next)_.next.prev=_}pop(){let _=this.sentinel.next;if(_===this.sentinel)return null;return _?.unlink(),_}head(){let _=this.sentinel.next;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.next||null,_}tail(){let _=this.sentinel.prev;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.prev||null,_}next(){let _=this.cursor;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.next||null,_}prev(){let _=this.cursor;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.prev||null,_}clear(){while(!0){let _=this.sentinel.next;if(_===this.sentinel)return;_?.unlink()}}}var Z0=async(_)=>new Promise((u)=>setTimeout(u,_)),i0=async(_)=>new Uint8Array(await(await fetch(_)).arrayBuffer());function q1(_,u,R,b,m){while(m--)R[b++]=_[u++]}function Y1(_){let u=0n;for(let R=0;R<_.length;R++)u=u<<8n|BigInt(_[R]);return u}function j1(_){let u=[];while(_>0n)u.unshift(Number(_&0xffn)),_>>=8n;if(u[0]&128)u.unshift(0);return new Uint8Array(u)}function w1(_,u,R){let b=1n;while(u>0n){if(u%2n===1n)b=b*_%R;_=_*_%R,u>>=1n}return b}class z extends V0{static CRC32_POLYNOMIAL=3988292384;static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static cacheMin=new $0;static cacheMid=new $0;static cacheMax=new $0;static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static{for(let _=0;_<32;_++)z.bitmask[_]=(1<<_)-1;z.bitmask[32]=4294967295;for(let _=0;_<256;_++){let u=_;for(let R=0;R<8;R++)if((u&1)===1)u=u>>>1^z.CRC32_POLYNOMIAL;else u>>>=1;z.crctable[_]=u}}static crc32(_){let u=4294967295;for(let R=0;R<_.length;R++)u=u>>>8^z.crctable[(u^_[R])&255];return~u}view;data;pos=0;bitPos=0;random=null;constructor(_){if(!_)throw new Error;super();if(_ instanceof Int8Array)this.data=new Uint8Array(_);else this.data=_;this.view=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength)}get length(){return this.view.byteLength}get available(){return this.length-this.pos}static alloc(_){let u=null;if(_===0&&z.cacheMinCount>0)z.cacheMinCount--,u=z.cacheMin.pop();else if(_===1&&z.cacheMidCount>0)z.cacheMidCount--,u=z.cacheMid.pop();else if(_===2&&z.cacheMaxCount>0)z.cacheMaxCount--,u=z.cacheMax.pop();if(u)return u.pos=0,u;if(_===0)return new z(new Uint8Array(100));else if(_===1)return new z(new Uint8Array(5000));return new z(new Uint8Array(30000))}release(){if(this.pos=0,this.view.byteLength===100&&z.cacheMinCount<1000)z.cacheMin.push(this),z.cacheMinCount++;else if(this.view.byteLength===5000&&z.cacheMidCount<250)z.cacheMid.push(this),z.cacheMidCount++;else if(this.view.byteLength===30000&&z.cacheMaxCount<50)z.cacheMax.push(this),z.cacheMaxCount++}g1(){return this.view.getUint8(this.pos++)}g1b(){return this.view.getInt8(this.pos++)}g2(){let _=this.view.getUint16(this.pos);return this.pos+=2,_}g2b(){let _=this.view.getInt16(this.pos);return this.pos+=2,_}g3(){let _=this.view.getUint8(this.pos++)<<16|this.view.getUint16(this.pos);return this.pos+=2,_}g4(){let _=this.view.getInt32(this.pos);return this.pos+=4,_}g8(){let _=this.view.getBigInt64(this.pos);return this.pos+=8,_}gsmart(){return this.view.getUint8(this.pos)<128?this.g1()-64:this.g2()-49152}gsmarts(){return this.view.getUint8(this.pos)<128?this.g1():this.g2()-32768}gjstr(){let _=this.view,u=_.byteLength,R="",b;while((b=_.getUint8(this.pos++))!==10&&this.pos<u)R+=String.fromCharCode(b);return R}gdata(_,u,R){R.set(this.data.subarray(this.pos,this.pos+_),u),this.pos+=_}p1isaac(_){this.view.setUint8(this.pos++,_+(this.random?.nextInt??0)&255)}p1(_){this.view.setUint8(this.pos++,_)}p2(_){this.view.setUint16(this.pos,_),this.pos+=2}ip2(_){this.view.setUint16(this.pos,_,!0),this.pos+=2}p3(_){this.view.setUint8(this.pos++,_>>16),this.view.setUint16(this.pos,_),this.pos+=2}p4(_){this.view.setInt32(this.pos,_),this.pos+=4}ip4(_){this.view.setInt32(this.pos,_,!0),this.pos+=4}p8(_){this.view.setBigInt64(this.pos,_),this.pos+=8}pjstr(_){let u=this.view,R=_.length;for(let b=0;b<R;b++)u.setUint8(this.pos++,_.charCodeAt(b));u.setUint8(this.pos++,10)}pdata(_,u,R){this.data.set(_.subarray(R,R+u),this.pos),this.pos+=u-R}psize1(_){this.view.setUint8(this.pos-_-1,_)}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(_){let u=this.bitPos>>>3,R=8-(this.bitPos&7),b=0;this.bitPos+=_;for(;_>R;R=8)b+=(this.view.getUint8(u++)&z.bitmask[R])<<_-R,_-=R;if(_===R)b+=this.view.getUint8(u)&z.bitmask[R];else b+=this.view.getUint8(u)>>>R-_&z.bitmask[_];return b}rsaenc(_,u){let R=this.pos;this.pos=0;let b=new Uint8Array(R);this.gdata(R,0,b);let m=Y1(b),E=w1(m,u,_),O=j1(E);this.pos=0,this.p1(O.length),this.pdata(O,O.length,0)}}class O0 extends V0{pixels;width2d;height2d;cropX;cropY;cropW;cropH;rgbPal;constructor(_,u,R){super();this.pixels=new Int8Array(_*u),this.width2d=this.cropW=_,this.height2d=this.cropH=u,this.cropX=this.cropY=0,this.rgbPal=R}static fromArchive(_,u,R=0){let b=new z(_.read(u+".dat")),m=new z(_.read("index.dat"));m.pos=b.g2();let E=m.g2(),O=m.g2(),I=m.g1(),L=new Int32Array(I);for(let J=1;J<I;J++)if(L[J]=m.g3(),L[J]===0)L[J]=1;for(let J=0;J<R;J++)m.pos+=2,b.pos+=m.g2()*m.g2(),m.pos+=1;if(b.pos>b.length||m.pos>m.length)throw new Error;let H=m.g1(),G=m.g1(),N=m.g2(),T=m.g2(),K=new O0(N,T,L);K.cropX=H,K.cropY=G,K.cropW=E,K.cropH=O;let Q=K.pixels,U=m.g1();if(U===0){let J=K.width2d*K.height2d;for(let q=0;q<J;q++)Q[q]=b.g1b()}else if(U===1){let{width2d:J,height2d:q}=K;for(let w=0;w<J;w++)for(let V=0;V<q;V++)Q[w+V*J]=b.g1b()}return K}draw(_,u){_|=0,u|=0,_+=this.cropX,u+=this.cropY;let R=_+u*F.width2d,b=0,m=this.height2d,E=this.width2d,O=F.width2d-E,I=0;if(u<F.top){let L=F.top-u;m-=L,u=F.top,b+=L*E,R+=L*F.width2d}if(u+m>F.bottom)m-=u+m-F.bottom;if(_<F.left){let L=F.left-_;E-=L,_=F.left,b+=L,R+=L,I+=L,O+=L}if(_+E>F.right){let L=_+E-F.right;E-=L,I+=L,O+=L}if(E>0&&m>0)this.copyImage(E,m,this.pixels,b,I,F.pixels,R,O)}flipHorizontally(){let _=this.pixels,u=this.width2d,R=this.height2d;for(let b=0;b<R;b++){let m=u/2|0;for(let E=0;E<m;E++){let O=E+b*u,I=u-E-1+b*u,L=_[O];_[O]=_[I],_[I]=L}}}flipVertically(){let _=this.pixels,u=this.width2d,R=this.height2d;for(let b=0;b<(R/2|0);b++)for(let m=0;m<u;m++){let E=m+b*u,O=m+(R-b-1)*u,I=_[E];_[E]=_[O],_[O]=I}}translate2d(_,u,R){for(let b=0;b<this.rgbPal.length;b++){let m=this.rgbPal[b]>>16&255;if(m+=_,m<0)m=0;else if(m>255)m=255;let E=this.rgbPal[b]>>8&255;if(E+=u,E<0)E=0;else if(E>255)E=255;let O=this.rgbPal[b]&255;if(O+=R,O<0)O=0;else if(O>255)O=255;this.rgbPal[b]=(m<<16)+(E<<8)+O}}shrink(){this.cropW|=0,this.cropH|=0,this.cropW/=2,this.cropH/=2,this.cropW|=0,this.cropH|=0;let _=new Int8Array(this.cropW*this.cropH),u=0;for(let R=0;R<this.height2d;R++)for(let b=0;b<this.width2d;b++)_[(b+this.cropX>>1)+(R+this.cropY>>1)*this.cropW]=this.pixels[u++];this.pixels=_,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}crop(){if(this.width2d===this.cropW&&this.height2d===this.cropH)return;let _=new Int8Array(this.cropW*this.cropH),u=0;for(let R=0;R<this.height2d;R++)for(let b=0;b<this.width2d;b++)_[b+this.cropX+(R+this.cropY)*this.cropW]=this.pixels[u++];this.pixels=_,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}copyImage(_,u,R,b,m,E,O,I){let L=-(_>>2);_=-(_&3);for(let H=-u;H<0;H++){for(let G=L;G<0;G++){let N=R[b++];if(N===0)O++;else E[O++]=this.rgbPal[N&255];if(N=R[b++],N===0)O++;else E[O++]=this.rgbPal[N&255];if(N=R[b++],N===0)O++;else E[O++]=this.rgbPal[N&255];if(N=R[b++],N===0)O++;else E[O++]=this.rgbPal[N&255]}for(let G=_;G<0;G++){let N=R[b++];if(N===0)O++;else E[O++]=this.rgbPal[N&255]}O+=I,b+=m}}clip(_,u,R,b){try{let m=this.width2d,E=this.height2d,O=0,I=0,L=(m<<16)/R|0,H=(E<<16)/b|0,G=this.cropW,N=this.cropH,T=(G<<16)/R|0,K=(N<<16)/b|0;if(_=_+(this.cropX*R+G-1)/G|0,u=u+(this.cropY*b+N-1)/N|0,this.cropX*R%G!=0)O=(G-this.cropX*R%G<<16)/R|0;if(this.cropY*b%N!=0)I=(N-this.cropY*b%N<<16)/b|0;R=R*(this.width2d-(O>>16))/G|0,b=b*(this.height2d-(I>>16))/N|0;let Q=_+u*F.width2d,U=F.width2d-R,J;if(u<F.top)J=F.top-u,b-=J,u=0,Q+=J*F.width2d,I+=K*J;if(u+b>F.bottom)b-=u+b-F.bottom;if(_<F.left)J=F.left-_,R-=J,_=0,Q+=J,O+=T*J,U+=J;if(_+R>F.right)J=_+R-F.right,R-=J,U+=J;this.plot_scale(F.pixels,this.pixels,this.rgbPal,O,I,Q,U,R,b,T,K,m)}catch(m){}}plot_scale(_,u,R,b,m,E,O,I,L,H,G,N){try{let T=b;for(let K=-L;K<0;K++){let Q=(m>>16)*N;for(let U=-I;U<0;U++){let J=u[(b>>16)+Q];if(J==0)E++;else _[E++]=R[J&255];b+=H}m+=G,b=T,E+=O}}catch(T){}}}class p extends Array{constructor(_,u){super(_);for(let R=0;R<_;R++)this[R]=u}}class U1 extends Array{constructor(_,u,R){super(_);for(let b=0;b<_;b++){this[b]=new Array(u);for(let m=0;m<u;m++)this[b][m]=R}}}class t0 extends Array{constructor(_,u,R,b){super(_);for(let m=0;m<_;m++){this[m]=new Array(u);for(let E=0;E<u;E++){this[m][E]=new Array(R);for(let O=0;O<R;O++)this[m][E][O]=b}}}}class l0 extends Array{constructor(_,u,R,b,m){super(_);for(let E=0;E<_;E++){this[E]=new Array(u);for(let O=0;O<u;O++){this[E][O]=new Array(R);for(let I=0;I<R;I++){this[E][O][I]=new Array(b);for(let L=0;L<b;L++)this[E][O][I][L]=m}}}}}class M0 extends Array{constructor(_,u,R){super(_);for(let b=0;b<_;b++){this[b]=new Array(u);for(let m=0;m<u;m++)this[b][m]=new Uint8Array(R)}}}class X0 extends Array{constructor(_,u){super(_);for(let R=0;R<_;R++)this[R]=new Int32Array(u)}}class D0 extends Array{constructor(_,u,R){super(_);for(let b=0;b<_;b++){this[b]=new Array(u);for(let m=0;m<u;m++)this[b][m]=new Int32Array(R)}}}class A extends F{static lowMemory=!1;static reciprocal15=new Int32Array(512);static reciprocal16=new Int32Array(2048);static sin=new Int32Array(2048);static cos=new Int32Array(2048);static hslPal=new Int32Array(65536);static textures=new p(50,null);static textureCount=0;static lineOffset=new Int32Array;static centerX=0;static centerY=0;static jagged=!0;static clipX=!1;static alpha=0;static texelPool=null;static activeTexels=new p(50,null);static poolSize=0;static cycle=0;static textureCycle=new Int32Array(50);static texPal=new p(50,null);static opaque=!1;static textureTranslucent=new p(50,!1);static averageTextureRGB=new Int32Array(50);static{for(let _=1;_<512;_++)this.reciprocal15[_]=32768/_|0;for(let _=1;_<2048;_++)this.reciprocal16[_]=65536/_|0;for(let _=0;_<2048;_++)this.sin[_]=Math.sin(_*0.0030679615757712823)*65536|0,this.cos[_]=Math.cos(_*0.0030679615757712823)*65536|0}static init2D(){this.lineOffset=new Int32Array(F.height2d);for(let _=0;_<F.height2d;_++)this.lineOffset[_]=F.width2d*_;this.centerX=F.width2d/2|0,this.centerY=F.height2d/2|0}static init3D(_,u){this.lineOffset=new Int32Array(u);for(let R=0;R<u;R++)this.lineOffset[R]=_*R;this.centerX=_/2|0,this.centerY=u/2|0}static clearTexels(){this.texelPool=null,this.activeTexels.fill(null)}static unpackTextures(_){this.textureCount=0;for(let u=0;u<50;u++)try{if(this.textures[u]=O0.fromArchive(_,u.toString()),this.lowMemory&&this.textures[u]?.cropW===128)this.textures[u]?.shrink();else this.textures[u]?.crop();this.textureCount++}catch(R){}}static getAverageTextureRGB(_){if(this.averageTextureRGB[_]!==0)return this.averageTextureRGB[_];let u=this.texPal[_];if(!u)return 0;let R=0,b=0,m=0,E=u.length;for(let I=0;I<E;I++)R+=u[I]>>16&255,b+=u[I]>>8&255,m+=u[I]&255;let O=((R/E|0)<<16)+((b/E|0)<<8)+(m/E|0);if(O=this.setGamma(O,1.4),O===0)O=1;return this.averageTextureRGB[_]=O,O}static setBrightness(_){let u=_+Math.random()*0.03-0.015,R=0;for(let b=0;b<512;b++){let m=(b/8|0)/64+0.0078125,E=(b&7)/8+0.0625;for(let O=0;O<128;O++){let I=O/128,L=I,H=I,G=I;if(E!==0){let U;if(I<0.5)U=I*(E+1);else U=I+E-I*E;let J=I*2-U,q=m+0.3333333333333333;if(q>1)q--;let w=m-0.3333333333333333;if(w<0)w++;if(q*6<1)L=J+(U-J)*6*q;else if(q*2<1)L=U;else if(q*3<2)L=J+(U-J)*(0.6666666666666666-q)*6;else L=J;if(m*6<1)H=J+(U-J)*6*m;else if(m*2<1)H=U;else if(m*3<2)H=J+(U-J)*(0.6666666666666666-m)*6;else H=J;if(w*6<1)G=J+(U-J)*6*w;else if(w*2<1)G=U;else if(w*3<2)G=J+(U-J)*(0.6666666666666666-w)*6;else G=J}let N=L*256|0,T=H*256|0,K=G*256|0,Q=(N<<16)+(T<<8)+K;this.hslPal[R++]=this.setGamma(Q,u)}}for(let b=0;b<50;b++){let m=this.textures[b];if(!m)continue;let E=m.rgbPal;this.texPal[b]=new Int32Array(E.length);for(let O=0;O<E.length;O++){let I=this.texPal[b];if(!I)continue;I[O]=this.setGamma(E[O],u)}}for(let b=0;b<50;b++)this.pushTexture(b)}static setGamma(_,u){let R=(_>>16)/256,b=(_>>8&255)/256,m=(_&255)/256,E=Math.pow(R,u),O=Math.pow(b,u),I=Math.pow(m,u),L=E*256|0,H=O*256|0,G=I*256|0;return(L<<16)+(H<<8)+G}static initPool(_){if(this.texelPool)return;if(this.poolSize=_,this.lowMemory)this.texelPool=new X0(_,16384);else this.texelPool=new X0(_,65536);this.activeTexels.fill(null)}static fillGouraudTriangle(_,u,R,b,m,E,O,I,L){let H=0,G=0;if(m!==b)H=(u-_<<16)/(m-b)|0,G=(I-O<<15)/(m-b)|0;let N=0,T=0;if(E!==m)N=(R-u<<16)/(E-m)|0,T=(L-I<<15)/(E-m)|0;let K=0,Q=0;if(E!==b)K=(_-R<<16)/(b-E)|0,Q=(O-L<<15)/(b-E)|0;if(b<=m&&b<=E){if(b<F.bottom){if(m>F.bottom)m=F.bottom;if(E>F.bottom)E=F.bottom;if(m<E){if(R=_<<=16,L=O<<=15,b<0)R-=K*b,_-=H*b,L-=Q*b,O-=G*b,b=0;if(u<<=16,I<<=15,m<0)u-=N*m,I-=T*m,m=0;if(b!==m&&K<H||b===m&&K>N){E-=m,m-=b,b=A.lineOffset[b];while(!0){if(m--,m<0)while(!0){if(E--,E<0)return;this.drawGouraudScanline(R>>16,u>>16,L>>7,I>>7,F.pixels,b,0),R+=K,u+=N,L+=Q,I+=T,b+=F.width2d}this.drawGouraudScanline(R>>16,_>>16,L>>7,O>>7,F.pixels,b,0),R+=K,_+=H,L+=Q,O+=G,b+=F.width2d}}else{E-=m,m-=b,b=A.lineOffset[b];while(!0){if(m--,m<0)while(!0){if(E--,E<0)return;this.drawGouraudScanline(u>>16,R>>16,I>>7,L>>7,F.pixels,b,0),R+=K,u+=N,L+=Q,I+=T,b+=F.width2d}this.drawGouraudScanline(_>>16,R>>16,O>>7,L>>7,F.pixels,b,0),R+=K,_+=H,L+=Q,O+=G,b+=F.width2d}}}else{if(u=_<<=16,I=O<<=15,b<0)u-=K*b,_-=H*b,I-=Q*b,O-=G*b,b=0;if(R<<=16,L<<=15,E<0)R-=N*E,L-=T*E,E=0;if(b!==E&&K<H||b===E&&N>H){m-=E,E-=b,b=A.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(m--,m<0)return;this.drawGouraudScanline(R>>16,_>>16,L>>7,O>>7,F.pixels,b,0),R+=N,_+=H,L+=T,O+=G,b+=F.width2d}this.drawGouraudScanline(u>>16,_>>16,I>>7,O>>7,F.pixels,b,0),u+=K,_+=H,I+=Q,O+=G,b+=F.width2d}}else{m-=E,E-=b,b=A.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(m--,m<0)return;this.drawGouraudScanline(_>>16,R>>16,O>>7,L>>7,F.pixels,b,0),R+=N,_+=H,L+=T,O+=G,b+=F.width2d}this.drawGouraudScanline(_>>16,u>>16,O>>7,I>>7,F.pixels,b,0),u+=K,_+=H,I+=Q,O+=G,b+=F.width2d}}}}}else if(m<=E){if(m<F.bottom){if(E>F.bottom)E=F.bottom;if(b>F.bottom)b=F.bottom;if(E<b){if(_=u<<=16,O=I<<=15,m<0)_-=H*m,u-=N*m,O-=G*m,I-=T*m,m=0;if(R<<=16,L<<=15,E<0)R-=K*E,L-=Q*E,E=0;if(m!==E&&H<N||m===E&&H>K){b-=E,E-=m,m=A.lineOffset[m];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.drawGouraudScanline(_>>16,R>>16,O>>7,L>>7,F.pixels,m,0),_+=H,R+=K,O+=G,L+=Q,m+=F.width2d}this.drawGouraudScanline(_>>16,u>>16,O>>7,I>>7,F.pixels,m,0),_+=H,u+=N,O+=G,I+=T,m+=F.width2d}}else{b-=E,E-=m,m=A.lineOffset[m];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.drawGouraudScanline(R>>16,_>>16,L>>7,O>>7,F.pixels,m,0),_+=H,R+=K,O+=G,L+=Q,m+=F.width2d}this.drawGouraudScanline(u>>16,_>>16,I>>7,O>>7,F.pixels,m,0),_+=H,u+=N,O+=G,I+=T,m+=F.width2d}}}else{if(R=u<<=16,L=I<<=15,m<0)R-=H*m,u-=N*m,L-=G*m,I-=T*m,m=0;if(_<<=16,O<<=15,b<0)_-=K*b,O-=Q*b,b=0;if(E-=b,b-=m,m=A.lineOffset[m],H<N)while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.drawGouraudScanline(_>>16,u>>16,O>>7,I>>7,F.pixels,m,0),_+=K,u+=N,O+=Q,I+=T,m+=F.width2d}this.drawGouraudScanline(R>>16,u>>16,L>>7,I>>7,F.pixels,m,0),R+=H,u+=N,L+=G,I+=T,m+=F.width2d}else while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.drawGouraudScanline(u>>16,_>>16,I>>7,O>>7,F.pixels,m,0),_+=K,u+=N,O+=Q,I+=T,m+=F.width2d}this.drawGouraudScanline(u>>16,R>>16,I>>7,L>>7,F.pixels,m,0),R+=H,u+=N,L+=G,I+=T,m+=F.width2d}}}}else if(E<F.bottom){if(b>F.bottom)b=F.bottom;if(m>F.bottom)m=F.bottom;if(b<m){if(u=R<<=16,I=L<<=15,E<0)u-=N*E,R-=K*E,I-=T*E,L-=Q*E,E=0;if(_<<=16,O<<=15,b<0)_-=H*b,O-=G*b,b=0;if(m-=b,b-=E,E=A.lineOffset[E],N<K)while(!0){if(b--,b<0)while(!0){if(m--,m<0)return;this.drawGouraudScanline(u>>16,_>>16,I>>7,O>>7,F.pixels,E,0),u+=N,_+=H,I+=T,O+=G,E+=F.width2d}this.drawGouraudScanline(u>>16,R>>16,I>>7,L>>7,F.pixels,E,0),u+=N,R+=K,I+=T,L+=Q,E+=F.width2d}else while(!0){if(b--,b<0)while(!0){if(m--,m<0)return;this.drawGouraudScanline(_>>16,u>>16,O>>7,I>>7,F.pixels,E,0),u+=N,_+=H,I+=T,O+=G,E+=F.width2d}this.drawGouraudScanline(R>>16,u>>16,L>>7,I>>7,F.pixels,E,0),u+=N,R+=K,I+=T,L+=Q,E+=F.width2d}}else{if(_=R<<=16,O=L<<=15,E<0)_-=N*E,R-=K*E,O-=T*E,L-=Q*E,E=0;if(u<<=16,I<<=15,m<0)u-=H*m,I-=G*m,m=0;if(b-=m,m-=E,E=A.lineOffset[E],N<K)while(!0){if(m--,m<0)while(!0){if(b--,b<0)return;this.drawGouraudScanline(u>>16,R>>16,I>>7,L>>7,F.pixels,E,0),u+=H,R+=K,I+=G,L+=Q,E+=F.width2d}this.drawGouraudScanline(_>>16,R>>16,O>>7,L>>7,F.pixels,E,0),_+=N,R+=K,O+=T,L+=Q,E+=F.width2d}else while(!0){if(m--,m<0)while(!0){if(b--,b<0)return;this.drawGouraudScanline(R>>16,u>>16,L>>7,I>>7,F.pixels,E,0),u+=H,R+=K,I+=G,L+=Q,E+=F.width2d}this.drawGouraudScanline(R>>16,_>>16,L>>7,O>>7,F.pixels,E,0),_+=N,R+=K,O+=T,L+=Q,E+=F.width2d}}}}static drawGouraudScanline(_,u,R,b,m,E,O){let I;if(A.jagged){let L;if(A.clipX){if(u-_>3)L=(b-R)/(u-_)|0;else L=0;if(u>F.boundX)u=F.boundX;if(_<0)R-=_*L,_=0;if(_>=u)return;E+=_,O=u-_>>2,L<<=2}else if(_<u)if(E+=_,O=u-_>>2,O>0)L=(b-R)*A.reciprocal15[O]>>15;else L=0;else return;if(A.alpha===0)while(!0){if(O--,O<0){if(O=u-_&3,O>0){I=A.hslPal[R>>8];do m[E++]=I,O--;while(O>0);return}break}I=A.hslPal[R>>8],R+=L,m[E++]=I,m[E++]=I,m[E++]=I,m[E++]=I}else{let H=A.alpha,G=256-A.alpha;while(!0){if(O--,O<0){if(O=u-_&3,O>0){I=A.hslPal[R>>8],I=((I&16711935)*G>>8&16711935)+((I&65280)*G>>8&65280);do m[E++]=I+((m[E]&16711935)*H>>8&16711935)+((m[E]&65280)*H>>8&65280),O--;while(O>0)}break}I=A.hslPal[R>>8],R+=L,I=((I&16711935)*G>>8&16711935)+((I&65280)*G>>8&65280),m[E++]=I+((m[E]&16711935)*H>>8&16711935)+((m[E]&65280)*H>>8&65280),m[E++]=I+((m[E]&16711935)*H>>8&16711935)+((m[E]&65280)*H>>8&65280),m[E++]=I+((m[E]&16711935)*H>>8&16711935)+((m[E]&65280)*H>>8&65280),m[E++]=I+((m[E]&16711935)*H>>8&16711935)+((m[E]&65280)*H>>8&65280)}}}else if(_<u){let L=(b-R)/(u-_)|0;if(A.clipX){if(u>F.boundX)u=F.boundX;if(_<0)R-=_*L,_=0;if(_>=u)return}if(E+=_,O=u-_,A.alpha===0)do m[E++]=A.hslPal[R>>8],R+=L,O--;while(O>0);else{let H=A.alpha,G=256-A.alpha;do I=A.hslPal[R>>8],R+=L,I=((I&16711935)*G>>8&16711935)+((I&65280)*G>>8&65280),m[E++]=I+((m[E]&16711935)*H>>8&16711935)+((m[E]&65280)*H>>8&65280),O--;while(O>0)}}}static fillTriangle(_,u,R,b,m,E,O){let I=0;if(m!==b)I=(u-_<<16)/(m-b)|0;let L=0;if(E!==m)L=(R-u<<16)/(E-m)|0;let H=0;if(E!==b)H=(_-R<<16)/(b-E)|0;if(b<=m&&b<=E){if(b<F.bottom){if(m>F.bottom)m=F.bottom;if(E>F.bottom)E=F.bottom;if(m<E){if(R=_<<=16,b<0)R-=H*b,_-=I*b,b=0;if(u<<=16,m<0)u-=L*m,m=0;if(b!==m&&H<I||b===m&&H>L){E-=m,m-=b,b=this.lineOffset[b];while(!0){if(m--,m<0)while(!0){if(E--,E<0)return;this.drawScanline(R>>16,u>>16,F.pixels,b,O),R+=H,u+=L,b+=F.width2d}this.drawScanline(R>>16,_>>16,F.pixels,b,O),R+=H,_+=I,b+=F.width2d}}else{E-=m,m-=b,b=this.lineOffset[b];while(!0){if(m--,m<0)while(!0){if(E--,E<0)return;this.drawScanline(u>>16,R>>16,F.pixels,b,O),R+=H,u+=L,b+=F.width2d}this.drawScanline(_>>16,R>>16,F.pixels,b,O),R+=H,_+=I,b+=F.width2d}}}else{if(u=_<<=16,b<0)u-=H*b,_-=I*b,b=0;if(R<<=16,E<0)R-=L*E,E=0;if(b!==E&&H<I||b===E&&L>I){m-=E,E-=b,b=this.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(m--,m<0)return;this.drawScanline(R>>16,_>>16,F.pixels,b,O),R+=L,_+=I,b+=F.width2d}this.drawScanline(u>>16,_>>16,F.pixels,b,O),u+=H,_+=I,b+=F.width2d}}else{m-=E,E-=b,b=this.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(m--,m<0)return;this.drawScanline(_>>16,R>>16,F.pixels,b,O),R+=L,_+=I,b+=F.width2d}this.drawScanline(_>>16,u>>16,F.pixels,b,O),u+=H,_+=I,b+=F.width2d}}}}}else if(m<=E){if(m<F.bottom){if(E>F.bottom)E=F.bottom;if(b>F.bottom)b=F.bottom;if(E<b){if(_=u<<=16,m<0)_-=I*m,u-=L*m,m=0;if(R<<=16,E<0)R-=H*E,E=0;if(m!==E&&I<L||m===E&&I>H){b-=E,E-=m,m=this.lineOffset[m];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.drawScanline(_>>16,R>>16,F.pixels,m,O),_+=I,R+=H,m+=F.width2d}this.drawScanline(_>>16,u>>16,F.pixels,m,O),_+=I,u+=L,m+=F.width2d}}else{b-=E,E-=m,m=this.lineOffset[m];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.drawScanline(R>>16,_>>16,F.pixels,m,O),_+=I,R+=H,m+=F.width2d}this.drawScanline(u>>16,_>>16,F.pixels,m,O),_+=I,u+=L,m+=F.width2d}}}else{if(R=u<<=16,m<0)R-=I*m,u-=L*m,m=0;if(_<<=16,b<0)_-=H*b,b=0;if(I<L){E-=b,b-=m,m=this.lineOffset[m];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.drawScanline(_>>16,u>>16,F.pixels,m,O),_+=H,u+=L,m+=F.width2d}this.drawScanline(R>>16,u>>16,F.pixels,m,O),R+=I,u+=L,m+=F.width2d}}else{E-=b,b-=m,m=this.lineOffset[m];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.drawScanline(u>>16,_>>16,F.pixels,m,O),_+=H,u+=L,m+=F.width2d}this.drawScanline(u>>16,R>>16,F.pixels,m,O),R+=I,u+=L,m+=F.width2d}}}}}else if(E<F.bottom){if(b>F.bottom)b=F.bottom;if(m>F.bottom)m=F.bottom;if(b<m){if(u=R<<=16,E<0)u-=L*E,R-=H*E,E=0;if(_<<=16,b<0)_-=I*b,b=0;if(L<H){m-=b,b-=E,E=this.lineOffset[E];while(!0){if(b--,b<0)while(!0){if(m--,m<0)return;this.drawScanline(u>>16,_>>16,F.pixels,E,O),u+=L,_+=I,E+=F.width2d}this.drawScanline(u>>16,R>>16,F.pixels,E,O),u+=L,R+=H,E+=F.width2d}}else{m-=b,b-=E,E=this.lineOffset[E];while(!0){if(b--,b<0)while(!0){if(m--,m<0)return;this.drawScanline(_>>16,u>>16,F.pixels,E,O),u+=L,_+=I,E+=F.width2d}this.drawScanline(R>>16,u>>16,F.pixels,E,O),u+=L,R+=H,E+=F.width2d}}}else{if(_=R<<=16,E<0)_-=L*E,R-=H*E,E=0;if(u<<=16,m<0)u-=I*m,m=0;if(L<H){b-=m,m-=E,E=this.lineOffset[E];while(!0){if(m--,m<0)while(!0){if(b--,b<0)return;this.drawScanline(u>>16,R>>16,F.pixels,E,O),u+=I,R+=H,E+=F.width2d}this.drawScanline(_>>16,R>>16,F.pixels,E,O),_+=L,R+=H,E+=F.width2d}}else{b-=m,m-=E,E=this.lineOffset[E];while(!0){if(m--,m<0)while(!0){if(b--,b<0)return;this.drawScanline(R>>16,u>>16,F.pixels,E,O),u+=I,R+=H,E+=F.width2d}this.drawScanline(R>>16,_>>16,F.pixels,E,O),_+=L,R+=H,E+=F.width2d}}}}}static fillTexturedTriangle(_,u,R,b,m,E,O,I,L,H,G,N,T,K,Q,U,J,q,w){let V=this.getTexels(w);this.opaque=!this.textureTranslucent[w];let Y=H-T,n=G-Q,f=N-J,Z=K-H,h=U-G,D=q-N,j=Z*G-h*H<<14,W=h*N-D*G<<8,M=D*H-Z*N<<5,X=Y*G-n*H<<14,P=n*N-f*G<<8,r=f*H-Y*N<<5,B=n*Z-Y*h<<14,t=f*h-n*D<<8,a=Y*D-f*Z<<5,x=0,E0=0;if(m!==b)x=(u-_<<16)/(m-b)|0,E0=(I-O<<16)/(m-b)|0;let _0=0,H0=0;if(E!==m)_0=(R-u<<16)/(E-m)|0,H0=(L-I<<16)/(E-m)|0;let L0=0,Q0=0;if(E!==b)L0=(_-R<<16)/(b-E)|0,Q0=(O-L<<16)/(b-E)|0;if(b<=m&&b<=E){if(b<F.bottom){if(m>F.bottom)m=F.bottom;if(E>F.bottom)E=F.bottom;if(m<E){if(R=_<<=16,L=O<<=16,b<0)R-=L0*b,_-=x*b,L-=Q0*b,O-=E0*b,b=0;if(u<<=16,I<<=16,m<0)u-=_0*m,I-=H0*m,m=0;let K0=b-this.centerY;if(j+=M*K0,X+=r*K0,B+=a*K0,j|=0,X|=0,B|=0,b!==m&&L0<x||b===m&&L0>_0){E-=m,m-=b,b=this.lineOffset[b];while(!0){if(m--,m<0)while(!0){if(E--,E<0)return;this.drawTexturedScanline(R>>16,u>>16,F.pixels,b,V,0,0,j,X,B,W,P,t,L>>8,I>>8),R+=L0,u+=_0,L+=Q0,I+=H0,b+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}this.drawTexturedScanline(R>>16,_>>16,F.pixels,b,V,0,0,j,X,B,W,P,t,L>>8,O>>8),R+=L0,_+=x,L+=Q0,O+=E0,b+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}}else{E-=m,m-=b,b=this.lineOffset[b];while(!0){if(m--,m<0)while(!0){if(E--,E<0)return;this.drawTexturedScanline(u>>16,R>>16,F.pixels,b,V,0,0,j,X,B,W,P,t,I>>8,L>>8),R+=L0,u+=_0,L+=Q0,I+=H0,b+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}this.drawTexturedScanline(_>>16,R>>16,F.pixels,b,V,0,0,j,X,B,W,P,t,O>>8,L>>8),R+=L0,_+=x,L+=Q0,O+=E0,b+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}}}else{if(u=_<<=16,I=O<<=16,b<0)u-=L0*b,_-=x*b,I-=Q0*b,O-=E0*b,b=0;if(R<<=16,L<<=16,E<0)R-=_0*E,L-=H0*E,E=0;let K0=b-this.centerY;if(j+=M*K0,X+=r*K0,B+=a*K0,j|=0,X|=0,B|=0,(b===E||L0>=x)&&(b!==E||_0<=x)){m-=E,E-=b,b=this.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(m--,m<0)return;this.drawTexturedScanline(_>>16,R>>16,F.pixels,b,V,0,0,j,X,B,W,P,t,O>>8,L>>8),R+=_0,_+=x,L+=H0,O+=E0,b+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}this.drawTexturedScanline(_>>16,u>>16,F.pixels,b,V,0,0,j,X,B,W,P,t,O>>8,I>>8),u+=L0,_+=x,I+=Q0,O+=E0,b+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}}else{m-=E,E-=b,b=this.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(m--,m<0)return;this.drawTexturedScanline(R>>16,_>>16,F.pixels,b,V,0,0,j,X,B,W,P,t,L>>8,O>>8),R+=_0,_+=x,L+=H0,O+=E0,b+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}this.drawTexturedScanline(u>>16,_>>16,F.pixels,b,V,0,0,j,X,B,W,P,t,I>>8,O>>8),u+=L0,_+=x,I+=Q0,O+=E0,b+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}}}}}else if(m<=E){if(m<F.bottom){if(E>F.bottom)E=F.bottom;if(b>F.bottom)b=F.bottom;if(E<b){if(_=u<<=16,O=I<<=16,m<0)_-=x*m,u-=_0*m,O-=E0*m,I-=H0*m,m=0;if(R<<=16,L<<=16,E<0)R-=L0*E,L-=Q0*E,E=0;let K0=m-this.centerY;if(j+=M*K0,X+=r*K0,B+=a*K0,j|=0,X|=0,B|=0,m!==E&&x<_0||m===E&&x>L0){b-=E,E-=m,m=this.lineOffset[m];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.drawTexturedScanline(_>>16,R>>16,F.pixels,m,V,0,0,j,X,B,W,P,t,O>>8,L>>8),_+=x,R+=L0,O+=E0,L+=Q0,m+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}this.drawTexturedScanline(_>>16,u>>16,F.pixels,m,V,0,0,j,X,B,W,P,t,O>>8,I>>8),_+=x,u+=_0,O+=E0,I+=H0,m+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}}else{b-=E,E-=m,m=this.lineOffset[m];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.drawTexturedScanline(R>>16,_>>16,F.pixels,m,V,0,0,j,X,B,W,P,t,L>>8,O>>8),_+=x,R+=L0,O+=E0,L+=Q0,m+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}this.drawTexturedScanline(u>>16,_>>16,F.pixels,m,V,0,0,j,X,B,W,P,t,I>>8,O>>8),_+=x,u+=_0,O+=E0,I+=H0,m+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}}}else{if(R=u<<=16,L=I<<=16,m<0)R-=x*m,u-=_0*m,L-=E0*m,I-=H0*m,m=0;if(_<<=16,O<<=16,b<0)_-=L0*b,O-=Q0*b,b=0;let K0=m-this.centerY;if(j+=M*K0,X+=r*K0,B+=a*K0,j|=0,X|=0,B|=0,E-=b,b-=m,m=this.lineOffset[m],x<_0)while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.drawTexturedScanline(_>>16,u>>16,F.pixels,m,V,0,0,j,X,B,W,P,t,O>>8,I>>8),_+=L0,u+=_0,O+=Q0,I+=H0,m+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}this.drawTexturedScanline(R>>16,u>>16,F.pixels,m,V,0,0,j,X,B,W,P,t,L>>8,I>>8),R+=x,u+=_0,L+=E0,I+=H0,m+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}else while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.drawTexturedScanline(u>>16,_>>16,F.pixels,m,V,0,0,j,X,B,W,P,t,I>>8,O>>8),_+=L0,u+=_0,O+=Q0,I+=H0,m+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}this.drawTexturedScanline(u>>16,R>>16,F.pixels,m,V,0,0,j,X,B,W,P,t,I>>8,L>>8),R+=x,u+=_0,L+=E0,I+=H0,m+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}}}}else if(E<F.bottom){if(b>F.bottom)b=F.bottom;if(m>F.bottom)m=F.bottom;if(b<m){if(u=R<<=16,I=L<<=16,E<0)u-=_0*E,R-=L0*E,I-=H0*E,L-=Q0*E,E=0;if(_<<=16,O<<=16,b<0)_-=x*b,O-=E0*b,b=0;let K0=E-this.centerY;if(j+=M*K0,X+=r*K0,B+=a*K0,j|=0,X|=0,B|=0,m-=b,b-=E,E=this.lineOffset[E],_0<L0)while(!0){if(b--,b<0)while(!0){if(m--,m<0)return;this.drawTexturedScanline(u>>16,_>>16,F.pixels,E,V,0,0,j,X,B,W,P,t,I>>8,O>>8),u+=_0,_+=x,I+=H0,O+=E0,E+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}this.drawTexturedScanline(u>>16,R>>16,F.pixels,E,V,0,0,j,X,B,W,P,t,I>>8,L>>8),u+=_0,R+=L0,I+=H0,L+=Q0,E+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}else while(!0){if(b--,b<0)while(!0){if(m--,m<0)return;this.drawTexturedScanline(_>>16,u>>16,F.pixels,E,V,0,0,j,X,B,W,P,t,O>>8,I>>8),u+=_0,_+=x,I+=H0,O+=E0,E+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}this.drawTexturedScanline(R>>16,u>>16,F.pixels,E,V,0,0,j,X,B,W,P,t,L>>8,I>>8),u+=_0,R+=L0,I+=H0,L+=Q0,E+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}}else{if(_=R<<=16,O=L<<=16,E<0)_-=_0*E,R-=L0*E,O-=H0*E,L-=Q0*E,E=0;if(u<<=16,I<<=16,m<0)u-=x*m,I-=E0*m,m=0;let K0=E-this.centerY;if(j+=M*K0,X+=r*K0,B+=a*K0,j|=0,X|=0,B|=0,b-=m,m-=E,E=this.lineOffset[E],_0<L0)while(!0){if(m--,m<0)while(!0){if(b--,b<0)return;this.drawTexturedScanline(u>>16,R>>16,F.pixels,E,V,0,0,j,X,B,W,P,t,I>>8,L>>8),u+=x,R+=L0,I+=E0,L+=Q0,E+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}this.drawTexturedScanline(_>>16,R>>16,F.pixels,E,V,0,0,j,X,B,W,P,t,O>>8,L>>8),_+=_0,R+=L0,O+=H0,L+=Q0,E+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}else while(!0){if(m--,m<0)while(!0){if(b--,b<0)return;this.drawTexturedScanline(R>>16,u>>16,F.pixels,E,V,0,0,j,X,B,W,P,t,L>>8,I>>8),u+=x,R+=L0,I+=E0,L+=Q0,E+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}this.drawTexturedScanline(R>>16,_>>16,F.pixels,E,V,0,0,j,X,B,W,P,t,L>>8,O>>8),_+=_0,R+=L0,O+=H0,L+=Q0,E+=F.width2d,j+=M,X+=r,B+=a,j|=0,X|=0,B|=0}}}}static drawTexturedScanline(_,u,R,b,m,E,O,I,L,H,G,N,T,K,Q){if(_>=u)return;let U,J;if(this.clipX){if(U=(Q-K)/(u-_)|0,u>F.boundX)u=F.boundX;if(_<0)K-=_*U,_=0;if(_>=u)return;J=u-_>>3,U<<=12}else if(u-_>7)J=u-_>>3,U=(Q-K)*this.reciprocal15[J]>>6;else J=0,U=0;K<<=9,b+=_;let q,w,V,Y,n,f,Z;if(this.lowMemory&&m){if(q=0,w=0,Y=_-this.centerX,I=I+(G>>3)*Y,L=L+(N>>3)*Y,H=H+(T>>3)*Y,I|=0,L|=0,H|=0,V=H>>12,V!==0){if(E=I/V|0,O=L/V|0,E<0)E=0;else if(E>4032)E=4032}if(I=I+G,L=L+N,H=H+T,I|=0,L|=0,H|=0,V=H>>12,V!==0){if(q=I/V|0,w=L/V|0,q<7)q=7;else if(q>4032)q=4032}if(n=q-E>>3,f=w-O>>3,E+=K>>3&786432,Z=K>>23,this.opaque){while(J-- >0){if(R[b++]=m[(O&4032)+(E>>6)]>>>Z,E+=n,O+=f,R[b++]=m[(O&4032)+(E>>6)]>>>Z,E+=n,O+=f,R[b++]=m[(O&4032)+(E>>6)]>>>Z,E+=n,O+=f,R[b++]=m[(O&4032)+(E>>6)]>>>Z,E+=n,O+=f,R[b++]=m[(O&4032)+(E>>6)]>>>Z,E+=n,O+=f,R[b++]=m[(O&4032)+(E>>6)]>>>Z,E+=n,O+=f,R[b++]=m[(O&4032)+(E>>6)]>>>Z,E+=n,O+=f,R[b++]=m[(O&4032)+(E>>6)]>>>Z,E=q,O=w,I+=G,L+=N,H+=T,V=H>>12,V!==0){if(q=I/V|0,w=L/V|0,q<7)q=7;else if(q>4032)q=4032}n=q-E>>3,f=w-O>>3,K+=U,E+=K>>3&786432,Z=K>>23}J=u-_&7;while(J-- >0)R[b++]=m[(O&4032)+(E>>6)]>>>Z,E+=n,O+=f}else{while(J-- >0){let h;if((h=m[(O&4032)+(E>>6)]>>>Z)!==0)R[b]=h;if(b=b+1,E+=n,O+=f,(h=m[(O&4032)+(E>>6)]>>>Z)!==0)R[b]=h;if(b++,E+=n,O+=f,(h=m[(O&4032)+(E>>6)]>>>Z)!==0)R[b]=h;if(b++,E+=n,O+=f,(h=m[(O&4032)+(E>>6)]>>>Z)!==0)R[b]=h;if(b++,E+=n,O+=f,(h=m[(O&4032)+(E>>6)]>>>Z)!==0)R[b]=h;if(b++,E+=n,O+=f,(h=m[(O&4032)+(E>>6)]>>>Z)!==0)R[b]=h;if(b++,E+=n,O+=f,(h=m[(O&4032)+(E>>6)]>>>Z)!==0)R[b]=h;if(b++,E+=n,O+=f,(h=m[(O&4032)+(E>>6)]>>>Z)!==0)R[b]=h;if(b=b+1,E=q,O=w,I+=G,L+=N,H+=T,I|=0,L|=0,H|=0,V=H>>12,V!==0){if(q=I/V|0,w=L/V|0,q<7)q=7;else if(q>4032)q=4032}n=q-E>>3,f=w-O>>3,K+=U,E+=K>>3&786432,Z=K>>23}J=u-_&7;while(J-- >0){let h;if((h=m[(O&4032)+(E>>6)]>>>Z)!==0)R[b]=h;b++,E+=n,O+=f}}return}if(q=0,w=0,Y=_-this.centerX,I=I+(G>>3)*Y,L=L+(N>>3)*Y,H=H+(T>>3)*Y,I|=0,L|=0,H|=0,V=H>>14,V!==0){if(E=I/V|0,O=L/V|0,E<0)E=0;else if(E>16256)E=16256}if(I=I+G,L=L+N,H=H+T,I|=0,L|=0,H|=0,V=H>>14,V!==0){if(q=I/V|0,w=L/V|0,q<7)q=7;else if(q>16256)q=16256}if(n=q-E>>3,f=w-O>>3,E+=K&6291456,Z=K>>23,this.opaque&&m){while(J-- >0){if(R[b++]=m[(O&16256)+(E>>7)]>>>Z,E+=n,O+=f,R[b++]=m[(O&16256)+(E>>7)]>>>Z,E+=n,O+=f,R[b++]=m[(O&16256)+(E>>7)]>>>Z,E+=n,O+=f,R[b++]=m[(O&16256)+(E>>7)]>>>Z,E+=n,O+=f,R[b++]=m[(O&16256)+(E>>7)]>>>Z,E+=n,O+=f,R[b++]=m[(O&16256)+(E>>7)]>>>Z,E+=n,O+=f,R[b++]=m[(O&16256)+(E>>7)]>>>Z,E+=n,O+=f,R[b++]=m[(O&16256)+(E>>7)]>>>Z,E=q,O=w,I+=G,L+=N,H+=T,I|=0,L|=0,H|=0,V=H>>14,V!==0){if(q=I/V|0,w=L/V|0,q<7)q=7;else if(q>16256)q=16256}n=q-E>>3,f=w-O>>3,K+=U,E+=K&6291456,Z=K>>23}J=u-_&7;while(J-- >0)R[b++]=m[(O&16256)+(E>>7)]>>>Z,E+=n,O+=f;return}while(J-- >0&&m){let h;if((h=m[(O&16256)+(E>>7)]>>>Z)!==0)R[b]=h;if(b=b+1,E+=n,O+=f,(h=m[(O&16256)+(E>>7)]>>>Z)!==0)R[b]=h;if(b++,E+=n,O+=f,(h=m[(O&16256)+(E>>7)]>>>Z)!==0)R[b]=h;if(b++,E+=n,O+=f,(h=m[(O&16256)+(E>>7)]>>>Z)!==0)R[b]=h;if(b++,E+=n,O+=f,(h=m[(O&16256)+(E>>7)]>>>Z)!==0)R[b]=h;if(b++,E+=n,O+=f,(h=m[(O&16256)+(E>>7)]>>>Z)!==0)R[b]=h;if(b++,E+=n,O+=f,(h=m[(O&16256)+(E>>7)]>>>Z)!==0)R[b]=h;if(b++,E+=n,O+=f,(h=m[(O&16256)+(E>>7)]>>>Z)!==0)R[b]=h;if(b++,E=q,O=w,I+=G,L+=N,H+=T,I|=0,L|=0,H|=0,V=H>>14,V!==0){if(q=I/V|0,w=L/V|0,q<7)q=7;else if(q>16256)q=16256}n=q-E>>3,f=w-O>>3,K+=U,E+=K&6291456,Z=K>>23}J=u-_&7;while(J-- >0&&m){let h;if((h=m[(O&16256)+(E>>7)]>>>Z)!==0)R[b]=h;b++,E+=n,O+=f}}static drawScanline(_,u,R,b,m){if(this.clipX){if(u>F.boundX)u=F.boundX;if(_<0)_=0}if(_>=u)return;b+=_;let E=u-_>>2;if(this.alpha===0)while(!0){if(E--,E<0){E=u-_&3;while(!0){if(E--,E<0)return;R[b++]=m}}R[b++]=m,R[b++]=m,R[b++]=m,R[b++]=m}let O=this.alpha,I=256-this.alpha;m=((m&16711935)*I>>8&16711935)+((m&65280)*I>>8&65280);while(!0){if(E--,E<0){E=u-_&3;while(!0){if(E--,E<0)return;R[b++]=m+((R[b]&16711935)*O>>8&16711935)+((R[b]&65280)*O>>8&65280)}}R[b++]=m+((R[b]&16711935)*O>>8&16711935)+((R[b]&65280)*O>>8&65280),R[b++]=m+((R[b]&16711935)*O>>8&16711935)+((R[b]&65280)*O>>8&65280),R[b++]=m+((R[b]&16711935)*O>>8&16711935)+((R[b]&65280)*O>>8&65280),R[b++]=m+((R[b]&16711935)*O>>8&16711935)+((R[b]&65280)*O>>8&65280)}}static pushTexture(_){if(this.activeTexels[_]&&this.texelPool)this.texelPool[this.poolSize++]=this.activeTexels[_],this.activeTexels[_]=null}static getTexels(_){if(this.textureCycle[_]=this.cycle++,this.activeTexels[_])return this.activeTexels[_];let u;if(this.poolSize>0&&this.texelPool)u=this.texelPool[--this.poolSize],this.texelPool[this.poolSize]=null;else{let m=0,E=-1;for(let O=0;O<this.textureCount;O++)if(this.activeTexels[O]&&(this.textureCycle[O]<m||E===-1))m=this.textureCycle[O],E=O;u=this.activeTexels[E],this.activeTexels[E]=null}this.activeTexels[_]=u;let R=this.textures[_],b=this.texPal[_];if(!u||!R||!b)return null;if(this.lowMemory){this.textureTranslucent[_]=!1;for(let m=0;m<4096;m++){let E=u[m]=b[R.pixels[m]]&16316671;if(E===0)this.textureTranslucent[_]=!0;u[m+4096]=E-(E>>>3)&16316671,u[m+8192]=E-(E>>>2)&16316671,u[m+12288]=E-(E>>>2)-(E>>>3)&16316671}}else{if(R.width2d===64)for(let m=0;m<128;m++)for(let E=0;E<128;E++)u[E+(m<<7|0)]=b[R.pixels[(E>>1)+(m>>1<<6|0)]];else for(let m=0;m<16384;m++)u[m]=b[R.pixels[m]];this.textureTranslucent[_]=!1;for(let m=0;m<16384;m++){u[m]&=16316671;let E=u[m];if(E===0)this.textureTranslucent[_]=!0;u[m+16384]=E-(E>>>3)&16316671,u[m+32768]=E-(E>>>2)&16316671,u[m+49152]=E-(E>>>2)-(E>>>3)&16316671}}return u}}class I0{image;width2d;height2d;ctx;paint;pixels;constructor(_,u,R=y){this.ctx=R,this.image=this.ctx.getImageData(0,0,_,u),this.paint=new Uint32Array(this.image.data.buffer),this.pixels=new Int32Array(_*u),this.width2d=_,this.height2d=u,this.bind()}clear(){this.pixels.fill(0)}bind(){F.bind(this.pixels,this.width2d,this.height2d)}draw(_,u){this.#_(),this.ctx.putImageData(this.image,_,u)}#_(){let _=this.pixels.length,u=this.pixels,R=this.paint;for(let b=0;b<_;b++){let m=u[b];R[b]=m>>16&255|(m>>8&255)<<8|(m&255)<<16|4278190080}}}var F1=["F11","F12"],S=new Map;S.set("ArrowLeft",{code:37,ch:1});S.set("ArrowRight",{code:39,ch:2});S.set("ArrowUp",{code:38,ch:3});S.set("ArrowDown",{code:40,ch:4});S.set("Control",{code:17,ch:5});S.set("Shift",{code:16,ch:6});S.set("Alt",{code:18,ch:7});S.set("Backspace",{code:8,ch:8});S.set("Tab",{code:9,ch:9});S.set("Enter",{code:10,ch:10});S.set("Escape",{code:27,ch:27});S.set(" ",{code:32,ch:32});S.set("Delete",{code:127,ch:127});S.set("Home",{code:36,ch:1000});S.set("End",{code:35,ch:1001});S.set("PageUp",{code:33,ch:1002});S.set("PageDown",{code:34,ch:1003});S.set("F1",{code:112,ch:1008});S.set("F2",{code:113,ch:1009});S.set("F3",{code:114,ch:1010});S.set("F4",{code:115,ch:1011});S.set("F5",{code:116,ch:1012});S.set("F6",{code:117,ch:1013});S.set("F7",{code:118,ch:1014});S.set("F8",{code:119,ch:1015});S.set("F9",{code:120,ch:1016});S.set("F10",{code:121,ch:1017});S.set("F11",{code:122,ch:1018});S.set("F12",{code:123,ch:1019});S.set("CapsLock",{code:20,ch:65535});S.set("Meta",{code:524,ch:65535});S.set("Insert",{code:155,ch:65535});S.set("`",{code:192,ch:96});S.set("~",{code:192,ch:126});S.set("!",{code:49,ch:33});S.set("@",{code:50,ch:64});S.set("#",{code:51,ch:35});S.set("$",{code:52,ch:36});S.set("%",{code:53,ch:37});S.set("^",{code:54,ch:94});S.set("&",{code:55,ch:38});S.set("*",{code:56,ch:42});S.set("(",{code:57,ch:40});S.set(")",{code:48,ch:41});S.set("-",{code:45,ch:45});S.set("_",{code:45,ch:95});S.set("=",{code:61,ch:61});S.set("+",{code:61,ch:43});S.set("[",{code:91,ch:91});S.set("{",{code:91,ch:123});S.set("]",{code:93,ch:93});S.set("}",{code:93,ch:125});S.set("\\",{code:92,ch:92});S.set("|",{code:92,ch:124});S.set(";",{code:59,ch:59});S.set(":",{code:59,ch:58});S.set("'",{code:222,ch:39});S.set('"',{code:222,ch:34});S.set(",",{code:44,ch:44});S.set("<",{code:44,ch:60});S.set(".",{code:46,ch:46});S.set(">",{code:46,ch:62});S.set("/",{code:47,ch:47});S.set("?",{code:47,ch:63});S.set("0",{code:48,ch:48});S.set("1",{code:49,ch:49});S.set("2",{code:50,ch:50});S.set("3",{code:51,ch:51});S.set("4",{code:52,ch:52});S.set("5",{code:53,ch:53});S.set("6",{code:54,ch:54});S.set("7",{code:55,ch:55});S.set("8",{code:56,ch:56});S.set("9",{code:57,ch:57});S.set("a",{code:65,ch:97});S.set("b",{code:66,ch:98});S.set("c",{code:67,ch:99});S.set("d",{code:68,ch:100});S.set("e",{code:69,ch:101});S.set("f",{code:70,ch:102});S.set("g",{code:71,ch:103});S.set("h",{code:72,ch:104});S.set("i",{code:73,ch:105});S.set("j",{code:74,ch:106});S.set("k",{code:75,ch:107});S.set("l",{code:76,ch:108});S.set("m",{code:77,ch:109});S.set("n",{code:78,ch:110});S.set("o",{code:79,ch:111});S.set("p",{code:80,ch:112});S.set("q",{code:81,ch:113});S.set("r",{code:82,ch:114});S.set("s",{code:83,ch:115});S.set("t",{code:84,ch:116});S.set("u",{code:85,ch:117});S.set("v",{code:86,ch:118});S.set("w",{code:87,ch:119});S.set("x",{code:88,ch:120});S.set("y",{code:89,ch:121});S.set("z",{code:90,ch:122});S.set("A",{code:65,ch:65});S.set("B",{code:66,ch:66});S.set("C",{code:67,ch:67});S.set("D",{code:68,ch:68});S.set("E",{code:69,ch:69});S.set("F",{code:70,ch:70});S.set("G",{code:71,ch:71});S.set("H",{code:72,ch:72});S.set("I",{code:73,ch:73});S.set("J",{code:74,ch:74});S.set("K",{code:75,ch:75});S.set("L",{code:76,ch:76});S.set("M",{code:77,ch:77});S.set("N",{code:78,ch:78});S.set("O",{code:79,ch:79});S.set("P",{code:80,ch:80});S.set("Q",{code:81,ch:81});S.set("R",{code:82,ch:82});S.set("S",{code:83,ch:83});S.set("T",{code:84,ch:84});S.set("U",{code:85,ch:85});S.set("V",{code:86,ch:86});S.set("W",{code:87,ch:87});S.set("X",{code:88,ch:88});S.set("Y",{code:89,ch:89});S.set("Z",{code:90,ch:90});class N0{static enabled=!1;static outBuffer=null;static oldBuffer=null;static lastTime=0;static trackedCount=0;static lastMoveTime=0;static lastX=0;static lastY=0;static setEnabled(){this.outBuffer=z.alloc(1),this.oldBuffer=null,this.lastTime=performance.now(),this.enabled=!0}static setDisabled(){this.enabled=!1,this.outBuffer=null,this.oldBuffer=null}static flush(){let _=null;if(this.oldBuffer&&this.enabled)_=this.oldBuffer;return this.oldBuffer=null,_}static stop(){let _=null;if(this.outBuffer&&this.outBuffer.pos>0&&this.enabled)_=this.outBuffer;return this.setDisabled(),_}static ensureCapacity(_){if(!this.outBuffer)return;if(this.outBuffer.pos+_>=500){let u=this.outBuffer;this.outBuffer=z.alloc(1),this.oldBuffer=u}}static mousePressed(_,u,R){if(!this.outBuffer)return;if(!this.enabled&&(_>=0&&_<789&&u>=0&&u<532))return;this.trackedCount++;let b=performance.now(),m=(b-this.lastTime)/10|0;if(m>250)m=250;if(this.lastTime=b,this.ensureCapacity(5),R===2)this.outBuffer.p1(1);else this.outBuffer.p1(2);this.outBuffer.p1(m),this.outBuffer.p3(_+(u<<10))}static mouseReleased(_){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let u=performance.now(),R=(u-this.lastTime)/10|0;if(R>250)R=250;if(this.lastTime=u,this.ensureCapacity(2),_===2)this.outBuffer.p1(3);else this.outBuffer.p1(4);this.outBuffer.p1(R)}static mouseMoved(_,u){if(!this.outBuffer)return;if(!this.enabled&&(_>=0&&_<789&&u>=0&&u<532))return;let R=performance.now();if(R-this.lastMoveTime<50)return;this.lastMoveTime=R,this.trackedCount++;let b=(R-this.lastTime)/10|0;if(b>250)b=250;if(this.lastTime=R,_-this.lastX<8&&_-this.lastX>=-8&&u-this.lastY<8&&u-this.lastY>=-8)this.ensureCapacity(3),this.outBuffer.p1(5),this.outBuffer.p1(b),this.outBuffer.p1(_+(u-this.lastY+8<<4)+8-this.lastX);else if(_-this.lastX<128&&_-this.lastX>=-128&&u-this.lastY<128&&u-this.lastY>=-128)this.ensureCapacity(4),this.outBuffer.p1(6),this.outBuffer.p1(b),this.outBuffer.p1(_+128-this.lastX),this.outBuffer.p1(u+128-this.lastY);else this.ensureCapacity(5),this.outBuffer.p1(7),this.outBuffer.p1(b),this.outBuffer.p3(_+(u<<10));this.lastX=_,this.lastY=u}static keyPressed(_){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let u=performance.now(),R=(u-this.lastTime)/10|0;if(R>250)R=250;if(this.lastTime=u,_===1000)_=11;else if(_===1001)_=12;else if(_===1002)_=14;else if(_===1003)_=15;else if(_>=1008)_-=992;this.ensureCapacity(3),this.outBuffer.p1(8),this.outBuffer.p1(R),this.outBuffer.p1(_)}static keyReleased(_){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let u=performance.now(),R=(u-this.lastTime)/10|0;if(R>250)R=250;if(this.lastTime=u,_===1000)_=11;else if(_===1001)_=12;else if(_===1002)_=14;else if(_===1003)_=15;else if(_>=1008)_-=992;this.ensureCapacity(3),this.outBuffer.p1(9),this.outBuffer.p1(R),this.outBuffer.p1(_)}static focusGained(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let _=performance.now(),u=(_-this.lastTime)/10|0;if(u>250)u=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer.p1(10),this.outBuffer.p1(u)}static focusLost(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let _=performance.now(),u=(_-this.lastTime)/10|0;if(u>250)u=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer.p1(11),this.outBuffer.p1(u)}static mouseEntered(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let _=performance.now(),u=(_-this.lastTime)/10|0;if(u>250)u=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer.p1(12),this.outBuffer.p1(u)}static mouseExited(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let _=performance.now(),u=(_-this.lastTime)/10|0;if(u>250)u=250;this.lastTime=_,this.ensureCapacity(2),this.outBuffer.p1(13),this.outBuffer.p1(u)}}class o0{state=0;deltime=20;mindel=1;otim=new Array(10);fps=0;debug=!1;drawArea=null;redrawScreen=!0;hasFocus=!0;idleCycles=Date.now();mouseButton=0;mouseX=-1;mouseY=-1;lastMouseClickButton=0;lastMouseClickX=0;lastMouseClickY=0;mouseClickButton=0;mouseClickX=-1;mouseClickY=-1;lastMouseClickTime=0;mouseClickTime=0;actionKey=[];keyQueue=[];keyQueueReadPos=0;keyQueueWritePos=0;slowestMS=0;averageMS=[];averageIndexMS=0;resizeToFit=!1;tfps=50;fpos=0;frameTime=[];ingame=!1;input=null;touching=!1;startedInViewport=!1;startedInTabArea=!1;time=-1;sx=0;sy=0;mx=0;my=0;nx=0;ny=0;async load(){}async update(){}async draw(){}async refresh(){}constructor(_=!1){if(G0.tabIndex=-1,y.fillStyle="black",y.fillRect(0,0,G0.width,G0.height),this.resizeToFit=_,this.resizeToFit)this.resize(window.innerWidth,window.innerHeight);else this.resize(G0.width,G0.height)}get width(){return G0.width}get height(){return G0.height}resize(_,u){G0.width=_,G0.height=u,this.drawArea=new I0(_,u),A.init2D()}async run(){if(G0.addEventListener("resize",()=>{if(this.resizeToFit)this.resize(window.innerWidth,window.innerHeight)},!1),G0.onfocus=this.onfocus.bind(this),G0.onblur=this.onblur.bind(this),G0.onmousedown=this.onmousedown.bind(this),G0.onmouseup=this.onmouseup.bind(this),G0.onmouseenter=this.onmouseenter.bind(this),G0.onmouseleave=this.onmouseleave.bind(this),G0.onmousemove=this.onmousemove.bind(this),G0.onkeydown=this.onkeydown.bind(this),G0.onkeyup=this.onkeyup.bind(this),this.isMobile)G0.ontouchstart=this.ontouchstart.bind(this),G0.ontouchend=this.ontouchend.bind(this),G0.ontouchmove=this.ontouchmove.bind(this);G0.oncontextmenu=(E)=>{E.preventDefault()},window.oncontextmenu=(E)=>{E.preventDefault()},await this.drawProgress(0,"Loading..."),await this.load();let _=0,u=0,R=256,b=1,m=0;for(let E=0;E<10;E++)this.otim[E]=performance.now();while(this.state>=0){if(this.state>0){if(this.state--,this.state===0){this.shutdown();return}}let E=R,O=b;R=300,b=1,_=performance.now();let I=this.otim[u];if(I===0)R=E,b=O;else if(_>I)R=this.deltime*2560/(_-I)|0;if(R<25)R=25;else if(R>256)R=256,b=this.deltime-(_-I)/10|0;if(this.otim[u]=_,u=(u+1)%10,b>1){for(let H=0;H<10;H++)if(this.otim[H]!==0)this.otim[H]+=b}if(b<this.mindel)b=this.mindel;await Z0(b);while(m<256)this.mouseClickButton=this.lastMouseClickButton,this.mouseClickX=this.lastMouseClickX,this.mouseClickY=this.lastMouseClickY,this.mouseClickTime=this.lastMouseClickTime,this.lastMouseClickButton=0,await this.update(),this.keyQueueReadPos=this.keyQueueWritePos,m+=R;if(m&=255,this.deltime>0)this.fps=R*1000/(this.deltime*256)|0;let L=performance.now();if(await this.draw(),this.frameTime[this.fpos]=(performance.now()-L)/1000,this.fpos=(this.fpos+1)%this.frameTime.length,this.tfps<50){let H=1000/this.tfps-(performance.now()-_);if(H>0)await Z0(H)}if(this.debug){for(let H=0;H<10;H++){let G=(u-H-1+20)%10}this.debug=!1}}if(this.state===-1)this.shutdown()}shutdown(){this.state=-2}setFramerate(_){this.deltime=1000/_|0}setTargetedFramerate(_){this.tfps=Math.max(Math.min(50,_|0),0)}start(){if(this.state>=0)this.state=0}stop(){if(this.state>=0)this.state=4000/this.deltime|0}async drawProgress(_,u){let R=this.width,b=this.height;if(this.redrawScreen)y.fillStyle="black",y.fillRect(0,0,R,b),this.redrawScreen=!1;let m=b/2-18;y.fillStyle="rgb(140, 17, 17)",y.rect((R/2|0)-152,m,304,34),y.fillRect((R/2|0)-150,m+2,_*3,30),y.fillStyle="black",y.fillRect((R/2|0)-150+_*3,m+2,300-_*3,30),y.font="bold 13px helvetica, sans-serif",y.textAlign="center",y.fillStyle="white",y.fillText(u,R/2|0,m+22),await Z0(5)}pollKey(){let _=-1;if(this.keyQueueWritePos!==this.keyQueueReadPos)_=this.keyQueue[this.keyQueueReadPos],this.keyQueueReadPos=this.keyQueueReadPos+1&127;return _}get ms(){let _=this.frameTime.length,u=0;for(let b=0;b<_;b++)u+=this.frameTime[b];let R=u/_*1000;if(R>this.slowestMS)this.slowestMS=R;return this.averageMS[this.averageIndexMS]=R,this.averageIndexMS=(this.averageIndexMS+1)%250,R}get msAvg(){return this.averageMS.reduce((_,u)=>_+u,0)/250}onkeydown(_){this.idleCycles=Date.now();let u=S.get(_.key);if(!u||_.code.length===0&&!_.isTrusted)return;let R=u.ch;if(_.ctrlKey){if(R>=65&&R<=93||R==95)R-=64;else if(R>=97&&R<=122)R-=96}if(R>0&&R<128)this.actionKey[R]=1;if(R>4)this.keyQueue[this.keyQueueWritePos]=R,this.keyQueueWritePos=this.keyQueueWritePos+1&127;if(N0.enabled)N0.keyPressed(R);if(!F1.includes(_.key))_.preventDefault()}onkeyup(_){this.idleCycles=Date.now();let u=S.get(_.key);if(!u||_.code.length===0&&!_.isTrusted)return;let R=u.ch;if(_.ctrlKey){if(R>=65&&R<=93||R==95)R-=64;else if(R>=97&&R<=122)R-=96}if(R>0&&R<128)this.actionKey[R]=0;if(N0.enabled)N0.keyReleased(R);if(!F1.includes(_.key))_.preventDefault()}onmousedown(_){if(this.touching=!1,_.clientX>0||_.clientY>0)this.setMousePosition(_);if(this.idleCycles=Date.now(),this.lastMouseClickX=this.mouseX,this.lastMouseClickY=this.mouseY,this.lastMouseClickTime=Date.now(),this.isMobile&&!this.isCapacitor){if(this.insideMobileInputArea()&&!this.insideChatPopupArea()){this.lastMouseClickButton=1,this.mouseButton=1;return}if(_.timeStamp>=this.time+500)this.lastMouseClickButton=2,this.mouseButton=2;else this.lastMouseClickButton=1,this.mouseButton=1}else if(_.button===2)this.lastMouseClickButton=2,this.mouseButton=2;else if(_.button===0)this.lastMouseClickButton=1,this.mouseButton=1;if(N0.enabled)N0.mousePressed(this.lastMouseClickX,this.lastMouseClickY,_.button)}onmouseup(_){if(this.setMousePosition(_),this.idleCycles=Date.now(),this.mouseButton=0,N0.enabled)N0.mouseReleased(_.button)}onmouseenter(_){if(this.setMousePosition(_),N0.enabled)N0.mouseEntered()}onmouseleave(_){if(this.setMousePosition(_),this.idleCycles=Date.now(),this.mouseX=-1,this.mouseY=-1,this.mouseButton=0,this.mouseClickX=-1,this.mouseClickY=-1,N0.enabled)N0.mouseExited()}onmousemove(_){if(this.setMousePosition(_),this.idleCycles=Date.now(),N0.enabled)N0.mouseMoved(this.mouseX,this.mouseY)}onfocus(_){if(this.hasFocus=!0,this.redrawScreen=!0,this.refresh(),N0.enabled)N0.focusGained()}onblur(_){this.hasFocus=!1;for(let u=0;u<128;u++)this.actionKey[u]=0;if(N0.enabled)N0.focusLost()}ontouchstart(_){if(!this.isMobile)return;if(this.input!==null)this.input.parentNode?.removeChild(this.input),this.input=null;this.touching=!0;let u=_.changedTouches[0],R=u.clientX|0,b=u.clientY|0;this.onmousemove(new MouseEvent("mousemove",{clientX:R,clientY:b})),this.sx=this.nx=this.mx=u.screenX|0,this.sy=this.ny=this.my=u.screenY|0,this.time=_.timeStamp,this.startedInViewport=this.insideViewportArea(),this.startedInTabArea=this.insideTabArea()}ontouchend(_){if(!this.isMobile||!this.touching)return;let u=_.changedTouches[0],R=u.clientX|0,b=u.clientY|0;if(this.onmousemove(new MouseEvent("mousemove",{clientX:R,clientY:b})),this.nx=u.screenX|0,this.ny=u.screenY|0,this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.startedInViewport&&!this.insideViewportArea()){this.touching=!1;return}else if(this.startedInTabArea&&!this.insideTabArea()){this.touching=!1;return}else if(this.insideMobileInputArea()){if(this.input!==null){if(this.input.parentNode?.contains(this.input))this.input.parentNode?.removeChild(this.input);this.input=null}let I=document.createElement("input");if(this.insideUsernameArea())I.setAttribute("id","username"),I.setAttribute("placeholder","Username");else if(this.inPasswordArea())I.setAttribute("id","password"),I.setAttribute("placeholder","Password");else if(this.insideChatInputArea())I.setAttribute("id","chatinput"),I.setAttribute("placeholder","Chatinput");else if(this.insideChatPopupArea())I.setAttribute("id","chatpopup"),I.setAttribute("placeholder","Chatpopup");else if(this.insideReportInterfaceTextArea())I.setAttribute("id","reportinput"),I.setAttribute("placeholder","Username");if(this.isAndroid)I.setAttribute("type","password");else I.setAttribute("type",this.inPasswordArea()?"password":"text");if(I.setAttribute("autofocus","autofocus"),I.setAttribute("spellcheck","false"),I.setAttribute("autocomplete","off"),I.setAttribute("style",`position: fixed; left: ${R}px; top: ${b}px; width: 1px; height: 1px; opacity: 0;`),document.body.appendChild(I),I.focus(),I.click(),this.isAndroid)I.oninput=(L)=>{if(!(L instanceof InputEvent))return;let H=L,G=H.data;if(G===null)return;if(H.inputType!=="insertText")return;this.onkeydown(new KeyboardEvent("keydown",{key:G,code:G}))};I.onkeydown=(L)=>{if(this.isAndroid){if(L.key==="Enter"||L.key==="Backspace")this.onkeydown(new KeyboardEvent("keydown",{key:L.key,code:L.key}));return}this.onkeydown(new KeyboardEvent("keydown",{key:L.key,code:L.key}))},I.onkeyup=(L)=>{if(this.isAndroid){if(L.key==="Enter"||L.key==="Backspace")this.onkeyup(new KeyboardEvent("keyup",{key:L.key,code:L.key}));return}this.onkeyup(new KeyboardEvent("keyup",{key:L.key,code:L.key}))},I.onfocus=(L)=>{this.input?.parentNode?.removeChild(this.input),this.input=null,this.onfocus(L)},this.input=I,this.touching=!1;return}let E=_.timeStamp>=this.time+500,O=Math.abs(this.sx-this.nx)>16||Math.abs(this.sy-this.ny)>16;if(E&&!O)this.touching=!0,this.onmousedown(new MouseEvent("mousedown",{clientX:R,clientY:b,button:2})),this.onmouseup(new MouseEvent("mouseup",{clientX:R,clientY:b,button:2}))}ontouchmove(_){if(!this.isMobile||!this.touching)return;if(_.touches.length>1)return;_.preventDefault();let u=_.changedTouches[0],R=u.clientX|0,b=u.clientY|0;if(this.onmousemove(new MouseEvent("mousemove",{clientX:R,clientY:b})),this.nx=u.screenX|0,this.ny=u.screenY|0,this.startedInViewport&&this.getViewportInterfaceId()===-1){if(this.mx-this.nx>0)this.rotate(2);else if(this.mx-this.nx<0)this.rotate(0);if(this.my-this.ny>0)this.rotate(3);else if(this.my-this.ny<0)this.rotate(1)}else if(this.startedInTabArea||this.getViewportInterfaceId()!==-1)this.onmousedown(new MouseEvent("mousedown",{clientX:R,clientY:b,button:1}));this.mx=this.nx,this.my=this.ny}get isMobile(){return["Android","webOS","iPhone","iPad","iPod","BlackBerry","Windows Phone"].some((u)=>navigator.userAgent.includes(u))}get isAndroid(){return["Android"].some((u)=>navigator.userAgent.includes(u))}get isCapacitor(){return["Capacitor"].some((u)=>navigator.userAgent.includes(u))}insideViewportArea(){return this.ingame&&this.mouseX>=8&&this.mouseX<=520&&this.mouseY>=11&&this.mouseY<=345}insideMobileInputArea(){return this.insideChatInputArea()||this.insideChatPopupArea()||this.insideUsernameArea()||this.inPasswordArea()||this.insideReportInterfaceTextArea()}insideChatInputArea(){return this.ingame&&this.getChatInterfaceId()===-1&&!this.isChatBackInputOpen()&&!this.isShowSocialInput()&&this.mouseX>=11&&this.mouseX<=506&&this.mouseY>=449&&this.mouseY<=482}insideChatPopupArea(){return this.ingame&&(this.isChatBackInputOpen()||this.isShowSocialInput())&&this.mouseX>=11&&this.mouseX<=506&&this.mouseY>=383&&this.mouseY<=482}insideReportInterfaceTextArea(){if(!this.ingame)return!1;let _=this.getViewportInterfaceId(),u=this.getReportAbuseInterfaceId();if(_===-1||u===-1)return!1;if(_!==u)return!1;let R=82,b=137,m=R+366,E=b+26;return this.mouseX>=R&&this.mouseX<=m&&this.mouseY>=b&&this.mouseY<=E}insideTabArea(){return this.ingame&&this.mouseX>=562&&this.mouseX<=752&&this.mouseY>=231&&this.mouseY<=492}insideUsernameArea(){return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=301&&this.mouseX<=562&&this.mouseY>=262&&this.mouseY<=279}inPasswordArea(){return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=301&&this.mouseX<=562&&this.mouseY>=279&&this.mouseY<=296}rotate(_){if(_===0)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowLeft",code:"ArrowLeft"}));else if(_===1)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowUp",code:"ArrowUp"}));else if(_===2)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowRight",code:"ArrowRight"}));else if(_===3)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowDown",code:"ArrowDown"}))}isFullScreen(){return document.fullscreenElement!==null}setMousePosition(_){let u=this.width,R=this.height,b=G0.getBoundingClientRect(),m={x:_.clientX-b.left,y:_.clientY-b.top};if(this.isFullScreen()){let E=u/R,I=window.innerWidth/window.innerHeight>=E,L=0,H=0,G=0,N=0;if(I)L=window.innerHeight*E,H=window.innerHeight,G=(window.innerWidth-L)/2;else L=window.innerWidth,H=window.innerWidth/E,N=(window.innerHeight-H)/2;let T=u/L,K=R/H;this.mouseX=(m.x-G)*T|0,this.mouseY=(m.y-N)*K|0}else{let E=G0.width/b.width,O=G0.height/b.height;this.mouseX=m.x*E|0,this.mouseY=m.y*O|0}if(this.mouseX<0)this.mouseX=0;if(this.mouseY<0)this.mouseY=0;if(this.mouseX>u)this.mouseX=u;if(this.mouseY>R)this.mouseY=R}}class U0{id;debugname=null;constructor(_){this.id=_}unpackType(_){while(!0){let u=_.g1();if(u===0)break;this.unpack(u,_)}return this}}class h0 extends U0{static count=0;static types=[];rgb=0;texture=-1;overlay=!1;occlude=!0;hue=0;saturation=0;lightness=0;luminance=0;chroma=0;hsl=0;static unpack(_){let u=new z(_.read("flo.dat"));this.count=u.g2(),this.types=new Array(this.count);for(let R=0;R<this.count;R++){if(!this.types[R])this.types[R]=new h0(R);this.types[R].unpackType(u)}}unpack(_,u){if(_===1)this.rgb=u.g3(),this.setColour(this.rgb);else if(_===2)this.texture=u.g1();else if(_===3)this.overlay=!0;else if(_===5)this.occlude=!1;else if(_===6)this.debugname=u.gjstr()}setColour(_){let u=(_>>16&255)/256,R=(_>>8&255)/256,b=(_&255)/256,m=u;if(R<u)m=R;if(b<m)m=b;let E=u;if(R>u)E=R;if(b>E)E=b;let O=0,I=0,L=(m+E)/2;if(m!==E){if(L<0.5)I=(E-m)/(E+m);if(L>=0.5)I=(E-m)/(2-E-m);if(u===E)O=(R-b)/(E-m);else if(R===E)O=(b-u)/(E-m)+2;else if(b===E)O=(u-R)/(E-m)+4}if(O/=6,this.hue=O*256|0,this.saturation=I*256|0,this.lightness=L*256|0,this.saturation<0)this.saturation=0;else if(this.saturation>255)this.saturation=255;if(this.lightness<0)this.lightness=0;else if(this.lightness>255)this.lightness=255;if(L>0.5)this.luminance=(1-L)*I*512|0;else this.luminance=L*I*512|0;if(this.luminance<1)this.luminance=1;this.chroma=O*this.luminance|0;let H=this.hue+(Math.random()*16|0)-8;if(H<0)H=0;else if(H>255)H=255;let G=this.saturation+(Math.random()*48|0)-24;if(G<0)G=0;else if(G>255)G=255;let N=this.lightness+(Math.random()*48|0)-24;if(N<0)N=0;else if(N>255)N=255;this.hsl=h0.hsl24to16(H,G,N)}static hsl24to16(_,u,R){if(R>179)u=u/2|0;if(R>192)u=u/2|0;if(R>217)u=u/2|0;if(R>243)u=u/2|0;return((_/4|0)<<10)+((u/32|0)<<7)+(R/2|0)}}class e0{length=0;types=null;labels=null;constructor(_){this.length=_.g1(),this.types=new Uint8Array(this.length),this.labels=new p(this.length,null);for(let u=0;u<this.length;u++)this.types[u]=_.g1();for(let u=0;u<this.length;u++){let R=_.g1();this.labels[u]=new Uint8Array(R);for(let b=0;b<R;b++)this.labels[u][b]=_.g1()}}}class w0{static instances=[];delay=-1;base=null;length=0;groups=null;x=null;y=null;z=null;static init(_){this.instances=new Array(_+1)}static unpack(_){let u=new z(_);u.pos=_.length-8;let R=u.g2(),b=u.g2(),m=u.g2(),E=u.g2(),O=0,I=new z(_);I.pos=O,O+=R+2;let L=new z(_);L.pos=O,O+=b;let H=new z(_);H.pos=O,O+=m;let G=new z(_);G.pos=O,O+=E;let N=new z(_);N.pos=O;let T=new e0(N),K=I.g2(),Q=new Int32Array(500),U=new Int32Array(500),J=new Int32Array(500),q=new Int32Array(500);for(let w=0;w<K;w++){let V=I.g2(),Y=this.instances[V]=new w0;Y.delay=G.g1(),Y.base=T;let n=I.g1(),f=-1,Z=0;for(let h=0;h<n;h++){if(!T.types)throw new Error;let D=L.g1();if(D>0){if(T.types[h]!==0){for(let W=h-1;W>f;W--)if(T.types[W]===0){Q[Z]=W,U[Z]=0,J[Z]=0,q[Z]=0,Z++;break}}Q[Z]=h;let j=0;if(T.types[Q[Z]]===3)j=128;if((D&1)===0)U[Z]=j;else U[Z]=H.gsmart();if((D&2)===0)J[Z]=j;else J[Z]=H.gsmart();if((D&4)===0)q[Z]=j;else q[Z]=H.gsmart();f=h,Z++}}Y.length=Z,Y.groups=new Int32Array(Z),Y.x=new Int32Array(Z),Y.y=new Int32Array(Z),Y.z=new Int32Array(Z);for(let h=0;h<Z;h++)Y.groups[h]=Q[h],Y.x[h]=U[h],Y.y[h]=J[h],Y.z[h]=q[h]}}static get(_){return w0.instances[_]}}class l extends U0{static count=0;static types=[];frameCount=0;frames=null;iframes=null;delay=null;replayoff=-1;walkmerge=null;stretches=!1;priority=5;righthand=-1;lefthand=-1;replaycount=99;preanim_move=-1;postanim_move=-1;restart_mode=-1;static unpack(_){let u=new z(_.read("seq.dat"));this.count=u.g2(),this.types=new Array(this.count);for(let R=0;R<this.count;R++){if(!this.types[R])this.types[R]=new l(R);let b=this.types[R].unpackType(u);if(b.preanim_move===-1)if(b.walkmerge===null)b.preanim_move=0;else b.preanim_move=2;if(b.postanim_move===-1)if(b.walkmerge===null)b.preanim_move=0;else b.postanim_move=2;if(b.frameCount===0)b.frameCount=1,b.frames=new Int16Array(1),b.frames[0]=-1,b.iframes=new Int16Array(1),b.iframes[0]=-1,b.delay=new Int16Array(1),b.delay[0]=-1}}getFrameDuration(_){if(!this.delay||!this.frames)return 0;let u=this.delay[_];if(u===0){let R=w0.get(this.frames[_]);if(R!=null)u=this.delay[_]=R.delay}if(u===0)u=1;return u}unpack(_,u){if(_===1){this.frameCount=u.g1(),this.frames=new Int16Array(this.frameCount),this.iframes=new Int16Array(this.frameCount),this.delay=new Int16Array(this.frameCount);for(let R=0;R<this.frameCount;R++){if(this.frames[R]=u.g2(),this.iframes[R]=u.g2(),this.iframes[R]===65535)this.iframes[R]=-1;this.delay[R]=u.g2()}}else if(_===2)this.replayoff=u.g2();else if(_===3){let R=u.g1();this.walkmerge=new Int32Array(R+1);for(let b=0;b<R;b++)this.walkmerge[b]=u.g1();this.walkmerge[R]=9999999}else if(_===4)this.stretches=!0;else if(_===5)this.priority=u.g1();else if(_===6)this.righthand=u.g2();else if(_===7)this.lefthand=u.g2();else if(_===8)this.replaycount=u.g1();else if(_===9)this.preanim_move=u.g1();else if(_===10)this.postanim_move=u.g1();else if(_===11)this.restart_mode=u.g1()}}class _1{bucketCount;buckets;constructor(_){this.buckets=new Array(_),this.bucketCount=_;for(let u=0;u<_;u++){let R=this.buckets[u]=new A0;R.next=R,R.prev=R}}get(_){let u=this.buckets[Number(_&BigInt(this.bucketCount-1))];for(let R=u.next;R!==u;R=R.next){if(!R)continue;if(R.key===_)return R}return null}put(_,u){if(u.prev)u.unlink();let R=this.buckets[Number(_&BigInt(this.bucketCount-1))];if(u.prev=R.prev,u.next=R,u.prev)u.prev.next=u;u.next.prev=u,u.key=_}}class s0{sentinel=new V0;cursor=null;constructor(){this.sentinel.next2=this.sentinel,this.sentinel.prev2=this.sentinel}push(_){if(_.prev2)_.unlink2();if(_.prev2=this.sentinel.prev2,_.next2=this.sentinel,_.prev2)_.prev2.next2=_;_.next2.prev2=_}pop(){let _=this.sentinel.next2;if(_===this.sentinel)return null;else return _?.unlink2(),_}head(){let _=this.sentinel.next2;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.next2||null,_}next(){let _=this.cursor;if(_===this.sentinel)return this.cursor=null,null;return this.cursor=_?.next2||null,_}size(){let _=0;for(let u=this.sentinel.next2;u!==this.sentinel&&u;u=u.next2)_++;return _}}class F0{capacity;hashtable=new _1(1024);cacheHistory=new s0;cacheAvailable;constructor(_){this.capacity=_,this.cacheAvailable=_}get(_){let u=this.hashtable.get(_);if(u)this.cacheHistory.push(u);return u}put(_,u){if(this.cacheAvailable===0){let R=this.cacheHistory.pop();R?.unlink(),R?.unlink2()}else this.cacheAvailable--;this.hashtable.put(_,u),this.cacheHistory.push(u)}clear(){while(!0){let _=this.cacheHistory.pop();if(!_){this.cacheAvailable=this.capacity;return}_.unlink(),_.unlink2()}}}class g{static WALL_STRAIGHT=new g(0,0);static WALL_DIAGONAL_CORNER=new g(1,0);static WALL_L=new g(2,0);static WALL_SQUARE_CORNER=new g(3,0);static WALLDECOR_STRAIGHT_NOOFFSET=new g(4,1);static WALLDECOR_STRAIGHT_OFFSET=new g(5,1);static WALLDECOR_DIAGONAL_OFFSET=new g(6,1);static WALLDECOR_DIAGONAL_NOOFFSET=new g(7,1);static WALLDECOR_DIAGONAL_BOTH=new g(8,1);static WALL_DIAGONAL=new g(9,2);static CENTREPIECE_STRAIGHT=new g(10,2);static CENTREPIECE_DIAGONAL=new g(11,2);static ROOF_STRAIGHT=new g(12,2);static ROOF_DIAGONAL_WITH_ROOFEDGE=new g(13,2);static ROOF_DIAGONAL=new g(14,2);static ROOF_L_CONCAVE=new g(15,2);static ROOF_L_CONVEX=new g(16,2);static ROOF_FLAT=new g(17,2);static ROOFEDGE_STRAIGHT=new g(18,2);static ROOFEDGE_DIAGONAL_CORNER=new g(19,2);static ROOFEDGE_L=new g(20,2);static ROOFEDGE_SQUARE_CORNER=new g(21,2);static GROUND_DECOR=new g(22,3);static values(){return[this.WALL_STRAIGHT,this.WALL_DIAGONAL_CORNER,this.ROOF_FLAT,this.ROOF_L_CONCAVE,this.WALL_L,this.ROOF_DIAGONAL,this.WALL_DIAGONAL,this.WALL_SQUARE_CORNER,this.GROUND_DECOR,this.ROOF_STRAIGHT,this.CENTREPIECE_DIAGONAL,this.WALLDECOR_DIAGONAL_OFFSET,this.ROOFEDGE_L,this.CENTREPIECE_STRAIGHT,this.WALLDECOR_STRAIGHT_OFFSET,this.ROOF_DIAGONAL_WITH_ROOFEDGE,this.WALLDECOR_DIAGONAL_NOOFFSET,this.WALLDECOR_STRAIGHT_NOOFFSET,this.ROOF_L_CONVEX,this.WALLDECOR_DIAGONAL_BOTH,this.ROOFEDGE_DIAGONAL_CORNER,this.ROOFEDGE_SQUARE_CORNER,this.ROOFEDGE_STRAIGHT]}static of(_){let u=this.values();for(let R=0;R<u.length;R++){let b=u[R];if(b.id===_)return b}throw Error("shape not found")}id;layer;constructor(_,u){this.id=_,this.layer=u}}class Y0 extends V0{vertexNormal=null;minY=1000;draw(_,u,R,b,m,E,O,I,L,H){let G=this.getModel(_);if(G)this.minY=G.minY,G.draw(0,u,R,b,m,E,O,I,L,H)}getModel(_){return null}}class v0{x=0;y=0;z=0;w=0}class k1{data=null;vertexCount=0;faceCount=0;texturedFaceCount=0;vertexFlagsOffset=-1;vertexXOffset=-1;vertexYOffset=-1;vertexZOffset=-1;vertexLabelsOffset=-1;faceVerticesOffset=-1;faceOrientationsOffset=-1;faceColoursOffset=-1;faceInfosOffset=-1;facePrioritiesOffset=0;faceAlphasOffset=-1;faceLabelsOffset=-1;faceTextureAxisOffset=-1}class $ extends Y0{static loaded=0;static empty=new $;static tmpVertexX=new Int32Array(2000);static tmpVertexY=new Int32Array(2000);static tmpVertexZ=new Int32Array(2000);static tmpFaceAlpha=new Int32Array(2000);maxDepth=0;minDepth=0;objRaise=0;vertexLabel=null;faceLabel=null;labelVertices=null;labelFaces=null;picking=!1;vertexNormalOriginal=null;static meta=null;static provider;static faceClippedX=new p(4096,!1);static faceNearClipped=new p(4096,!1);static vertexScreenX=new Int32Array(4096);static vertexScreenY=new Int32Array(4096);static vertexScreenZ=new Int32Array(4096);static vertexViewSpaceX=new Int32Array(4096);static vertexViewSpaceY=new Int32Array(4096);static vertexViewSpaceZ=new Int32Array(4096);static tmpDepthFaceCount=new Int32Array(1500);static tmpDepthFaces=new X0(1500,512);static tmpPriorityFaceCount=new Int32Array(12);static tmpPriorityFaces=new X0(12,2000);static tmpPriority10FaceDepth=new Int32Array(2000);static tmpPriority11FaceDepth=new Int32Array(2000);static tmpPriorityDepthSum=new Int32Array(12);vertexCount=0;faceCount=0;texturedFaceCount=0;vertexX=null;vertexY=null;vertexZ=null;faceVertexA=null;faceVertexB=null;faceVertexC=null;texturedVertexA=null;texturedVertexB=null;texturedVertexC=null;faceInfo=null;facePriority=null;priority=0;faceAlpha=null;faceColour=null;faceColourA=null;faceColourB=null;faceColourC=null;maxY=0;radius=0;minX=0;maxX=0;minZ=0;maxZ=0;static clippedX=new Int32Array(10);static clippedY=new Int32Array(10);static clippedColour=new Int32Array(10);static pickedBitsets=new Int32Array(1000);static baseX=0;static baseY=0;static baseZ=0;static mouseX=0;static mouseY=0;static pickedCount=0;static checkHover=!1;static init(_,u){$.meta=new Array(_),$.provider=u}static unpack(_,u){if(!$.meta)return;if(!u){let Q=$.meta[_]=new k1;Q.vertexCount=0,Q.faceCount=0,Q.texturedFaceCount=0;return}let R=new z(u);R.pos=u.length-18;let b=$.meta[_]=new k1;b.data=u,b.vertexCount=R.g2(),b.faceCount=R.g2(),b.texturedFaceCount=R.g1();let m=R.g1(),E=R.g1(),O=R.g1(),I=R.g1(),L=R.g1(),H=R.g2(),G=R.g2(),N=R.g2(),T=R.g2(),K=0;if(b.vertexFlagsOffset=K,K+=b.vertexCount,b.faceOrientationsOffset=K,K+=b.faceCount,b.facePrioritiesOffset=K,E==255)K+=b.faceCount;else b.facePrioritiesOffset=-E-1;if(b.faceLabelsOffset=K,I==1)K+=b.faceCount;else b.faceLabelsOffset=-1;if(b.faceInfosOffset=K,m==1)K+=b.faceCount;else b.faceInfosOffset=-1;if(b.vertexLabelsOffset=K,L==1)K+=b.vertexCount;else b.vertexLabelsOffset=-1;if(b.faceAlphasOffset=K,O==1)K+=b.faceCount;else b.faceAlphasOffset=-1;b.faceVerticesOffset=K,K+=T,b.faceColoursOffset=K,K+=b.faceCount*2,b.faceTextureAxisOffset=K,K+=b.texturedFaceCount*6,b.vertexXOffset=K,K+=H,b.vertexYOffset=K,K+=G,b.vertexZOffset=K,K+=N}static unload(_){if($.meta)$.meta[_]=null}static tryGet(_){if(!$.meta)return null;if(!$.meta[_])return $.provider.requestModel(_),null;return $.fromId(_)}static isReady(_){if(!$.meta)return!1;if(!$.meta[_])return $.provider.requestModel(_),!1;return!0}constructor(_){super();if(_)this.vertexCount=_.vertexCount,this.vertexX=_.vertexX,this.vertexY=_.vertexY,this.vertexZ=_.vertexZ,this.faceCount=_.faceCount,this.faceVertexA=_.faceVertexA,this.faceVertexB=_.faceVertexB,this.faceVertexC=_.faceVertexC,this.faceColourA=_.faceColorA,this.faceColourB=_.faceColorB,this.faceColourC=_.faceColorC,this.faceInfo=_.faceInfo,this.facePriority=_.facePriority,this.faceAlpha=_.faceAlpha,this.faceColour=_.faceColor,this.priority=_.priorityVal,this.texturedFaceCount=_.texturedFaceCount,this.texturedVertexA=_.texturedVertexA,this.texturedVertexB=_.texturedVertexB,this.texturedVertexC=_.texturedVertexC,this.minX=_.minX??0,this.maxX=_.maxX??0,this.minZ=_.minZ??0,this.maxZ=_.maxZ??0,this.radius=_.radius??0,this.maxY=_.minY??0,this.minY=_.maxY??0,this.maxDepth=_.maxDepth??0,this.minDepth=_.minDepth??0,this.vertexLabel=_.vertexLabel??null,this.faceLabel=_.faceLabel??null,this.labelVertices=_.labelVertices??null,this.labelFaces=_.labelFaces??null,this.vertexNormal=_.vertexNormal??null,this.vertexNormalOriginal=_.vertexNormalOriginal??null}static fromId(_){if(!$.meta||!$.meta[_])return new $;$.loaded++;let u=$.meta[_],R=new $;if(R.vertexCount=u.vertexCount,R.faceCount=u.faceCount,R.texturedFaceCount=u.texturedFaceCount,R.vertexX=new Int32Array(R.vertexCount),R.vertexY=new Int32Array(R.vertexCount),R.vertexZ=new Int32Array(R.vertexCount),R.faceVertexA=new Int32Array(R.faceCount),R.faceVertexB=new Int32Array(R.faceCount),R.faceVertexC=new Int32Array(R.faceCount),R.texturedVertexA=new Int32Array(R.texturedFaceCount),R.texturedVertexB=new Int32Array(R.texturedFaceCount),R.texturedVertexC=new Int32Array(R.texturedFaceCount),u.vertexLabelsOffset>=0)R.vertexLabel=new Int32Array(R.vertexCount);if(u.faceInfosOffset>=0)R.faceInfo=new Int32Array(R.faceCount);if(u.facePrioritiesOffset>=0)R.facePriority=new Int32Array(R.faceCount);else R.priority=-u.facePrioritiesOffset-1;if(u.faceAlphasOffset>=0)R.faceAlpha=new Int32Array(R.faceCount);if(u.faceLabelsOffset>=0)R.faceLabel=new Int32Array(R.faceCount);R.faceColour=new Int32Array(R.faceCount);let b=new z(u.data);b.pos=u.vertexFlagsOffset;let m=new z(u.data);m.pos=u.vertexXOffset;let E=new z(u.data);E.pos=u.vertexYOffset;let O=new z(u.data);O.pos=u.vertexZOffset;let I=new z(u.data);I.pos=u.vertexLabelsOffset;let L=0,H=0,G=0;for(let Z=0;Z<R.vertexCount;Z++){let h=b.g1(),D=0;if((h&1)!=0)D=m.gsmart();let j=0;if((h&2)!=0)j=E.gsmart();let W=0;if((h&4)!=0)W=O.gsmart();if(R.vertexX[Z]=L+D,R.vertexY[Z]=H+j,R.vertexZ[Z]=G+W,L=R.vertexX[Z],H=R.vertexY[Z],G=R.vertexZ[Z],R.vertexLabel!=null)R.vertexLabel[Z]=I.g1()}let N=new z(u.data);N.pos=u.faceColoursOffset;let T=new z(u.data);T.pos=u.faceInfosOffset;let K=new z(u.data);K.pos=u.facePrioritiesOffset;let Q=new z(u.data);Q.pos=u.faceAlphasOffset;let U=new z(u.data);U.pos=u.faceLabelsOffset;for(let Z=0;Z<R.faceCount;Z++){if(R.faceColour[Z]=N.g2(),R.faceInfo!=null)R.faceInfo[Z]=T.g1();if(R.facePriority!=null)R.facePriority[Z]=K.g1();if(R.faceAlpha!=null)R.faceAlpha[Z]=Q.g1();if(R.faceLabel!=null)R.faceLabel[Z]=U.g1()}let J=new z(u.data);J.pos=u.faceVerticesOffset;let q=new z(u.data);q.pos=u.faceOrientationsOffset;let w=0,V=0,Y=0,n=0;for(let Z=0;Z<R.faceCount;Z++){let h=q.g1();if(h==1)w=J.gsmart()+n,V=J.gsmart()+w,Y=J.gsmart()+V,n=Y;else if(h==2)w=w,V=Y,Y=J.gsmart()+n,n=Y;else if(h==3)w=Y,V=V,Y=J.gsmart()+n,n=Y;else if(h==4){let D=w;w=V,V=D,Y=J.gsmart()+n,n=Y}R.faceVertexA[Z]=w,R.faceVertexB[Z]=V,R.faceVertexC[Z]=Y}let f=new z(u.data);f.pos=u.faceTextureAxisOffset;for(let Z=0;Z<R.texturedFaceCount;Z++)R.texturedVertexA[Z]=f.g2(),R.texturedVertexB[Z]=f.g2(),R.texturedVertexC[Z]=f.g2();return R}static modelCopyFaces(_,u,R){let{vertexCount:b,faceCount:m,texturedFaceCount:E}=_,O;if(u){O=new Int32Array(b);for(let K=0;K<b;K++)O[K]=_.vertexY[K]}else O=_.vertexY;let I,L,H,G,N=null,T=null;if(R){I=new Int32Array(m),L=new Int32Array(m),H=new Int32Array(m);for(let K=0;K<m;K++){if(_.faceColourA)I[K]=_.faceColourA[K];if(_.faceColourB)L[K]=_.faceColourB[K];if(_.faceColourC)H[K]=_.faceColourC[K]}if(G=new Int32Array(m),!_.faceInfo)for(let K=0;K<m;K++)G[K]=0;else for(let K=0;K<m;K++)G[K]=_.faceInfo[K];N=new p(b,null);for(let K=0;K<b;K++){let Q=N[K]=new v0;if(_.vertexNormal){let U=_.vertexNormal[K];if(U)Q.x=U.x,Q.y=U.y,Q.z=U.z,Q.w=U.w}}T=_.vertexNormalOriginal}else I=_.faceColourA,L=_.faceColourB,H=_.faceColourC,G=_.faceInfo;return new $({vertexCount:b,vertexX:_.vertexX,vertexY:O,vertexZ:_.vertexZ,faceCount:m,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:I,faceColorB:L,faceColorC:H,faceInfo:G,facePriority:_.facePriority,faceAlpha:_.faceAlpha,faceColor:_.faceColour,priorityVal:_.priority,texturedFaceCount:E,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,minX:_.minX,maxX:_.maxX,minZ:_.minZ,maxZ:_.maxZ,radius:_.radius,minY:_.maxY,maxY:_.minY,maxDepth:_.maxDepth,minDepth:_.minDepth,vertexNormal:N,vertexNormalOriginal:T})}static modelShareColored(_,u,R,b){let{vertexCount:m,faceCount:E,texturedFaceCount:O}=_,I,L,H;if(b)I=_.vertexX,L=_.vertexY,H=_.vertexZ;else{I=new Int32Array(m),L=new Int32Array(m),H=new Int32Array(m);for(let T=0;T<m;T++)I[T]=_.vertexX[T],L[T]=_.vertexY[T],H[T]=_.vertexZ[T]}let G;if(u)G=_.faceColour;else{G=new Int32Array(E);for(let T=0;T<E;T++)if(_.faceColour)G[T]=_.faceColour[T]}let N;if(R)N=_.faceAlpha;else if(N=new Int32Array(E),!_.faceAlpha)for(let T=0;T<E;T++)N[T]=0;else for(let T=0;T<E;T++)N[T]=_.faceAlpha[T];return new $({vertexCount:m,vertexX:I,vertexY:L,vertexZ:H,faceCount:E,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:_.faceInfo,facePriority:_.facePriority,faceAlpha:N,faceColor:G,priorityVal:_.priority,texturedFaceCount:O,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,vertexLabel:_.vertexLabel,faceLabel:_.faceLabel})}static modelShareAlpha(_,u){let{vertexCount:R,faceCount:b,texturedFaceCount:m}=_,E=new Int32Array(R),O=new Int32Array(R),I=new Int32Array(R);for(let H=0;H<R;H++)E[H]=_.vertexX[H],O[H]=_.vertexY[H],I[H]=_.vertexZ[H];let L;if(u)L=_.faceAlpha;else if(L=new Int32Array(b),!_.faceAlpha)for(let H=0;H<b;H++)L[H]=0;else for(let H=0;H<b;H++)L[H]=_.faceAlpha[H];return new $({vertexCount:R,vertexX:E,vertexY:O,vertexZ:I,faceCount:b,faceVertexA:_.faceVertexA,faceVertexB:_.faceVertexB,faceVertexC:_.faceVertexC,faceColorA:_.faceColourA,faceColorB:_.faceColourB,faceColorC:_.faceColourC,faceInfo:_.faceInfo,facePriority:_.facePriority,faceAlpha:L,faceColor:_.faceColour,priorityVal:_.priority,texturedFaceCount:m,texturedVertexA:_.texturedVertexA,texturedVertexB:_.texturedVertexB,texturedVertexC:_.texturedVertexC,labelVertices:_.labelVertices,labelFaces:_.labelFaces})}static modelFromModelsBounds(_,u){let R=!1,b=!1,m=!1,E=!1,O=0,I=0,L=0,H=-1;for(let W=0;W<u;W++){let M=_[W];if(M){if(O+=M.vertexCount,I+=M.faceCount,L+=M.texturedFaceCount,R||=M.faceInfo!==null,!M.facePriority){if(H===-1)H=M.priority;if(H!==M.priority)b=!0}else b=!0;m||=M.faceAlpha!==null,E||=M.faceColour!==null}}let G=new Int32Array(O),N=new Int32Array(O),T=new Int32Array(O),K=new Int32Array(I),Q=new Int32Array(I),U=new Int32Array(I),J=new Int32Array(I),q=new Int32Array(I),w=new Int32Array(I),V=new Int32Array(L),Y=new Int32Array(L),n=new Int32Array(L),f=null;if(R)f=new Int32Array(I);let Z=null;if(b)Z=new Int32Array(I);let h=null;if(m)h=new Int32Array(I);let D=null;if(E)D=new Int32Array(I);O=0,I=0,L=0;for(let W=0;W<u;W++){let M=_[W];if(M){let X=O;for(let P=0;P<M.vertexCount;P++)G[O]=M.vertexX[P],N[O]=M.vertexY[P],T[O]=M.vertexZ[P],O++;for(let P=0;P<M.faceCount;P++){if(K[I]=M.faceVertexA[P]+X,Q[I]=M.faceVertexB[P]+X,U[I]=M.faceVertexC[P]+X,M.faceColourA)J[I]=M.faceColourA[P];if(M.faceColourB)q[I]=M.faceColourB[P];if(M.faceColourC)w[I]=M.faceColourC[P];if(R){if(!M.faceInfo){if(f)f[I]=0}else if(f)f[I]=M.faceInfo[P]}if(b){if(!M.facePriority){if(Z)Z[I]=M.priority}else if(Z)Z[I]=M.facePriority[P]}if(m){if(!M.faceAlpha){if(h)h[I]=0}else if(h)h[I]=M.faceAlpha[P]}if(E&&M.faceColour){if(D)D[I]=M.faceColour[P]}I++}for(let P=0;P<M.texturedFaceCount;P++)V[L]=M.texturedVertexA[P]+X,Y[L]=M.texturedVertexB[P]+X,n[L]=M.texturedVertexC[P]+X,L++}}let j=new $({vertexCount:O,vertexX:G,vertexY:N,vertexZ:T,faceCount:I,faceVertexA:K,faceVertexB:Q,faceVertexC:U,faceColorA:J,faceColorB:q,faceColorC:w,faceInfo:f,facePriority:Z,faceAlpha:h,faceColor:D,priorityVal:H,texturedFaceCount:L,texturedVertexA:V,texturedVertexB:Y,texturedVertexC:n});return j.calculateBoundsCylinder(),j}static modelFromModels(_,u){let R=!1,b=!1,m=!1,E=!1,O=0,I=0,L=0,H=-1;for(let D=0;D<u;D++){let j=_[D];if(j){if(O+=j.vertexCount,I+=j.faceCount,L+=j.texturedFaceCount,R||=j.faceInfo!==null,!j.facePriority){if(H===-1)H=j.priority;if(H!==j.priority)b=!0}else b=!0;m||=j.faceAlpha!==null,E||=j.faceLabel!==null}}let G=new Int32Array(O),N=new Int32Array(O),T=new Int32Array(O),K=new Int32Array(O),Q=new Int32Array(I),U=new Int32Array(I),J=new Int32Array(I),q=new Int32Array(L),w=new Int32Array(L),V=new Int32Array(L),Y=null;if(R)Y=new Int32Array(I);let n=null;if(b)n=new Int32Array(I);let f=null;if(m)f=new Int32Array(I);let Z=null;if(E)Z=new Int32Array(I);let h=new Int32Array(I);O=0,I=0,L=0;for(let D=0;D<u;D++){let j=_[D];if(j){for(let W=0;W<j.faceCount;W++){if(R){if(!j.faceInfo){if(Y)Y[I]=0}else if(Y)Y[I]=j.faceInfo[W]}if(b){if(!j.facePriority){if(n)n[I]=j.priority}else if(n)n[I]=j.facePriority[W]}if(m){if(!j.faceAlpha){if(f)f[I]=0}else if(f)f[I]=j.faceAlpha[W]}if(E&&j.faceLabel){if(Z)Z[I]=j.faceLabel[W]}if(j.faceColour)h[I]=j.faceColour[W];let M=$.addVertex(j,j.faceVertexA[W],G,N,T,K,O);O=M.vertexCount;let X=$.addVertex(j,j.faceVertexB[W],G,N,T,K,O);O=X.vertexCount;let P=$.addVertex(j,j.faceVertexC[W],G,N,T,K,O);O=P.vertexCount,Q[I]=M.vertex,U[I]=X.vertex,J[I]=P.vertex,I++}for(let W=0;W<j.texturedFaceCount;W++){let M=$.addVertex(j,j.texturedVertexA[W],G,N,T,K,O);O=M.vertexCount;let X=$.addVertex(j,j.texturedVertexB[W],G,N,T,K,O);O=X.vertexCount;let P=$.addVertex(j,j.texturedVertexC[W],G,N,T,K,O);O=P.vertexCount,q[L]=M.vertex,w[L]=X.vertex,V[L]=P.vertex,L++}}}return new $({vertexCount:O,vertexX:G,vertexY:N,vertexZ:T,faceCount:I,faceVertexA:Q,faceVertexB:U,faceVertexC:J,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:Y,facePriority:n,faceAlpha:f,faceColor:h,priorityVal:H,texturedFaceCount:L,texturedVertexA:q,texturedVertexB:w,texturedVertexC:V,vertexLabel:K,faceLabel:Z})}set(_,u){if($.tmpVertexX.length<this.vertexCount)$.tmpVertexX=new Int32Array(this.vertexCount+100),$.tmpVertexY=new Int32Array(this.vertexCount+100),$.tmpVertexZ=new Int32Array(this.vertexCount+100);this.vertexX=$.tmpVertexX,this.vertexY=$.tmpVertexY,this.vertexZ=$.tmpVertexZ;for(let R=0;R<this.vertexCount;R++)this.vertexX[R]=_.vertexX[R],this.vertexY[R]=_.vertexY[R],this.vertexZ[R]=_.vertexZ[R];if(u)this.faceAlpha=_.faceAlpha;else{if($.tmpFaceAlpha.length<this.faceCount)$.tmpFaceAlpha=new Int32Array(this.faceCount+100);if(this.faceAlpha=new Int32Array(this.faceCount),!_.faceAlpha)for(let R=0;R<this.faceCount;R++)this.faceAlpha[R]=0;else for(let R=0;R<this.faceCount;R++)this.faceAlpha[R]=_.faceAlpha[R]}this.faceInfo=_.faceInfo,this.faceColour=_.faceColour,this.facePriority=_.facePriority,this.priority=_.priority,this.labelFaces=_.labelFaces,this.labelVertices=_.labelVertices,this.faceVertexA=_.faceVertexA,this.faceVertexB=_.faceVertexB,this.faceVertexC=_.faceVertexC,this.faceColourA=_.faceColourA,this.faceColourB=_.faceColourB,this.faceColourC=_.faceColourC,this.texturedVertexA=_.texturedVertexA,this.texturedVertexB=_.texturedVertexB,this.texturedVertexC=_.texturedVertexC}static addVertex=(_,u,R,b,m,E,O)=>{let I=-1;if(_.vertexX&&_.vertexY&&_.vertexZ){let L=_.vertexX[u],H=_.vertexY[u],G=_.vertexZ[u];for(let N=0;N<O;N++)if(L===R[N]&&H===b[N]&&G===m[N]){I=N;break}if(I===-1){if(R[O]=L,b[O]=H,m[O]=G,E&&_.vertexLabel)E[O]=_.vertexLabel[u];I=O++}}return{vertex:I,vertexCount:O}};calculateBoundsCylinder(){this.minY=0,this.radius=0,this.maxY=0;for(let _=0;_<this.vertexCount;_++){let u=this.vertexX[_],R=this.vertexY[_],b=this.vertexZ[_];if(-R>this.minY)this.minY=-R;if(R>this.maxY)this.maxY=R;let m=u*u+b*b;if(m>this.radius)this.radius=m}this.radius=Math.sqrt(this.radius)+0.99|0,this.minDepth=Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0)}calculateBoundsY(){this.minY=0,this.maxY=0;for(let _=0;_<this.vertexCount;_++){let u=this.vertexY[_];if(-u>this.minY)this.minY=-u;if(u>this.maxY)this.maxY=u}this.minDepth=Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0)}calculateBoundsAABB(){this.minY=0,this.radius=0,this.maxY=0,this.minX=999999,this.maxX=-999999,this.maxZ=-99999,this.minZ=99999;for(let _=0;_<this.vertexCount;_++){let u=this.vertexX[_],R=this.vertexY[_],b=this.vertexZ[_];if(u<this.minX)this.minX=u;if(u>this.maxX)this.maxX=u;if(b<this.minZ)this.minZ=b;if(b>this.maxZ)this.maxZ=b;if(-R>this.minY)this.minY=-R;if(R>this.maxY)this.maxY=R;let m=u*u+b*b;if(m>this.radius)this.radius=m}this.radius=Math.sqrt(this.radius)|0,this.minDepth=Math.sqrt(this.radius*this.radius+this.minY*this.minY)|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)|0)}createLabelReferences(){if(this.vertexLabel){let _=new Int32Array(256),u=0;for(let b=0;b<this.vertexCount;b++){let m=this.vertexLabel[b];if(_[m]++,m>u)u=m}this.labelVertices=new p(u+1,null);for(let b=0;b<=u;b++)this.labelVertices[b]=new Int32Array(_[b]),_[b]=0;let R=0;while(R<this.vertexCount){let b=this.vertexLabel[R],m=this.labelVertices[b];if(!m)continue;m[_[b]++]=R++}this.vertexLabel=null}if(this.faceLabel){let _=new Int32Array(256),u=0;for(let b=0;b<this.faceCount;b++){let m=this.faceLabel[b];if(_[m]++,m>u)u=m}this.labelFaces=new p(u+1,null);for(let b=0;b<=u;b++)this.labelFaces[b]=new Int32Array(_[b]),_[b]=0;let R=0;while(R<this.faceCount){let b=this.faceLabel[R],m=this.labelFaces[b];if(!m)continue;m[_[b]++]=R++}this.faceLabel=null}}applyTransform(_){if(!this.labelVertices||_===-1)return;let u=w0.instances[_];if(!u)return;let R=u.base;$.baseX=0,$.baseY=0,$.baseZ=0;for(let b=0;b<u.length;b++){if(!u.groups||!u.x||!u.y||!u.z||!R||!R.labels||!R.types)continue;let m=u.groups[b];this.applyTransform2(u.x[b],u.y[b],u.z[b],R.labels[m],R.types[m])}}applyTransforms(_,u,R){if(_===-1)return;if(!R||u===-1)this.applyTransform(_);else{let b=w0.instances[_],m=w0.instances[u],E=b.base;$.baseX=0,$.baseY=0,$.baseZ=0;let O=0,I=R[O++];for(let L=0;L<b.length;L++){if(!b.groups)continue;let H=b.groups[L];while(H>I)I=R[O++];if(E&&E.types&&b.x&&b.y&&b.z&&E.labels&&(H!==I||E.types[H]===0))this.applyTransform2(b.x[L],b.y[L],b.z[L],E.labels[H],E.types[H])}$.baseX=0,$.baseY=0,$.baseZ=0,O=0,I=R[O++];for(let L=0;L<m.length;L++){if(!m.groups)continue;let H=m.groups[L];while(H>I)I=R[O++];if(E&&E.types&&m.x&&m.y&&m.z&&E.labels&&(H===I||E.types[H]===0))this.applyTransform2(m.x[L],m.y[L],m.z[L],E.labels[H],E.types[H])}}}applyTransform2(_,u,R,b,m){if(!b)return;let E=b.length;if(m===0){let O=0;$.baseX=0,$.baseY=0,$.baseZ=0;for(let I=0;I<E;I++){if(!this.labelVertices)continue;let L=b[I];if(L<this.labelVertices.length){let H=this.labelVertices[L];if(H)for(let G=0;G<H.length;G++){let N=H[G];$.baseX+=this.vertexX[N],$.baseY+=this.vertexY[N],$.baseZ+=this.vertexZ[N],O++}}}if(O>0)$.baseX=($.baseX/O|0)+_,$.baseY=($.baseY/O|0)+u,$.baseZ=($.baseZ/O|0)+R;else $.baseX=_,$.baseY=u,$.baseZ=R}else if(m===1)for(let O=0;O<E;O++){let I=b[O];if(!this.labelVertices||I>=this.labelVertices.length)continue;let L=this.labelVertices[I];if(L)for(let H=0;H<L.length;H++){let G=L[H];this.vertexX[G]+=_,this.vertexY[G]+=u,this.vertexZ[G]+=R}}else if(m===2)for(let O=0;O<E;O++){let I=b[O];if(!this.labelVertices||I>=this.labelVertices.length)continue;let L=this.labelVertices[I];if(L)for(let H=0;H<L.length;H++){let G=L[H];this.vertexX[G]-=$.baseX,this.vertexY[G]-=$.baseY,this.vertexZ[G]-=$.baseZ;let N=(_&255)*8,T=(u&255)*8,K=(R&255)*8,Q,U;if(K!==0){Q=A.sin[K],U=A.cos[K];let J=this.vertexY[G]*Q+this.vertexX[G]*U>>16;this.vertexY[G]=this.vertexY[G]*U-this.vertexX[G]*Q>>16,this.vertexX[G]=J}if(N!==0){Q=A.sin[N],U=A.cos[N];let J=this.vertexY[G]*U-this.vertexZ[G]*Q>>16;this.vertexZ[G]=this.vertexY[G]*Q+this.vertexZ[G]*U>>16,this.vertexY[G]=J}if(T!==0){Q=A.sin[T],U=A.cos[T];let J=this.vertexZ[G]*Q+this.vertexX[G]*U>>16;this.vertexZ[G]=this.vertexZ[G]*U-this.vertexX[G]*Q>>16,this.vertexX[G]=J}this.vertexX[G]+=$.baseX,this.vertexY[G]+=$.baseY,this.vertexZ[G]+=$.baseZ}}else if(m===3)for(let O=0;O<E;O++){let I=b[O];if(!this.labelVertices||I>=this.labelVertices.length)continue;let L=this.labelVertices[I];if(L)for(let H=0;H<L.length;H++){let G=L[H];this.vertexX[G]-=$.baseX,this.vertexY[G]-=$.baseY,this.vertexZ[G]-=$.baseZ,this.vertexX[G]=this.vertexX[G]*_/128|0,this.vertexY[G]=this.vertexY[G]*u/128|0,this.vertexZ[G]=this.vertexZ[G]*R/128|0,this.vertexX[G]+=$.baseX,this.vertexY[G]+=$.baseY,this.vertexZ[G]+=$.baseZ}}else if(m===5&&this.labelFaces&&this.faceAlpha)for(let O=0;O<E;O++){let I=b[O];if(I>=this.labelFaces.length)continue;let L=this.labelFaces[I];if(L)for(let H=0;H<L.length;H++){let G=L[H];if(this.faceAlpha[G]+=_*8,this.faceAlpha[G]<0)this.faceAlpha[G]=0;if(this.faceAlpha[G]>255)this.faceAlpha[G]=255}}}rotateY90(){for(let _=0;_<this.vertexCount;_++){let u=this.vertexX[_];this.vertexX[_]=this.vertexZ[_],this.vertexZ[_]=-u}}rotateX(_){let u=A.sin[_],R=A.cos[_];for(let b=0;b<this.vertexCount;b++){let m=this.vertexY[b]*R-this.vertexZ[b]*u>>16;this.vertexZ[b]=this.vertexY[b]*u+this.vertexZ[b]*R>>16,this.vertexY[b]=m}}translate(_,u,R){for(let b=0;b<this.vertexCount;b++)this.vertexX[b]+=u,this.vertexY[b]+=_,this.vertexZ[b]+=R}recolour(_,u){if(!this.faceColour)return;for(let R=0;R<this.faceCount;R++)if(this.faceColour[R]===_)this.faceColour[R]=u}rotateY180(){for(let _=0;_<this.vertexCount;_++)this.vertexZ[_]=-this.vertexZ[_];for(let _=0;_<this.faceCount;_++){let u=this.faceVertexA[_];this.faceVertexA[_]=this.faceVertexC[_],this.faceVertexC[_]=u}}scale(_,u,R){for(let b=0;b<this.vertexCount;b++)this.vertexX[b]=this.vertexX[b]*_/128|0,this.vertexY[b]=this.vertexY[b]*u/128|0,this.vertexZ[b]=this.vertexZ[b]*R/128|0}calculateNormals(_,u,R,b,m,E){let O=Math.sqrt(R*R+b*b+m*m)|0,I=u*O>>8;if(!this.faceColourA||!this.faceColourB||!this.faceColourC)this.faceColourA=new Int32Array(this.faceCount),this.faceColourB=new Int32Array(this.faceCount),this.faceColourC=new Int32Array(this.faceCount);if(!this.vertexNormal){this.vertexNormal=new p(this.vertexCount,null);for(let L=0;L<this.vertexCount;L++)this.vertexNormal[L]=new v0}for(let L=0;L<this.faceCount;L++){let H=this.faceVertexA[L],G=this.faceVertexB[L],N=this.faceVertexC[L],T=this.vertexX[G]-this.vertexX[H],K=this.vertexY[G]-this.vertexY[H],Q=this.vertexZ[G]-this.vertexZ[H],U=this.vertexX[N]-this.vertexX[H],J=this.vertexY[N]-this.vertexY[H],q=this.vertexZ[N]-this.vertexZ[H],w=K*q-J*Q,V=Q*U-q*T,Y=T*J-U*K;while(w>8192||V>8192||Y>8192||w<-8192||V<-8192||Y<-8192)w>>=1,V>>=1,Y>>=1;let n=Math.sqrt(w*w+V*V+Y*Y)|0;if(n<=0)n=1;if(w=w*256/n|0,V=V*256/n|0,Y=Y*256/n|0,!this.faceInfo||(this.faceInfo[L]&1)===0){let f=this.vertexNormal[H];if(f)f.x+=w,f.y+=V,f.z+=Y,f.w++;if(f=this.vertexNormal[G],f)f.x+=w,f.y+=V,f.z+=Y,f.w++;if(f=this.vertexNormal[N],f)f.x+=w,f.y+=V,f.z+=Y,f.w++}else{let f=_+((R*w+b*V+m*Y)/(I+(I/2|0))|0);if(this.faceColour)this.faceColourA[L]=$.mulColourLightness(this.faceColour[L],f,this.faceInfo[L])}}if(E)this.applyLighting(_,I,R,b,m);else{this.vertexNormalOriginal=new p(this.vertexCount,null);for(let L=0;L<this.vertexCount;L++){let H=this.vertexNormal[L],G=new v0;if(H)G.x=H.x,G.y=H.y,G.z=H.z,G.w=H.w;this.vertexNormalOriginal[L]=G}}if(E)this.calculateBoundsCylinder();else this.calculateBoundsAABB()}applyLighting(_,u,R,b,m){for(let E=0;E<this.faceCount;E++){let O=this.faceVertexA[E],I=this.faceVertexB[E],L=this.faceVertexC[E];if(!this.faceInfo&&this.faceColour&&this.vertexNormal&&this.faceColourA&&this.faceColourB&&this.faceColourC){let H=this.faceColour[E],G=this.vertexNormal[O];if(G)this.faceColourA[E]=$.mulColourLightness(H,_+((R*G.x+b*G.y+m*G.z)/(u*G.w)|0),0);let N=this.vertexNormal[I];if(N)this.faceColourB[E]=$.mulColourLightness(H,_+((R*N.x+b*N.y+m*N.z)/(u*N.w)|0),0);let T=this.vertexNormal[L];if(T)this.faceColourC[E]=$.mulColourLightness(H,_+((R*T.x+b*T.y+m*T.z)/(u*T.w)|0),0)}else if(this.faceInfo&&(this.faceInfo[E]&1)===0&&this.faceColour&&this.vertexNormal&&this.faceColourA&&this.faceColourB&&this.faceColourC){let H=this.faceColour[E],G=this.faceInfo[E],N=this.vertexNormal[O];if(N)this.faceColourA[E]=$.mulColourLightness(H,_+((R*N.x+b*N.y+m*N.z)/(u*N.w)|0),G);let T=this.vertexNormal[I];if(T)this.faceColourB[E]=$.mulColourLightness(H,_+((R*T.x+b*T.y+m*T.z)/(u*T.w)|0),G);let K=this.vertexNormal[L];if(K)this.faceColourC[E]=$.mulColourLightness(H,_+((R*K.x+b*K.y+m*K.z)/(u*K.w)|0),G)}}if(this.vertexNormal=null,this.vertexNormalOriginal=null,this.vertexLabel=null,this.faceLabel=null,this.faceInfo){for(let E=0;E<this.faceCount;E++)if((this.faceInfo[E]&2)===2)return}this.faceColour=null}static mulColourLightness(_,u,R){if((R&2)===2){if(u<0)u=0;else if(u>127)u=127;return 127-u}if(u=u*(_&127)>>7,u<2)u=2;else if(u>126)u=126;return(_&65408)+u}drawSimple(_,u,R,b,m,E,O){let I=A.sin[_],L=A.cos[_],H=A.sin[u],G=A.cos[u],N=A.sin[R],T=A.cos[R],K=A.sin[b],Q=A.cos[b],U=E*K+O*Q>>16;for(let J=0;J<this.vertexCount;J++){let q=this.vertexX[J],w=this.vertexY[J],V=this.vertexZ[J],Y;if(R!==0)Y=w*N+q*T>>16,w=w*T-q*N>>16,q=Y;if(_!==0)Y=w*L-V*I>>16,V=w*I+V*L>>16,w=Y;if(u!==0)Y=V*H+q*G>>16,V=V*G-q*H>>16,q=Y;if(q+=m,w+=E,V+=O,Y=w*Q-V*K>>16,V=w*K+V*Q>>16,w=Y,$.vertexScreenX&&$.vertexScreenY&&$.vertexScreenZ)$.vertexScreenZ[J]=V-U,$.vertexScreenX[J]=A.centerX+((q<<9)/V|0),$.vertexScreenY[J]=A.centerY+((w<<9)/V|0);if(this.texturedFaceCount>0&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ)$.vertexViewSpaceX[J]=q,$.vertexViewSpaceY[J]=w,$.vertexViewSpaceZ[J]=V}try{this.draw2(!1,!1,0)}catch(J){}}draw(_,u,R,b,m,E,O,I,L,H){let G=L*E-O*m>>16,N=I*R+G*b>>16,T=this.radius*b>>16,K=N+T;if(K<=50||N>=3500)return;let Q=L*m+O*E>>16,U=Q-this.radius<<9;if((U/K|0)>=F.centerX2d)return;let J=Q+this.radius<<9;if((J/K|0)<=-F.centerX2d)return;let q=I*b-G*R>>16,w=this.radius*R>>16,V=q+w<<9;if((V/K|0)<=-F.centerY2d)return;let Y=w+(this.minY*b>>16),n=q-Y<<9;if((n/K|0)>=F.centerY2d)return;let f=T+(this.minY*R>>16),Z=N-f<=50,h=!1;if(H>0&&$.checkHover){let X=N-T;if(X<=50)X=50;if(Q>0)U=U/K|0,J=J/X|0;else J=J/K|0,U=U/X|0;if(q>0)n=n/K|0,V=V/X|0;else V=V/K|0,n=n/X|0;let P=$.mouseX-A.centerX,r=$.mouseY-A.centerY;if(P>U&&P<J&&r>n&&r<V)if(this.picking)$.pickedBitsets[$.pickedCount++]=H;else h=!0}let D=A.centerX,j=A.centerY,W=0,M=0;if(u!==0)W=A.sin[u],M=A.cos[u];for(let X=0;X<this.vertexCount;X++){let P=this.vertexX[X],r=this.vertexY[X],B=this.vertexZ[X],t;if(u!==0)t=B*W+P*M>>16,B=B*M-P*W>>16,P=t;if(P+=O,r+=I,B+=L,t=B*m+P*E>>16,B=B*E-P*m>>16,P=t,t=r*b-B*R>>16,B=r*R+B*b>>16,r=t,$.vertexScreenZ)$.vertexScreenZ[X]=B-N;if(B>=50&&$.vertexScreenX&&$.vertexScreenY)$.vertexScreenX[X]=D+((P<<9)/B|0),$.vertexScreenY[X]=j+((r<<9)/B|0);else if($.vertexScreenX)$.vertexScreenX[X]=-5000,Z=!0;if((Z||this.texturedFaceCount>0)&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ)$.vertexViewSpaceX[X]=P,$.vertexViewSpaceY[X]=r,$.vertexViewSpaceZ[X]=B}try{this.draw2(Z,h,H)}catch(X){}}draw2(_,u,R,b=!1){for(let I=0;I<this.maxDepth;I++)if($.tmpDepthFaceCount)$.tmpDepthFaceCount[I]=0;for(let I=0;I<this.faceCount;I++){if(this.faceInfo&&this.faceInfo[I]===-1)continue;if($.vertexScreenX&&$.vertexScreenY&&$.vertexScreenZ&&$.tmpDepthFaces&&$.tmpDepthFaceCount){let L=this.faceVertexA[I],H=this.faceVertexB[I],G=this.faceVertexC[I],N=$.vertexScreenX[L],T=$.vertexScreenX[H],K=$.vertexScreenX[G],Q=$.vertexScreenY[L],U=$.vertexScreenY[H],J=$.vertexScreenY[G],q=$.vertexScreenZ[L],w=$.vertexScreenZ[H],V=$.vertexScreenZ[G];if(_&&(N===-5000||T===-5000||K===-5000)){if($.faceNearClipped)$.faceNearClipped[I]=!0;if($.tmpDepthFaces&&$.tmpDepthFaceCount){let Y=((q+w+V)/3|0)+this.minDepth;$.tmpDepthFaces[Y][$.tmpDepthFaceCount[Y]++]=I}}else{if(u&&this.pointWithinTriangle($.mouseX,$.mouseY,Q,U,J,N,T,K))$.pickedBitsets[$.pickedCount++]=R,u=!1;let Y=N-T,n=Q-U,f=K-T,Z=J-U;if(Y*Z-n*f<=0)continue;if($.faceNearClipped)$.faceNearClipped[I]=!1;if($.faceClippedX)$.faceClippedX[I]=N<0||T<0||K<0||N>F.boundX||T>F.boundX||K>F.boundX;if($.tmpDepthFaces&&$.tmpDepthFaceCount){let h=((q+w+V)/3|0)+this.minDepth;$.tmpDepthFaces[h][$.tmpDepthFaceCount[h]++]=I}}}}if(!this.facePriority&&$.tmpDepthFaceCount){for(let I=this.maxDepth-1;I>=0;I--){let L=$.tmpDepthFaceCount[I];if(L<=0)continue;if($.tmpDepthFaces){let H=$.tmpDepthFaces[I];for(let G=0;G<L;G++)try{this.drawFace(H[G],b)}catch(N){}}}return}for(let I=0;I<12;I++)if($.tmpPriorityFaceCount&&$.tmpPriorityDepthSum)$.tmpPriorityFaceCount[I]=0,$.tmpPriorityDepthSum[I]=0;if($.tmpDepthFaceCount)for(let I=this.maxDepth-1;I>=0;I--){let L=$.tmpDepthFaceCount[I];if(L>0&&$.tmpDepthFaces){let H=$.tmpDepthFaces[I];for(let G=0;G<L;G++)if(this.facePriority&&$.tmpPriorityFaceCount&&$.tmpPriorityFaces){let N=H[G],T=this.facePriority[N],K=$.tmpPriorityFaceCount[T]++;if($.tmpPriorityFaces[T][K]=N,T<10&&$.tmpPriorityDepthSum)$.tmpPriorityDepthSum[T]+=I;else if(T===10&&$.tmpPriority10FaceDepth)$.tmpPriority10FaceDepth[K]=I;else if($.tmpPriority11FaceDepth)$.tmpPriority11FaceDepth[K]=I}}}let m=0;if($.tmpPriorityFaceCount&&$.tmpPriorityDepthSum&&($.tmpPriorityFaceCount[1]>0||$.tmpPriorityFaceCount[2]>0))m=($.tmpPriorityDepthSum[1]+$.tmpPriorityDepthSum[2])/($.tmpPriorityFaceCount[1]+$.tmpPriorityFaceCount[2])|0;let E=0;if($.tmpPriorityFaceCount&&$.tmpPriorityDepthSum&&($.tmpPriorityFaceCount[3]>0||$.tmpPriorityFaceCount[4]>0))E=($.tmpPriorityDepthSum[3]+$.tmpPriorityDepthSum[4])/($.tmpPriorityFaceCount[3]+$.tmpPriorityFaceCount[4])|0;let O=0;if($.tmpPriorityFaceCount&&$.tmpPriorityDepthSum&&($.tmpPriorityFaceCount[6]>0||$.tmpPriorityFaceCount[8]>0))O=($.tmpPriorityDepthSum[6]+$.tmpPriorityDepthSum[8])/($.tmpPriorityFaceCount[6]+$.tmpPriorityFaceCount[8])|0;if($.tmpPriorityFaceCount&&$.tmpPriorityFaces){let I=0,L=$.tmpPriorityFaceCount[10],H=$.tmpPriorityFaces[10],G=$.tmpPriority10FaceDepth;if(I===L)I=0,L=$.tmpPriorityFaceCount[11],H=$.tmpPriorityFaces[11],G=$.tmpPriority11FaceDepth;let N;if(I<L&&G)N=G[I];else N=-1000;for(let T=0;T<10;T++){while(T===0&&N>m)try{if(this.drawFace(H[I++],b),I===L&&H!==$.tmpPriorityFaces[11])I=0,L=$.tmpPriorityFaceCount[11],H=$.tmpPriorityFaces[11],G=$.tmpPriority11FaceDepth;if(I<L&&G)N=G[I];else N=-1000}catch(U){}while(T===3&&N>E)try{if(this.drawFace(H[I++],b),I===L&&H!==$.tmpPriorityFaces[11])I=0,L=$.tmpPriorityFaceCount[11],H=$.tmpPriorityFaces[11],G=$.tmpPriority11FaceDepth;if(I<L&&G)N=G[I];else N=-1000}catch(U){}while(T===5&&N>O)try{if(this.drawFace(H[I++],b),I===L&&H!==$.tmpPriorityFaces[11])I=0,L=$.tmpPriorityFaceCount[11],H=$.tmpPriorityFaces[11],G=$.tmpPriority11FaceDepth;if(I<L&&G)N=G[I];else N=-1000}catch(U){}let K=$.tmpPriorityFaceCount[T],Q=$.tmpPriorityFaces[T];for(let U=0;U<K;U++)try{this.drawFace(Q[U],b)}catch(J){}}while(N!==-1000)try{if(this.drawFace(H[I++],b),I===L&&H!==$.tmpPriorityFaces[11])I=0,H=$.tmpPriorityFaces[11],L=$.tmpPriorityFaceCount[11],G=$.tmpPriority11FaceDepth;if(I<L&&G)N=G[I];else N=-1000}catch(T){}}}drawFace(_,u=!1){if($.faceNearClipped&&$.faceNearClipped[_]){this.drawNearClippedFace(_,u);return}let R=this.faceVertexA[_],b=this.faceVertexB[_],m=this.faceVertexC[_];if($.faceClippedX)A.clipX=$.faceClippedX[_];if(!this.faceAlpha)A.alpha=0;else A.alpha=this.faceAlpha[_];let E;if(!this.faceInfo)E=0;else E=this.faceInfo[_]&3;if(u&&$.vertexScreenX&&$.vertexScreenY&&this.faceColourA&&this.faceColourB&&this.faceColourC)A.drawLine($.vertexScreenX[R],$.vertexScreenY[R],$.vertexScreenX[b],$.vertexScreenY[b],A.hslPal[this.faceColourA[_]]),A.drawLine($.vertexScreenX[b],$.vertexScreenY[b],$.vertexScreenX[m],$.vertexScreenY[m],A.hslPal[this.faceColourB[_]]),A.drawLine($.vertexScreenX[m],$.vertexScreenY[m],$.vertexScreenX[R],$.vertexScreenY[R],A.hslPal[this.faceColourC[_]]);else if(E===0&&this.faceColourA&&this.faceColourB&&this.faceColourC&&$.vertexScreenX&&$.vertexScreenY)A.fillGouraudTriangle($.vertexScreenX[R],$.vertexScreenX[b],$.vertexScreenX[m],$.vertexScreenY[R],$.vertexScreenY[b],$.vertexScreenY[m],this.faceColourA[_],this.faceColourB[_],this.faceColourC[_]);else if(E===1&&this.faceColourA&&$.vertexScreenX&&$.vertexScreenY)A.fillTriangle($.vertexScreenX[R],$.vertexScreenX[b],$.vertexScreenX[m],$.vertexScreenY[R],$.vertexScreenY[b],$.vertexScreenY[m],A.hslPal[this.faceColourA[_]]);else if(E===2&&this.faceInfo&&this.faceColour&&this.faceColourA&&this.faceColourB&&this.faceColourC&&$.vertexScreenX&&$.vertexScreenY&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ){let O=this.faceInfo[_]>>2,I=this.texturedVertexA[O],L=this.texturedVertexB[O],H=this.texturedVertexC[O];A.fillTexturedTriangle($.vertexScreenX[R],$.vertexScreenX[b],$.vertexScreenX[m],$.vertexScreenY[R],$.vertexScreenY[b],$.vertexScreenY[m],this.faceColourA[_],this.faceColourB[_],this.faceColourC[_],$.vertexViewSpaceX[I],$.vertexViewSpaceY[I],$.vertexViewSpaceZ[I],$.vertexViewSpaceX[L],$.vertexViewSpaceX[H],$.vertexViewSpaceY[L],$.vertexViewSpaceY[H],$.vertexViewSpaceZ[L],$.vertexViewSpaceZ[H],this.faceColour[_])}else if(E===3&&this.faceInfo&&this.faceColour&&this.faceColourA&&$.vertexScreenX&&$.vertexScreenY&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ){let O=this.faceInfo[_]>>2,I=this.texturedVertexA[O],L=this.texturedVertexB[O],H=this.texturedVertexC[O];A.fillTexturedTriangle($.vertexScreenX[R],$.vertexScreenX[b],$.vertexScreenX[m],$.vertexScreenY[R],$.vertexScreenY[b],$.vertexScreenY[m],this.faceColourA[_],this.faceColourA[_],this.faceColourA[_],$.vertexViewSpaceX[I],$.vertexViewSpaceY[I],$.vertexViewSpaceZ[I],$.vertexViewSpaceX[L],$.vertexViewSpaceX[H],$.vertexViewSpaceY[L],$.vertexViewSpaceY[H],$.vertexViewSpaceZ[L],$.vertexViewSpaceZ[H],this.faceColour[_])}}drawNearClippedFace(_,u=!1){let R=0;if($.vertexViewSpaceZ){let H=A.centerX,G=A.centerY,N=this.faceVertexA[_],T=this.faceVertexB[_],K=this.faceVertexC[_],Q=$.vertexViewSpaceZ[N],U=$.vertexViewSpaceZ[T],J=$.vertexViewSpaceZ[K];if(Q>=50&&$.vertexScreenX&&$.vertexScreenY&&this.faceColourA)$.clippedX[R]=$.vertexScreenX[N],$.clippedY[R]=$.vertexScreenY[N],$.clippedColour[R++]=this.faceColourA[_];else if($.vertexViewSpaceX&&$.vertexViewSpaceY&&this.faceColourA){let q=$.vertexViewSpaceX[N],w=$.vertexViewSpaceY[N],V=this.faceColourA[_];if(J>=50&&this.faceColourC){let Y=(50-Q)*A.reciprocal16[J-Q];$.clippedX[R]=H+((q+(($.vertexViewSpaceX[K]-q)*Y>>16)<<9)/50|0),$.clippedY[R]=G+((w+(($.vertexViewSpaceY[K]-w)*Y>>16)<<9)/50|0),$.clippedColour[R++]=V+((this.faceColourC[_]-V)*Y>>16)}if(U>=50&&this.faceColourB){let Y=(50-Q)*A.reciprocal16[U-Q];$.clippedX[R]=H+((q+(($.vertexViewSpaceX[T]-q)*Y>>16)<<9)/50|0),$.clippedY[R]=G+((w+(($.vertexViewSpaceY[T]-w)*Y>>16)<<9)/50|0),$.clippedColour[R++]=V+((this.faceColourB[_]-V)*Y>>16)}}if(U>=50&&$.vertexScreenX&&$.vertexScreenY&&this.faceColourB)$.clippedX[R]=$.vertexScreenX[T],$.clippedY[R]=$.vertexScreenY[T],$.clippedColour[R++]=this.faceColourB[_];else if($.vertexViewSpaceX&&$.vertexViewSpaceY&&this.faceColourB){let q=$.vertexViewSpaceX[T],w=$.vertexViewSpaceY[T],V=this.faceColourB[_];if(Q>=50&&this.faceColourA){let Y=(50-U)*A.reciprocal16[Q-U];$.clippedX[R]=H+((q+(($.vertexViewSpaceX[N]-q)*Y>>16)<<9)/50|0),$.clippedY[R]=G+((w+(($.vertexViewSpaceY[N]-w)*Y>>16)<<9)/50|0),$.clippedColour[R++]=V+((this.faceColourA[_]-V)*Y>>16)}if(J>=50&&this.faceColourC){let Y=(50-U)*A.reciprocal16[J-U];$.clippedX[R]=H+((q+(($.vertexViewSpaceX[K]-q)*Y>>16)<<9)/50|0),$.clippedY[R]=G+((w+(($.vertexViewSpaceY[K]-w)*Y>>16)<<9)/50|0),$.clippedColour[R++]=V+((this.faceColourC[_]-V)*Y>>16)}}if(J>=50&&$.vertexScreenX&&$.vertexScreenY&&this.faceColourC)$.clippedX[R]=$.vertexScreenX[K],$.clippedY[R]=$.vertexScreenY[K],$.clippedColour[R++]=this.faceColourC[_];else if($.vertexViewSpaceX&&$.vertexViewSpaceY&&this.faceColourC){let q=$.vertexViewSpaceX[K],w=$.vertexViewSpaceY[K],V=this.faceColourC[_];if(U>=50&&this.faceColourB){let Y=(50-J)*A.reciprocal16[U-J];$.clippedX[R]=H+((q+(($.vertexViewSpaceX[T]-q)*Y>>16)<<9)/50|0),$.clippedY[R]=G+((w+(($.vertexViewSpaceY[T]-w)*Y>>16)<<9)/50|0),$.clippedColour[R++]=V+((this.faceColourB[_]-V)*Y>>16)}if(Q>=50&&this.faceColourA){let Y=(50-J)*A.reciprocal16[Q-J];$.clippedX[R]=H+((q+(($.vertexViewSpaceX[N]-q)*Y>>16)<<9)/50|0),$.clippedY[R]=G+((w+(($.vertexViewSpaceY[N]-w)*Y>>16)<<9)/50|0),$.clippedColour[R++]=V+((this.faceColourA[_]-V)*Y>>16)}}}let b=$.clippedX[0],m=$.clippedX[1],E=$.clippedX[2],O=$.clippedY[0],I=$.clippedY[1],L=$.clippedY[2];if((b-m)*(L-I)-(O-I)*(E-m)<=0)return;if(A.clipX=!1,R===3){if(b<0||m<0||E<0||b>F.boundX||m>F.boundX||E>F.boundX)A.clipX=!0;let H;if(!this.faceInfo)H=0;else H=this.faceInfo[_]&3;if(u)A.drawLine(b,m,O,I,$.clippedColour[0]),A.drawLine(m,E,I,L,$.clippedColour[1]),A.drawLine(E,b,L,O,$.clippedColour[2]);else if(H===0)A.fillGouraudTriangle(b,m,E,O,I,L,$.clippedColour[0],$.clippedColour[1],$.clippedColour[2]);else if(H===1&&this.faceColourA)A.fillTriangle(b,m,E,O,I,L,A.hslPal[this.faceColourA[_]]);else if(H===2&&this.faceInfo&&this.faceColour&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ){let G=this.faceInfo[_]>>2,N=this.texturedVertexA[G],T=this.texturedVertexB[G],K=this.texturedVertexC[G];A.fillTexturedTriangle(b,m,E,O,I,L,$.clippedColour[0],$.clippedColour[1],$.clippedColour[2],$.vertexViewSpaceX[N],$.vertexViewSpaceY[N],$.vertexViewSpaceZ[N],$.vertexViewSpaceX[T],$.vertexViewSpaceX[K],$.vertexViewSpaceY[T],$.vertexViewSpaceY[K],$.vertexViewSpaceZ[T],$.vertexViewSpaceZ[K],this.faceColour[_])}else if(H===3&&this.faceInfo&&this.faceColour&&this.faceColourA&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ){let G=this.faceInfo[_]>>2,N=this.texturedVertexA[G],T=this.texturedVertexB[G],K=this.texturedVertexC[G];A.fillTexturedTriangle(b,m,E,O,I,L,this.faceColourA[_],this.faceColourA[_],this.faceColourA[_],$.vertexViewSpaceX[N],$.vertexViewSpaceY[N],$.vertexViewSpaceZ[N],$.vertexViewSpaceX[T],$.vertexViewSpaceX[K],$.vertexViewSpaceY[T],$.vertexViewSpaceY[K],$.vertexViewSpaceZ[T],$.vertexViewSpaceZ[K],this.faceColour[_])}}else if(R===4){if(b<0||m<0||E<0||b>F.boundX||m>F.boundX||E>F.boundX||$.clippedX[3]<0||$.clippedX[3]>F.boundX)A.clipX=!0;let H;if(!this.faceInfo)H=0;else H=this.faceInfo[_]&3;if(u)A.drawLine(b,m,O,I,$.clippedColour[0]),A.drawLine(m,E,I,L,$.clippedColour[1]),A.drawLine(E,$.clippedX[3],L,$.clippedY[3],$.clippedColour[2]),A.drawLine($.clippedX[3],b,$.clippedY[3],O,$.clippedColour[3]);else if(H===0)A.fillGouraudTriangle(b,m,E,O,I,L,$.clippedColour[0],$.clippedColour[1],$.clippedColour[2]),A.fillGouraudTriangle(b,E,$.clippedX[3],O,L,$.clippedY[3],$.clippedColour[0],$.clippedColour[2],$.clippedColour[3]);else if(H===1){if(this.faceColourA){let G=A.hslPal[this.faceColourA[_]];A.fillTriangle(b,m,E,O,I,L,G),A.fillTriangle(b,E,$.clippedX[3],O,L,$.clippedY[3],G)}}else if(H===2&&this.faceInfo&&this.faceColour&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ){let G=this.faceInfo[_]>>2,N=this.texturedVertexA[G],T=this.texturedVertexB[G],K=this.texturedVertexC[G];A.fillTexturedTriangle(b,m,E,O,I,L,$.clippedColour[0],$.clippedColour[1],$.clippedColour[2],$.vertexViewSpaceX[N],$.vertexViewSpaceY[N],$.vertexViewSpaceZ[N],$.vertexViewSpaceX[T],$.vertexViewSpaceX[K],$.vertexViewSpaceY[T],$.vertexViewSpaceY[K],$.vertexViewSpaceZ[T],$.vertexViewSpaceZ[K],this.faceColour[_]),A.fillTexturedTriangle(b,E,$.clippedX[3],O,L,$.clippedY[3],$.clippedColour[0],$.clippedColour[2],$.clippedColour[3],$.vertexViewSpaceX[N],$.vertexViewSpaceY[N],$.vertexViewSpaceZ[N],$.vertexViewSpaceX[T],$.vertexViewSpaceX[K],$.vertexViewSpaceY[T],$.vertexViewSpaceY[K],$.vertexViewSpaceZ[T],$.vertexViewSpaceZ[K],this.faceColour[_])}else if(H===3&&this.faceInfo&&this.faceColour&&this.faceColourA&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ){let G=this.faceInfo[_]>>2,N=this.texturedVertexA[G],T=this.texturedVertexB[G],K=this.texturedVertexC[G];A.fillTexturedTriangle(b,m,E,O,I,L,this.faceColourA[_],this.faceColourA[_],this.faceColourA[_],$.vertexViewSpaceX[N],$.vertexViewSpaceY[N],$.vertexViewSpaceZ[N],$.vertexViewSpaceX[T],$.vertexViewSpaceX[K],$.vertexViewSpaceY[T],$.vertexViewSpaceY[K],$.vertexViewSpaceZ[T],$.vertexViewSpaceZ[K],this.faceColour[_]),A.fillTexturedTriangle(b,E,$.clippedX[3],O,L,$.clippedY[3],this.faceColourA[_],this.faceColourA[_],this.faceColourA[_],$.vertexViewSpaceX[N],$.vertexViewSpaceY[N],$.vertexViewSpaceZ[N],$.vertexViewSpaceX[T],$.vertexViewSpaceX[K],$.vertexViewSpaceY[T],$.vertexViewSpaceY[K],$.vertexViewSpaceZ[T],$.vertexViewSpaceZ[K],this.faceColour[_])}}}pointWithinTriangle(_,u,R,b,m,E,O,I){if(u<R&&u<b&&u<m)return!1;else if(u>R&&u>b&&u>m)return!1;else if(_<E&&_<O&&_<I)return!1;else return _<=E||_<=O||_<=I}}class u0 extends U0{static ignoreCache=!1;static count=0;static idx=null;static data=null;static cache=null;static cachePos=0;models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=!0;blockrange=!0;active=!1;_active=-1;hillskew=!1;sharelight=!1;occlude=!1;static modelCacheStatic=new F0(500);static modelCacheDynamic=new F0(30);ambient=0;contrast=0;anim=-1;wallwidth=16;mapfunction=-1;mapscene=-1;resizex=128;resizey=128;resizez=128;offsetx=0;offsety=0;offsetz=0;forceapproach=0;animHasAlpha=!1;mirror=!1;shadow=!0;forcedecor=!1;op=null;static unpack(_){this.data=new z(_.read("loc.dat"));let u=new z(_.read("loc.idx"));this.count=u.g2(),this.idx=new Int32Array(this.count);let R=2;for(let b=0;b<this.count;b++)this.idx[b]=R,R+=u.g2();this.cache=new p(10,null);for(let b=0;b<10;b++)this.cache[b]=new u0(-1)}static get(_){if(!this.cache||!this.idx||!this.data)throw new Error;for(let R=0;R<10;R++){let b=this.cache[R];if(!b)continue;if(b.id===_)return b}this.cachePos=(this.cachePos+1)%10;let u=this.cache[this.cachePos];if(this.data.pos=this.idx[_],u.id=_,u.reset(),u.unpackType(this.data),!u.shapes)u.shapes=new Int32Array(1);if(u._active===-1&&u.shapes){if(u.active=u.shapes.length>0&&u.shapes[0]===g.CENTREPIECE_STRAIGHT.id,u.op)u.active=!0}return u}unpack(_,u){if(_===1){let R=u.g1();this.models=new Int32Array(R),this.shapes=new Int32Array(R);for(let b=0;b<R;b++)this.models[b]=u.g2(),this.shapes[b]=u.g1()}else if(_===2)this.name=u.gjstr();else if(_===3)this.desc=u.gjstr();else if(_===14)this.width=u.g1();else if(_===15)this.length=u.g1();else if(_===17)this.blockwalk=!1;else if(_===18)this.blockrange=!1;else if(_===19){if(this._active=u.g1(),this._active===1)this.active=!0}else if(_===21)this.hillskew=!0;else if(_===22)this.sharelight=!0;else if(_===23)this.occlude=!0;else if(_===24){if(this.anim=u.g2(),this.anim===65535)this.anim=-1}else if(_===25)this.animHasAlpha=!0;else if(_===28)this.wallwidth=u.g1();else if(_===29)this.ambient=u.g1b();else if(_===39)this.contrast=u.g1b();else if(_>=30&&_<39){if(!this.op)this.op=new p(5,null);if(this.op[_-30]=u.gjstr(),this.op[_-30]?.toLowerCase()==="hidden")this.op[_-30]=null}else if(_===40){let R=u.g1();this.recol_s=new Uint16Array(R),this.recol_d=new Uint16Array(R);for(let b=0;b<R;b++)this.recol_s[b]=u.g2(),this.recol_d[b]=u.g2()}else if(_===60)this.mapfunction=u.g2();else if(_===62)this.mirror=!0;else if(_===64)this.shadow=!1;else if(_===65)this.resizex=u.g2();else if(_===66)this.resizey=u.g2();else if(_===67)this.resizez=u.g2();else if(_===68)this.mapscene=u.g2();else if(_===69)this.forceapproach=u.g1();else if(_===70)this.offsetx=u.g2b();else if(_===71)this.offsety=u.g2b();else if(_===72)this.offsetz=u.g2b();else if(_===73)this.forcedecor=!0}shapeModelsAreReady(_){if(this.shapes===null)return!0;let u=-1;for(let b=0;b<this.shapes.length;b++)if(this.shapes[b]==_){u=b;break}if(u==-1)return!0;if(this.models==null)return!0;let R=this.models[u];return R==-1?!0:$.isReady(R&65535)}modelsAreReady(){let _=!0;if(this.models==null)return!0;for(let u=0;u<this.models.length;u++){let R=this.models[u];if(R!=-1)_&&=$.isReady(R&65535)}return _}prefetch(_){if(this.models==null)return;for(let u=0;u<this.models.length;u++){let R=this.models[u];if(R!=-1)_.prefetch(0,R&65535)}}getModel(_,u,R,b,m,E,O){if(!this.shapes)return null;let I=-1;for(let J=0;J<this.shapes.length;J++)if(this.shapes[J]===_){I=J;break}if(I===-1)return null;let L=(BigInt(O)+1n<<32n)+(BigInt(this.id)<<6n)+(BigInt(I)<<3n)+BigInt(u);if(u0.ignoreCache)L=0n;let H=u0.modelCacheDynamic?.get(L);if(H){if(u0.ignoreCache)return H;if(this.hillskew||this.sharelight)H=$.modelCopyFaces(H,this.hillskew,this.sharelight);if(this.hillskew){let J=(R+b+m+E)/4|0;for(let q=0;q<H.vertexCount;q++){let w=H.vertexX[q],V=H.vertexZ[q],Y=R+((b-R)*(w+64)/128|0),n=E+((m-E)*(w+64)/128|0),f=Y+((n-Y)*(V+64)/128|0);H.vertexY[q]+=f-J}H.calculateBoundsY()}return H}if(!this.models||I>=this.models.length)return null;let G=this.models[I];if(G===-1)return null;let N=this.mirror!==u>3;if(N)G+=65536;let T=u0.modelCacheStatic?.get(BigInt(G));if(!T){if(T=$.tryGet(G&65535),!T)return null;if(N)T.rotateY180();u0.modelCacheStatic?.put(BigInt(G),T)}let K=this.resizex!==128||this.resizey!==128||this.resizez!==128,Q=this.offsetx!==0||this.offsety!==0||this.offsetz!==0,U=$.modelShareColored(T,!this.recol_s,!this.animHasAlpha,u===0&&O===-1&&!K&&!Q);if(O!==-1)U.createLabelReferences(),U.applyTransform(O),U.labelFaces=null,U.labelVertices=null;while(u-- >0)U.rotateY90();if(this.recol_s&&this.recol_d)for(let J=0;J<this.recol_s.length;J++)U.recolour(this.recol_s[J],this.recol_d[J]);if(K)U.scale(this.resizex,this.resizey,this.resizez);if(Q)U.translate(this.offsety,this.offsetx,this.offsetz);if(U.calculateNormals((this.ambient&255)+64,(this.contrast&255)*5+768,-50,-10,-50,!this.sharelight),this.blockwalk)U.objRaise=U.minY;if(u0.modelCacheDynamic?.put(L,U),this.hillskew||this.sharelight)U=$.modelCopyFaces(U,this.hillskew,this.sharelight);if(this.hillskew){let J=(R+b+m+E)/4|0;for(let q=0;q<U.vertexCount;q++){let w=U.vertexX[q],V=U.vertexZ[q],Y=R+((b-R)*(w+64)/128|0),n=E+((m-E)*(w+64)/128|0),f=Y+((n-Y)*(V+64)/128|0);U.vertexY[q]+=f-J}U.calculateBoundsY()}return U}reset(){this.models=null,this.shapes=null,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.width=1,this.length=1,this.blockwalk=!0,this.blockrange=!0,this.active=!1,this._active=-1,this.hillskew=!1,this.sharelight=!1,this.occlude=!1,this.anim=-1,this.wallwidth=16,this.ambient=0,this.contrast=0,this.op=null,this.animHasAlpha=!1,this.mapfunction=-1,this.mapscene=-1,this.mirror=!1,this.shadow=!0,this.resizex=128,this.resizey=128,this.resizez=128,this.forceapproach=0,this.offsetx=0,this.offsety=0,this.offsetz=0,this.forcedecor=!1}}async function n1(_){if(_[0]!==255)_[0]=255;URL.revokeObjectURL(z0.src),z0.src=URL.createObjectURL(new Blob([_],{type:"image/jpeg"})),await new Promise((b)=>z0.onload=()=>b()),d0.clearRect(0,0,g0.width,g0.height);let u=z0.naturalWidth,R=z0.naturalHeight;return g0.width=u,g0.height=R,d0.drawImage(z0,0,0),d0.getImageData(0,0,u,R)}class R0 extends F{pixels;cropRight;cropBottom;cropLeft;cropTop;width;height;constructor(_,u){super();this.pixels=new Int32Array(_*u),this.cropRight=this.width=_,this.cropBottom=this.height=u,this.cropLeft=this.cropTop=0}static async fromJpeg(_,u){let R=_.read(u+".dat");if(!R)throw new Error;let b=await n1(R),m=new R0(b.width,b.height),E=new Uint32Array(b.data.buffer),O=m.pixels;for(let I=0;I<O.length;I++){let L=E[I];O[I]=(L>>24&255)<<24|(L&255)<<16|(L>>8&255)<<8|L>>16&255}return m}static fromArchive(_,u,R=0){let b=new z(_.read(u+".dat")),m=new z(_.read("index.dat"));m.pos=b.g2();let E=m.g2(),O=m.g2(),I=m.g1(),L=[],H=I-1;for(let J=0;J<H;J++)if(L[J+1]=m.g3(),L[J+1]===0)L[J+1]=1;for(let J=0;J<R;J++)m.pos+=2,b.pos+=m.g2()*m.g2(),m.pos+=1;if(b.pos>b.length||m.pos>m.length)throw new Error;let G=m.g1(),N=m.g1(),T=m.g2(),K=m.g2(),Q=new R0(T,K);Q.cropLeft=G,Q.cropTop=N,Q.width=E,Q.height=O;let U=m.g1();if(U===0){let J=Q.cropRight*Q.cropBottom;for(let q=0;q<J;q++)Q.pixels[q]=L[b.g1()]}else if(U===1){let J=Q.cropRight;for(let q=0;q<J;q++){let w=Q.cropBottom;for(let V=0;V<w;V++)Q.pixels[q+V*J]=L[b.g1()]}}return Q}bind(){F.bind(this.pixels,this.cropRight,this.cropBottom)}draw(_,u){_|=0,u|=0,_+=this.cropLeft,u+=this.cropTop;let R=_+u*F.width2d,b=0,m=this.cropBottom,E=this.cropRight,O=F.width2d-E,I=0;if(u<F.top){let L=F.top-u;m-=L,u=F.top,b+=L*E,R+=L*F.width2d}if(u+m>F.bottom)m-=u+m-F.bottom;if(_<F.left){let L=F.left-_;E-=L,_=F.left,b+=L,R+=L,I+=L,O+=L}if(_+E>F.right){let L=_+E-F.right;E-=L,I+=L,O+=L}if(E>0&&m>0)this.copyImageDraw(E,m,this.pixels,b,I,F.pixels,R,O)}drawAlpha(_,u,R){u|=0,R|=0,u+=this.cropLeft,R+=this.cropTop;let b=u+R*F.width2d,m=0,E=this.cropBottom,O=this.cropRight,I=F.width2d-O,L=0;if(R<F.top){let H=F.top-R;E-=H,R=F.top,m+=H*O,b+=H*F.width2d}if(R+E>F.bottom)E-=R+E-F.bottom;if(u<F.left){let H=F.left-u;O-=H,u=F.left,m+=H,b+=H,L+=H,I+=H}if(u+O>F.right){let H=u+O-F.right;O-=H,L+=H,I+=H}if(O>0&&E>0)this.copyPixelsAlpha(O,E,this.pixels,m,L,F.pixels,b,I,_)}blitOpaque(_,u){_|=0,u|=0,_+=this.cropLeft,u+=this.cropTop;let R=_+u*F.width2d,b=0,m=this.cropBottom,E=this.cropRight,O=F.width2d-E,I=0;if(u<F.top){let L=F.top-u;m-=L,u=F.top,b+=L*E,R+=L*F.width2d}if(u+m>F.bottom)m-=u+m-F.bottom;if(_<F.left){let L=F.left-_;E-=L,_=F.left,b+=L,R+=L,I+=L,O+=L}if(_+E>F.right){let L=_+E-F.right;E-=L,I+=L,O+=L}if(E>0&&m>0)this.copyImageBlitOpaque(E,m,this.pixels,b,I,F.pixels,R,O)}flipHorizontally(){let _=this.pixels,u=this.cropRight,R=this.cropBottom;for(let b=0;b<R;b++){let m=u/2|0;for(let E=0;E<m;E++){let O=E+b*u,I=u-E-1+b*u,L=_[O];_[O]=_[I],_[I]=L}}}flipVertically(){let _=this.pixels,u=this.cropRight,R=this.cropBottom;for(let b=0;b<(R/2|0);b++)for(let m=0;m<u;m++){let E=m+b*u,O=m+(R-b-1)*u,I=_[E];_[E]=_[O],_[O]=I}}translate2d(_,u,R){for(let b=0;b<this.pixels.length;b++){let m=this.pixels[b];if(m!==0){let E=m>>16&255;if(E+=_,E<1)E=1;else if(E>255)E=255;let O=m>>8&255;if(O+=u,O<1)O=1;else if(O>255)O=255;let I=m&255;if(I+=R,I<1)I=1;else if(I>255)I=255;this.pixels[b]=(E<<16)+(O<<8)+I}}}crop(){let _=new Int32Array(this.width*this.height);for(let u=0;u<this.cropBottom;u++)for(let R=0;R<this.cropRight;R++)_[(this.cropTop+u)*this.width+this.cropLeft+R]=this.pixels[this.cropRight*u+R];this.pixels=_,this.cropRight=this.width,this.cropBottom=this.height,this.cropLeft=0,this.cropTop=0}drawRotated(_,u,R,b,m,E,O,I){I|=0,_|=0,E|=0,O|=0;try{let L=-E/2|0,H=-O/2|0,G=Math.sin(u)*65536|0,N=Math.cos(u)*65536|0,T=G*R>>8,K=N*R>>8,Q=(b<<16)+(H*T+L*K),U=(m<<16)+(H*K-L*T),J=I+_*F.width2d;for(let q=0;q<O;q++){let w=J,V=Q,Y=U;for(let n=-E;n<0;n++){let f=this.pixels[(V>>16)+(Y>>16)*this.width];if(f==0)w++;else F.pixels[w++]=f;V+=K,Y-=T}Q+=T,U+=K,J+=F.width2d}}catch(L){}}drawRotatedMasked(_,u,R,b,m,E,O,I,L,H){_|=0,u|=0,R|=0,b|=0;try{let G=-R/2|0,N=-b/2|0,T=Math.sin(L/326.11)*65536|0,K=Math.cos(L/326.11)*65536|0,Q=T*H>>8,U=K*H>>8,J=(O<<16)+N*Q+G*U,q=(I<<16)+(N*U-G*Q),w=_+u*F.width2d;for(let V=0;V<b;V++){let Y=m[V],n=w+Y,f=J+U*Y,Z=q-Q*Y;for(let h=-E[V];h<0;h++)F.pixels[n++]=this.pixels[(f>>16)+(Z>>16)*this.cropRight],f+=U,Z-=Q;J+=Q,q+=U,w+=F.width2d}}catch(G){}}drawMasked(_,u,R){_|=0,u|=0,_+=this.cropLeft,u+=this.cropTop;let b=_+u*F.width2d,m=0,E=this.cropBottom,O=this.cropRight,I=F.width2d-O,L=0;if(u<F.top){let H=F.top-u;E-=H,u=F.top,m+=H*O,b+=H*F.width2d}if(u+E>F.bottom)E-=u+E-F.bottom;if(_<F.left){let H=F.left-_;O-=H,_=F.left,m+=H,b+=H,L+=H,I+=H}if(_+O>F.right){let H=_+O-F.right;O-=H,L+=H,I+=H}if(O>0&&E>0)this.copyPixelsMasked(O,E,this.pixels,L,m,F.pixels,b,I,R.pixels)}scale(_,u,R,b,m,E,O,I,L,H,G){try{let N=b;for(let T=-u;T<0;T++){let K=(m>>16)*L;for(let Q=-_;Q<0;Q++){let U=R[(b>>16)+K];if(U===0)I++;else E[I++]=U;b+=H}m+=G,b=N,I+=O}}catch(N){}}copyImageBlitOpaque(_,u,R,b,m,E,O,I){let L=-(_>>2);_=-(_&3);for(let H=-u;H<0;H++){for(let G=L;G<0;G++)E[O++]=R[b++],E[O++]=R[b++],E[O++]=R[b++],E[O++]=R[b++];for(let G=_;G<0;G++)E[O++]=R[b++];O+=I,b+=m}}copyPixelsAlpha(_,u,R,b,m,E,O,I,L){let H=256-L;for(let G=-u;G<0;G++){for(let N=-_;N<0;N++){let T=R[b++];if(T===0)O++;else{let K=E[O];E[O++]=((T&16711935)*L+(K&16711935)*H&4278255360)+((T&65280)*L+(K&65280)*H&16711680)>>8}}O+=I,b+=m}}copyImageDraw(_,u,R,b,m,E,O,I){let L=-(_>>2);_=-(_&3);for(let H=-u;H<0;H++){for(let G=L;G<0;G++){let N=R[b++];if(N===0)O++;else E[O++]=N;if(N=R[b++],N===0)O++;else E[O++]=N;if(N=R[b++],N===0)O++;else E[O++]=N;if(N=R[b++],N===0)O++;else E[O++]=N}for(let G=_;G<0;G++){let N=R[b++];if(N===0)O++;else E[O++]=N}O+=I,b+=m}}copyPixelsMasked(_,u,R,b,m,E,O,I,L){let H=-(_>>2);_=-(_&3);for(let G=-u;G<0;G++){for(let N=H;N<0;N++){let T=R[m++];if(T!==0&&L[O]===0)E[O++]=T;else O++;if(T=R[m++],T!==0&&L[O]===0)E[O++]=T;else O++;if(T=R[m++],T!==0&&L[O]===0)E[O++]=T;else O++;if(T=R[m++],T!==0&&L[O]===0)E[O++]=T;else O++}for(let N=_;N<0;N++){let T=R[m++];if(T!==0&&L[O]===0)E[O++]=T;else O++}O+=I,m+=b}}}class d extends U0{static count=0;static idx=null;static data=null;static cache=null;static cachePos=0;static membersWorld=!0;model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2000;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=!1;code10=-1;stackable=!1;cost=1;members=!1;static modelCache=new F0(50);static iconCache=new F0(200);manwearOffsetY=0;womanwearOffsetY=0;manwear=-1;manwear2=-1;womanwear=-1;womanwear2=-1;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;certlink=-1;certtemplate=-1;resizex=0;resizey=0;resizez=0;ambient=0;contrast=0;countobj=null;countco=null;op=null;iop=null;static unpack(_,u){this.membersWorld=u,this.data=new z(_.read("obj.dat"));let R=new z(_.read("obj.idx"));this.count=R.g2(),this.idx=new Int32Array(this.count);let b=2;for(let m=0;m<this.count;m++)this.idx[m]=b,b+=R.g2();this.cache=new p(10,null);for(let m=0;m<10;m++)this.cache[m]=new d(-1)}static get(_){if(!this.cache||!this.idx||!this.data)throw new Error;for(let R=0;R<10;R++){let b=this.cache[R];if(b&&b.id===_)return b}this.cachePos=(this.cachePos+1)%10;let u=this.cache[this.cachePos];if(this.data.pos=this.idx[_],u.id=_,u.reset(),u.unpackType(this.data),u.certtemplate!==-1)u.toCertificate();if(!this.membersWorld&&u.members)u.name="Members Object",u.desc="Login to a members' server to use this object.",u.op=null,u.iop=null;return u}reset(){this.model=0,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.zoom2d=2000,this.xan2d=0,this.yan2d=0,this.zan2d=0,this.xof2d=0,this.yof2d=0,this.code9=!1,this.code10=-1,this.stackable=!1,this.cost=1,this.members=!1,this.op=null,this.iop=null,this.manwear=-1,this.manwear2=-1,this.manwearOffsetY=0,this.womanwear=-1,this.womanwear2=-1,this.womanwearOffsetY=0,this.manwear3=-1,this.womanwear3=-1,this.manhead=-1,this.manhead2=-1,this.womanhead=-1,this.womanhead2=-1,this.countobj=null,this.countco=null,this.certlink=-1,this.certtemplate=-1,this.resizex=128,this.resizey=128,this.resizez=128,this.ambient=0,this.contrast=0}unpack(_,u){if(_===1)this.model=u.g2();else if(_===2)this.name=u.gjstr();else if(_===3)this.desc=u.gjstr();else if(_===4)this.zoom2d=u.g2();else if(_===5)this.xan2d=u.g2();else if(_===6)this.yan2d=u.g2();else if(_===7){if(this.xof2d=u.g2b(),this.xof2d>32767)this.xof2d-=65536}else if(_===8){if(this.yof2d=u.g2b(),this.yof2d>32767)this.yof2d-=65536}else if(_===9)this.code9=!0;else if(_===10)this.code10=u.g2();else if(_===11)this.stackable=!0;else if(_===12)this.cost=u.g4();else if(_===16)this.members=!0;else if(_===23)this.manwear=u.g2(),this.manwearOffsetY=u.g1b();else if(_===24)this.manwear2=u.g2();else if(_===25)this.womanwear=u.g2(),this.womanwearOffsetY=u.g1b();else if(_===26)this.womanwear2=u.g2();else if(_>=30&&_<35){if(!this.op)this.op=new p(5,null);if(this.op[_-30]=u.gjstr(),this.op[_-30]?.toLowerCase()==="hidden")this.op[_-30]=null}else if(_>=35&&_<40){if(!this.iop)this.iop=new p(5,null);this.iop[_-35]=u.gjstr()}else if(_===40){let R=u.g1();this.recol_s=new Uint16Array(R),this.recol_d=new Uint16Array(R);for(let b=0;b<R;b++)this.recol_s[b]=u.g2(),this.recol_d[b]=u.g2()}else if(_===78)this.manwear3=u.g2();else if(_===79)this.womanwear3=u.g2();else if(_===90)this.manhead=u.g2();else if(_===91)this.womanhead=u.g2();else if(_===92)this.manhead2=u.g2();else if(_===93)this.womanhead2=u.g2();else if(_===95)this.zan2d=u.g2();else if(_===97)this.certlink=u.g2();else if(_===98)this.certtemplate=u.g2();else if(_>=100&&_<110){if(!this.countobj||!this.countco)this.countobj=new Uint16Array(10),this.countco=new Uint16Array(10);this.countobj[_-100]=u.g2(),this.countco[_-100]=u.g2()}else if(_===110)this.resizex=u.g2();else if(_===111)this.resizey=u.g2();else if(_===112)this.resizez=u.g2();else if(_===113)this.ambient=u.g1b();else if(_===114)this.ambient=u.g1b()*5}toCertificate(){let _=d.get(this.certtemplate);this.model=_.model,this.zoom2d=_.zoom2d,this.xan2d=_.xan2d,this.yan2d=_.yan2d,this.zan2d=_.zan2d,this.xof2d=_.xof2d,this.yof2d=_.yof2d,this.recol_s=_.recol_s,this.recol_d=_.recol_d;let u=d.get(this.certlink);this.name=u.name,this.members=u.members,this.cost=u.cost;let R="a",b=(u.name||"").toLowerCase().charAt(0);if(b==="a"||b==="e"||b==="i"||b==="o"||b==="u")R="an";this.desc=`Swap this note at any bank for ${R} ${u.name}.`,this.stackable=!0}getModel(_){if(this.countobj&&this.countco&&_>1){let R=-1;for(let b=0;b<10;b++)if(_>=this.countco[b]&&this.countco[b]!==0)R=this.countobj[b];if(R!==-1)return d.get(R).getModel(1)}let u=null;if(d.modelCache){if(u=d.modelCache.get(BigInt(this.id)),u)return u}if(u=$.tryGet(this.model),!u)return null;if(this.resizex!==128||this.resizey!==128||this.resizez!==128)u.scale(this.resizex,this.resizey,this.resizez);if(this.recol_s&&this.recol_d)for(let R=0;R<this.recol_s.length;R++)u.recolour(this.recol_s[R],this.recol_d[R]);if(u.calculateNormals(this.ambient+64,this.contrast+768,-50,-10,-50,!0),u.picking=!0,d.modelCache)d.modelCache.put(BigInt(this.id),u);return u}getInvModel(_){if(this.countobj&&this.countco&&_>1){let R=-1;for(let b=0;b<10;b++)if(_>=this.countco[b]&&this.countco[b]!==0)R=this.countobj[b];if(R!==-1)return d.get(R).getInvModel(1)}let u=$.tryGet(this.model);if(!u)return null;if(this.recol_s&&this.recol_d)for(let R=0;R<this.recol_s.length;R++)u.recolour(this.recol_s[R],this.recol_d[R]);return u}static getIcon(_,u,R){if(d.iconCache&&R===0){let Y=d.iconCache.get(BigInt(_));if(Y&&Y.height!==u&&Y.height!==-1)Y.unlink(),Y=null;if(Y)return Y}let b=d.get(_);if(!b.countobj)u=-1;if(b.countobj&&b.countco&&u>1){let Y=-1;for(let n=0;n<10;n++)if(u>=b.countco[n]&&b.countco[n]!==0)Y=b.countobj[n];if(Y!==-1)b=d.get(Y)}let m=b.getModel(1);if(!m)return null;let E=null;if(b.certtemplate!==-1){if(E=this.getIcon(b.certlink,10,-1),!E)return null}let O=new R0(32,32),I=A.centerX,L=A.centerY,H=A.lineOffset,G=F.pixels,N=F.width2d,T=F.height2d,K=F.left,Q=F.right,U=F.top,J=F.bottom;A.jagged=!1,F.bind(O.pixels,32,32),F.fillRect2d(0,0,32,32,0),A.init2D();let q=b.zoom2d;if(R===-1)q=q*1.5|0;else if(R>0)q=q*1.04|0;let w=A.sin[b.xan2d]*q>>16,V=A.cos[b.xan2d]*q>>16;m.drawSimple(0,b.yan2d,b.zan2d,b.xan2d,b.xof2d,w+(m.minY/2|0)+b.yof2d,V+b.yof2d);for(let Y=31;Y>=0;Y--)for(let n=31;n>=0;n--){if(O.pixels[Y+n*32]!==0)continue;if(Y>0&&O.pixels[Y+n*32-1]>1)O.pixels[Y+n*32]=1;else if(n>0&&O.pixels[Y+(n-1)*32]>1)O.pixels[Y+n*32]=1;else if(Y<31&&O.pixels[Y+n*32+1]>1)O.pixels[Y+n*32]=1;else if(n<31&&O.pixels[Y+(n+1)*32]>1)O.pixels[Y+n*32]=1}if(R>0)for(let Y=31;Y>=0;Y--)for(let n=31;n>=0;n--){if(O.pixels[Y+n*32]!==0)continue;if(Y>0&&O.pixels[Y+n*32-1]===1)O.pixels[Y+n*32]=R;else if(n>0&&O.pixels[Y+(n-1)*32]===1)O.pixels[Y+n*32]=R;else if(Y<31&&O.pixels[Y+n*32+1]===1)O.pixels[Y+n*32]=R;else if(n<31&&O.pixels[Y+(n+1)*32]===1)O.pixels[Y+n*32]=R}else for(let Y=31;Y>=0;Y--)for(let n=31;n>=0;n--)if(O.pixels[Y+n*32]===0&&Y>0&&n>0&&O.pixels[Y+(n-1)*32-1]>0)O.pixels[Y+n*32]=3153952;if(E&&b.certtemplate!==-1){let{width:Y,height:n}=E;E.width=32,E.height=32,E.draw(0,0),E.width=Y,E.height=n}if(d.iconCache&&R===0)d.iconCache.put(BigInt(_),O);if(F.bind(G,N,T),F.setBounds(K,U,Q,J),A.centerX=I,A.centerY=L,A.lineOffset=H,A.jagged=!0,b.stackable)O.width=33;else O.width=32;return O.height=u,O}wornModelIsReady(_){let u=this.manwear,R=this.manwear2,b=this.manwear3;if(_==1)u=this.womanwear,R=this.womanwear2,b=this.womanwear3;if(u==-1)return!0;let m=!0;if(!$.isReady(u))m=!1;if(R!=-1&&!$.isReady(R))m=!1;if(b!=-1&&!$.isReady(b))m=!1;return m}getWornModel(_){let u=this.manwear;if(_===1)u=this.womanwear;if(u===-1)return null;let R=this.manwear2,b=this.manwear3;if(_===1)R=this.womanwear2,b=this.womanwear3;let m=$.tryGet(u);if(!m)return null;if(R!==-1){let E=$.tryGet(R);if(!E)return null;if(b===-1){let O=[m,E];m=$.modelFromModels(O,2)}else{let O=$.tryGet(b);if(!O)return null;let I=[m,E,O];m=$.modelFromModels(I,3)}}if(_===0&&this.manwearOffsetY!==0)m.translate(this.manwearOffsetY,0,0);else if(_===1&&this.womanwearOffsetY!==0)m.translate(this.womanwearOffsetY,0,0);if(this.recol_s&&this.recol_d)for(let E=0;E<this.recol_s.length;E++)m.recolour(this.recol_s[E],this.recol_d[E]);return m}headModelIsReady(_){let u=this.manhead,R=this.manhead2;if(_==1)u=this.womanhead,R=this.womanhead2;if(u==-1)return!0;let b=!0;if(!$.isReady(u))b=!1;if(R!=-1&&!$.isReady(R))b=!1;return b}getHeadModel(_){let u=this.manhead;if(_===1)u=this.womanhead;if(u===-1)return null;let R=this.manhead2;if(_===1)R=this.womanhead2;let b=$.tryGet(u);if(!b)return null;if(R!==-1){let m=$.tryGet(R);if(!m)return null;let E=[b,m];b=$.modelFromModels(E,2)}if(this.recol_s&&this.recol_d)for(let m=0;m<this.recol_s.length;m++)b.recolour(this.recol_s[m],this.recol_d[m]);return b}}class j0 extends U0{static count=0;static idx=null;static data=null;static cache=null;static cachePos=0;name=null;desc=null;size=1;models=null;heads=null;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;animHasAlpha=!1;recol_s=null;recol_d=null;op=null;resizex=-1;resizey=-1;resizez=-1;minimap=!0;vislevel=-1;resizeh=128;resizev=128;alwaysontop=!1;headicon=-1;static modelCache=new F0(30);ambient=0;contrast=0;static unpack(_){this.data=new z(_.read("npc.dat"));let u=new z(_.read("npc.idx"));this.count=u.g2(),this.idx=new Int32Array(this.count);let R=2;for(let b=0;b<this.count;b++)this.idx[b]=R,R+=u.g2();this.cache=new p(20,null);for(let b=0;b<20;b++)this.cache[b]=new j0(-1)}static get(_){if(!this.cache||!this.idx||!this.data)throw new Error;for(let R=0;R<20;R++){let b=this.cache[R];if(b&&b.id===_)return b}this.cachePos=(this.cachePos+1)%20;let u=this.cache[this.cachePos]=new j0(_);return this.data.pos=this.idx[_],u.unpackType(this.data),u}unpack(_,u){if(_===1){let R=u.g1();this.models=new Uint16Array(R);for(let b=0;b<R;b++)this.models[b]=u.g2()}else if(_===2)this.name=u.gjstr();else if(_===3)this.desc=u.gjstr();else if(_===12)this.size=u.g1b();else if(_===13)this.readyanim=u.g2();else if(_===14)this.walkanim=u.g2();else if(_===16)this.animHasAlpha=!0;else if(_===17)this.walkanim=u.g2(),this.walkanim_b=u.g2(),this.walkanim_r=u.g2(),this.walkanim_l=u.g2();else if(_>=30&&_<40){if(!this.op)this.op=new p(5,null);if(this.op[_-30]=u.gjstr(),this.op[_-30]?.toLowerCase()==="hidden")this.op[_-30]=null}else if(_===40){let R=u.g1();this.recol_s=new Uint16Array(R),this.recol_d=new Uint16Array(R);for(let b=0;b<R;b++)this.recol_s[b]=u.g2(),this.recol_d[b]=u.g2()}else if(_===60){let R=u.g1();this.heads=new Uint16Array(R);for(let b=0;b<R;b++)this.heads[b]=u.g2()}else if(_===90)this.resizex=u.g2();else if(_===91)this.resizey=u.g2();else if(_===92)this.resizez=u.g2();else if(_===93)this.minimap=!1;else if(_===95)this.vislevel=u.g2();else if(_===97)this.resizeh=u.g2();else if(_===98)this.resizev=u.g2();else if(_===99)this.alwaysontop=!0;else if(_===100)this.ambient=u.g1b();else if(_===101)this.contrast=u.g1b()*5;else if(_===102)this.headicon=u.g2()}getModel(_,u,R){let b=null;if(j0.modelCache){if(b=j0.modelCache.get(BigInt(this.id)),!b&&this.models){let E=!1;for(let I=0;I<this.models.length;I++)if(!$.isReady(this.models[I]))E=!0;if(E)return null;let O=new p(this.models.length,null);for(let I=0;I<this.models.length;I++)O[I]=$.tryGet(this.models[I]);if(O.length===1)b=O[0];else b=$.modelFromModels(O,O.length);if(b){if(this.recol_s&&this.recol_d)for(let I=0;I<this.recol_s.length;I++)b.recolour(this.recol_s[I],this.recol_d[I]);b.createLabelReferences(),b.calculateNormals(64,850,-30,-50,-30,!0),j0.modelCache.put(BigInt(this.id),b)}}}let m=null;if(b){if(m=$.modelShareAlpha(b,!this.animHasAlpha),_!==-1&&u!==-1)m.applyTransforms(_,u,R);else if(_!==-1)m.applyTransform(_);if(this.resizeh!==128||this.resizev!==128)m.scale(this.resizeh,this.resizev,this.resizeh);if(m.calculateBoundsCylinder(),m.labelFaces=null,m.labelVertices=null,this.size===1)m.picking=!0}return m}getHeadModel(){if(!this.heads)return null;let _=!1;for(let b=0;b<this.heads.length;b++)if(!$.isReady(this.heads[b]))_=!0;if(_)return null;let u=new p(this.heads.length,null);for(let b=0;b<this.heads.length;b++)u[b]=$.tryGet(this.heads[b]);let R;if(u.length===1)R=u[0];else R=$.modelFromModels(u,u.length);if(R&&this.recol_s&&this.recol_d)for(let b=0;b<this.recol_s.length;b++)R.recolour(this.recol_s[b],this.recol_d[b]);return R}}class J0 extends U0{static count=0;static types=[];type=-1;models=null;recol_s=new Int32Array(6);recol_d=new Int32Array(6);heads=new Int32Array(5).fill(-1);disable=!1;static unpack(_){let u=new z(_.read("idk.dat"));this.count=u.g2(),this.types=new Array(this.count);for(let R=0;R<this.count;R++){if(!this.types[R])this.types[R]=new J0(R);this.types[R].unpackType(u)}}unpack(_,u){if(_===1)this.type=u.g1();else if(_===2){let R=u.g1();this.models=new Int32Array(R);for(let b=0;b<R;b++)this.models[b]=u.g2()}else if(_===3)this.disable=!0;else if(_>=40&&_<50)this.recol_s[_-40]=u.g2();else if(_>=50&&_<60)this.recol_d[_-50]=u.g2();else if(_>=60&&_<70)this.heads[_-60]=u.g2()}modelIsReady(){if(!this.models)return!0;let _=!0;for(let u=0;u<this.models.length;u++)if(!$.isReady(this.models[u]))_=!1;return _}getModel(){if(!this.models)return null;let _=new p(this.models.length,null);for(let R=0;R<this.models.length;R++)_[R]=$.tryGet(this.models[R]);let u;if(_.length===1)u=_[0];else u=$.modelFromModels(_,_.length);for(let R=0;R<6&&this.recol_s[R]!==0;R++)u?.recolour(this.recol_s[R],this.recol_d[R]);return u}headModelIsReady(){let _=!0;for(let u=0;u<this.heads.length;u++)if(this.heads[u]!=-1&&!$.isReady(this.heads[u]))_=!1;return _}getHeadModel(){let _=0,u=new p(5,null);for(let b=0;b<5;b++)if(this.heads[b]!==-1)u[_++]=$.tryGet(this.heads[b]);let R=$.modelFromModels(u,_);for(let b=0;b<6&&this.recol_s[b]!==0;b++)R.recolour(this.recol_s[b],this.recol_d[b]);return R}}class q0 extends U0{static count=0;static types=[];model=0;anim=-1;seq=null;animHasAlpha=!1;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;angle=0;ambient=0;contrast=0;static modelCache=new F0(30);static unpack(_){let u=new z(_.read("spotanim.dat"));this.count=u.g2();for(let R=0;R<this.count;R++)this.types[R]=new q0(R).unpackType(u)}unpack(_,u){if(_===1)this.model=u.g2();else if(_===2){if(this.anim=u.g2(),l.types)this.seq=l.types[this.anim]}else if(_===3)this.animHasAlpha=!0;else if(_===4)this.resizeh=u.g2();else if(_===5)this.resizev=u.g2();else if(_===6)this.angle=u.g2();else if(_===7)this.ambient=u.g1();else if(_===8)this.contrast=u.g1();else if(_>=40&&_<50)this.recol_s[_-40]=u.g2();else if(_>=50&&_<60)this.recol_d[_-50]=u.g2()}getModel(){let _=null;if(q0.modelCache){if(_=q0.modelCache.get(BigInt(this.id)),_)return _}if(_=$.tryGet(this.model),!_)return null;for(let u=0;u<6;u++)if(this.recol_s[0]!==0)_.recolour(this.recol_s[u],this.recol_d[u]);if(q0.modelCache)q0.modelCache.put(BigInt(this.id),_);return _}}class B0 extends U0{static count=0;static types=[];static code3s=[];static code3Count=0;code1=0;code2=0;code3=!1;code4=!0;clientcode=0;code7=0;code6=!1;code8=!1;code11=!1;static unpack(_){let u=new z(_.read("varp.dat"));this.count=u.g2();for(let R=0;R<this.count;R++)this.types[R]=new B0(R).unpackType(u)}unpack(_,u){if(_===1)this.code1=u.g1();else if(_===2)this.code2=u.g1();else if(_===3)this.code3=!0,B0.code3s[B0.code3Count++]=this.id;else if(_===4)this.code4=!1;else if(_===5)this.clientcode=u.g2();else if(_===6)this.code6=!0;else if(_===7)this.code7=u.g4();else if(_===8)this.code8=!0,this.code11=!0;else if(_===10)this.debugname=u.gjstr();else if(_===11)this.code11=!0}}class c{static BASE37_LOOKUP=["_","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];static toBase37(_){_=_.trim();let u=0n;for(let R=0;R<_.length&&R<12;R++){let b=_.charCodeAt(R);if(u*=37n,b>=65&&b<=90)u+=BigInt(b+1-65);else if(b>=97&&b<=122)u+=BigInt(b+1-97);else if(b>=48&&b<=57)u+=BigInt(b+27-48)}return u}static fromBase37(_){if(_<0n||_>=6582952005840035281n)return"invalid_name";if(_%37n===0n)return"invalid_name";let u=0,R=Array(12);while(_!==0n){let b=_;_/=37n,R[11-u++]=this.BASE37_LOOKUP[Number(b-_*37n)]}return R.slice(12-u).join("")}static toSentenceCase(_){let u=[..._.toLowerCase()],R=!0;for(let b=0;b<u.length;b++){let m=u[b];if(R&&m>="a"&&m<="z")u[b]=m.toUpperCase(),R=!1;if(m==="."||m==="!")R=!0}return u.join("")}static toAsterisks(_){let u="";for(let R=0;R<_.length;R++)u=u+"*";return u}static formatIPv4(_){return(_>>24&255)+"."+(_>>16&255)+"."+(_>>8&255)+"."+(_&255)}static formatName(_){if(_.length===0)return _;let u=[..._];for(let R=0;R<u.length;R++)if(u[R]==="_"){if(u[R]=" ",R+1<u.length&&u[R+1]>="a"&&u[R+1]<="z")u[R+1]=String.fromCharCode(u[R+1].charCodeAt(0)+65-97)}if(u[0]>="a"&&u[0]<="z")u[0]=String.fromCharCode(u[0].charCodeAt(0)+65-97);return u.join("")}static hashCode(_){let u=_.toUpperCase(),R=0n;for(let b=0;b<u.length;b++)R=R*61n+BigInt(u.charCodeAt(b))-32n,R=R+(R>>56n)&0xffffffffffffffn;return R}}class s{static types=[];invSlotObjId=null;invSlotObjCount=null;seqFrame=0;seqCycle=0;id=-1;layer=-1;type=-1;buttonType=-1;clientCode=0;width=0;height=0;alpha=0;x=0;y=0;scripts=null;scriptComparator=null;scriptOperand=null;overlayer=-1;scroll=0;scrollPosition=0;hide=!1;children=null;activeModelType=0;activeModel=0;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;targetVerb=null;targetText=null;targetMask=-1;option=null;static modelCache=new F0(30);static imageCache=null;marginX=0;marginY=0;colour=0;activeColour=0;overColour=0;modelType=0;model=0;graphic=null;activeGraphic=null;font=null;text=null;activeText=null;draggable=!1;interactable=!1;usable=!1;fill=!1;center=!1;shadowed=!1;invSlotOffsetX=null;invSlotOffsetY=null;childX=null;childY=null;invSlotGraphic=null;iop=null;static unpack(_,u,R){this.imageCache=new F0(50000);let b=new z(_.read("data")),m=-1,E=b.g2();this.types=new Array(E);while(b.pos<b.length){let O=b.g2();if(O===65535)m=b.g2(),O=b.g2();let I=this.types[O]=new s;if(I.id=O,I.layer=m,I.type=b.g1(),I.buttonType=b.g1(),I.clientCode=b.g2(),I.width=b.g2(),I.height=b.g2(),I.alpha=b.g1(),I.overlayer=b.g1(),I.overlayer===0)I.overlayer=-1;else I.overlayer=(I.overlayer-1<<8)+b.g1();let L=b.g1();if(L>0){I.scriptComparator=new Uint8Array(L),I.scriptOperand=new Uint16Array(L);for(let G=0;G<L;G++)I.scriptComparator[G]=b.g1(),I.scriptOperand[G]=b.g2()}let H=b.g1();if(H>0){I.scripts=new p(H,null);for(let G=0;G<H;G++){let N=b.g2(),T=new Uint16Array(N);I.scripts[G]=T;for(let K=0;K<N;K++)T[K]=b.g2()}}if(I.type===0){I.scroll=b.g2(),I.hide=b.g1()===1;let G=b.g2();I.children=new Array(G),I.childX=new Array(G),I.childY=new Array(G);for(let N=0;N<G;N++)I.children[N]=b.g2(),I.childX[N]=b.g2b(),I.childY[N]=b.g2b()}if(I.type===1)b.pos+=3;if(I.type===2){I.invSlotObjId=new Int32Array(I.width*I.height),I.invSlotObjCount=new Int32Array(I.width*I.height),I.draggable=b.g1()===1,I.interactable=b.g1()===1,I.usable=b.g1()===1,I.marginX=b.g1(),I.marginY=b.g1(),I.invSlotOffsetX=new Int16Array(20),I.invSlotOffsetY=new Int16Array(20),I.invSlotGraphic=new p(20,null);for(let G=0;G<20;G++)if(b.g1()===1){I.invSlotOffsetX[G]=b.g2b(),I.invSlotOffsetY[G]=b.g2b();let N=b.gjstr();if(u&&N.length>0){let T=N.lastIndexOf(",");I.invSlotGraphic[G]=this.getImage(u,N.substring(0,T),parseInt(N.substring(T+1)))}}I.iop=new p(5,null);for(let G=0;G<5;G++)if(I.iop[G]=b.gjstr(),I.iop[G].length===0)I.iop[G]=null}if(I.type===3)I.fill=b.g1()===1;if(I.type===4||I.type===1){I.center=b.g1()===1;let G=b.g1();if(R)I.font=R[G];I.shadowed=b.g1()===1}if(I.type===4)I.text=b.gjstr(),I.activeText=b.gjstr();if(I.type===1||I.type===3||I.type===4)I.colour=b.g4();if(I.type===3||I.type===4)I.activeColour=b.g4(),I.overColour=b.g4();if(I.type===5){let G=b.gjstr();if(u&&G.length>0){let T=G.lastIndexOf(",");I.graphic=this.getImage(u,G.substring(0,T),parseInt(G.substring(T+1),10))}let N=b.gjstr();if(u&&N.length>0){let T=N.lastIndexOf(",");I.activeGraphic=this.getImage(u,N.substring(0,T),parseInt(N.substring(T+1),10))}}if(I.type===6){let G=b.g1();if(G!==0)I.modelType=1,I.model=(G-1<<8)+b.g1();let N=b.g1();if(N!==0)I.activeModelType=1,I.activeModel=(N-1<<8)+b.g1();if(I.anim=b.g1(),I.anim===0)I.anim=-1;else I.anim=(I.anim-1<<8)+b.g1();if(I.activeAnim=b.g1(),I.activeAnim===0)I.activeAnim=-1;else I.activeAnim=(I.activeAnim-1<<8)+b.g1();I.zoom=b.g2(),I.xan=b.g2(),I.yan=b.g2()}if(I.type===7){I.invSlotObjId=new Int32Array(I.width*I.height),I.invSlotObjCount=new Int32Array(I.width*I.height),I.center=b.g1()===1;let G=b.g1();if(R)I.font=R[G];I.shadowed=b.g1()===1,I.colour=b.g4(),I.marginX=b.g2b(),I.marginY=b.g2b(),I.interactable=b.g1()===1,I.iop=new p(5,null);for(let N=0;N<5;N++)if(I.iop[N]=b.gjstr(),I.iop[N].length===0)I.iop[N]=null}if(I.buttonType===2||I.type===2)I.targetVerb=b.gjstr(),I.targetText=b.gjstr(),I.targetMask=b.g2();if(I.buttonType===1||I.buttonType===4||I.buttonType===5||I.buttonType===6){if(I.option=b.gjstr(),I.option.length===0){if(I.buttonType===1)I.option="Ok";else if(I.buttonType===4)I.option="Select";else if(I.buttonType===5)I.option="Select";else if(I.buttonType===6)I.option="Continue"}}}this.imageCache=null}swapObj(_,u){if(!this.invSlotObjId||!this.invSlotObjCount)return;let R=this.invSlotObjId[_];this.invSlotObjId[_]=this.invSlotObjId[u],this.invSlotObjId[u]=R,R=this.invSlotObjCount[_],this.invSlotObjCount[_]=this.invSlotObjCount[u],this.invSlotObjCount[u]=R}getModel(_,u,R,b){let m=null;if(R)m=this.loadModel(this.activeModelType,this.activeModel,b);else m=this.loadModel(this.modelType,this.model,b);if(!m)return null;if(_===-1&&u===-1&&!m.faceColour)return m;let E=$.modelShareColored(m,!0,!0,!1);if(_!==-1||u!==-1)E.createLabelReferences();if(_!==-1)E.applyTransform(_);if(u!==-1)E.applyTransform(u);return E.calculateNormals(64,768,-50,-10,-50,!0),E}loadModel(_,u,R){let b=s.modelCache.get(BigInt((_<<16)+u));if(b)return b;if(_===1)b=$.tryGet(u);else if(_===2)b=j0.get(u).getHeadModel();else if(_===3){if(R)b=R.getHeadModel()}else if(_===4)b=d.get(u).getInvModel(50);else if(_===5)b=null;if(b)s.modelCache.put(BigInt((_<<16)+u),b);return b}static cacheModel(_,u,R){if(s.modelCache.clear(),_&&u!=4)s.modelCache.put(BigInt((u<<16)+R),_)}getAbsoluteX(){if(this.layer===this.id)return this.x;let _=s.types[this.layer];if(!_.children||!_.childX||!_.childY)return this.x;let u=_.children.indexOf(this.id);if(u===-1)return this.x;let R=_.childX[u];while(_.layer!==_.id){let b=s.types[_.layer];if(b.children&&b.childX&&b.childY){if(u=b.children.indexOf(_.id),u!==-1)R+=b.childX[u]}_=b}return R}static getImage(_,u,R){let b=c.hashCode(u)<<8n|BigInt(R);if(this.imageCache){let m=this.imageCache.get(b);if(m)return m}try{let m=R0.fromArchive(_,u,R);return this.imageCache?.put(b,m),m}catch(m){return null}}}class o{static index=(_,u)=>_*104+u;startX;startZ;sizeX;sizeZ;flags;constructor(){this.startX=0,this.startZ=0,this.sizeX=104,this.sizeZ=104,this.flags=new Int32Array(this.sizeX*this.sizeZ),this.reset()}reset(){for(let _=0;_<this.sizeX;_++)for(let u=0;u<this.sizeZ;u++){let R=o.index(_,u);if(_===0||u===0||_===this.sizeX-1||u===this.sizeZ-1)this.flags[R]=16777215;else this.flags[R]=0}}addFloor(_,u){this.flags[o.index(_-this.startX,u-this.startZ)]|=2097152}removeFloor(_,u){this.flags[o.index(_-this.startX,u-this.startZ)]&=~2097152}addLoc(_,u,R,b,m,E){let O=256;if(E)O|=131072;let I=_-this.startX,L=u-this.startZ;if(m===1||m===3){let H=R;R=b,b=H}for(let H=I;H<I+R;H++){if(!(H>=0&&H<this.sizeX))continue;for(let G=L;G<L+b;G++){if(!(G>=0&&G<this.sizeZ))continue;this.add(H,G,O)}}}removeLoc(_,u,R,b,m,E){let O=256;if(E)O|=131072;let I=_-this.startX,L=u-this.startZ;if(m===1||m===3){let H=R;R=b,b=H}for(let H=I;H<I+R;H++){if(!(H>=0&&H<this.sizeX))continue;for(let G=L;G<L+b;G++){if(!(G>=0&&G<this.sizeZ))continue;this.remove(H,G,O)}}}addWall(_,u,R,b,m){let E=_-this.startX,O=u-this.startZ,I=m?65536:128,L=m?4096:8,H=m?1024:2,G=m?16384:32,N=m?512:1,T=m?8192:16,K=m?2048:4,Q=m?32768:64;if(R===g.WALL_STRAIGHT.id){if(b===0)this.add(E,O,I),this.add(E-1,O,L);else if(b===1)this.add(E,O,H),this.add(E,O+1,G);else if(b===2)this.add(E,O,L),this.add(E+1,O,I);else if(b===3)this.add(E,O,G),this.add(E,O-1,H)}else if(R===g.WALL_DIAGONAL_CORNER.id||R===g.WALL_SQUARE_CORNER.id){if(b===0)this.add(E,O,N),this.add(E-1,O+1,T);else if(b===1)this.add(E,O,K),this.add(E+1,O+1,Q);else if(b===2)this.add(E,O,T),this.add(E+1,O-1,N);else if(b===3)this.add(E,O,Q),this.add(E-1,O-1,K)}else if(R===g.WALL_L.id){if(b===0)this.add(E,O,H|I),this.add(E-1,O,L),this.add(E,O+1,G);else if(b===1)this.add(E,O,H|L),this.add(E,O+1,G),this.add(E+1,O,I);else if(b===2)this.add(E,O,G|L),this.add(E+1,O,I),this.add(E,O-1,H);else if(b===3)this.add(E,O,G|I),this.add(E,O-1,H),this.add(E-1,O,L)}if(m)this.addWall(_,u,R,b,!1)}removeWall(_,u,R,b,m){let E=_-this.startX,O=u-this.startZ,I=m?65536:128,L=m?4096:8,H=m?1024:2,G=m?16384:32,N=m?512:1,T=m?8192:16,K=m?2048:4,Q=m?32768:64;if(R===g.WALL_STRAIGHT.id){if(b===0)this.remove(E,O,I),this.remove(E-1,O,L);else if(b===1)this.remove(E,O,H),this.remove(E,O+1,G);else if(b===2)this.remove(E,O,L),this.remove(E+1,O,I);else if(b===3)this.remove(E,O,G),this.remove(E,O-1,H)}else if(R===g.WALL_DIAGONAL_CORNER.id||R===g.WALL_SQUARE_CORNER.id){if(b===0)this.remove(E,O,N),this.remove(E-1,O+1,T);else if(b===1)this.remove(E,O,K),this.remove(E+1,O+1,Q);else if(b===2)this.remove(E,O,T),this.remove(E+1,O-1,N);else if(b===3)this.remove(E,O,Q),this.remove(E-1,O-1,K)}else if(R===g.WALL_L.id){if(b===0)this.remove(E,O,H|I),this.remove(E-1,O,L),this.remove(E,O+1,G);else if(b===1)this.remove(E,O,H|L),this.remove(E,O+1,G),this.remove(E+1,O,I);else if(b===2)this.remove(E,O,G|L),this.remove(E+1,O,I),this.remove(E,O-1,H);else if(b===3)this.remove(E,O,G|I),this.remove(E,O-1,H),this.remove(E-1,O,L)}if(m)this.removeWall(_,u,R,b,!1)}reachedWall(_,u,R,b,m,E){if(_===R&&u===b)return!0;let O=_-this.startX,I=u-this.startZ,L=R-this.startX,H=b-this.startZ,G=o.index(O,I);if(m===g.WALL_STRAIGHT.id){if(E===0){if(O===L-1&&I===H)return!0;else if(O===L&&I===H+1&&(this.flags[G]&2621728)===0)return!0;else if(O===L&&I===H-1&&(this.flags[G]&2621698)===0)return!0}else if(E===1){if(O===L&&I===H+1)return!0;else if(O===L-1&&I===H&&(this.flags[G]&2621704)===0)return!0;else if(O===L+1&&I===H&&(this.flags[G]&2621824)===0)return!0}else if(E===2){if(O===L+1&&I===H)return!0;else if(O===L&&I===H+1&&(this.flags[G]&2621728)===0)return!0;else if(O===L&&I===H-1&&(this.flags[G]&2621698)===0)return!0}else if(E===3){if(O===L&&I===H-1)return!0;else if(O===L-1&&I===H&&(this.flags[G]&2621704)===0)return!0;else if(O===L+1&&I===H&&(this.flags[G]&2621824)===0)return!0}}else if(m===g.WALL_L.id){if(E===0){if(O===L-1&&I===H)return!0;else if(O===L&&I===H+1)return!0;else if(O===L+1&&I===H&&(this.flags[G]&2621824)===0)return!0;else if(O===L&&I===H-1&&(this.flags[G]&2621698)===0)return!0}else if(E===1){if(O===L-1&&I===H&&(this.flags[G]&2621704)===0)return!0;else if(O===L&&I===H+1)return!0;else if(O===L+1&&I===H)return!0;else if(O===L&&I===H-1&&(this.flags[G]&2621698)===0)return!0}else if(E===2){if(O===L-1&&I===H&&(this.flags[G]&2621704)===0)return!0;else if(O===L&&I===H+1&&(this.flags[G]&2621728)===0)return!0;else if(O===L+1&&I===H)return!0;else if(O===L&&I===H-1)return!0}else if(E===3){if(O===L-1&&I===H)return!0;else if(O===L&&I===H+1&&(this.flags[G]&2621728)===0)return!0;else if(O===L+1&&I===H&&(this.flags[G]&2621824)===0)return!0;else if(O===L&&I===H-1)return!0}}else if(m===g.WALL_DIAGONAL.id){if(O===L&&I===H+1&&(this.flags[G]&32)===0)return!0;else if(O===L&&I===H-1&&(this.flags[G]&2)===0)return!0;else if(O===L-1&&I===H&&(this.flags[G]&8)===0)return!0;else if(O===L+1&&I===H&&(this.flags[G]&128)===0)return!0}return!1}reachedWallDecoration(_,u,R,b,m,E){if(_===R&&u===b)return!0;let O=_-this.startX,I=u-this.startZ,L=R-this.startX,H=b-this.startZ,G=o.index(O,I);if(m===g.WALLDECOR_DIAGONAL_OFFSET.id||m===g.WALLDECOR_DIAGONAL_NOOFFSET.id){if(m===g.WALLDECOR_DIAGONAL_NOOFFSET.id)E=E+2&3;if(E===0){if(O===L+1&&I===H&&(this.flags[G]&128)===0)return!0;else if(O===L&&I===H-1&&(this.flags[G]&2)===0)return!0}else if(E===1){if(O===L-1&&I===H&&(this.flags[G]&8)===0)return!0;else if(O===L&&I===H-1&&(this.flags[G]&2)===0)return!0}else if(E===2){if(O===L-1&&I===H&&(this.flags[G]&8)===0)return!0;else if(O===L&&I===H+1&&(this.flags[G]&32)===0)return!0}else if(E===3){if(O===L+1&&I===H&&(this.flags[G]&128)===0)return!0;else if(O===L&&I===H+1&&(this.flags[G]&32)===0)return!0}}else if(m===g.WALLDECOR_DIAGONAL_BOTH.id){if(O===L&&I===H+1&&(this.flags[G]&32)===0)return!0;else if(O===L&&I===H-1&&(this.flags[G]&2)===0)return!0;else if(O===L-1&&I===H&&(this.flags[G]&8)===0)return!0;else if(O===L+1&&I===H&&(this.flags[G]&128)===0)return!0}return!1}reachedLoc(_,u,R,b,m,E,O){let I=R+m-1,L=b+E-1,H=o.index(_-this.startX,u-this.startZ);if(_>=R&&_<=I&&u>=b&&u<=L)return!0;else if(_===R-1&&u>=b&&u<=L&&(this.flags[H]&8)===0&&(O&8)===0)return!0;else if(_===I+1&&u>=b&&u<=L&&(this.flags[H]&128)===0&&(O&2)===0)return!0;else if(u===b-1&&_>=R&&_<=I&&(this.flags[H]&2)===0&&(O&4)===0)return!0;else if(u===L+1&&_>=R&&_<=I&&(this.flags[H]&32)===0&&(O&1)===0)return!0;return!1}add(_,u,R){this.flags[o.index(_,u)]|=R}remove(_,u,R){this.flags[o.index(_,u)]&=16777215-R}}class R1{minTileX;maxTileX;minTileZ;maxTileZ;type;minX;maxX;minZ;maxZ;minY;maxY;mode=0;minDeltaX=0;maxDeltaX=0;minDeltaZ=0;maxDeltaZ=0;minDeltaY=0;maxDeltaY=0;constructor(_,u,R,b,m,E,O,I,L,H,G){this.minTileX=_,this.maxTileX=u,this.minTileZ=R,this.maxTileZ=b,this.type=m,this.minX=E,this.maxX=O,this.minZ=I,this.maxZ=L,this.minY=H,this.maxY=G}}class b1{y;x;z;model;typecode;info;constructor(_,u,R,b,m,E){this.y=_,this.x=u,this.z=R,this.model=b,this.typecode=m,this.info=E}}class m1{locLevel;y;x;z;model;yaw;minSceneTileX;maxSceneTileX;minSceneTileZ;maxSceneTileZ;typecode;info;distance=0;cycle=0;constructor(_,u,R,b,m,E,O,I,L,H,G,N){this.locLevel=_,this.y=u,this.x=R,this.z=b,this.model=m,this.yaw=E,this.minSceneTileX=O,this.maxSceneTileX=I,this.minSceneTileZ=L,this.maxSceneTileZ=H,this.typecode=G,this.info=N}}class E1{y;x;z;topObj;middleObj;bottomObj;typecode;offset;constructor(_,u,R,b,m,E,O,I){this.y=_,this.x=u,this.z=R,this.topObj=b,this.middleObj=m,this.bottomObj=E,this.typecode=O,this.offset=I}}class n0 extends A0{level;x;z;originalLevel;locs;primaryExtendDirections;quickGround=null;ground=null;wall=null;decor=null;groundDecor=null;groundObject=null;linkedSquare=null;primaryCount=0;combinedPrimaryExtendDirections=0;drawLevel=0;drawFront=!1;drawBack=!1;drawPrimaries=!1;cornerSides=0;sidesBeforeCorner=0;sidesAfterCorner=0;backWallTypes=0;constructor(_,u,R){super();this.originalLevel=this.level=_,this.x=u,this.z=R,this.locs=new p(5,null),this.primaryExtendDirections=new Int32Array(5)}}class C{static tmpScreenX=new Int32Array(6);static tmpScreenY=new Int32Array(6);static tmpViewspaceX=new Int32Array(6);static tmpViewspaceY=new Int32Array(6);static tmpViewspaceZ=new Int32Array(6);static SHAPE_POINTS=[Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,2,6),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,13,14)];static SHAPE_PATHS=[Int8Array.of(0,1,2,3,0,0,1,3),Int8Array.of(1,1,2,3,1,0,1,3),Int8Array.of(0,1,2,3,1,0,1,3),Int8Array.of(0,0,1,2,0,0,2,4,1,0,4,3),Int8Array.of(0,0,1,4,0,0,4,3,1,1,2,4),Int8Array.of(0,0,4,3,1,0,1,2,1,0,2,4),Int8Array.of(0,1,2,4,1,0,1,4,1,0,4,3),Int8Array.of(0,4,1,2,0,4,2,5,1,0,4,5,1,0,5,3),Int8Array.of(0,4,1,2,0,4,2,3,0,4,3,5,1,0,4,5),Int8Array.of(0,0,4,5,1,4,1,2,1,4,2,3,1,4,3,5),Int8Array.of(0,0,1,5,0,1,4,5,0,1,2,4,1,0,5,3,1,5,4,3,1,4,2,3),Int8Array.of(1,0,1,5,1,1,4,5,1,1,2,4,0,0,5,3,0,5,4,3,0,4,2,3),Int8Array.of(1,0,5,4,1,0,1,5,0,0,4,3,0,4,5,3,0,5,2,3,0,1,2,5)];static FULL_SQUARE=128;static HALF_SQUARE=this.FULL_SQUARE/2|0;static CORNER_SMALL=this.FULL_SQUARE/4|0;static CORNER_BIG=this.FULL_SQUARE*3/4|0;vertexX;vertexY;vertexZ;triangleColorA;triangleColorB;triangleColorC;triangleVertexA;triangleVertexB;triangleVertexC;triangleTextureIds;flat;shape;shapeAngle;backgroundRgb;foregroundRgb;constructor(_,u,R,b,m,E,O,I,L,H,G,N,T,K,Q,U,J,q,w){this.flat=!(J!==b||J!==K||J!==I),this.shape=u,this.shapeAngle=E,this.backgroundRgb=T,this.foregroundRgb=L;let V=C.SHAPE_POINTS[u],Y=V.length;this.vertexX=new Int32Array(Y),this.vertexY=new Int32Array(Y),this.vertexZ=new Int32Array(Y);let n=new Int32Array(Y),f=new Int32Array(Y),Z=_*C.FULL_SQUARE,h=q*C.FULL_SQUARE;for(let M=0;M<Y;M++){let X=V[M];if((X&1)===0&&X<=8)X=(X-E-E-1&7)+1;if(X>8&&X<=12)X=(X-E-9&3)+9;if(X>12&&X<=16)X=(X-E-13&3)+13;let P,r,B,t,a;if(X===1)P=Z,r=h,B=J,t=O,a=H;else if(X===2)P=Z+C.HALF_SQUARE,r=h,B=J+b>>1,t=O+w>>1,a=H+R>>1;else if(X===3)P=Z+C.FULL_SQUARE,r=h,B=b,t=w,a=R;else if(X===4)P=Z+C.FULL_SQUARE,r=h+C.HALF_SQUARE,B=b+K>>1,t=w+m>>1,a=R+Q>>1;else if(X===5)P=Z+C.FULL_SQUARE,r=h+C.FULL_SQUARE,B=K,t=m,a=Q;else if(X===6)P=Z+C.HALF_SQUARE,r=h+C.FULL_SQUARE,B=K+I>>1,t=m+U>>1,a=Q+N>>1;else if(X===7)P=Z,r=h+C.FULL_SQUARE,B=I,t=U,a=N;else if(X===8)P=Z,r=h+C.HALF_SQUARE,B=I+J>>1,t=U+O>>1,a=N+H>>1;else if(X===9)P=Z+C.HALF_SQUARE,r=h+C.CORNER_SMALL,B=J+b>>1,t=O+w>>1,a=H+R>>1;else if(X===10)P=Z+C.CORNER_BIG,r=h+C.HALF_SQUARE,B=b+K>>1,t=w+m>>1,a=R+Q>>1;else if(X===11)P=Z+C.HALF_SQUARE,r=h+C.CORNER_BIG,B=K+I>>1,t=m+U>>1,a=Q+N>>1;else if(X===12)P=Z+C.CORNER_SMALL,r=h+C.HALF_SQUARE,B=I+J>>1,t=U+O>>1,a=N+H>>1;else if(X===13)P=Z+C.CORNER_SMALL,r=h+C.CORNER_SMALL,B=J,t=O,a=H;else if(X===14)P=Z+C.CORNER_BIG,r=h+C.CORNER_SMALL,B=b,t=w,a=R;else if(X===15)P=Z+C.CORNER_BIG,r=h+C.CORNER_BIG,B=K,t=m,a=Q;else P=Z+C.CORNER_SMALL,r=h+C.CORNER_BIG,B=I,t=U,a=N;this.vertexX[M]=P,this.vertexY[M]=B,this.vertexZ[M]=r,n[M]=t,f[M]=a}let D=C.SHAPE_PATHS[u],j=D.length/4|0;if(this.triangleVertexA=new Int32Array(j),this.triangleVertexB=new Int32Array(j),this.triangleVertexC=new Int32Array(j),this.triangleColorA=new Int32Array(j),this.triangleColorB=new Int32Array(j),this.triangleColorC=new Int32Array(j),G!==-1)this.triangleTextureIds=new Int32Array(j);else this.triangleTextureIds=null;let W=0;for(let M=0;M<j;M++){let X=D[W],P=D[W+1],r=D[W+2],B=D[W+3];if(W+=4,P<4)P=P-E&3;if(r<4)r=r-E&3;if(B<4)B=B-E&3;if(this.triangleVertexA[M]=P,this.triangleVertexB[M]=r,this.triangleVertexC[M]=B,X===0){if(this.triangleColorA[M]=n[P],this.triangleColorB[M]=n[r],this.triangleColorC[M]=n[B],this.triangleTextureIds)this.triangleTextureIds[M]=-1}else if(this.triangleColorA[M]=f[P],this.triangleColorB[M]=f[r],this.triangleColorC[M]=f[B],this.triangleTextureIds)this.triangleTextureIds[M]=G}}}class a0{southwestColor;southeastColor;northeastColor;northwestColor;textureId;colour;flat;constructor(_,u,R,b,m,E,O){this.southwestColor=_,this.southeastColor=u,this.northeastColor=R,this.northwestColor=b,this.textureId=m,this.colour=E,this.flat=O}}class O1{y;x;z;angle1;angle2;model1;model2;typecode;typecode2;constructor(_,u,R,b,m,E,O,I,L){this.y=_,this.x=u,this.z=R,this.angle1=b,this.angle2=m,this.model1=E,this.model2=O,this.typecode=I,this.typecode2=L}}class I1{y;x;z;angle1;angle2;model;typecode;info;constructor(_,u,R,b,m,E,O,I){this.y=_,this.x=u,this.z=R,this.angle1=b,this.angle2=m,this.model=E,this.typecode=O,this.info=I}}class k{static visibilityMatrix=new l0(8,32,51,51,!1);static locBuffer=new p(100,null);static levelOccluderCount=new Int32Array(4);static levelOccluders=new U1(4,500,null);static activeOccluders=new p(500,null);static drawTileQueue=new $0;static cycle=0;static viewportLeft=0;static viewportTop=0;static viewportRight=0;static viewportBottom=0;static viewportCenterX=0;static viewportCenterY=0;static sinEyePitch=0;static cosEyePitch=0;static sinEyeYaw=0;static cosEyeYaw=0;static eyeX=0;static eyeY=0;static eyeZ=0;static eyeTileX=0;static eyeTileZ=0;static minDrawTileX=0;static maxDrawTileX=0;static minDrawTileZ=0;static maxDrawTileZ=0;static topLevel=0;static tilesRemaining=0;static takingInput=!1;static visibilityMap=null;static FRONT_WALL_TYPES=Uint8Array.of(19,55,38,155,255,110,137,205,76);static DIRECTION_ALLOW_WALL_CORNER_TYPE=Uint8Array.of(160,192,80,96,0,144,80,48,160);static BACK_WALL_TYPES=Uint8Array.of(76,8,137,4,0,1,38,2,19);static MIDDEP_16=Int8Array.of(0,0,2,0,0,2,1,1,0);static MIDDEP_32=Int8Array.of(2,0,0,2,0,0,0,4,4);static MIDDEP_64=Int8Array.of(0,4,4,8,0,0,8,0,0);static MIDDEP_128=Int8Array.of(1,1,0,0,0,8,0,0,8);static WALL_DECORATION_INSET_X=Int8Array.of(53,-53,-53,53);static WALL_DECORATION_INSET_Z=Int8Array.of(-53,-53,53,53);static WALL_DECORATION_OUTSET_X=Int8Array.of(-45,45,45,-45);static WALL_DECORATION_OUTSET_Z=Int8Array.of(45,45,-45,-45);static MINIMAP_TILE_MASK=[new Int8Array(16),Int8Array.of(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,0,0,0,1,1,0,0,1,1,1,0,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,1,1,0,0,1,1,0,0,0,1,0,0,0,1),Int8Array.of(0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0),Int8Array.of(0,0,0,0,0,0,0,0,1,0,0,0,1,1,0,0),Int8Array.of(1,1,1,1,1,1,1,1,0,1,1,1,0,0,1,1),Int8Array.of(1,1,1,1,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,0,0,0,0,1,1,0,1,1,1,0,1,1,1),Int8Array.of(0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1)];static MINIMAP_TILE_ROTATION_MAP=[Int8Array.of(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15),Int8Array.of(12,8,4,0,13,9,5,1,14,10,6,2,15,11,7,3),Int8Array.of(15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0),Int8Array.of(3,7,11,15,2,6,10,14,1,5,9,13,0,4,8,12)];static TEXTURE_HSL=Int32Array.of(41,39248,41,4643,41,41,41,41,41,41,41,41,41,41,41,43086,41,41,41,41,41,41,41,8602,41,28992,41,41,41,41,41,5056,41,41,41,41,41,41,41,41,41,41,41,41,41,41,3131,41,41,41);static activeOccluderCount=0;static mouseX=0;static mouseY=0;static clickTileX=-1;static clickTileZ=-1;static lowMemory=!0;static init(_,u,R,b,m){this.viewportLeft=0,this.viewportTop=0,this.viewportRight=_,this.viewportBottom=u,this.viewportCenterX=_/2|0,this.viewportCenterY=u/2|0;let E=new l0(9,32,53,53,!1);for(let O=128;O<=384;O+=32)for(let I=0;I<2048;I+=64){this.sinEyePitch=A.sin[O],this.cosEyePitch=A.cos[O],this.sinEyeYaw=A.sin[I],this.cosEyeYaw=A.cos[I];let L=(O-128)/32|0,H=I/64|0;for(let G=-26;G<=26;G++)for(let N=-26;N<=26;N++){let T=G*128,K=N*128,Q=!1;for(let U=-R;U<=b;U+=128)if(this.testPoint(T,K,m[L]+U)){Q=!0;break}E[L][H][G+25+1][N+25+1]=Q}}for(let O=0;O<8;O++)for(let I=0;I<32;I++)for(let L=-25;L<25;L++)for(let H=-25;H<25;H++){let G=!1;_:for(let N=-1;N<=1;N++)for(let T=-1;T<=1;T++){if(E[O][I][L+N+25+1][H+T+25+1]){G=!0;break _}if(E[O][(I+1)%31][L+N+25+1][H+T+25+1]){G=!0;break _}if(E[O+1][I][L+N+25+1][H+T+25+1]){G=!0;break _}if(E[O+1][(I+1)%31][L+N+25+1][H+T+25+1]){G=!0;break _}}this.visibilityMatrix[O][I][L+25][H+25]=G}}static addOccluder(_,u,R,b,m,E,O,I){k.levelOccluders[_][k.levelOccluderCount[_]++]=new R1(R/128|0,E/128|0,m/128|0,I/128|0,u,R,E,m,I,b,O)}static testPoint(_,u,R){let b=u*this.sinEyeYaw+_*this.cosEyeYaw>>16,m=u*this.cosEyeYaw-_*this.sinEyeYaw>>16,E=R*this.sinEyePitch+m*this.cosEyePitch>>16,O=R*this.cosEyePitch-m*this.sinEyePitch>>16;if(E<50||E>3500)return!1;let I=this.viewportCenterX+((b<<9)/E|0),L=this.viewportCenterY+((O<<9)/E|0);return I>=this.viewportLeft&&I<=this.viewportRight&&L>=this.viewportTop&&L<=this.viewportBottom}maxLevel;maxTileX;maxTileZ;levelHeightmaps;levelTiles;temporaryLocs;levelTileOcclusionCycles;mergeIndexA;mergeIndexB;temporaryLocCount=0;minLevel=0;tmpMergeIndex=0;constructor(_,u,R,b){this.maxLevel=R,this.maxTileX=b,this.maxTileZ=u,this.levelTiles=new t0(R,b,u,null),this.levelTileOcclusionCycles=new D0(R,b+1,u+1),this.levelHeightmaps=_,this.temporaryLocs=new p(5000,null),this.mergeIndexA=new Int32Array(1e4),this.mergeIndexB=new Int32Array(1e4),this.reset()}reset(){for(let _=0;_<this.maxLevel;_++)for(let u=0;u<this.maxTileX;u++)for(let R=0;R<this.maxTileZ;R++)this.levelTiles[_][u][R]=null;for(let _=0;_<4;_++){for(let u=0;u<k.levelOccluderCount[_];u++)k.levelOccluders[_][u]=null;k.levelOccluderCount[_]=0}for(let _=0;_<this.temporaryLocCount;_++)this.temporaryLocs[_]=null;this.temporaryLocCount=0,k.locBuffer.fill(null)}setMinLevel(_){this.minLevel=_;for(let u=0;u<this.maxTileX;u++)for(let R=0;R<this.maxTileZ;R++)this.levelTiles[_][u][R]=new n0(_,u,R)}setBridge(_,u){let R=this.levelTiles[0][_][u];for(let m=0;m<3;m++){this.levelTiles[m][_][u]=this.levelTiles[m+1][_][u];let E=this.levelTiles[m][_][u];if(E)E.level--}if(!this.levelTiles[0][_][u])this.levelTiles[0][_][u]=new n0(0,_,u);let b=this.levelTiles[0][_][u];if(b)b.linkedSquare=R;this.levelTiles[3][_][u]=null}setDrawLevel(_,u,R,b){let m=this.levelTiles[_][u][R];if(!m)return;m.drawLevel=b}setTile(_,u,R,b,m,E,O,I,L,H,G,N,T,K,Q,U,J,q,w,V){if(b===0){for(let n=_;n>=0;n--)if(!this.levelTiles[n][u][R])this.levelTiles[n][u][R]=new n0(n,u,R);let Y=this.levelTiles[_][u][R];if(Y)Y.quickGround=new a0(G,N,T,K,-1,w,!1)}else if(b===1){for(let n=_;n>=0;n--)if(!this.levelTiles[n][u][R])this.levelTiles[n][u][R]=new n0(n,u,R);let Y=this.levelTiles[_][u][R];if(Y)Y.quickGround=new a0(Q,U,J,q,E,V,O===I&&O===L&&O===H)}else{for(let n=_;n>=0;n--)if(!this.levelTiles[n][u][R])this.levelTiles[n][u][R]=new n0(n,u,R);let Y=this.levelTiles[_][u][R];if(Y)Y.ground=new C(u,b,U,I,T,m,G,H,V,Q,E,q,w,L,J,K,O,R,N)}}addGroundDecoration(_,u,R,b,m,E,O){if(!this.levelTiles[u][R][b])this.levelTiles[u][R][b]=new n0(u,R,b);let I=this.levelTiles[u][R][b];if(I)I.groundDecor=new b1(m,R*128+64,b*128+64,_,E,O)}removeGroundDecoration(_,u,R){let b=this.levelTiles[_][u][R];if(!b)return;b.groundDecor=null}addGroundObject(_,u,R,b,m,E,O,I){let L=0,H=this.levelTiles[b][_][u];if(H)for(let N=0;N<H.primaryCount;N++){let T=H.locs[N];if(!T||!T.model||!(T.model instanceof $))continue;let K=T.model.objRaise;if(K>L)L=K}else this.levelTiles[b][_][u]=new n0(b,_,u);let G=this.levelTiles[b][_][u];if(G)G.groundObject=new E1(R,_*128+64,u*128+64,E,O,I,m,L)}removeGroundObject(_,u,R){let b=this.levelTiles[_][u][R];if(!b)return;b.groundObject=null}addWall(_,u,R,b,m,E,O,I,L,H){if(!O&&!I)return;for(let N=_;N>=0;N--)if(!this.levelTiles[N][u][R])this.levelTiles[N][u][R]=new n0(N,u,R);let G=this.levelTiles[_][u][R];if(G)G.wall=new O1(b,u*128+64,R*128+64,m,E,O,I,L,H)}removeWall(_,u,R,b){let m=this.levelTiles[_][u][R];if(b===1&&m)m.wall=null}setWallDecoration(_,u,R,b,m,E,O,I,L,H,G){if(!I)return;for(let T=_;T>=0;T--)if(!this.levelTiles[T][u][R])this.levelTiles[T][u][R]=new n0(T,u,R);let N=this.levelTiles[_][u][R];if(N)N.decor=new I1(b,u*128+m+64,R*128+E+64,G,H,I,O,L)}removeWallDecoration(_,u,R){let b=this.levelTiles[_][u][R];if(!b)return;b.decor=null}setWallDecorationOffset(_,u,R,b){let m=this.levelTiles[_][u][R];if(!m)return;let E=m.decor;if(!E)return;let O=u*128+64,I=R*128+64;E.x=O+((E.x-O)*b/16|0),E.z=I+((E.z-I)*b/16|0)}setWallDecorationModel(_,u,R,b){if(!b)return;let m=this.levelTiles[_][u][R];if(!m)return;let E=m.decor;if(!E)return;E.model=b}setGroundDecorationModel(_,u,R,b){if(!b)return;let m=this.levelTiles[_][u][R];if(!m)return;let E=m.groundDecor;if(!E)return;E.model=b}setWallModel(_,u,R,b){if(!b)return;let m=this.levelTiles[_][u][R];if(!m)return;let E=m.wall;if(!E)return;E.model1=b}setWallModels(_,u,R,b,m){if(!b)return;let E=this.levelTiles[R][_][u];if(!E)return;let O=E.wall;if(!O)return;O.model1=b,O.model2=m}addLoc(_,u,R,b,m,E,O,I,L,H){if(!m)return!0;let G=u*128+I*64,N=R*128+L*64;return this.addModel(G,N,b,_,u,R,I,L,m,E,O,H,!1)}addTemporary(_,u,R,b,m,E,O,I,L){if(!m)return!0;let H=u-I,G=b-I,N=u+I,T=b+I;if(L){if(O>640&&O<1408)T+=128;if(O>1152&&O<1920)N+=128;if(O>1664||O<384)G-=128;if(O>128&&O<896)H-=128}return H=H/128|0,G=G/128|0,N=N/128|0,T=T/128|0,this.addModel(u,b,R,_,H,G,N+1-H,T-G+1,m,E,0,O,!0)}addTemporary2(_,u,R,b,m,E,O,I,L,H,G){return!L||this.addModel(u,b,R,_,m,E,O+1-m,I-E+1,L,H,0,G,!0)}removeLoc(_,u,R){let b=this.levelTiles[_][u][R];if(!b)return;for(let m=0;m<b.primaryCount;m++){let E=b.locs[m];if(E&&(E.typecode>>29&3)===2&&E.minSceneTileX===u&&E.minSceneTileZ===R){this.removeLoc2(E);return}}}clearLocChanges(){for(let _=0;_<this.temporaryLocCount;_++){let u=this.temporaryLocs[_];if(u)this.removeLoc2(u);this.temporaryLocs[_]=null}this.temporaryLocCount=0}getWallTypecode(_,u,R){let b=this.levelTiles[_][u][R];return!b||!b.wall?0:b.wall.typecode}getDecorTypecode(_,u,R){let b=this.levelTiles[_][R][u];return!b||!b.decor?0:b.decor.typecode}getLocTypecode(_,u,R){let b=this.levelTiles[_][u][R];if(!b)return 0;for(let m=0;m<b.primaryCount;m++){let E=b.locs[m];if(E&&(E.typecode>>29&3)===2&&E.minSceneTileX===u&&E.minSceneTileZ===R)return E.typecode}return 0}getGroundDecorTypecode(_,u,R){let b=this.levelTiles[_][u][R];return!b||!b.groundDecor?0:b.groundDecor.typecode}getWall(_,u,R){let b=this.levelTiles[_][u][R];return!b||!b.wall?null:b.wall}getDecor(_,u,R){let b=this.levelTiles[_][R][u];return!b||!b.decor?null:b.decor}getLoc(_,u,R){let b=this.levelTiles[_][u][R];if(!b)return null;for(let m=0;m<b.primaryCount;m++){let E=b.locs[m];if(E&&(E.typecode>>29&3)===2&&E.minSceneTileX===u&&E.minSceneTileZ===R)return E}return null}getGroundDecor(_,u,R){let b=this.levelTiles[_][u][R];return!b||!b.groundDecor?null:b.groundDecor}getInfo(_,u,R,b){let m=this.levelTiles[_][u][R];if(!m)return-1;else if(m.wall&&m.wall.typecode===b)return m.wall.typecode2&255;else if(m.decor&&m.decor.typecode===b)return m.decor.info&255;else if(m.groundDecor&&m.groundDecor.typecode===b)return m.groundDecor.info&255;else{for(let E=0;E<m.primaryCount;E++){let O=m.locs[E];if(O&&O.typecode===b)return O.info&255}return-1}}buildModels(_,u,R,b,m){let E=Math.sqrt(R*R+b*b+m*m)|0,O=u*E>>8;for(let I=0;I<this.maxLevel;I++)for(let L=0;L<this.maxTileX;L++)for(let H=0;H<this.maxTileZ;H++){let G=this.levelTiles[I][L][H];if(!G)continue;let N=G.wall;if(N&&N.model1&&N.model1.vertexNormal){if(this.mergeLocNormals(I,L,H,1,1,N.model1),N.model2&&N.model2.vertexNormal)this.mergeLocNormals(I,L,H,1,1,N.model2),this.mergeNormals(N.model1,N.model2,0,0,0,!1),N.model2.applyLighting(_,O,R,b,m);N.model1.applyLighting(_,O,R,b,m)}for(let K=0;K<G.primaryCount;K++){let Q=G.locs[K];if(Q&&Q.model&&Q.model.vertexNormal)this.mergeLocNormals(I,L,H,Q.maxSceneTileX+1-Q.minSceneTileX,Q.maxSceneTileZ-Q.minSceneTileZ+1,Q.model),Q.model.applyLighting(_,O,R,b,m)}let T=G.groundDecor;if(T&&T.model&&T.model.vertexNormal)this.mergeGroundDecorationNormals(I,L,H,T.model),T.model.applyLighting(_,O,R,b,m)}}mergeGroundDecorationNormals(_,u,R,b){if(u<this.maxTileX){let m=this.levelTiles[_][u+1][R];if(m&&m.groundDecor&&m.groundDecor.model&&m.groundDecor.model.vertexNormal)this.mergeNormals(b,m.groundDecor.model,128,0,0,!0)}if(R<this.maxTileX){let m=this.levelTiles[_][u][R+1];if(m&&m.groundDecor&&m.groundDecor.model&&m.groundDecor.model.vertexNormal)this.mergeNormals(b,m.groundDecor.model,0,0,128,!0)}if(u<this.maxTileX&&R<this.maxTileZ){let m=this.levelTiles[_][u+1][R+1];if(m&&m.groundDecor&&m.groundDecor.model&&m.groundDecor.model.vertexNormal)this.mergeNormals(b,m.groundDecor.model,128,0,128,!0)}if(u<this.maxTileX&&R>0){let m=this.levelTiles[_][u+1][R-1];if(m&&m.groundDecor&&m.groundDecor.model&&m.groundDecor.model.vertexNormal)this.mergeNormals(b,m.groundDecor.model,128,0,-128,!0)}}mergeLocNormals(_,u,R,b,m,E){let O=!0,I=u,L=u+b,H=R-1,G=R+m;for(let N=_;N<=_+1;N++){if(N===this.maxLevel)continue;for(let T=I;T<=L;T++){if(T<0||T>=this.maxTileX)continue;for(let K=H;K<=G;K++){if(K<0||K>=this.maxTileZ||O&&T<L&&K<G&&(K>=R||T===u))continue;let Q=this.levelTiles[N][T][K];if(!Q)continue;let U=(T-u)*128+(1-b)*64,J=(K-R)*128+(1-m)*64,q=((this.levelHeightmaps[N][T][K]+this.levelHeightmaps[N][T+1][K]+this.levelHeightmaps[N][T][K+1]+this.levelHeightmaps[N][T+1][K+1])/4|0)-((this.levelHeightmaps[_][u][R]+this.levelHeightmaps[_][u+1][R]+this.levelHeightmaps[_][u][R+1]+this.levelHeightmaps[_][u+1][R+1])/4|0),w=Q.wall;if(w&&w.model1&&w.model1.vertexNormal)this.mergeNormals(E,w.model1,U,q,J,O);if(w&&w.model2&&w.model2.vertexNormal)this.mergeNormals(E,w.model2,U,q,J,O);for(let V=0;V<Q.primaryCount;V++){let Y=Q.locs[V];if(!Y||!Y.model||!Y.model.vertexNormal)continue;let n=Y.maxSceneTileX+1-Y.minSceneTileX,f=Y.maxSceneTileZ+1-Y.minSceneTileZ;this.mergeNormals(E,Y.model,(Y.minSceneTileX-u)*128+(n-b)*64,q,(Y.minSceneTileZ-R)*128+(f-m)*64,O)}}}I--,O=!1}}mergeNormals(_,u,R,b,m,E){this.tmpMergeIndex++;let O=0,I=u.vertexX,L=u.vertexCount;if(_.vertexNormal&&_.vertexNormalOriginal)for(let H=0;H<_.vertexCount;H++){let G=_.vertexNormal[H],N=_.vertexNormalOriginal[H];if(N&&N.w!==0){let T=_.vertexY[H]-b;if(T>u.maxY)continue;let K=_.vertexX[H]-R;if(K<u.minX||K>u.maxX)continue;let Q=_.vertexZ[H]-m;if(Q<u.minZ||Q>u.maxZ)continue;if(u.vertexNormal&&u.vertexNormalOriginal)for(let U=0;U<L;U++){let J=u.vertexNormal[U],q=u.vertexNormalOriginal[U];if(K!==I[U]||Q!==u.vertexZ[U]||T!==u.vertexY[U]||q&&q.w===0)continue;if(G&&J&&q)G.x+=q.x,G.y+=q.y,G.z+=q.z,G.w+=q.w,J.x+=N.x,J.y+=N.y,J.z+=N.z,J.w+=N.w,O++;this.mergeIndexA[H]=this.tmpMergeIndex,this.mergeIndexB[U]=this.tmpMergeIndex}}}if(O<3||!E)return;if(_.faceInfo){for(let H=0;H<_.faceCount;H++)if(this.mergeIndexA[_.faceVertexA[H]]===this.tmpMergeIndex&&this.mergeIndexA[_.faceVertexB[H]]===this.tmpMergeIndex&&this.mergeIndexA[_.faceVertexC[H]]===this.tmpMergeIndex)_.faceInfo[H]=-1}if(u.faceInfo){for(let H=0;H<u.faceCount;H++)if(this.mergeIndexB[u.faceVertexA[H]]===this.tmpMergeIndex&&this.mergeIndexB[u.faceVertexB[H]]===this.tmpMergeIndex&&this.mergeIndexB[u.faceVertexC[H]]===this.tmpMergeIndex)u.faceInfo[H]=-1}}drawMinimapTile(_,u,R,b,m,E){let O=this.levelTiles[_][u][R];if(!O)return;let I=O.quickGround;if(I){let J=I.colour;if(J!==0)for(let q=0;q<4;q++)b[m]=J,b[m+1]=J,b[m+2]=J,b[m+3]=J,m+=E;return}let L=O.ground;if(!L)return;let{shape:H,shapeAngle:G,backgroundRgb:N,foregroundRgb:T}=L,K=k.MINIMAP_TILE_MASK[H],Q=k.MINIMAP_TILE_ROTATION_MAP[G],U=0;if(N!==0){for(let J=0;J<4;J++)b[m]=K[Q[U++]]===0?N:T,b[m+1]=K[Q[U++]]===0?N:T,b[m+2]=K[Q[U++]]===0?N:T,b[m+3]=K[Q[U++]]===0?N:T,m+=E;return}for(let J=0;J<4;J++){if(K[Q[U++]]!==0)b[m]=T;if(K[Q[U++]]!==0)b[m+1]=T;if(K[Q[U++]]!==0)b[m+2]=T;if(K[Q[U++]]!==0)b[m+3]=T;m+=E}}click(_,u){k.takingInput=!0,k.mouseX=_,k.mouseY=u,k.clickTileX=-1,k.clickTileZ=-1}draw(_,u,R,b,m,E,O){if(_<0)_=0;else if(_>=this.maxTileX*128)_=this.maxTileX*128-1;if(R<0)R=0;else if(R>=this.maxTileZ*128)R=this.maxTileZ*128-1;if(k.cycle++,k.sinEyePitch=A.sin[E],k.cosEyePitch=A.cos[E],k.sinEyeYaw=A.sin[m],k.cosEyeYaw=A.cos[m],k.visibilityMap=k.visibilityMatrix[(E-128)/32|0][m/64|0],k.eyeX=_,k.eyeY=u,k.eyeZ=R,k.eyeTileX=_/128|0,k.eyeTileZ=R/128|0,k.topLevel=b,k.minDrawTileX=k.eyeTileX-25,k.minDrawTileX<0)k.minDrawTileX=0;if(k.minDrawTileZ=k.eyeTileZ-25,k.minDrawTileZ<0)k.minDrawTileZ=0;if(k.maxDrawTileX=k.eyeTileX+25,k.maxDrawTileX>this.maxTileX)k.maxDrawTileX=this.maxTileX;if(k.maxDrawTileZ=k.eyeTileZ+25,k.maxDrawTileZ>this.maxTileZ)k.maxDrawTileZ=this.maxTileZ;this.updateActiveOccluders(),k.tilesRemaining=0;for(let I=this.minLevel;I<this.maxLevel;I++){let L=this.levelTiles[I];for(let H=k.minDrawTileX;H<k.maxDrawTileX;H++)for(let G=k.minDrawTileZ;G<k.maxDrawTileZ;G++){let N=L[H][G];if(!N)continue;if(N.drawLevel<=b&&(k.visibilityMap[H+25-k.eyeTileX][G+25-k.eyeTileZ]||this.levelHeightmaps[I][H][G]-u>=2000))N.drawFront=!0,N.drawBack=!0,N.drawPrimaries=N.primaryCount>0,k.tilesRemaining++;else N.drawFront=!1,N.drawBack=!1,N.cornerSides=0}}for(let I=this.minLevel;I<this.maxLevel;I++){let L=this.levelTiles[I];for(let H=-25;H<=0;H++){let G=k.eyeTileX+H,N=k.eyeTileX-H;if(G<k.minDrawTileX&&N>=k.maxDrawTileX)continue;for(let T=-25;T<=0;T++){let K=k.eyeTileZ+T,Q=k.eyeTileZ-T,U;if(G>=k.minDrawTileX){if(K>=k.minDrawTileZ){if(U=L[G][K],U&&U.drawFront)this.drawTile(U,!0,O)}if(Q<k.maxDrawTileZ){if(U=L[G][Q],U&&U.drawFront)this.drawTile(U,!0,O)}}if(N<k.maxDrawTileX){if(K>=k.minDrawTileZ){if(U=L[N][K],U&&U.drawFront)this.drawTile(U,!0,O)}if(Q<k.maxDrawTileZ){if(U=L[N][Q],U&&U.drawFront)this.drawTile(U,!0,O)}}if(k.tilesRemaining===0){k.takingInput=!1;return}}}}for(let I=this.minLevel;I<this.maxLevel;I++){let L=this.levelTiles[I];for(let H=-25;H<=0;H++){let G=k.eyeTileX+H,N=k.eyeTileX-H;if(G<k.minDrawTileX&&N>=k.maxDrawTileX)continue;for(let T=-25;T<=0;T++){let K=k.eyeTileZ+T,Q=k.eyeTileZ-T,U;if(G>=k.minDrawTileX){if(K>=k.minDrawTileZ){if(U=L[G][K],U&&U.drawFront)this.drawTile(U,!1,O)}if(Q<k.maxDrawTileZ){if(U=L[G][Q],U&&U.drawFront)this.drawTile(U,!1,O)}}if(N<k.maxDrawTileX){if(K>=k.minDrawTileZ){if(U=L[N][K],U&&U.drawFront)this.drawTile(U,!1,O)}if(Q<k.maxDrawTileZ){if(U=L[N][Q],U&&U.drawFront)this.drawTile(U,!1,O)}}if(k.tilesRemaining===0){k.takingInput=!1;return}}}}}addModel(_,u,R,b,m,E,O,I,L,H,G,N,T){if(!L)return!1;for(let Q=m;Q<m+O;Q++)for(let U=E;U<E+I;U++){if(Q<0||U<0||Q>=this.maxTileX||U>=this.maxTileZ)return!1;let J=this.levelTiles[b][Q][U];if(J&&J.primaryCount>=5)return!1}let K=new m1(b,R,_,u,L,N,m,m+O-1,E,E+I-1,H,G);for(let Q=m;Q<m+O;Q++)for(let U=E;U<E+I;U++){let J=0;if(Q>m)J|=1;if(Q<m+O-1)J+=4;if(U>E)J+=8;if(U<E+I-1)J+=2;for(let w=b;w>=0;w--)if(!this.levelTiles[w][Q][U])this.levelTiles[w][Q][U]=new n0(w,Q,U);let q=this.levelTiles[b][Q][U];if(q)q.locs[q.primaryCount]=K,q.primaryExtendDirections[q.primaryCount]=J,q.combinedPrimaryExtendDirections|=J,q.primaryCount++}if(T)this.temporaryLocs[this.temporaryLocCount++]=K;return!0}removeLoc2(_){for(let u=_.minSceneTileX;u<=_.maxSceneTileX;u++)for(let R=_.minSceneTileZ;R<=_.maxSceneTileZ;R++){let b=this.levelTiles[_.locLevel][u][R];if(!b)continue;for(let m=0;m<b.primaryCount;m++)if(b.locs[m]===_){b.primaryCount--;for(let E=m;E<b.primaryCount;E++)b.locs[E]=b.locs[E+1],b.primaryExtendDirections[E]=b.primaryExtendDirections[E+1];b.locs[b.primaryCount]=null;break}b.combinedPrimaryExtendDirections=0;for(let m=0;m<b.primaryCount;m++)b.combinedPrimaryExtendDirections|=b.primaryExtendDirections[m]}}updateActiveOccluders(){let _=k.levelOccluderCount[k.topLevel],u=k.levelOccluders[k.topLevel];k.activeOccluderCount=0;for(let R=0;R<_;R++){let b=u[R];if(!b)continue;let m,E,O,I;if(b.type===1){if(m=b.minTileX+25-k.eyeTileX,m>=0&&m<=50){if(E=b.minTileZ+25-k.eyeTileZ,E<0)E=0;if(O=b.maxTileZ+25-k.eyeTileZ,O>50)O=50;let L=!1;while(E<=O)if(k.visibilityMap&&k.visibilityMap[m][E++]){L=!0;break}if(L){if(I=k.eyeX-b.minX,I>32)b.mode=1;else{if(I>=-32)continue;b.mode=2,I=-I}b.minDeltaZ=(b.minZ-k.eyeZ<<8)/I|0,b.maxDeltaZ=(b.maxZ-k.eyeZ<<8)/I|0,b.minDeltaY=(b.minY-k.eyeY<<8)/I|0,b.maxDeltaY=(b.maxY-k.eyeY<<8)/I|0,k.activeOccluders[k.activeOccluderCount++]=b}}}else if(b.type===2){if(m=b.minTileZ+25-k.eyeTileZ,m>=0&&m<=50){if(E=b.minTileX+25-k.eyeTileX,E<0)E=0;if(O=b.maxTileX+25-k.eyeTileX,O>50)O=50;let L=!1;while(E<=O)if(k.visibilityMap&&k.visibilityMap[E++][m]){L=!0;break}if(L){if(I=k.eyeZ-b.minZ,I>32)b.mode=3;else{if(I>=-32)continue;b.mode=4,I=-I}b.minDeltaX=(b.minX-k.eyeX<<8)/I|0,b.maxDeltaX=(b.maxX-k.eyeX<<8)/I|0,b.minDeltaY=(b.minY-k.eyeY<<8)/I|0,b.maxDeltaY=(b.maxY-k.eyeY<<8)/I|0,k.activeOccluders[k.activeOccluderCount++]=b}}}else if(b.type===4){if(m=b.minY-k.eyeY,m>128){if(E=b.minTileZ+25-k.eyeTileZ,E<0)E=0;if(O=b.maxTileZ+25-k.eyeTileZ,O>50)O=50;if(E<=O){let L=b.minTileX+25-k.eyeTileX;if(L<0)L=0;if(I=b.maxTileX+25-k.eyeTileX,I>50)I=50;let H=!1;_:for(let G=L;G<=I;G++)for(let N=E;N<=O;N++)if(k.visibilityMap&&k.visibilityMap[G][N]){H=!0;break _}if(H)b.mode=5,b.minDeltaX=(b.minX-k.eyeX<<8)/m|0,b.maxDeltaX=(b.maxX-k.eyeX<<8)/m|0,b.minDeltaZ=(b.minZ-k.eyeZ<<8)/m|0,b.maxDeltaZ=(b.maxZ-k.eyeZ<<8)/m|0,k.activeOccluders[k.activeOccluderCount++]=b}}}}}drawTile(_,u,R){k.drawTileQueue.push(_);while(!0){let b;do if(b=k.drawTileQueue.pop(),!b)return;while(!b.drawBack);let{x:m,z:E,level:O,originalLevel:I}=b,L=this.levelTiles[O];if(b.drawFront){if(u){if(O>0){let J=this.levelTiles[O-1][m][E];if(J&&J.drawBack)continue}if(m<=k.eyeTileX&&m>k.minDrawTileX){let J=L[m-1][E];if(J&&J.drawBack&&(J.drawFront||(b.combinedPrimaryExtendDirections&1)===0))continue}if(m>=k.eyeTileX&&m<k.maxDrawTileX-1){let J=L[m+1][E];if(J&&J.drawBack&&(J.drawFront||(b.combinedPrimaryExtendDirections&4)===0))continue}if(E<=k.eyeTileZ&&E>k.minDrawTileZ){let J=L[m][E-1];if(J&&J.drawBack&&(J.drawFront||(b.combinedPrimaryExtendDirections&8)===0))continue}if(E>=k.eyeTileZ&&E<k.maxDrawTileZ-1){let J=L[m][E+1];if(J&&J.drawBack&&(J.drawFront||(b.combinedPrimaryExtendDirections&2)===0))continue}}else u=!0;if(b.drawFront=!1,b.linkedSquare){let J=b.linkedSquare;if(!J.quickGround){if(J.ground&&!this.tileVisible(0,m,E))this.drawTileOverlay(m,E,J.ground,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw)}else if(!this.tileVisible(0,m,E))this.drawTileUnderlay(J.quickGround,0,m,E,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw);let q=J.wall;if(q)q.model1?.draw(R,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,q.x-k.eyeX,q.y-k.eyeY,q.z-k.eyeZ,q.typecode);for(let w=0;w<J.primaryCount;w++){let V=J.locs[w];if(V)V.model?.draw(R,V.yaw,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,V.x-k.eyeX,V.y-k.eyeY,V.z-k.eyeZ,V.typecode)}}let G=!1;if(!b.quickGround){if(b.ground&&!this.tileVisible(I,m,E))G=!0,this.drawTileOverlay(m,E,b.ground,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw)}else if(!this.tileVisible(I,m,E))G=!0,this.drawTileUnderlay(b.quickGround,I,m,E,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw);let N=0,T=0,K=b.wall,Q=b.decor;if(K||Q){if(k.eyeTileX===m)N+=1;else if(k.eyeTileX<m)N+=2;if(k.eyeTileZ===E)N+=3;else if(k.eyeTileZ>E)N+=6;T=k.FRONT_WALL_TYPES[N],b.backWallTypes=k.BACK_WALL_TYPES[N]}if(K){if((K.angle1&k.DIRECTION_ALLOW_WALL_CORNER_TYPE[N])===0)b.cornerSides=0;else if(K.angle1===16)b.cornerSides=3,b.sidesBeforeCorner=k.MIDDEP_16[N],b.sidesAfterCorner=3-b.sidesBeforeCorner;else if(K.angle1===32)b.cornerSides=6,b.sidesBeforeCorner=k.MIDDEP_32[N],b.sidesAfterCorner=6-b.sidesBeforeCorner;else if(K.angle1===64)b.cornerSides=12,b.sidesBeforeCorner=k.MIDDEP_64[N],b.sidesAfterCorner=12-b.sidesBeforeCorner;else b.cornerSides=9,b.sidesBeforeCorner=k.MIDDEP_128[N],b.sidesAfterCorner=9-b.sidesBeforeCorner;if((K.angle1&T)!==0&&!this.isTileSideOccluded(I,m,E,K.angle1))K.model1?.draw(R,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,K.x-k.eyeX,K.y-k.eyeY,K.z-k.eyeZ,K.typecode);if((K.angle2&T)!==0&&!this.isTileSideOccluded(I,m,E,K.angle2))K.model2?.draw(R,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,K.x-k.eyeX,K.y-k.eyeY,K.z-k.eyeZ,K.typecode)}if(Q&&!this.isTileColumnOccluded(I,m,E,Q.model.minY)){if((Q.angle1&T)!==0)Q.model.draw(R,Q.angle2,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,Q.x-k.eyeX,Q.y-k.eyeY,Q.z-k.eyeZ,Q.typecode);else if((Q.angle1&768)!==0){let J=Q.x-k.eyeX,q=Q.y-k.eyeY,w=Q.z-k.eyeZ,V=Q.angle2,Y;if(V===1||V===2)Y=-J;else Y=J;let n;if(V===2||V===3)n=-w;else n=w;if((Q.angle1&256)!==0&&n<Y){let f=J+k.WALL_DECORATION_INSET_X[V],Z=w+k.WALL_DECORATION_INSET_Z[V];Q.model.draw(R,V*512+256,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,f,q,Z,Q.typecode)}if((Q.angle1&512)!==0&&n>Y){let f=J+k.WALL_DECORATION_OUTSET_X[V],Z=w+k.WALL_DECORATION_OUTSET_Z[V];Q.model.draw(R,V*512+1280&2047,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,f,q,Z,Q.typecode)}}}if(G){let J=b.groundDecor;if(J)J.model?.draw(R,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,J.x-k.eyeX,J.y-k.eyeY,J.z-k.eyeZ,J.typecode);let q=b.groundObject;if(q&&q.offset===0){if(q.bottomObj)q.bottomObj.draw(R,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,q.x-k.eyeX,q.y-k.eyeY,q.z-k.eyeZ,q.typecode);if(q.middleObj)q.middleObj.draw(R,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,q.x-k.eyeX,q.y-k.eyeY,q.z-k.eyeZ,q.typecode);if(q.topObj)q.topObj.draw(R,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,q.x-k.eyeX,q.y-k.eyeY,q.z-k.eyeZ,q.typecode)}}let U=b.combinedPrimaryExtendDirections;if(U!==0){if(m<k.eyeTileX&&(U&4)!==0){let J=L[m+1][E];if(J&&J.drawBack)k.drawTileQueue.push(J)}if(E<k.eyeTileZ&&(U&2)!==0){let J=L[m][E+1];if(J&&J.drawBack)k.drawTileQueue.push(J)}if(m>k.eyeTileX&&(U&1)!==0){let J=L[m-1][E];if(J&&J.drawBack)k.drawTileQueue.push(J)}if(E>k.eyeTileZ&&(U&8)!==0){let J=L[m][E-1];if(J&&J.drawBack)k.drawTileQueue.push(J)}}}if(b.cornerSides!==0){let G=!0;for(let N=0;N<b.primaryCount;N++){let T=b.locs[N];if(!T)continue;if(T.cycle!==k.cycle&&(b.primaryExtendDirections[N]&b.cornerSides)===b.sidesBeforeCorner){G=!1;break}}if(G){let N=b.wall;if(N&&!this.isTileSideOccluded(I,m,E,N.angle1))N.model1?.draw(R,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,N.x-k.eyeX,N.y-k.eyeY,N.z-k.eyeZ,N.typecode);b.cornerSides=0}}if(b.drawPrimaries){let G=b.primaryCount;b.drawPrimaries=!1;let N=0;_:for(let T=0;T<G;T++){let K=b.locs[T];if(!K||K.cycle===k.cycle)continue;for(let w=K.minSceneTileX;w<=K.maxSceneTileX;w++)for(let V=K.minSceneTileZ;V<=K.maxSceneTileZ;V++){let Y=L[w][V];if(!Y)continue;if(Y.drawFront){b.drawPrimaries=!0;continue _}if(Y.cornerSides===0)continue;let n=0;if(w>K.minSceneTileX)n+=1;if(w<K.maxSceneTileX)n+=4;if(V>K.minSceneTileZ)n+=8;if(V<K.maxSceneTileZ)n+=2;if((n&Y.cornerSides)!==b.sidesAfterCorner)continue}k.locBuffer[N++]=K;let Q=k.eyeTileX-K.minSceneTileX,U=K.maxSceneTileX-k.eyeTileX;if(U>Q)Q=U;let J=k.eyeTileZ-K.minSceneTileZ,q=K.maxSceneTileZ-k.eyeTileZ;if(q>J)K.distance=Q+q;else K.distance=Q+J}while(N>0){let T=-50,K=-1;for(let U=0;U<N;U++){let J=k.locBuffer[U];if(!J)continue;if(J.distance>T&&J.cycle!==k.cycle)T=J.distance,K=U}if(K===-1)break;let Q=k.locBuffer[K];if(Q){if(Q.cycle=k.cycle,!this.locVisible(I,Q.minSceneTileX,Q.maxSceneTileX,Q.minSceneTileZ,Q.maxSceneTileZ,Q.model?.minY??0))Q.model?.draw(R,Q.yaw,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,Q.x-k.eyeX,Q.y-k.eyeY,Q.z-k.eyeZ,Q.typecode);for(let U=Q.minSceneTileX;U<=Q.maxSceneTileX;U++)for(let J=Q.minSceneTileZ;J<=Q.maxSceneTileZ;J++){let q=L[U][J];if(!q)continue;if(q.cornerSides!==0)k.drawTileQueue.push(q);else if((U!==m||J!==E)&&q.drawBack)k.drawTileQueue.push(q)}}}if(b.drawPrimaries)continue}if(!b.drawBack||b.cornerSides!==0)continue;if(m<=k.eyeTileX&&m>k.minDrawTileX){let G=L[m-1][E];if(G&&G.drawBack)continue}if(m>=k.eyeTileX&&m<k.maxDrawTileX-1){let G=L[m+1][E];if(G&&G.drawBack)continue}if(E<=k.eyeTileZ&&E>k.minDrawTileZ){let G=L[m][E-1];if(G&&G.drawBack)continue}if(E>=k.eyeTileZ&&E<k.maxDrawTileZ-1){let G=L[m][E+1];if(G&&G.drawBack)continue}b.drawBack=!1,k.tilesRemaining--;let H=b.groundObject;if(H&&H.offset!==0){if(H.bottomObj)H.bottomObj.draw(R,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,H.x-k.eyeX,H.y-k.eyeY-H.offset,H.z-k.eyeZ,H.typecode);if(H.middleObj)H.middleObj.draw(R,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,H.x-k.eyeX,H.y-k.eyeY-H.offset,H.z-k.eyeZ,H.typecode);if(H.topObj)H.topObj.draw(R,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,H.x-k.eyeX,H.y-k.eyeY-H.offset,H.z-k.eyeZ,H.typecode)}if(b.backWallTypes!==0){let G=b.decor;if(G&&!this.isTileColumnOccluded(I,m,E,G.model.minY)){if((G.angle1&b.backWallTypes)!==0)G.model.draw(R,G.angle2,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,G.x-k.eyeX,G.y-k.eyeY,G.z-k.eyeZ,G.typecode);else if((G.angle1&768)!==0){let T=G.x-k.eyeX,K=G.y-k.eyeY,Q=G.z-k.eyeZ,U=G.angle2,J;if(U===1||U===2)J=-T;else J=T;let q;if(U===2||U===3)q=-Q;else q=Q;if((G.angle1&256)!==0&&q>=J){let w=T+k.WALL_DECORATION_INSET_X[U],V=Q+k.WALL_DECORATION_INSET_Z[U];G.model.draw(R,U*512+256,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,w,K,V,G.typecode)}if((G.angle1&512)!==0&&q<=J){let w=T+k.WALL_DECORATION_OUTSET_X[U],V=Q+k.WALL_DECORATION_OUTSET_Z[U];G.model.draw(R,U*512+1280&2047,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,w,K,V,G.typecode)}}}let N=b.wall;if(N){if((N.angle2&b.backWallTypes)!==0&&!this.isTileSideOccluded(I,m,E,N.angle2))N.model2?.draw(R,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,N.x-k.eyeX,N.y-k.eyeY,N.z-k.eyeZ,N.typecode);if((N.angle1&b.backWallTypes)!==0&&!this.isTileSideOccluded(I,m,E,N.angle1))N.model1?.draw(R,0,k.sinEyePitch,k.cosEyePitch,k.sinEyeYaw,k.cosEyeYaw,N.x-k.eyeX,N.y-k.eyeY,N.z-k.eyeZ,N.typecode)}}if(O<this.maxLevel-1){let G=this.levelTiles[O+1][m][E];if(G&&G.drawBack)k.drawTileQueue.push(G)}if(m<k.eyeTileX){let G=L[m+1][E];if(G&&G.drawBack)k.drawTileQueue.push(G)}if(E<k.eyeTileZ){let G=L[m][E+1];if(G&&G.drawBack)k.drawTileQueue.push(G)}if(m>k.eyeTileX){let G=L[m-1][E];if(G&&G.drawBack)k.drawTileQueue.push(G)}if(E>k.eyeTileZ){let G=L[m][E-1];if(G&&G.drawBack)k.drawTileQueue.push(G)}}}drawTileUnderlay(_,u,R,b,m,E,O,I){let L,H=L=(R<<7)-k.eyeX,G,N=G=(b<<7)-k.eyeZ,T,K=T=H+128,Q,U=Q=N+128,J=this.levelHeightmaps[u][R][b]-k.eyeY,q=this.levelHeightmaps[u][R+1][b]-k.eyeY,w=this.levelHeightmaps[u][R+1][b+1]-k.eyeY,V=this.levelHeightmaps[u][R][b+1]-k.eyeY,Y=N*O+H*I>>16;if(N=N*I-H*O>>16,H=Y,Y=J*E-N*m>>16,N=J*m+N*E>>16,J=Y,N<50)return;if(Y=G*O+K*I>>16,G=G*I-K*O>>16,K=Y,Y=q*E-G*m>>16,G=q*m+G*E>>16,q=Y,G<50)return;if(Y=U*O+T*I>>16,U=U*I-T*O>>16,T=Y,Y=w*E-U*m>>16,U=w*m+U*E>>16,w=Y,U<50)return;if(Y=Q*O+L*I>>16,Q=Q*I-L*O>>16,L=Y,Y=V*E-Q*m>>16,Q=V*m+Q*E>>16,V=Y,Q<50)return;let n=A.centerX+((H<<9)/N|0),f=A.centerY+((J<<9)/N|0),Z=A.centerX+((K<<9)/G|0),h=A.centerY+((q<<9)/G|0),D=A.centerX+((T<<9)/U|0),j=A.centerY+((w<<9)/U|0),W=A.centerX+((L<<9)/Q|0),M=A.centerY+((V<<9)/Q|0);if(A.alpha=0,(D-W)*(h-M)-(j-M)*(Z-W)>0){if(A.clipX=D<0||W<0||Z<0||D>F.boundX||W>F.boundX||Z>F.boundX,k.takingInput&&this.pointInsideTriangle(k.mouseX,k.mouseY,j,M,h,D,W,Z))k.clickTileX=R,k.clickTileZ=b;if(_.textureId===-1){if(_.northeastColor!==12345678)A.fillGouraudTriangle(D,W,Z,j,M,h,_.northeastColor,_.northwestColor,_.southeastColor)}else if(k.lowMemory){let X=k.TEXTURE_HSL[_.textureId];A.fillGouraudTriangle(D,W,Z,j,M,h,this.mulLightness(X,_.northeastColor),this.mulLightness(X,_.northwestColor),this.mulLightness(X,_.southeastColor))}else if(_.flat)A.fillTexturedTriangle(D,W,Z,j,M,h,_.northeastColor,_.northwestColor,_.southeastColor,H,J,N,K,L,q,V,G,Q,_.textureId);else A.fillTexturedTriangle(D,W,Z,j,M,h,_.northeastColor,_.northwestColor,_.southeastColor,T,w,U,L,K,V,q,Q,G,_.textureId)}if((n-Z)*(M-h)-(f-h)*(W-Z)<=0)return;if(A.clipX=n<0||Z<0||W<0||n>F.boundX||Z>F.boundX||W>F.boundX,k.takingInput&&this.pointInsideTriangle(k.mouseX,k.mouseY,f,h,M,n,Z,W))k.clickTileX=R,k.clickTileZ=b;if(_.textureId!==-1){if(!k.lowMemory){A.fillTexturedTriangle(n,Z,W,f,h,M,_.southwestColor,_.southeastColor,_.northwestColor,H,J,N,K,L,q,V,G,Q,_.textureId);return}let X=k.TEXTURE_HSL[_.textureId];A.fillGouraudTriangle(n,Z,W,f,h,M,this.mulLightness(X,_.southwestColor),this.mulLightness(X,_.southeastColor),this.mulLightness(X,_.northwestColor))}else if(_.southwestColor!==12345678)A.fillGouraudTriangle(n,Z,W,f,h,M,_.southwestColor,_.southeastColor,_.northwestColor)}drawTileOverlay(_,u,R,b,m,E,O){let I=R.vertexX.length;for(let L=0;L<I;L++){let H=R.vertexX[L]-k.eyeX,G=R.vertexY[L]-k.eyeY,N=R.vertexZ[L]-k.eyeZ,T=N*E+H*O>>16;if(N=N*O-H*E>>16,H=T,T=G*m-N*b>>16,N=G*b+N*m>>16,G=T,N<50)return;if(R.triangleTextureIds)C.tmpViewspaceX[L]=H,C.tmpViewspaceY[L]=G,C.tmpViewspaceZ[L]=N;C.tmpScreenX[L]=A.centerX+((H<<9)/N|0),C.tmpScreenY[L]=A.centerY+((G<<9)/N|0)}A.alpha=0,I=R.triangleVertexA.length;for(let L=0;L<I;L++){let H=R.triangleVertexA[L],G=R.triangleVertexB[L],N=R.triangleVertexC[L],T=C.tmpScreenX[H],K=C.tmpScreenX[G],Q=C.tmpScreenX[N],U=C.tmpScreenY[H],J=C.tmpScreenY[G],q=C.tmpScreenY[N];if((T-K)*(q-J)-(U-J)*(Q-K)>0){if(A.clipX=T<0||K<0||Q<0||T>F.boundX||K>F.boundX||Q>F.boundX,k.takingInput&&this.pointInsideTriangle(k.mouseX,k.mouseY,U,J,q,T,K,Q))k.clickTileX=_,k.clickTileZ=u;if(!R.triangleTextureIds||R.triangleTextureIds[L]===-1){if(R.triangleColorA[L]!==12345678)A.fillGouraudTriangle(T,K,Q,U,J,q,R.triangleColorA[L],R.triangleColorB[L],R.triangleColorC[L])}else if(k.lowMemory){let w=k.TEXTURE_HSL[R.triangleTextureIds[L]];A.fillGouraudTriangle(T,K,Q,U,J,q,this.mulLightness(w,R.triangleColorA[L]),this.mulLightness(w,R.triangleColorB[L]),this.mulLightness(w,R.triangleColorC[L]))}else if(R.flat)A.fillTexturedTriangle(T,K,Q,U,J,q,R.triangleColorA[L],R.triangleColorB[L],R.triangleColorC[L],C.tmpViewspaceX[0],C.tmpViewspaceY[0],C.tmpViewspaceZ[0],C.tmpViewspaceX[1],C.tmpViewspaceX[3],C.tmpViewspaceY[1],C.tmpViewspaceY[3],C.tmpViewspaceZ[1],C.tmpViewspaceZ[3],R.triangleTextureIds[L]);else A.fillTexturedTriangle(T,K,Q,U,J,q,R.triangleColorA[L],R.triangleColorB[L],R.triangleColorC[L],C.tmpViewspaceX[H],C.tmpViewspaceY[H],C.tmpViewspaceZ[H],C.tmpViewspaceX[G],C.tmpViewspaceX[N],C.tmpViewspaceY[G],C.tmpViewspaceY[N],C.tmpViewspaceZ[G],C.tmpViewspaceZ[N],R.triangleTextureIds[L])}}}tileVisible(_,u,R){let b=this.levelTileOcclusionCycles[_][u][R];if(b===-k.cycle)return!1;else if(b===k.cycle)return!0;else{let m=u<<7,E=R<<7;if(this.occluded(m+1,this.levelHeightmaps[_][u][R],E+1)&&this.occluded(m+128-1,this.levelHeightmaps[_][u+1][R],E+1)&&this.occluded(m+128-1,this.levelHeightmaps[_][u+1][R+1],E+128-1)&&this.occluded(m+1,this.levelHeightmaps[_][u][R+1],E+128-1))return this.levelTileOcclusionCycles[_][u][R]=k.cycle,!0;else return this.levelTileOcclusionCycles[_][u][R]=-k.cycle,!1}}isTileSideOccluded(_,u,R,b){if(!this.tileVisible(_,u,R))return!1;let m=u<<7,E=R<<7,O=this.levelHeightmaps[_][u][R]-1,I=O-120,L=O-230,H=O-238;if(b<16){if(b===1){if(m>k.eyeX){if(!this.occluded(m,O,E))return!1;if(!this.occluded(m,O,E+128))return!1}if(_>0){if(!this.occluded(m,I,E))return!1;if(!this.occluded(m,I,E+128))return!1}if(!this.occluded(m,L,E))return!1;return this.occluded(m,L,E+128)}if(b===2){if(E<k.eyeZ){if(!this.occluded(m,O,E+128))return!1;if(!this.occluded(m+128,O,E+128))return!1}if(_>0){if(!this.occluded(m,I,E+128))return!1;if(!this.occluded(m+128,I,E+128))return!1}if(!this.occluded(m,L,E+128))return!1;return this.occluded(m+128,L,E+128)}if(b===4){if(m<k.eyeX){if(!this.occluded(m+128,O,E))return!1;if(!this.occluded(m+128,O,E+128))return!1}if(_>0){if(!this.occluded(m+128,I,E))return!1;if(!this.occluded(m+128,I,E+128))return!1}if(!this.occluded(m+128,L,E))return!1;return this.occluded(m+128,L,E+128)}if(b===8){if(E>k.eyeZ){if(!this.occluded(m,O,E))return!1;if(!this.occluded(m+128,O,E))return!1}if(_>0){if(!this.occluded(m,I,E))return!1;if(!this.occluded(m+128,I,E))return!1}if(!this.occluded(m,L,E))return!1;return this.occluded(m+128,L,E)}}if(!this.occluded(m+64,H,E+64))return!1;else if(b===16)return this.occluded(m,L,E+128);else if(b===32)return this.occluded(m+128,L,E+128);else if(b===64)return this.occluded(m+128,L,E);else if(b===128)return this.occluded(m,L,E);return!0}isTileColumnOccluded(_,u,R,b){if(this.tileVisible(_,u,R)){let m=u<<7,E=R<<7;return this.occluded(m+1,this.levelHeightmaps[_][u][R]-b,E+1)&&this.occluded(m+128-1,this.levelHeightmaps[_][u+1][R]-b,E+1)&&this.occluded(m+128-1,this.levelHeightmaps[_][u+1][R+1]-b,E+128-1)&&this.occluded(m+1,this.levelHeightmaps[_][u][R+1]-b,E+128-1)}return!1}locVisible(_,u,R,b,m,E){let O,I;if(u!==R||b!==m){for(O=u;O<=R;O++)for(I=b;I<=m;I++)if(this.levelTileOcclusionCycles[_][O][I]===-k.cycle)return!1;I=(u<<7)+1;let L=(b<<7)+2,H=this.levelHeightmaps[_][u][b]-E;if(!this.occluded(I,H,L))return!1;let G=(R<<7)-1;if(!this.occluded(G,H,L))return!1;let N=(m<<7)-1;if(!this.occluded(I,H,N))return!1;else return this.occluded(G,H,N)}else if(this.tileVisible(_,u,b))return O=u<<7,I=b<<7,this.occluded(O+1,this.levelHeightmaps[_][u][b]-E,I+1)&&this.occluded(O+128-1,this.levelHeightmaps[_][u+1][b]-E,I+1)&&this.occluded(O+128-1,this.levelHeightmaps[_][u+1][b+1]-E,I+128-1)&&this.occluded(O+1,this.levelHeightmaps[_][u][b+1]-E,I+128-1);return!1}occluded(_,u,R){for(let b=0;b<k.activeOccluderCount;b++){let m=k.activeOccluders[b];if(!m)continue;if(m.mode===1){let E=m.minX-_;if(E>0){let O=m.minZ+(m.minDeltaZ*E>>8),I=m.maxZ+(m.maxDeltaZ*E>>8),L=m.minY+(m.minDeltaY*E>>8),H=m.maxY+(m.maxDeltaY*E>>8);if(R>=O&&R<=I&&u>=L&&u<=H)return!0}}else if(m.mode===2){let E=_-m.minX;if(E>0){let O=m.minZ+(m.minDeltaZ*E>>8),I=m.maxZ+(m.maxDeltaZ*E>>8),L=m.minY+(m.minDeltaY*E>>8),H=m.maxY+(m.maxDeltaY*E>>8);if(R>=O&&R<=I&&u>=L&&u<=H)return!0}}else if(m.mode===3){let E=m.minZ-R;if(E>0){let O=m.minX+(m.minDeltaX*E>>8),I=m.maxX+(m.maxDeltaX*E>>8),L=m.minY+(m.minDeltaY*E>>8),H=m.maxY+(m.maxDeltaY*E>>8);if(_>=O&&_<=I&&u>=L&&u<=H)return!0}}else if(m.mode===4){let E=R-m.minZ;if(E>0){let O=m.minX+(m.minDeltaX*E>>8),I=m.maxX+(m.maxDeltaX*E>>8),L=m.minY+(m.minDeltaY*E>>8),H=m.maxY+(m.maxDeltaY*E>>8);if(_>=O&&_<=I&&u>=L&&u<=H)return!0}}else if(m.mode===5){let E=u-m.minY;if(E>0){let O=m.minX+(m.minDeltaX*E>>8),I=m.maxX+(m.maxDeltaX*E>>8),L=m.minZ+(m.minDeltaZ*E>>8),H=m.maxZ+(m.maxDeltaZ*E>>8);if(_>=O&&_<=I&&R>=L&&R<=H)return!0}}}return!1}pointInsideTriangle(_,u,R,b,m,E,O,I){if(u<R&&u<b&&u<m)return!1;else if(u>R&&u>b&&u>m)return!1;else if(_<E&&_<O&&_<I)return!1;else if(_>E&&_>O&&_>I)return!1;let L=(u-R)*(O-E)-(_-E)*(b-R),H=(u-m)*(E-I)-(_-I)*(R-m),G=(u-b)*(I-O)-(_-O)*(m-b);return L*G>0&&G*H>0}mulLightness(_,u){if(u=(127-u)*(_&127)/160|0,u<2)u=2;else if(u>126)u=126;return(_&65408)+u}}class e extends Y0{index;shape;angle;heightmapSW;heightmapSE;heightmapNE;heightmapNW;seq;seqFrame;seqCycle;constructor(_,u,R,b,m,E,O,I,L,H){super();if(this.index=u,this.shape=R,this.angle=b,this.heightmapSW=m,this.heightmapSE=E,this.heightmapNE=O,this.heightmapNW=I,this.seq=l.types[L],this.seqFrame=0,this.seqCycle=_,H&&this.seq.replayoff!==-1)this.seqFrame=Math.random()*this.seq.frameCount|0,this.seqCycle-=Math.random()*this.seq.getFrameDuration(this.seqFrame)|0}getModel(_){if(this.seq){let b=_-this.seqCycle;if(b>100&&this.seq.replayoff>0)b=100;while(b>this.seq.getFrameDuration(this.seqFrame)){if(b-=this.seq.getFrameDuration(this.seqFrame),this.seqFrame++,this.seqFrame<this.seq.frameCount)continue;if(this.seqFrame-=this.seq.replayoff,this.seqFrame<0||this.seqFrame>=this.seq.frameCount){this.seq=null;break}}this.seqCycle=_-b}let u=-1;if(this.seq&&this.seq.frames&&typeof this.seq.frames[this.seqFrame]!=="undefined")u=this.seq.frames[this.seqFrame];return u0.get(this.index).getModel(this.shape,this.angle,this.heightmapSW,this.heightmapSE,this.heightmapNE,this.heightmapNW,u)}}class i{static ROTATION_WALL_TYPE=Int8Array.of(1,2,4,8);static ROTATION_WALL_CORNER_TYPE=Uint8Array.of(16,32,64,128);static WALL_DECORATION_ROTATION_FORWARD_X=Int8Array.of(1,0,-1,0);static WALL_DECORATION_ROTATION_FORWARD_Z=Int8Array.of(0,-1,0,1);static randomHueOffset=(Math.random()*17|0)-8;static randomLightnessOffset=(Math.random()*33|0)-16;static lowMemory=!0;static levelBuilt=0;static fullbright=!1;static perlin(_,u){let R=this.perlinScale(_+45365,u+91923,4)+(this.perlinScale(_+10294,u+37821,2)-128>>1)+(this.perlinScale(_,u,1)-128>>2)-128;if(R=(R*0.3|0)+35,R<10)R=10;else if(R>60)R=60;return R}static perlinScale(_,u,R){let b=_/R|0,m=_&R-1,E=u/R|0,O=u&R-1,I=this.smoothNoise(b,E),L=this.smoothNoise(b+1,E),H=this.smoothNoise(b,E+1),G=this.smoothNoise(b+1,E+1),N=this.interpolate(I,L,m,R),T=this.interpolate(H,G,m,R);return this.interpolate(N,T,O,R)}static interpolate(_,u,R,b){let m=65536-A.cos[R*1024/b|0]>>1;return(_*(65536-m)>>16)+(u*m>>16)}static smoothNoise(_,u){let R=this.noise(_-1,u-1)+this.noise(_+1,u-1)+this.noise(_-1,u+1)+this.noise(_+1,u+1),b=this.noise(_-1,u)+this.noise(_+1,u)+this.noise(_,u-1)+this.noise(_,u+1),m=this.noise(_,u);return(R/16|0)+(b/8|0)+(m/4|0)}static noise(_,u){let R=_+u*57,b=BigInt(R<<13^R);return Number((b*(b*b*15731n+789221n)+1376312589n&0x7fffffffn)>>19n)&255}static isLocReady(_,u){let R=u0.get(_);if(u==11)u=10;if(u>=5&&u<=8)u=4;return R.shapeModelsAreReady(u)}static addLoc(_,u,R,b,m,E,O,I,L,H,G){let N=E[G][R][b],T=E[G][R+1][b],K=E[G][R+1][b+1],Q=E[G][R][b+1],U=N+T+K+Q>>2,J=u0.get(I),q=R+(b<<7)+(I<<14)+1073741824|0;if(!J.active)q+=-2147483648;q|=0;let w=((H<<6)+L|0)<<24>>24;if(L===g.GROUND_DECOR.id){let V;if(J.anim===-1)V=J.getModel(22,H,N,T,Q,K,-1);else V=new e(_,I,22,L,N,T,Q,K,J.anim,!0);if(m?.addGroundDecoration(V,u,R,b,U,q,w),J.blockwalk&&J.active&&O)O.addFloor(R,b)}else if(L===g.CENTREPIECE_STRAIGHT.id||L===g.CENTREPIECE_DIAGONAL.id){let V;if(J.anim===-1)V=J.getModel(10,H,N,T,Q,K,-1);else V=new e(_,I,10,H,N,T,Q,K,J.anim,!0);if(V){let Y=0;if(L===g.CENTREPIECE_DIAGONAL.id)Y+=256;let n,f;if(H===1||H===3)n=J.length,f=J.width;else n=J.width,f=J.length;m?.addLoc(u,R,b,U,V,q,w,n,f,Y)}if(J.blockwalk&&O)O.addLoc(R,b,J.width,J.length,H,J.blockrange)}else if(L>=g.ROOF_STRAIGHT.id){let V;if(J.anim===-1)V=J.getModel(L,H,N,T,Q,K,-1);else V=new e(_,I,L,H,N,T,Q,K,J.anim,!0);if(m?.addLoc(u,R,b,U,V,q,w,1,1,0),J.blockwalk&&O)O.addLoc(R,b,J.width,J.length,H,J.blockrange)}else if(L===g.WALL_STRAIGHT.id){let V;if(J.anim===-1)V=J.getModel(0,H,N,T,Q,K,-1);else V=new e(_,I,0,H,N,T,Q,K,J.anim,!0);if(m?.addWall(u,R,b,U,i.ROTATION_WALL_TYPE[H],0,V,null,q,w),J.blockwalk&&O)O.addWall(R,b,L,H,J.blockrange)}else if(L===g.WALL_DIAGONAL_CORNER.id){let V;if(J.anim===-1)V=J.getModel(1,H,N,T,Q,K,-1);else V=new e(_,I,1,H,N,T,Q,K,J.anim,!0);if(m?.addWall(u,R,b,U,i.ROTATION_WALL_CORNER_TYPE[H],0,V,null,q,w),J.blockwalk&&O)O.addWall(R,b,L,H,J.blockrange)}else if(L===g.WALL_L.id){let V=H+1&3,Y,n;if(J.anim===-1)Y=J.getModel(2,H+4,N,T,Q,K,-1),n=J.getModel(2,V,N,T,Q,K,-1);else Y=new e(_,I,2,H+4,N,T,Q,K,J.anim,!0),n=new e(_,I,2,V,N,T,Q,K,J.anim,!0);if(m?.addWall(u,R,b,U,i.ROTATION_WALL_TYPE[H],i.ROTATION_WALL_TYPE[V],Y,n,q,w),J.blockwalk&&O)O.addWall(R,b,L,H,J.blockrange)}else if(L===g.WALL_SQUARE_CORNER.id){let V;if(J.anim===-1)V=J.getModel(3,H,N,T,Q,K,-1);else V=new e(_,I,3,H,N,T,Q,K,J.anim,!0);if(m?.addWall(u,R,b,U,i.ROTATION_WALL_CORNER_TYPE[H],0,V,null,q,w),J.blockwalk&&O)O.addWall(R,b,L,H,J.blockrange)}else if(L===g.WALL_DIAGONAL.id){let V;if(J.anim===-1)V=J.getModel(L,H,N,T,Q,K,-1);else V=new e(_,I,L,H,N,T,Q,K,J.anim,!0);if(m?.addLoc(u,R,b,U,V,q,w,1,1,0),J.blockwalk&&O)O.addLoc(R,b,J.width,J.length,H,J.blockrange)}else if(L===g.WALLDECOR_STRAIGHT_NOOFFSET.id){let V;if(J.anim===-1)V=J.getModel(4,0,N,T,Q,K,-1);else V=new e(_,I,4,0,N,T,Q,K,J.anim,!0);m?.setWallDecoration(u,R,b,U,0,0,q,V,w,H*512,i.ROTATION_WALL_TYPE[H])}else if(L===g.WALLDECOR_STRAIGHT_OFFSET.id){let V=16;if(m){let n=m.getWallTypecode(u,R,b);if(n>0)V=u0.get(n>>14&32767).wallwidth}let Y;if(J.anim===-1)Y=J.getModel(4,0,N,T,Q,K,-1);else Y=new e(_,I,4,0,N,T,Q,K,J.anim,!0);m?.setWallDecoration(u,R,b,U,i.WALL_DECORATION_ROTATION_FORWARD_X[H]*V,i.WALL_DECORATION_ROTATION_FORWARD_Z[H]*V,q,Y,w,H*512,i.ROTATION_WALL_TYPE[H])}else if(L===g.WALLDECOR_DIAGONAL_OFFSET.id){let V;if(J.anim===-1)V=J.getModel(4,0,N,T,Q,K,-1);else V=new e(_,I,4,0,N,T,Q,K,J.anim,!0);m?.setWallDecoration(u,R,b,U,0,0,q,V,w,H,256)}else if(L===g.WALLDECOR_DIAGONAL_NOOFFSET.id){let V;if(J.anim===-1)V=J.getModel(4,0,N,T,Q,K,-1);else V=new e(_,I,4,0,N,T,Q,K,J.anim,!0);m?.setWallDecoration(u,R,b,U,0,0,q,V,w,H,512)}else if(L===g.WALLDECOR_DIAGONAL_BOTH.id){let V;if(J.anim===-1)V=J.getModel(4,0,N,T,Q,K,-1);else V=new e(_,I,4,0,N,T,Q,K,J.anim,!0);m?.setWallDecoration(u,R,b,U,0,0,q,V,w,H,768)}}maxTileX;maxTileZ;heightmap;levelTileFlags;levelTileUnderlayIds;levelTileOverlayIds;levelTileOverlayShape;levelTileOverlayRotation;shadow;levelLightmap;blendChroma;blendSaturation;blendLightness;blendLuminance;blendMagnitude;occlusion;constructor(_,u,R,b){this.maxTileX=_,this.maxTileZ=u,this.heightmap=R,this.levelTileFlags=b,this.levelTileUnderlayIds=new M0(4,_,u),this.levelTileOverlayIds=new M0(4,_,u),this.levelTileOverlayShape=new M0(4,_,u),this.levelTileOverlayRotation=new M0(4,_,u),this.occlusion=new D0(4,_+1,u+1),this.shadow=new M0(4,_+1,u+1),this.levelLightmap=new X0(_+1,u+1),this.blendChroma=new Int32Array(u),this.blendSaturation=new Int32Array(u),this.blendLightness=new Int32Array(u),this.blendLuminance=new Int32Array(u),this.blendMagnitude=new Int32Array(u)}build(_,u){for(let R=0;R<4;R++)for(let b=0;b<104;b++)for(let m=0;m<104;m++)if((this.levelTileFlags[R][b][m]&1)===1){let E=R;if((this.levelTileFlags[1][b][m]&2)===2)E--;if(E>=0)u[E]?.addFloor(b,m)}if(i.randomHueOffset+=(Math.random()*5|0)-2,i.randomHueOffset<-8)i.randomHueOffset=-8;else if(i.randomHueOffset>8)i.randomHueOffset=8;if(i.randomLightnessOffset+=(Math.random()*5|0)-2,i.randomLightnessOffset<-16)i.randomLightnessOffset=-16;else if(i.randomLightnessOffset>16)i.randomLightnessOffset=16;for(let R=0;R<4;R++){let b=this.shadow[R],m=96,E=768,O=-50,I=-10,L=-50,G=768*(Math.sqrt(5100)|0)>>8;for(let N=1;N<this.maxTileZ-1;N++)for(let T=1;T<this.maxTileX-1;T++){let K=this.heightmap[R][T+1][N]-this.heightmap[R][T-1][N],Q=this.heightmap[R][T][N+1]-this.heightmap[R][T][N-1],U=Math.sqrt(K*K+Q*Q+65536)|0,J=(K<<8)/U|0,q=65536/U|0,w=(Q<<8)/U|0,V=96+((-50*J+-10*q+-50*w)/G|0),Y=(b[T-1][N]>>2)+(b[T+1][N]>>3)+(b[T][N-1]>>2)+(b[T][N+1]>>3)+(b[T][N]>>1);this.levelLightmap[T][N]=V-Y}for(let N=0;N<this.maxTileZ;N++)this.blendChroma[N]=0,this.blendSaturation[N]=0,this.blendLightness[N]=0,this.blendLuminance[N]=0,this.blendMagnitude[N]=0;for(let N=-5;N<this.maxTileX+5;N++){for(let T=0;T<this.maxTileZ;T++){let K=N+5,Q;if(K>=0&&K<this.maxTileX){let J=this.levelTileUnderlayIds[R][K][T]&255;if(J>0){let q=h0.types[J-1];this.blendChroma[T]+=q.chroma,this.blendSaturation[T]+=q.saturation,this.blendLightness[T]+=q.lightness,this.blendLuminance[T]+=q.luminance,Q=this.blendMagnitude[T]++}}let U=N-5;if(U>=0&&U<this.maxTileX){let J=this.levelTileUnderlayIds[R][U][T]&255;if(J>0){let q=h0.types[J-1];this.blendChroma[T]-=q.chroma,this.blendSaturation[T]-=q.saturation,this.blendLightness[T]-=q.lightness,this.blendLuminance[T]-=q.luminance,Q=this.blendMagnitude[T]--}}}if(N>=1&&N<this.maxTileX-1){let T=0,K=0,Q=0,U=0,J=0;for(let q=-5;q<this.maxTileZ+5;q++){let w=q+5;if(w>=0&&w<this.maxTileZ)T+=this.blendChroma[w],K+=this.blendSaturation[w],Q+=this.blendLightness[w],U+=this.blendLuminance[w],J+=this.blendMagnitude[w];let V=q-5;if(V>=0&&V<this.maxTileZ)T-=this.blendChroma[V],K-=this.blendSaturation[V],Q-=this.blendLightness[V],U-=this.blendLuminance[V],J-=this.blendMagnitude[V];if(q>=1&&q<this.maxTileZ-1&&(!i.lowMemory||(this.levelTileFlags[R][N][q]&16)===0&&this.getDrawLevel(R,N,q)===i.levelBuilt)){let Y=this.levelTileUnderlayIds[R][N][q]&255,n=this.levelTileOverlayIds[R][N][q]&255;if(Y>0||n>0){let f=this.heightmap[R][N][q],Z=this.heightmap[R][N+1][q],h=this.heightmap[R][N+1][q+1],D=this.heightmap[R][N][q+1],j=this.levelLightmap[N][q],W=this.levelLightmap[N+1][q],M=this.levelLightmap[N+1][q+1],X=this.levelLightmap[N][q+1],P=-1,r=-1;if(Y>0){let t=T*256/U|0,a=K/J|0,x=Q/J|0;P=this.hsl24to16(t,a,x);let E0=t+i.randomHueOffset&255;if(x+=i.randomLightnessOffset,x<0)x=0;else if(x>255)x=255;r=this.hsl24to16(E0,a,x)}if(R>0){let t=Y!==0||this.levelTileOverlayShape[R][N][q]===0;if(n>0&&!h0.types[n-1].occlude)t=!1;if(t&&f===Z&&f===h&&f===D)this.occlusion[R][N][q]|=2340}let B=0;if(P!==-1)B=A.hslPal[i.mulHSL(r,96)];if(n===0)_?.setTile(R,N,q,0,0,-1,f,Z,h,D,i.mulHSL(P,j),i.mulHSL(P,W),i.mulHSL(P,M),i.mulHSL(P,X),0,0,0,0,B,0);else{let t=this.levelTileOverlayShape[R][N][q]+1,a=this.levelTileOverlayRotation[R][N][q],x=h0.types[n-1],E0=x.texture,_0,H0;if(E0>=0)H0=A.getAverageTextureRGB(E0),_0=-1;else if(x.rgb===16711935)H0=0,_0=-2,E0=-1;else _0=this.hsl24to16(x.hue,x.saturation,x.lightness),H0=A.hslPal[this.adjustLightness(x.hsl,96)];_?.setTile(R,N,q,t,a,E0,f,Z,h,D,i.mulHSL(P,j),i.mulHSL(P,W),i.mulHSL(P,M),i.mulHSL(P,X),this.adjustLightness(_0,j),this.adjustLightness(_0,W),this.adjustLightness(_0,M),this.adjustLightness(_0,X),B,H0)}}}}}}for(let N=1;N<this.maxTileZ-1;N++)for(let T=1;T<this.maxTileX-1;T++)_?.setDrawLevel(R,T,N,this.getDrawLevel(R,T,N))}if(!i.fullbright)_?.buildModels(64,768,-50,-10,-50);for(let R=0;R<this.maxTileX;R++)for(let b=0;b<this.maxTileZ;b++)if((this.levelTileFlags[1][R][b]&2)===2)_?.setBridge(R,b);if(!i.fullbright){let R=1,b=2,m=4;for(let E=0;E<4;E++){if(E>0)R<<=3,b<<=3,m<<=3;for(let O=0;O<=E;O++)for(let I=0;I<=this.maxTileZ;I++)for(let L=0;L<=this.maxTileX;L++){if((this.occlusion[O][L][I]&R)!==0){let H=I,G=I,N=O,T=O;while(H>0&&(this.occlusion[O][L][H-1]&R)!==0)H--;while(G<this.maxTileZ&&(this.occlusion[O][L][G+1]&R)!==0)G++;_:while(N>0){for(let Q=H;Q<=G;Q++)if((this.occlusion[N-1][L][Q]&R)===0)break _;N--}_:while(T<E){for(let Q=H;Q<=G;Q++)if((this.occlusion[T+1][L][Q]&R)===0)break _;T++}if((T+1-N)*(G+1-H)>=8){let Q=this.heightmap[T][L][H]-240,U=this.heightmap[N][L][H];k.addOccluder(E,1,L*128,Q,H*128,L*128,U,G*128+128);for(let J=N;J<=T;J++)for(let q=H;q<=G;q++)this.occlusion[J][L][q]&=~R}}if((this.occlusion[O][L][I]&b)!==0){let H=L,G=L,N=O,T=O;while(H>0&&(this.occlusion[O][H-1][I]&b)!==0)H--;while(G<this.maxTileX&&(this.occlusion[O][G+1][I]&b)!==0)G++;_:while(N>0){for(let Q=H;Q<=G;Q++)if((this.occlusion[N-1][Q][I]&b)===0)break _;N--}_:while(T<E){for(let Q=H;Q<=G;Q++)if((this.occlusion[T+1][Q][I]&b)===0)break _;T++}if((T+1-N)*(G+1-H)>=8){let Q=this.heightmap[T][H][I]-240,U=this.heightmap[N][H][I];k.addOccluder(E,2,H*128,Q,I*128,G*128+128,U,I*128);for(let J=N;J<=T;J++)for(let q=H;q<=G;q++)this.occlusion[J][q][I]&=~b}}if((this.occlusion[O][L][I]&m)!==0){let H=L,G=L,N=I,T=I;while(N>0&&(this.occlusion[O][L][N-1]&m)!==0)N--;while(T<this.maxTileZ&&(this.occlusion[O][L][T+1]&m)!==0)T++;_:while(H>0){for(let K=N;K<=T;K++)if((this.occlusion[O][H-1][K]&m)===0)break _;H--}_:while(G<this.maxTileX){for(let K=N;K<=T;K++)if((this.occlusion[O][G+1][K]&m)===0)break _;G++}if((G+1-H)*(T+1-N)>=4){let K=this.heightmap[O][H][N];k.addOccluder(E,4,H*128,K,N*128,G*128+128,K,T*128+128);for(let Q=H;Q<=G;Q++)for(let U=N;U<=T;U++)this.occlusion[O][Q][U]&=~m}}}}}}spreadHeight(_,u,R,b){for(let m=_;m<_+R;m++)for(let E=u;E<u+b;E++)if(E>=0&&E<this.maxTileX&&m>=0&&m<this.maxTileZ){if(this.shadow[0][E][m]=127,u==E&&E>0)this.heightmap[0][E][m]=this.heightmap[0][E-1][m];if(u+b==E&&E<this.maxTileX-1)this.heightmap[0][E][m]=this.heightmap[0][E+1][m];if(_==m&&m>0)this.heightmap[0][E][m]=this.heightmap[0][E][m-1];if(_+R==m&&m<this.maxTileZ-1)this.heightmap[0][E][m]=this.heightmap[0][E][m+1]}}loadGround(_,u,R,b,m){let E=new z(m);for(let O=0;O<4;O++)for(let I=0;I<64;I++)for(let L=0;L<64;L++){let H=I+R,G=L+b,N;if(H>=0&&H<104&&G>=0&&G<104){this.levelTileFlags[O][H][G]=0;while(!0){if(N=E.g1(),N===0){if(O===0)this.heightmap[0][H][G]=-i.perlin(H+_+932731,G+556238+u)*8;else this.heightmap[O][H][G]=this.heightmap[O-1][H][G]-240;break}if(N===1){let T=E.g1();if(T===1)T=0;if(O===0)this.heightmap[0][H][G]=-T*8;else this.heightmap[O][H][G]=this.heightmap[O-1][H][G]-T*8;break}if(N<=49)this.levelTileOverlayIds[O][H][G]=E.g1b(),this.levelTileOverlayShape[O][H][G]=((N-2)/4|0)<<24>>24,this.levelTileOverlayRotation[O][H][G]=(N-2&3)<<24>>24;else if(N<=81)this.levelTileFlags[O][H][G]=N-49<<24>>24;else this.levelTileUnderlayIds[O][H][G]=N-81<<24>>24}}else while(!0){if(N=E.g1(),N===0)break;if(N===1){E.g1();break}if(N<=49)E.g1()}}}static locsAreReady(_,u,R){let b=!0,m=new z(_),E=-1;while(!0){let O=m.gsmarts();if(O==0)break;E+=O;let I=0,L=!1;while(!0)if(L){if(m.gsmarts()==0)break;m.g1()}else{let H=m.gsmarts();if(H==0)break;I+=H-1;let G=I&63,N=I>>6&63,T=m.g1()>>2,K=u+N,Q=R+G;if(K>0&&Q>0&&K<103&&Q<103){let U=u0.get(E);if(T!=22||!i.lowMemory||U.active||U.forcedecor){if(!U.modelsAreReady())b=!1;L=!0}}}}return b}static prefetchLocs(_,u){let R=-1;while(!0){let b=_.gsmarts();if(b==0)return;R+=b,u0.get(R).prefetch(u);while(!0){if(_.gsmarts()==0)break;_.g1()}}}loadLocations(_,u,R,b,m,E){let O=new z(b),I=-1;while(!0){let L=O.gsmarts();if(L===0)return;I+=L;let H=0;while(!0){let G=O.gsmarts();if(G===0)break;H+=G-1;let N=H&63,T=H>>6&63,K=H>>12,Q=O.g1(),U=Q>>2,J=Q&3,q=T+m,w=N+E;if(q>0&&w>0&&q<104-1&&w<104-1){let V=K;if((this.levelTileFlags[1][q][w]&2)===2)V=K-1;let Y=null;if(V>=0)Y=R[V];this.addLoc(_,K,q,w,u,Y,I,U,J)}}}}addLoc(_,u,R,b,m,E,O,I,L){if(i.lowMemory){if((this.levelTileFlags[u][R][b]&16)!==0)return;if(this.getDrawLevel(u,R,b)!==i.levelBuilt)return}let H=this.heightmap[u][R][b],G=this.heightmap[u][R+1][b],N=this.heightmap[u][R+1][b+1],T=this.heightmap[u][R][b+1],K=H+G+N+T>>2,Q=u0.get(O),U=R+(b<<7)+(O<<14)+1073741824|0;if(!Q.active)U+=-2147483648;U|=0;let J=((L<<6)+I|0)<<24>>24;if(I===g.GROUND_DECOR.id){if(!i.lowMemory||Q.active||Q.forcedecor){let q;if(Q.anim===-1)q=Q.getModel(22,L,H,G,N,T,-1);else q=new e(_,O,22,I,H,G,N,T,Q.anim,!0);if(m?.addGroundDecoration(q,u,R,b,K,U,J),Q.blockwalk&&Q.active&&E)E.addFloor(R,b)}}else if(I===g.CENTREPIECE_STRAIGHT.id||I===g.CENTREPIECE_DIAGONAL.id){let q;if(Q.anim===-1)q=Q.getModel(10,L,H,G,N,T,-1);else q=new e(_,O,10,L,H,G,N,T,Q.anim,!0);if(q){let w=0;if(I===g.CENTREPIECE_DIAGONAL.id)w+=256;let V,Y;if(L===1||L===3)V=Q.length,Y=Q.width;else V=Q.width,Y=Q.length;if(m?.addLoc(u,R,b,K,q,U,J,V,Y,w)&&Q.shadow){let n;if(q instanceof $)n=q;else n=Q.getModel(10,L,H,G,N,T,-1);if(n)for(let f=0;f<=V;f++)for(let Z=0;Z<=Y;Z++){let h=n.radius/4|0;if(h>30)h=30;if(h>this.shadow[u][R+f][b+Z])this.shadow[u][R+f][b+Z]=h<<24>>24}}}if(Q.blockwalk&&E)E.addLoc(R,b,Q.width,Q.length,L,Q.blockrange)}else if(I>=g.ROOF_STRAIGHT.id){let q;if(Q.anim===-1)q=Q.getModel(I,L,H,G,N,T,-1);else q=new e(_,O,I,L,H,G,N,T,Q.anim,!0);if(m?.addLoc(u,R,b,K,q,U,J,1,1,0),I>=g.ROOF_STRAIGHT.id&&I<=g.ROOF_FLAT.id&&I!==g.ROOF_DIAGONAL_WITH_ROOFEDGE.id&&u>0)this.occlusion[u][R][b]|=2340;if(Q.blockwalk&&E)E.addLoc(R,b,Q.width,Q.length,L,Q.blockrange)}else if(I===g.WALL_STRAIGHT.id){let q;if(Q.anim===-1)q=Q.getModel(0,L,H,G,N,T,-1);else q=new e(_,O,0,L,H,G,N,T,Q.anim,!0);if(m?.addWall(u,R,b,K,i.ROTATION_WALL_TYPE[L],0,q,null,U,J),L===0){if(Q.shadow)this.shadow[u][R][b]=50,this.shadow[u][R][b+1]=50;if(Q.occlude)this.occlusion[u][R][b]|=585}else if(L===1){if(Q.shadow)this.shadow[u][R][b+1]=50,this.shadow[u][R+1][b+1]=50;if(Q.occlude)this.occlusion[u][R][b+1]|=1170}else if(L===2){if(Q.shadow)this.shadow[u][R+1][b]=50,this.shadow[u][R+1][b+1]=50;if(Q.occlude)this.occlusion[u][R+1][b]|=585}else if(L===3){if(Q.shadow)this.shadow[u][R][b]=50,this.shadow[u][R+1][b]=50;if(Q.occlude)this.occlusion[u][R][b]|=1170}if(Q.blockwalk&&E)E.addWall(R,b,I,L,Q.blockrange);if(Q.wallwidth!==16)m?.setWallDecorationOffset(u,R,b,Q.wallwidth)}else if(I===g.WALL_DIAGONAL_CORNER.id){let q;if(Q.anim===-1)q=Q.getModel(1,L,H,G,N,T,-1);else q=new e(_,O,1,L,H,G,N,T,Q.anim,!0);if(m?.addWall(u,R,b,K,i.ROTATION_WALL_CORNER_TYPE[L],0,q,null,U,J),Q.shadow){if(L===0)this.shadow[u][R][b+1]=50;else if(L===1)this.shadow[u][R+1][b+1]=50;else if(L===2)this.shadow[u][R+1][b]=50;else if(L===3)this.shadow[u][R][b]=50}if(Q.blockwalk&&E)E.addWall(R,b,I,L,Q.blockrange)}else if(I===g.WALL_L.id){let q=L+1&3,w,V;if(Q.anim===-1)w=Q.getModel(2,L+4,H,G,N,T,-1),V=Q.getModel(2,q,H,G,N,T,-1);else w=new e(_,O,2,L+4,H,G,N,T,Q.anim,!0),V=new e(_,O,2,q,H,G,N,T,Q.anim,!0);if(m?.addWall(u,R,b,K,i.ROTATION_WALL_TYPE[L],i.ROTATION_WALL_TYPE[q],w,V,U,J),Q.occlude){if(L===0)this.occlusion[u][R][b]|=265,this.occlusion[u][R][b+1]|=1170;else if(L===1)this.occlusion[u][R][b+1]|=1170,this.occlusion[u][R+1][b]|=585;else if(L===2)this.occlusion[u][R+1][b]|=585,this.occlusion[u][R][b]|=1170;else if(L===3)this.occlusion[u][R][b]|=1170,this.occlusion[u][R][b]|=585}if(Q.blockwalk&&E)E.addWall(R,b,I,L,Q.blockrange);if(Q.wallwidth!==16)m?.setWallDecorationOffset(u,R,b,Q.wallwidth)}else if(I===g.WALL_SQUARE_CORNER.id){let q;if(Q.anim===-1)q=Q.getModel(3,L,H,G,N,T,-1);else q=new e(_,O,3,L,H,G,N,T,Q.anim,!0);if(m?.addWall(u,R,b,K,i.ROTATION_WALL_CORNER_TYPE[L],0,q,null,U,J),Q.shadow){if(L===0)this.shadow[u][R][b+1]=50;else if(L===1)this.shadow[u][R+1][b+1]=50;else if(L===2)this.shadow[u][R+1][b]=50;else if(L===3)this.shadow[u][R][b]=50}if(Q.blockwalk&&E)E.addWall(R,b,I,L,Q.blockrange)}else if(I===g.WALL_DIAGONAL.id){let q;if(Q.anim===-1)q=Q.getModel(I,L,H,G,N,T,-1);else q=new e(_,O,I,L,H,G,N,T,Q.anim,!0);if(m?.addLoc(u,R,b,K,q,U,J,1,1,0),Q.blockwalk&&E)E.addLoc(R,b,Q.width,Q.length,L,Q.blockrange)}else if(I===g.WALLDECOR_STRAIGHT_NOOFFSET.id){let q;if(Q.anim===-1)q=Q.getModel(4,0,H,G,N,T,-1);else q=new e(_,O,4,0,H,G,N,T,Q.anim,!0);m?.setWallDecoration(u,R,b,K,0,0,U,q,J,L*512,i.ROTATION_WALL_TYPE[L])}else if(I===g.WALLDECOR_STRAIGHT_OFFSET.id){let q=16;if(m){let V=m.getWallTypecode(u,R,b);if(V>0)q=u0.get(V>>14&32767).wallwidth}let w;if(Q.anim===-1)w=Q.getModel(4,0,H,G,N,T,-1);else w=new e(_,O,4,0,H,G,N,T,Q.anim,!0);m?.setWallDecoration(u,R,b,K,i.WALL_DECORATION_ROTATION_FORWARD_X[L]*q,i.WALL_DECORATION_ROTATION_FORWARD_Z[L]*q,U,w,J,L*512,i.ROTATION_WALL_TYPE[L])}else if(I===g.WALLDECOR_DIAGONAL_OFFSET.id){let q;if(Q.anim===-1)q=Q.getModel(4,0,H,G,N,T,-1);else q=new e(_,O,4,0,H,G,N,T,Q.anim,!0);m?.setWallDecoration(u,R,b,K,0,0,U,q,J,L,256)}else if(I===g.WALLDECOR_DIAGONAL_NOOFFSET.id){let q;if(Q.anim===-1)q=Q.getModel(4,0,H,G,N,T,-1);else q=new e(_,O,4,0,H,G,N,T,Q.anim,!0);m?.setWallDecoration(u,R,b,K,0,0,U,q,J,L,512)}else if(I===g.WALLDECOR_DIAGONAL_BOTH.id){let q;if(Q.anim===-1)q=Q.getModel(4,0,H,G,N,T,-1);else q=new e(_,O,4,0,H,G,N,T,Q.anim,!0);m?.setWallDecoration(u,R,b,K,0,0,U,q,J,L,768)}}getDrawLevel(_,u,R){if((this.levelTileFlags[_][u][R]&8)===0)return _<=0||(this.levelTileFlags[1][u][R]&2)===0?_:_-1;return 0}hsl24to16(_,u,R){if(R>179)u=u/2|0;if(R>192)u=u/2|0;if(R>217)u=u/2|0;if(R>243)u=u/2|0;return((_/4|0)<<10)+((u/32|0)<<7)+(R/2|0)}static mulHSL(_,u){if(_===-1)return 12345678;if(u=u*(_&127)/128|0,u<2)u=2;else if(u>126)u=126;return(_&65408)+u}adjustLightness(_,u){if(_===-2)return 12345678;if(_===-1){if(u<0)u=0;else if(u>127)u=127;return 127-u}else{if(u=u*(_&127)/128|0,u<2)u=2;else if(u>126)u=126;return(_&65408)+u}}}class p0 extends Y0{x=0;z=0;yaw=0;needsForwardDrawPadding=!1;size=1;readyanim=-1;turnanim=-1;walkanim=-1;walkanim_b=-1;walkanim_l=-1;walkanim_r=-1;runanim=-1;chatMessage=null;chatTimer=100;chatColour=0;chatEffect=0;combatCycle=-1000;damageValues=new Int32Array(4);damageTypes=new Int32Array(4);damageCycles=new Int32Array(4);health=0;totalHealth=0;targetId=-1;targetTileX=0;targetTileZ=0;secondarySeqId=-1;secondarySeqFrame=0;secondarySeqCycle=0;primarySeqId=-1;primarySeqFrame=0;primarySeqCycle=0;primarySeqDelay=0;primarySeqLoop=0;spotanimId=-1;spotanimFrame=0;spotanimCycle=0;spotanimLastCycle=0;spotanimHeight=0;forceMoveStartSceneTileX=0;forceMoveEndSceneTileX=0;forceMoveStartSceneTileZ=0;forceMoveEndSceneTileZ=0;forceMoveEndCycle=0;forceMoveStartCycle=0;forceMoveFaceDirection=0;cycle=0;height=0;dstYaw=0;routeLength=0;routeTileX=new Int32Array(10);routeTileZ=new Int32Array(10);routeRun=new p(10,!1);seqDelayMove=0;preanimRouteLength=0;move(_,u,R){if(this.primarySeqId!==-1&&l.types[this.primarySeqId].postanim_move===1)this.primarySeqId=-1;if(!_){let b=u-this.routeTileX[0],m=R-this.routeTileZ[0];if(b>=-8&&b<=8&&m>=-8&&m<=8){if(this.routeLength<9)this.routeLength++;for(let E=this.routeLength;E>0;E--)this.routeTileX[E]=this.routeTileX[E-1],this.routeTileZ[E]=this.routeTileZ[E-1],this.routeRun[E]=this.routeRun[E-1];this.routeTileX[0]=u,this.routeTileZ[0]=R,this.routeRun[0]=!1;return}}this.routeLength=0,this.preanimRouteLength=0,this.seqDelayMove=0,this.routeTileX[0]=u,this.routeTileZ[0]=R,this.x=this.routeTileX[0]*128+this.size*64,this.z=this.routeTileZ[0]*128+this.size*64}step(_,u){let R=this.routeTileX[0],b=this.routeTileZ[0];if(u===0)R--,b++;else if(u===1)b++;else if(u===2)R++,b++;else if(u===3)R--;else if(u===4)R++;else if(u===5)R--,b--;else if(u===6)b--;else if(u===7)R++,b--;if(this.primarySeqId!==-1&&l.types[this.primarySeqId].postanim_move===1)this.primarySeqId=-1;if(this.routeLength<9)this.routeLength++;for(let m=this.routeLength;m>0;m--)this.routeTileX[m]=this.routeTileX[m-1],this.routeTileZ[m]=this.routeTileZ[m-1],this.routeRun[m]=this.routeRun[m-1];this.routeTileX[0]=R,this.routeTileZ[0]=b,this.routeRun[0]=_}clearRoute(){this.routeLength=0,this.preanimRouteLength=0}hit(_,u,R){for(let b=0;b<4;b++)if(this.damageCycles[b]<=_){this.damageValues[b]=R,this.damageTypes[b]=u,this.damageCycles[b]=_+70;return}}}class L1 extends p0{type=null;getModel(){if(this.type==null)return null;let _=this.getAnimatedModel();if(_==null)return null;if(this.height=_.minY,this.spotanimId!=-1&&this.spotanimFrame!=-1){let u=q0.types[this.spotanimId],R=u.getModel();if(R!=null){let b=$.modelShareColored(R,!0,!u.animHasAlpha,!1);if(b.translate(-this.spotanimHeight,0,0),b.createLabelReferences(),u.seq&&u.seq.frames)b.applyTransform(u.seq.frames[this.spotanimFrame]);if(b.labelFaces=null,b.labelVertices=null,u.resizeh!=128||u.resizev!=128)b.scale(u.resizev,u.resizeh,u.resizeh);b.calculateNormals(u.ambient+64,u.contrast+850,-30,-50,-30,!0);let m=[_,b];_=$.modelFromModelsBounds(m,2)}}if(this.type.size==1)_.picking=!0;return _}getAnimatedModel(){if(!this.type)return null;if(this.primarySeqId<0||this.primarySeqDelay!=0){let _=l.types[this.secondarySeqId],u=-1;if(this.secondarySeqId>=0&&_.frames)u=_.frames[this.secondarySeqFrame];return this.type.getModel(u,-1,null)}else{let _=l.types[this.primarySeqId],u=-1;if(_.frames)u=_.frames[this.primarySeqFrame];let R=l.types[this.secondarySeqId],b=-1;if(this.secondarySeqId>=0&&this.secondarySeqId!=this.readyanim&&R.frames)b=R.frames[this.secondarySeqFrame];return this.type.getModel(u,b,_.walkmerge)}}isVisible(){return this.type!==null}}class T0 extends p0{static TORSO_RECOLORS=[9104,10275,7595,3610,7975,8526,918,38802,24466,10145,58654,5027,1457,16565,34991,25486];static DESIGN_IDK_COLORS=[[6798,107,10283,16,4797,7744,5799,4634,33697,22433,2983,54193],[8741,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003,25239],[25238,8742,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003],[4626,11146,6439,12,4758,10270],[4550,4537,5681,5673,5790,6806,8076,4574]];name=null;visible=!1;gender=0;headicons=0;appearance=new Uint16Array(12);colour=new Uint16Array(5);combatLevel=0;hash=0n;lowMemory=!1;modelCacheKey=-1n;static modelCache=new F0(200);y=0;locStartCycle=0;locStopCycle=0;locOffsetX=0;locOffsetY=0;locOffsetZ=0;locModel=null;minTileX=0;minTileZ=0;maxTileX=0;maxTileZ=0;read(_){_.pos=0,this.gender=_.g1(),this.headicons=_.g1();for(let u=0;u<12;u++){let R=_.g1();if(R===0)this.appearance[u]=0;else this.appearance[u]=(R<<8)+_.g1()}for(let u=0;u<5;u++){let R=_.g1();if(R<0||R>=T0.DESIGN_IDK_COLORS[u].length)R=0;this.colour[u]=R}if(this.readyanim=_.g2(),this.readyanim===65535)this.readyanim=-1;if(this.turnanim=_.g2(),this.turnanim===65535)this.turnanim=-1;if(this.walkanim=_.g2(),this.walkanim===65535)this.walkanim=-1;if(this.walkanim_b=_.g2(),this.walkanim_b===65535)this.walkanim_b=-1;if(this.walkanim_l=_.g2(),this.walkanim_l===65535)this.walkanim_l=-1;if(this.walkanim_r=_.g2(),this.walkanim_r===65535)this.walkanim_r=-1;if(this.runanim=_.g2(),this.runanim===65535)this.runanim=-1;this.name=c.formatName(c.fromBase37(_.g8())),this.combatLevel=_.g1(),this.visible=!0,this.hash=0n;for(let u=0;u<12;u++)if(this.hash<<=0x4n,this.appearance[u]>=256)this.hash+=BigInt(this.appearance[u])-256n;if(this.appearance[0]>=256)this.hash+=BigInt(this.appearance[0])-256n>>4n;if(this.appearance[1]>=256)this.hash+=BigInt(this.appearance[1])-256n>>8n;for(let u=0;u<5;u++)this.hash<<=0x3n,this.hash+=BigInt(this.colour[u]);this.hash<<=0x1n,this.hash+=BigInt(this.gender)}getModel(_){if(!this.visible)return null;let u=this.getAnimatedModel();if(u==null)return null;if(this.height=u.minY,u.picking=!0,this.lowMemory)return u;if(this.spotanimId!=-1&&this.spotanimFrame!=-1){let R=q0.types[this.spotanimId],b=R.getModel();if(b!=null){let m=$.modelShareColored(b,!0,!R.animHasAlpha,!1);if(m.translate(-this.spotanimHeight,0,0),m.createLabelReferences(),R.seq&&R.seq.frames)m.applyTransform(R.seq.frames[this.spotanimFrame]);if(m.labelFaces=null,m.labelVertices=null,R.resizeh!=128||R.resizev!=128)m.scale(R.resizev,R.resizeh,R.resizeh);m.calculateNormals(R.ambient+64,R.contrast+850,-30,-50,-30,!0);let E=[u,m];u=$.modelFromModelsBounds(E,2)}}if(this.locModel!=null){if(_>=this.locStopCycle)this.locModel=null;if(_>=this.locStartCycle&&_<this.locStopCycle){let R=this.locModel;if(R){if(R.translate(this.locOffsetY-this.y,this.locOffsetX-this.x,this.locOffsetZ-this.z),this.dstYaw==512)R.rotateY90(),R.rotateY90(),R.rotateY90();else if(this.dstYaw==1024)R.rotateY90(),R.rotateY90();else if(this.dstYaw==1536)R.rotateY90();let b=[u,R];if(u=$.modelFromModelsBounds(b,2),this.dstYaw==512)R.rotateY90();else if(this.dstYaw==1024)R.rotateY90(),R.rotateY90();else if(this.dstYaw==1536)R.rotateY90(),R.rotateY90(),R.rotateY90();R.translate(this.y-this.locOffsetY,super.x-this.locOffsetX,super.z-this.locOffsetZ)}}}return u.picking=!0,u}getAnimatedModel(){let _=this.hash,u=-1,R=-1,b=-1,m=-1;if(this.primarySeqId>=0&&this.primarySeqDelay===0){let I=l.types[this.primarySeqId];if(I.frames)u=I.frames[this.primarySeqFrame];if(this.secondarySeqId>=0&&this.secondarySeqId!==this.readyanim){let L=l.types[this.secondarySeqId].frames;if(L)R=L[this.secondarySeqFrame]}if(I.righthand>=0)b=I.righthand,_+=BigInt(b-this.appearance[5])<<40n;if(I.lefthand>=0)m=I.lefthand,_+=BigInt(m-this.appearance[3])<<48n}else if(this.secondarySeqId>=0){let I=l.types[this.secondarySeqId].frames;if(I)u=I[this.secondarySeqFrame]}let E=T0.modelCache?.get(_);if(!E){let I=!1;for(let L=0;L<12;L++){let H=this.appearance[L];if(m>=0&&L==3)H=m;if(b>=0&&L==5)H=b;if(H>=256&&H<512&&!J0.types[H-256].modelIsReady())I=!0;if(H>=512&&!d.get(H-512).wornModelIsReady(this.gender))I=!0}if(I){if(this.modelCacheKey!==-1n&&T0.modelCache)E=T0.modelCache.get(this.hash);if(E==null)return null}}if(!E){let I=new p(12,null),L=0;for(let H=0;H<12;H++){let G=this.appearance[H];if(m>=0&&H===3)G=m;if(b>=0&&H===5)G=b;if(G>=256&&G<512){let N=J0.types[G-256].getModel();if(N)I[L++]=N}if(G>=512){let T=d.get(G-512).getWornModel(this.gender);if(T)I[L++]=T}}E=$.modelFromModels(I,L);for(let H=0;H<5;H++){if(this.colour[H]===0)continue;if(E.recolour(T0.DESIGN_IDK_COLORS[H][0],T0.DESIGN_IDK_COLORS[H][this.colour[H]]),H===1)E.recolour(T0.TORSO_RECOLORS[0],T0.TORSO_RECOLORS[this.colour[H]])}E.createLabelReferences(),E.calculateNormals(64,850,-30,-50,-30,!0),T0.modelCache?.put(_,E),this.modelCacheKey=_}if(this.lowMemory)return E;let O=$.modelShareAlpha(E,!0);if(u!==-1&&R!==-1)O.applyTransforms(u,R,l.types[this.primarySeqId].walkmerge);else if(u!==-1)O.applyTransform(u);return O.calculateBoundsCylinder(),O.labelFaces=null,O.labelVertices=null,O}getHeadModel(){if(!this.visible)return null;let _=!1;for(let m=0;m<12;m++){let E=this.appearance[m];if(E>=256&&E<512&&!J0.types[E-256].headModelIsReady())_=!0;if(E>=512&&!d.get(E-512).headModelIsReady(this.gender))_=!0}if(_)return null;let u=new p(12,null),R=0;for(let m=0;m<12;m++){let E=this.appearance[m];if(E>=256&&E<512){let O=J0.types[E-256].getHeadModel();if(O)u[R++]=O}if(E>=512){let O=d.get(E-512).getHeadModel(this.gender);if(O)u[R++]=O}}let b=$.modelFromModels(u,R);for(let m=0;m<5;m++){if(this.colour[m]===0)continue;if(b.recolour(T0.DESIGN_IDK_COLORS[m][0],T0.DESIGN_IDK_COLORS[m][this.colour[m]]),m===1)b.recolour(T0.TORSO_RECOLORS[0],T0.TORSO_RECOLORS[this.colour[m]])}return b}isVisible(){return this.visible}}class H1 extends A0{endTime=-1;newType=0;newAngle=0;newShape=0;level=0;layer=0;x=0;z=0;oldType=0;oldAngle=0;oldShape=0;startTime=0}class y0 extends Y0{index;count;constructor(_,u){super();this.index=_,this.count=u}getModel(){return d.get(this.index).getModel(this.count)}}class G1 extends Y0{spotanim;projLevel;srcX;srcZ;srcY;projOffsetY;startCycle;lastCycle;peakPitch;projArc;projTarget;mobile=!1;x=0;z=0;y=0;projVelocityX=0;projVelocityZ=0;projVelocity=0;projVelocityY=0;accelerationY=0;yaw=0;pitch=0;seqFrame=0;seqCycle=0;constructor(_,u,R,b,m,E,O,I,L,H,G){super();this.spotanim=q0.types[_],this.projLevel=u,this.srcX=R,this.srcZ=m,this.srcY=b,this.startCycle=E,this.lastCycle=O,this.peakPitch=I,this.projArc=L,this.projTarget=H,this.projOffsetY=G}updateVelocity(_,u,R,b){if(!this.mobile){let E=_-this.srcX,O=R-this.srcZ,I=Math.sqrt(E*E+O*O);this.x=this.srcX+E*this.projArc/I,this.z=this.srcZ+O*this.projArc/I,this.y=this.srcY}let m=this.lastCycle+1-b;if(this.projVelocityX=(_-this.x)/m,this.projVelocityZ=(R-this.z)/m,this.projVelocity=Math.sqrt(this.projVelocityX*this.projVelocityX+this.projVelocityZ*this.projVelocityZ),!this.mobile)this.projVelocityY=-this.projVelocity*Math.tan(this.peakPitch*0.02454369);this.accelerationY=(u-this.y-this.projVelocityY*m)*2/(m*m)}update(_){if(this.mobile=!0,this.x+=this.projVelocityX*_,this.z+=this.projVelocityZ*_,this.y+=this.projVelocityY*_+this.accelerationY*0.5*_*_,this.projVelocityY+=this.accelerationY*_,this.yaw=(Math.atan2(this.projVelocityX,this.projVelocityZ)*325.949+1024|0)&2047,this.pitch=(Math.atan2(this.projVelocityY,this.projVelocity)*325.949|0)&2047,!this.spotanim.seq)return;this.seqCycle+=_;while(this.seqCycle>this.spotanim.seq.getFrameDuration(this.seqFrame))if(this.seqCycle-=this.spotanim.seq.getFrameDuration(this.seqFrame)+1,this.seqFrame++,this.seqFrame>=this.spotanim.seq.frameCount)this.seqFrame=0}getModel(){let _=this.spotanim.getModel();if(!_)return null;let u=$.modelShareColored(_,!0,!this.spotanim.animHasAlpha,!1);if(this.spotanim.seq&&this.spotanim.seq.frames)u.createLabelReferences(),u.applyTransform(this.spotanim.seq.frames[this.seqFrame]),u.labelFaces=null,u.labelVertices=null;if(this.spotanim.resizeh!==128||this.spotanim.resizev!==128)u.scale(this.spotanim.resizeh,this.spotanim.resizev,this.spotanim.resizeh);return u.rotateX(this.pitch),u.calculateNormals(64+this.spotanim.ambient,850+this.spotanim.contrast,-30,-50,-30,!0),u}}class N1 extends Y0{spotType;spotLevel;x;z;y;startCycle;seqComplete=!1;seqFrame=0;seqCycle=0;constructor(_,u,R,b,m,E,O){super();this.spotType=q0.types[_],this.spotLevel=u,this.x=R,this.z=b,this.y=m,this.startCycle=E+O}update(_){if(!this.spotType.seq)return;for(this.seqCycle+=_;this.seqCycle>this.spotType.seq.getFrameDuration(this.seqFrame);)if(this.seqCycle-=this.spotType.seq.getFrameDuration(this.seqFrame)+1,this.seqFrame++,this.seqFrame>=this.spotType.seq.frameCount)this.seqFrame=0,this.seqComplete=!0}getModel(){let _=this.spotType.getModel();if(!_)return null;let u=$.modelShareColored(_,!0,!this.spotType.animHasAlpha,!1);if(!this.seqComplete&&this.spotType.seq&&this.spotType.seq.frames)u.createLabelReferences(),u.applyTransform(this.spotType.seq.frames[this.seqFrame]),u.labelFaces=null,u.labelVertices=null;if(this.spotType.resizeh!==128||this.spotType.resizev!==128)u.scale(this.spotType.resizeh,this.spotType.resizev,this.spotType.resizeh);if(this.spotType.angle!==0){if(this.spotType.angle===90)u.rotateY90();else if(this.spotType.angle===180)u.rotateY90(),u.rotateY90();else if(this.spotType.angle===270)u.rotateY90(),u.rotateY90(),u.rotateY90()}return u.calculateNormals(64+this.spotType.ambient,850+this.spotType.contrast,-30,-50,-30,!0),u}}class T1{seed;constructor(_){this.seed=(_^0x5deece66dn)&(1n<<48n)-1n}setSeed(_){this.seed=(_^0x5deece66dn)&(1n<<48n)-1n}nextInt(){return this.next(32)}next(_){return this.seed=this.seed*0x5deece66dn+0xbn&(1n<<48n)-1n,Number(this.seed)>>>48-_}}class k0 extends V0{static CHARSET=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!"$%^&*()-_=+[{]};:'@#~,<.>/?\\| `;static CHARCODESET=[];charMask=[];charMaskWidth=new Int32Array(94);charMaskHeight=new Int32Array(94);charOffsetX=new Int32Array(94);charOffsetY=new Int32Array(94);charAdvance=new Int32Array(95);drawWidth=new Int32Array(256);random=new T1(BigInt(Date.now()));height2d=0;static{let _=navigator.userAgent.includes("Capacitor");for(let u=0;u<256;u++){let R=k0.CHARSET.indexOf(String.fromCharCode(u));if(_){if(R>=63)R--}if(R===-1)R=74;k0.CHARCODESET[u]=R}}static fromArchive(_,u){let R=new z(_.read(u+".dat")),b=new z(_.read("index.dat"));b.pos=R.g2()+4;let m=b.g1();if(m>0)b.pos+=(m-1)*3;let E=new k0;for(let O=0;O<94;O++){E.charOffsetX[O]=b.g1(),E.charOffsetY[O]=b.g1();let I=E.charMaskWidth[O]=b.g2(),L=E.charMaskHeight[O]=b.g2(),H=b.g1(),G=I*L;if(E.charMask[O]=new Int8Array(G),H===0)for(let N=0;N<I*L;N++)E.charMask[O][N]=R.g1b();else if(H===1)for(let N=0;N<I;N++)for(let T=0;T<L;T++)E.charMask[O][N+T*I]=R.g1b();if(L>E.height2d)E.height2d=L;E.charOffsetX[O]=1,E.charAdvance[O]=I+2;{let N=0;for(let T=L/7|0;T<L;T++)N+=E.charMask[O][T*I];if(N<=(L/7|0))E.charAdvance[O]--,E.charOffsetX[O]=0}{let N=0;for(let T=L/7|0;T<L;T++)N+=E.charMask[O][I+T*I-1];if(N<=(L/7|0))E.charAdvance[O]--}}E.charAdvance[94]=E.charAdvance[8];for(let O=0;O<256;O++)E.drawWidth[O]=E.charAdvance[k0.CHARCODESET[O]];return E}drawString(_,u,R,b){if(!R)return;_|=0,u|=0;let m=R.length;u-=this.height2d;for(let E=0;E<m;E++){let O=k0.CHARCODESET[R.charCodeAt(E)];if(O!==94)this.drawChar(this.charMask[O],_+this.charOffsetX[O],u+this.charOffsetY[O],this.charMaskWidth[O],this.charMaskHeight[O],b);_+=this.charAdvance[O]}}drawStringTaggable(_,u,R,b,m){_|=0,u|=0;let E=R.length;u-=this.height2d;for(let O=0;O<E;O++)if(R.charAt(O)==="@"&&O+4<E&&R.charAt(O+4)==="@")b=this.evaluateTag(R.substring(O+1,O+4)),O+=4;else{let I=k0.CHARCODESET[R.charCodeAt(O)];if(I!==94){if(m)this.drawChar(this.charMask[I],_+this.charOffsetX[I]+1,u+this.charOffsetY[I]+1,this.charMaskWidth[I],this.charMaskHeight[I],0);this.drawChar(this.charMask[I],_+this.charOffsetX[I],u+this.charOffsetY[I],this.charMaskWidth[I],this.charMaskHeight[I],b)}_+=this.charAdvance[I]}}stringWidth(_){if(!_)return 0;let u=_.length,R=0;for(let b=0;b<u;b++)if(_.charAt(b)==="@"&&b+4<u&&_.charAt(b+4)==="@")b+=4;else R+=this.drawWidth[_.charCodeAt(b)];return R}drawStringTaggableCenter(_,u,R,b,m){_|=0,u|=0,this.drawStringTaggable(_-(this.stringWidth(R)/2|0),u,R,b,m)}drawStringCenter(_,u,R,b){if(!R)return;_|=0,u|=0,this.drawString(_-(this.stringWidth(R)/2|0),u,R,b)}drawStringTooltip(_,u,R,b,m,E){_|=0,u|=0,this.random.setSeed(BigInt(E));let O=(this.random.nextInt()&31)+192,I=u-this.height2d;for(let L=0;L<R.length;L++)if(R.charAt(L)==="@"&&L+4<R.length&&R.charAt(L+4)==="@")b=this.evaluateTag(R.substring(L+1,L+4)),L+=4;else{let H=k0.CHARCODESET[R.charCodeAt(L)];if(H!==94){if(m)this.drawCharAlpha(_+this.charOffsetX[H]+1,I+this.charOffsetY[H]+1,this.charMaskWidth[H],this.charMaskHeight[H],0,192,this.charMask[H]);this.drawCharAlpha(_+this.charOffsetX[H],I+this.charOffsetY[H],this.charMaskWidth[H],this.charMaskHeight[H],b,O,this.charMask[H])}if(_+=this.charAdvance[H],(this.random.nextInt()&3)===0)_++}}drawStringRight(_,u,R,b,m=!0){if(_|=0,u|=0,m)this.drawString(_-this.stringWidth(R)+1,u+1,R,0);this.drawString(_-this.stringWidth(R),u,R,b)}drawCenteredWave(_,u,R,b,m){if(!R)return;_|=0,u|=0,_-=this.stringWidth(R)/2|0;let E=u-this.height2d;for(let O=0;O<R.length;O++){let I=k0.CHARCODESET[R.charCodeAt(O)];if(I!=94)this.drawChar(this.charMask[I],_+this.charOffsetX[I],E+this.charOffsetY[I]+(Math.sin(O/2+m/5)*5|0),this.charMaskWidth[I],this.charMaskHeight[I],b);_+=this.charAdvance[I]}}drawChar(_,u,R,b,m,E){u|=0,R|=0,b|=0,m|=0;let O=u+R*F.width2d,I=F.width2d-b,L=0,H=0;if(R<F.top){let G=F.top-R;m-=G,R=F.top,H+=G*b,O+=G*F.width2d}if(R+m>=F.bottom)m-=R+m+1-F.bottom;if(u<F.left){let G=F.left-u;b-=G,u=F.left,H+=G,O+=G,L+=G,I+=G}if(u+b>=F.right){let G=u+b+1-F.right;b-=G,L+=G,I+=G}if(b>0&&m>0)this.drawMask(b,m,_,H,L,F.pixels,O,I,E)}drawCharAlpha(_,u,R,b,m,E,O){_|=0,u|=0,R|=0,b|=0;let I=_+u*F.width2d,L=F.width2d-R,H=0,G=0;if(u<F.top){let N=F.top-u;b-=N,u=F.top,G+=N*R,I+=N*F.width2d}if(u+b>=F.bottom)b-=u+b+1-F.bottom;if(_<F.left){let N=F.left-_;R-=N,_=F.left,G+=N,I+=N,H+=N,L+=N}if(_+R>=F.right){let N=_+R+1-F.right;R-=N,H+=N,L+=N}if(R>0&&b>0)this.drawMaskAlpha(R,b,F.pixels,I,L,O,G,H,m,E)}drawMask(_,u,R,b,m,E,O,I,L){_|=0,u|=0;let H=-(_>>2);_=-(_&3);for(let G=-u;G<0;G++){for(let N=H;N<0;N++){if(R[b++]===0)O++;else E[O++]=L;if(R[b++]===0)O++;else E[O++]=L;if(R[b++]===0)O++;else E[O++]=L;if(R[b++]===0)O++;else E[O++]=L}for(let N=_;N<0;N++)if(R[b++]===0)O++;else E[O++]=L;O+=I,b+=m}}drawMaskAlpha(_,u,R,b,m,E,O,I,L,H){_|=0,u|=0;let G=((L&16711935)*H&4278255360)+((L&65280)*H&16711680)>>8,N=256-H;for(let T=-u;T<0;T++){for(let K=-_;K<0;K++)if(E[O++]===0)b++;else{let Q=R[b];R[b++]=(((Q&16711935)*N&4278255360)+((Q&65280)*N&16711680)>>8)+G}b+=m,O+=I}}evaluateTag(_){if(_==="red")return 16711680;else if(_==="gre")return 65280;else if(_==="blu")return 255;else if(_==="yel")return 16776960;else if(_==="cya")return 65535;else if(_==="mag")return 16711935;else if(_==="whi")return 16777215;else if(_==="bla")return 0;else if(_==="lre")return 16748608;else if(_==="dre")return 8388608;else if(_==="dbl")return 128;else if(_==="or1")return 16756736;else if(_==="or2")return 16740352;else if(_==="or3")return 16723968;else if(_==="gr1")return 12648192;else if(_==="gr2")return 8453888;else if(_==="gr3")return 4259584;else return 0}split(_,u){if(_.length===0)return[_];let R=[];while(_.length>0){if(this.stringWidth(_)<=u&&_.indexOf("|")===-1){R.push(_);break}let m=_.length;for(let E=0;E<_.length;E++)if(_[E]===" "){if(this.stringWidth(_.substring(0,E))>u)break;m=E}else if(_[E]==="|"){m=E;break}R.push(_.substring(0,m)),_=_.substring(m+1)}return R}}class S0{socket;wsin;wsout;closed=!1;ioerror=!1;static async openSocket(_,u){return await new Promise((R,b)=>{let E=new WebSocket(`${u?"wss":"ws"}://${_}`,"binary");E.addEventListener("open",()=>{R(E)}),E.addEventListener("error",()=>{b(E)})})}constructor(_){_.onclose=this.onclose,_.onerror=this.onerror,this.wsin=new h1(_,5000),this.wsout=new Z1(_,5000),this.socket=_}get host(){return this.socket.url.split("/")[2]}get port(){return parseInt(this.socket.url.split(":")[2],10)}get available(){return this.closed?0:this.wsin.available}write(_,u){if(!this.closed)this.wsout.write(_,u)}async read(){return this.closed?0:await this.wsin.read()}async readBytes(_,u,R){if(this.closed)return;await this.wsin.readBytes(_,u,R)}close(){this.closed=!0,this.socket.close(),this.wsin.close(),this.wsout.close()}onclose=(_)=>{if(this.closed)return;this.close()};onerror=(_)=>{if(this.closed)return;this.ioerror=!0,this.close()}}class Z1{socket;limit;closed=!1;ioerror=!1;constructor(_,u){this.socket=_,this.limit=u}write(_,u){if(this.closed)return;if(this.ioerror)throw this.ioerror=!1,new Error;if(u>this.limit||_.length>this.limit)throw new Error;try{this.socket.send(_.slice(0,u))}catch(R){this.ioerror=!0}}close(){this.closed=!0}}class X1{bytes;position;constructor(_){this.bytes=_,this.position=0}get available(){return this.bytes.length-this.position}get read(){return this.bytes[this.position++]}get len(){return this.bytes.length}}class h1{limit;queue=[];event=null;callback=null;closed=!1;total=0;constructor(_,u){this.limit=u,_.binaryType="arraybuffer",_.onmessage=this.onmessage}get available(){return this.total}onmessage=(_)=>{if(this.closed)throw new Error;let u=new X1(new Uint8Array(_.data));if(this.total+=u.available,this.callback){let R=this.callback;this.callback=null,R(u)}else this.queue.push(u)};async read(){if(this.closed)throw new Error;return await Promise.race([new Promise((_)=>{if(!this.event||this.event.available===0)this.event=this.queue.shift()??null;if(this.event&&this.event.available>0)_(this.event.read),this.total--;else this.callback=(u)=>{this.event=u,this.total--,_(u.read)}}),new Promise((_,u)=>{setTimeout(()=>{if(this.closed)u(new Error);else u(new Error)},20000)})])}async readBytes(_,u,R){if(this.closed)throw new Error;for(let b=0;b<R;b++)_[u+b]=await this.read();return _}close(){this.closed=!0,this.callback=null,this.event=null,this.queue=[]}}class x0{db;constructor(_){_.onerror=this.onerror,_.onclose=this.onclose,this.db=_}static async openDatabase(){return await new Promise((_,u)=>{let R=indexedDB.open("lostcity",1);R.onsuccess=(b)=>{let m=b.target;_(m.result)},R.onupgradeneeded=(b)=>{b.target.result.createObjectStore("cache")},R.onerror=(b)=>{let m=b.target;u(m.result)}})}async read(_,u){return await new Promise((R)=>{let E=this.db.transaction("cache","readonly").objectStore("cache").get(`${_}.${u}`);E.onsuccess=()=>{if(E.result)R(new Uint8Array(E.result));else R(void 0)},E.onerror=()=>{R(void 0)}})}async cacheload(_){return await new Promise((u)=>{let m=this.db.transaction("cache","readonly").objectStore("cache").get(_);m.onsuccess=()=>{if(m.result)u(new Uint8Array(m.result));else u(void 0)},m.onerror=()=>{u(void 0)}})}async write(_,u,R){if(R===null)return;return await new Promise((b,m)=>{let I=this.db.transaction("cache","readwrite").objectStore("cache").put(R,`${_}.${u}`);I.onsuccess=()=>{b()},I.onerror=()=>{b()}})}async cachesave(_,u){if(u===null)return;return await new Promise((R,b)=>{let O=this.db.transaction("cache","readwrite").objectStore("cache").put(u,_);O.onsuccess=()=>{R()},O.onerror=()=>{R()}})}onclose=(_)=>{};onerror=(_)=>{}}class c0{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(_){for(let u=0;u<_.length;u++)this.rsl[u]=_[u];this.init()}get nextInt(){if(this.count--===0)this.isaac(),this.count=255;return this.rsl[this.count]}init(){let _=2654435769,u=2654435769,R=2654435769,b=2654435769,m=2654435769,E=2654435769,O=2654435769,I=2654435769;for(let L=0;L<4;L++)_^=u<<11,b+=_,u+=R,u^=R>>>2,m+=u,R+=b,R^=b<<8,E+=R,b+=m,b^=m>>>16,O+=b,m+=E,m^=E<<10,I+=m,E+=O,E^=O>>>4,_+=E,O+=I,O^=I<<8,u+=O,I+=_,I^=_>>>9,R+=I,_+=u;for(let L=0;L<256;L+=8)_+=this.rsl[L],u+=this.rsl[L+1],R+=this.rsl[L+2],b+=this.rsl[L+3],m+=this.rsl[L+4],E+=this.rsl[L+5],O+=this.rsl[L+6],I+=this.rsl[L+7],_^=u<<11,b+=_,u+=R,u^=R>>>2,m+=u,R+=b,R^=b<<8,E+=R,b+=m,b^=m>>>16,O+=b,m+=E,m^=E<<10,I+=m,E+=O,E^=O>>>4,_+=E,O+=I,O^=I<<8,u+=O,I+=_,I^=_>>>9,R+=I,_+=u,this.mem[L]=_,this.mem[L+1]=u,this.mem[L+2]=R,this.mem[L+3]=b,this.mem[L+4]=m,this.mem[L+5]=E,this.mem[L+6]=O,this.mem[L+7]=I;for(let L=0;L<256;L+=8)_+=this.mem[L],u+=this.mem[L+1],R+=this.mem[L+2],b+=this.mem[L+3],m+=this.mem[L+4],E+=this.mem[L+5],O+=this.mem[L+6],I+=this.mem[L+7],_^=u<<11,b+=_,u+=R,u^=R>>>2,m+=u,R+=b,R^=b<<8,E+=R,b+=m,b^=m>>>16,O+=b,m+=E,m^=E<<10,I+=m,E+=O,E^=O>>>4,_+=E,O+=I,O^=I<<8,u+=O,I+=_,I^=_>>>9,R+=I,_+=u,this.mem[L]=_,this.mem[L+1]=u,this.mem[L+2]=R,this.mem[L+3]=b,this.mem[L+4]=m,this.mem[L+5]=E,this.mem[L+6]=O,this.mem[L+7]=I;this.isaac(),this.count=256}isaac(){this.c++,this.b+=this.c;for(let _=0;_<256;_++){let u=this.mem[_],R=_&3;if(R===0)this.a^=this.a<<13;else if(R===1)this.a^=this.a>>>6;else if(R===2)this.a^=this.a<<2;else if(R===3)this.a^=this.a>>>16;this.a+=this.mem[_+128&255];let b;this.mem[_]=b=this.mem[u>>>2&255]+this.a+this.b,this.rsl[_]=this.b=this.mem[b>>>8>>>2&255]+u}}}import{BZip2 as f1}from"./deps.js";class r0{static genHash(_){let u=0;_=_.toUpperCase();for(let R=0;R<_.length;R++)u=u*61+_.charCodeAt(R)-32|0;return u}jagSrc;compressedWhole;fileCount;fileHash;fileUnpackedSize;filePackedSize;fileOffset;fileUnpacked=[];constructor(_){let u=new z(new Uint8Array(_)),R=u.g3(),b=u.g3();if(R===b)this.jagSrc=_,this.compressedWhole=!1;else this.jagSrc=f1.decompress(_.subarray(6),R,!0),u=new z(new Uint8Array(this.jagSrc)),this.compressedWhole=!0;this.fileCount=u.g2(),this.fileHash=[],this.fileUnpackedSize=[],this.filePackedSize=[],this.fileOffset=[];let m=u.pos+this.fileCount*10;for(let E=0;E<this.fileCount;E++)this.fileHash.push(u.g4()),this.fileUnpackedSize.push(u.g3()),this.filePackedSize.push(u.g3()),this.fileOffset.push(m),m+=this.filePackedSize[E]}read(_){let u=r0.genHash(_),R=this.fileHash.indexOf(u);if(R===-1)return null;return this.readIndex(R)}readIndex(_){if(_<0||_>=this.fileCount)return null;if(this.fileUnpacked[_])return this.fileUnpacked[_];let u=this.fileOffset[_],R=u+this.filePackedSize[_],b=new Uint8Array(this.jagSrc.subarray(u,u+R));if(this.compressedWhole)return this.fileUnpacked[_]=b,b;else{let m=f1.decompress(b,this.fileUnpackedSize[_],!0);return this.fileUnpacked[_]=m,m}}}var M1=[0,0,0,0,0,0,0,-2,0,3,2,0,6,0,0,0,0,0,0,0,0,0,0,0,6,0,0,0,0,14,-1,0,0,0,0,0,0,0,0,3,0,0,0,0,10,0,0,0,0,6,4,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,7,9,0,-2,0,0,0,0,0,4,0,0,0,0,0,0,2,-2,0,0,0,0,0,0,0,2,-1,0,1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,2,0,0,0,4,0,2,-2,0,0,0,0,15,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,-2,4,0,0,2,0,2,0,2,0,6,4,0,0,1,0,0,0,0,4,2,0,2,1,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,6,0,3,0,0,0,0,0,0,4,0,7,3,0,0,0,0,0,0,0,0,4,0,0,6,0,0,0,6,0,0,0,0,0,4,-2,5,0,3,0,0,0,2,6,0,0,-2,4,0,0,0,0,0,0,0,0,0];class W0{static PERIOD=new Uint16Array(["d","o","t"].join("").split("").map((_)=>_.charCodeAt(0)));static AMPERSAT=new Uint16Array(["(","a",")"].join("").split("").map((_)=>_.charCodeAt(0)));static SLASH=new Uint16Array(["s","l","a","s","h"].join("").split("").map((_)=>_.charCodeAt(0)));static whitelist=["cook","cook's","cooks","seeks","sheet"];static tlds=[];static tldTypes=[];static bads=[];static badCombinations=[];static domains=[];static fragments=[];static unpack(_){let u=new z(_.read("fragmentsenc.txt")),R=new z(_.read("badenc.txt")),b=new z(_.read("domainenc.txt")),m=new z(_.read("tldlist.txt"));this.read(R,b,u,m)}static filter(_){let u=[..._];this.format(u);let R=u.join("").trim(),b=R.toLowerCase(),m=[...b];this.filterTlds(m),this.filterBadWords(m),this.filterDomains(m),this.filterFragments(m);for(let E=0;E<this.whitelist.length;E++){let O=-1;while((O=b.indexOf(this.whitelist[E],O+1))!==-1){let I=[...this.whitelist[E]];for(let L=0;L<I.length;L++)m[L+O]=I[L]}}return this.replaceUppercases(m,[...R]),this.formatUppercases(m),m.join("").trim()}static read(_,u,R,b){this.readBadWords(_),this.readDomains(u),this.readFragments(R),this.readTld(b)}static readTld(_){let u=_.g4();for(let R=0;R<u;R++)this.tldTypes[R]=_.g1(),this.tlds[R]=new Uint16Array(_.g1()).map(()=>_.g1())}static readBadWords(_){let u=_.g4();for(let R=0;R<u;R++){this.bads[R]=new Uint16Array(_.g1()).map(()=>_.g1());let b=new Array(_.g1()).fill([]).map(()=>[_.g1b(),_.g1b()]);if(b.length>0)this.badCombinations[R]=b}}static readDomains(_){let u=_.g4();for(let R=0;R<u;R++)this.domains[R]=new Uint16Array(_.g1()).map(()=>_.g1())}static readFragments(_){let u=_.g4();for(let R=0;R<u;R++)this.fragments[R]=_.g2()}static filterTlds(_){let u=[..._],R=[..._];this.filterBadCombinations(null,u,this.PERIOD),this.filterBadCombinations(null,R,this.SLASH);for(let b=0;b<this.tlds.length;b++)this.filterTld(R,this.tldTypes[b],_,this.tlds[b],u)}static filterBadWords(_){for(let u=0;u<2;u++)for(let R=this.bads.length-1;R>=0;R--)this.filterBadCombinations(this.badCombinations[R],_,this.bads[R])}static filterDomains(_){let u=[..._],R=[..._];this.filterBadCombinations(null,u,this.AMPERSAT),this.filterBadCombinations(null,R,this.PERIOD);for(let b=this.domains.length-1;b>=0;b--)this.filterDomain(R,u,this.domains[b],_)}static filterFragments(_){for(let u=0;u<_.length;){let R=this.indexOfNumber(_,u);if(R===-1)return;let b=!1;for(let O=u;O>=0&&O<R&&!b;O++)if(!this.isSymbol(_[O])&&!this.isNotLowercaseAlpha(_[O]))b=!0;let m=0;if(b)m=0;if(m===0)m=1,u=R;let E=0;for(let O=R;O<_.length&&O<u;O++)E=E*10+_[O].charCodeAt(0)-48;if(E<=255&&u-R<=8)m++;else m=0;if(m===4)this.maskChars(R,u,_),m=0;u=this.indexOfNonNumber(u,_)}}static isBadFragment(_){if(this.isNumericalChars(_))return!0;let u=this.getInteger(_),R=this.fragments,b=R.length;if(u===R[0]||u===R[b-1])return!0;let m=0,E=b-1;while(m<=E){let O=(m+E)/2|0;if(u===R[O])return!0;else if(u<R[O])E=O-1;else m=O+1}return!1}static getInteger(_){if(_.length>6)return 0;let u=0;for(let R=0;R<_.length;R++){let b=_[_.length-R-1];if(this.isLowercaseAlpha(b))u=u*38+b.charCodeAt(0)+1-97;else if(b==="'")u=u*38+27;else if(this.isNumerical(b))u=u*38+b.charCodeAt(0)+28-48;else if(b!=="\x00")return 0}return u}static indexOfNumber(_,u){for(let R=u;R<_.length&&R>=0;R++)if(this.isNumerical(_[R]))return R;return-1}static indexOfNonNumber(_,u){for(let R=_;R<u.length&&R>=0;R++)if(!this.isNumerical(u[R]))return R;return u.length}static getEmulatedDomainCharLen(_,u,R){if(u===R)return 1;else if(u==="o"&&R==="0")return 1;else if(u==="o"&&R==="("&&_===")")return 2;else if(u==="c"&&(R==="("||R==="<"||R==="["))return 1;else if(u==="e"&&R==="")return 1;else if(u==="s"&&R==="$")return 1;else if(u==="l"&&R==="i")return 1;return 0}static filterDomain(_,u,R,b){let m=R.length,E=b.length;for(let O=0;O<=E-m;O++){let{matched:I,currentIndex:L}=this.findMatchingDomain(O,R,b);if(!I)continue;let H=this.prefixSymbolStatus(O,b,3,u,["@"]),G=this.suffixSymbolStatus(L-1,b,3,_,[".",","]);if(!(H>2||G>2))continue;this.maskChars(O,L,b)}}static findMatchingDomain(_,u,R){let b=u.length,m=_,E=0;while(m<R.length&&E<b){let O=R[m],I=m+1<R.length?R[m+1]:"\x00",L=this.getEmulatedDomainCharLen(I,String.fromCharCode(u[E]),O);if(L>0)m+=L,E++;else{if(E===0)break;let H=this.getEmulatedDomainCharLen(I,String.fromCharCode(u[E-1]),O);if(H>0){if(m+=H,E===1)_++}else{if(E>=b||!this.isSymbol(O))break;m++}}}return{matched:E>=b,currentIndex:m}}static filterBadCombinations(_,u,R){if(R.length>u.length)return;for(let b=0;b<=u.length-R.length;b++){let m=b,{currentIndex:E,badIndex:O,hasSymbol:I,hasNumber:L,hasDigit:H}=this.processBadCharacters(u,R,m);m=E;let G=u[m],N=m+1<u.length?u[m+1]:"\x00";if(!(O>=R.length&&(!L||!H)))continue;let T=!0,K;if(I){let J=!1,q=!1;if(b-1<0||this.isSymbol(u[b-1])&&u[b-1]!=="'")J=!0;if(m>=u.length||this.isSymbol(u[m])&&u[m]!=="'")q=!0;if(!J||!q){let w=!1;if(K=b-2,J)K=b;while(!w&&K<m){if(K>=0&&(!this.isSymbol(u[K])||u[K]==="'")){let V=[],Y;for(Y=0;Y<3&&K+Y<u.length&&(!this.isSymbol(u[K+Y])||u[K+Y]==="'");Y++)V[Y]=u[K+Y];let n=!0;if(Y===0)n=!1;if(Y<3&&K-1>=0&&(!this.isSymbol(u[K-1])||u[K-1]==="'"))n=!1;if(n&&!this.isBadFragment(V))w=!0}K++}if(!w)T=!1}}else{if(G=" ",b-1>=0)G=u[b-1];if(N=" ",m<u.length)N=u[m];let J=this.getIndex(G),q=this.getIndex(N);if(_&&this.comboMatches(J,_,q))T=!1}if(!T)continue;let Q=0,U=0;for(let J=b;J<m;J++)if(this.isNumerical(u[J]))Q++;else if(this.isAlpha(u[J]))U++;if(Q<=U)this.maskChars(b,m,u)}}static processBadCharacters(_,u,R){let b=R,m=0,E=0,O=!1,I=!1,L=!1;for(;b<_.length&&!(I&&L);){if(b>=_.length||I&&L)break;let H=_[b],G=b+1<_.length?_[b+1]:"\x00",N;if(m<u.length&&(N=this.getEmulatedBadCharLen(G,String.fromCharCode(u[m]),H))>0){if(N===1&&this.isNumerical(H))I=!0;if(N===2&&(this.isNumerical(H)||this.isNumerical(G)))I=!0;b+=N,m++}else{if(m===0)break;let T;if((T=this.getEmulatedBadCharLen(G,String.fromCharCode(u[m-1]),H))>0)b+=T;else{if(m>=u.length||!this.isNotLowercaseAlpha(H))break;if(this.isSymbol(H)&&H!=="'")O=!0;if(this.isNumerical(H))L=!0;if(b++,E++,(E*100/(b-R)|0)>90)break}}}return{currentIndex:b,badIndex:m,hasSymbol:O,hasNumber:I,hasDigit:L}}static getEmulatedBadCharLen(_,u,R){if(u===R)return 1;if(u>="a"&&u<="m"){if(u==="a"){if(R!=="4"&&R!=="@"&&R!=="^"){if(R==="/"&&_==="\\")return 2;return 0}return 1}if(u==="b"){if(R!=="6"&&R!=="8"){if(R==="1"&&_==="3")return 2;return 0}return 1}if(u==="c"){if(R!=="("&&R!=="<"&&R!=="{"&&R!=="[")return 0;return 1}if(u==="d"){if(R==="["&&_===")")return 2;return 0}if(u==="e"){if(R!=="3"&&R!=="")return 0;return 1}if(u==="f"){if(R==="p"&&_==="h")return 2;if(R==="")return 1;return 0}if(u==="g"){if(R!=="9"&&R!=="6")return 0;return 1}if(u==="h"){if(R==="#")return 1;return 0}if(u==="i"){if(R!=="y"&&R!=="l"&&R!=="j"&&R!=="1"&&R!=="!"&&R!==":"&&R!==";"&&R!=="|")return 0;return 1}if(u==="j")return 0;if(u==="k")return 0;if(u==="l"){if(R!=="1"&&R!=="|"&&R!=="i")return 0;return 1}if(u==="m")return 0}if(u>="n"&&u<="z"){if(u==="n")return 0;if(u==="o"){if(R!=="0"&&R!=="*"){if((R!=="("||_!==")")&&(R!=="["||_!=="]")&&(R!=="{"||_!=="}")&&(R!=="<"||_!==">"))return 0;return 2}return 1}if(u==="p")return 0;if(u==="q")return 0;if(u==="r")return 0;if(u==="s"){if(R!=="5"&&R!=="z"&&R!=="$"&&R!=="2")return 0;return 1}if(u==="t"){if(R!=="7"&&R!=="+")return 0;return 1}if(u==="u"){if(R==="v")return 1;if((R!=="\\"||_!=="/")&&(R!=="\\"||_!=="|")&&(R!=="|"||_!=="/"))return 0;return 2}if(u==="v"){if((R!=="\\"||_!=="/")&&(R!=="\\"||_!=="|")&&(R!=="|"||_!=="/"))return 0;return 2}if(u==="w"){if(R==="v"&&_==="v")return 2;return 0}if(u==="x"){if((R!==")"||_!=="(")&&(R!=="}"||_!=="{")&&(R!=="]"||_!=="[")&&(R!==">"||_!=="<"))return 0;return 2}if(u==="y")return 0;if(u==="z")return 0}if(u>="0"&&u<="9")if(u==="0")if(R==="o"||R==="O")return 1;else if((R!=="("||_!==")")&&(R!=="{"||_!=="}")&&(R!=="["||_!=="]"))return 0;else return 2;else if(u==="1")return R==="l"?1:0;else return 0;else if(u===",")return R==="."?1:0;else if(u===".")return R===","?1:0;else if(u==="!")return R==="i"?1:0;return 0}static comboMatches(_,u,R){let b=0,m=u.length-1;while(b<=m){let E=(b+m)/2|0;if(u[E][0]===_&&u[E][1]===R)return!0;else if(_<u[E][0]||_===u[E][0]&&R<u[E][1])m=E-1;else b=E+1}return!1}static getIndex(_){if(this.isLowercaseAlpha(_))return _.charCodeAt(0)+1-97;else if(_==="'")return 28;else if(this.isNumerical(_))return _.charCodeAt(0)+29-48;return 27}static filterTld(_,u,R,b,m){if(b.length>R.length)return;for(let E=0;E<=R.length-b.length;E++){let{currentIndex:O,tldIndex:I}=this.processTlds(R,b,E);if(I<b.length)continue;let L=!1,H=this.prefixSymbolStatus(E,R,3,m,[",","."]),G=this.suffixSymbolStatus(O-1,R,5,_,["\\","/"]);if(u===1&&H>0&&G>0)L=!0;if(u===2&&(H>2&&G>0||H>0&&G>2))L=!0;if(u===3&&H>0&&G>2)L=!0;if(!L)continue;let N=E,T=O-1,K=!1,Q;if(H>2){if(H===4){K=!1;for(Q=E-1;Q>=0;Q--)if(K){if(m[Q]!=="*")break;N=Q}else if(m[Q]==="*")N=Q,K=!0}K=!1;for(Q=N-1;Q>=0;Q--)if(K){if(this.isSymbol(R[Q]))break;N=Q}else if(!this.isSymbol(R[Q]))K=!0,N=Q}if(G>2){if(G===4){K=!1;for(Q=T+1;Q<R.length;Q++)if(K){if(_[Q]!=="*")break;T=Q}else if(_[Q]==="*")T=Q,K=!0}K=!1;for(Q=T+1;Q<R.length;Q++)if(K){if(this.isSymbol(R[Q]))break;T=Q}else if(!this.isSymbol(R[Q]))K=!0,T=Q}this.maskChars(N,T+1,R)}}static processTlds(_,u,R){let b=0;while(R<_.length&&b<u.length){let m=_[R],E=R+1<_.length?_[R+1]:"\x00",O;if((O=this.getEmulatedDomainCharLen(E,String.fromCharCode(u[b]),m))>0)R+=O,b++;else{if(b===0)break;let I;if((I=this.getEmulatedDomainCharLen(E,String.fromCharCode(u[b-1]),m))>0)R+=I;else{if(!this.isSymbol(m))break;R++}}}return{currentIndex:R,tldIndex:b}}static isSymbol(_){return!this.isAlpha(_)&&!this.isNumerical(_)}static isNotLowercaseAlpha(_){return this.isLowercaseAlpha(_)?_==="v"||_==="x"||_==="j"||_==="q"||_==="z":!0}static isAlpha(_){return this.isLowercaseAlpha(_)||this.isUppercaseAlpha(_)}static isNumerical(_){return _>="0"&&_<="9"}static isLowercaseAlpha(_){return _>="a"&&_<="z"}static isUppercaseAlpha(_){return _>="A"&&_<="Z"}static isNumericalChars(_){for(let u=0;u<_.length;u++)if(!this.isNumerical(_[u])&&_[u]!=="\x00")return!1;return!0}static maskChars(_,u,R){for(let b=_;b<u;b++)R[b]="*"}static maskedCountBackwards(_,u){let R=0;for(let b=u-1;b>=0&&this.isSymbol(_[b]);b--)if(_[b]==="*")R++;return R}static maskedCountForwards(_,u){let R=0;for(let b=u+1;b<_.length&&this.isSymbol(_[b]);b++)if(_[b]==="*")R++;return R}static maskedCharsStatus(_,u,R,b,m){if((m?this.maskedCountBackwards(u,R):this.maskedCountForwards(u,R))>=b)return 4;else if(this.isSymbol(m?_[R-1]:_[R+1]))return 1;return 0}static prefixSymbolStatus(_,u,R,b,m){if(_===0)return 2;for(let E=_-1;E>=0&&this.isSymbol(u[E]);E--)if(m.includes(u[E]))return 3;return this.maskedCharsStatus(u,b,_,R,!0)}static suffixSymbolStatus(_,u,R,b,m){if(_+1===u.length)return 2;for(let E=_+1;E<u.length&&this.isSymbol(u[E]);E++)if(m.includes(u[E]))return 3;return this.maskedCharsStatus(u,b,_,R,!1)}static format(_){let u=0;for(let R=0;R<_.length;R++){if(this.isCharacterAllowed(_[R]))_[u]=_[R];else _[u]=" ";if(u===0||_[u]!==" "||_[u-1]!==" ")u++}for(let R=u;R<_.length;R++)_[R]=" "}static isCharacterAllowed(_){return _>=" "&&_<=""||_===" "||_===`
`||_==="\t"||_===""||_===""}static replaceUppercases(_,u){for(let R=0;R<u.length;R++)if(_[R]!=="*"&&this.isUppercaseAlpha(u[R]))_[R]=u[R]}static formatUppercases(_){let u=!0;for(let R=0;R<_.length;R++){let b=_[R];if(!this.isAlpha(b))u=!0;else if(u){if(this.isLowercaseAlpha(b))u=!1}else if(this.isUppercaseAlpha(b))_[R]=String.fromCharCode(b.charCodeAt(0)+97-65)}}}class P0{static TABLE=[" ","e","t","a","o","i","h","n","s","r","d","l","u","m","w","c","y","f","g","p","b","v","k","x","j","q","z","0","1","2","3","4","5","6","7","8","9"," ","!","?",".",",",":",";","(",")","-","&","*","\\","'","@","#","+","=","","$","%",'"',"[","]"];static charBuffer=[];static unpack(_,u){let R=0,b=-1,m;for(let O=0;O<u&&R<100;O++){let I=_.g1();if(m=I>>4&15,b!==-1)this.charBuffer[R++]=this.TABLE[(b<<4)+m-195],b=-1;else if(m<13)this.charBuffer[R++]=this.TABLE[m];else b=m;if(m=I&15,b!==-1)this.charBuffer[R++]=this.TABLE[(b<<4)+m-195],b=-1;else if(m<13)this.charBuffer[R++]=this.TABLE[m];else b=m}let E=!0;for(let O=0;O<R;O++){let I=this.charBuffer[O];if(E&&I>="a"&&I<="z")this.charBuffer[O]=I.toUpperCase(),E=!1;if(I==="."||I==="!")E=!0}return this.charBuffer.slice(0,R).join("")}static pack(_,u){if(u.length>80)u=u.substring(0,80);u=u.toLowerCase();let R=-1;for(let b=0;b<u.length;b++){let m=u.charAt(b),E=0;for(let O=0;O<this.TABLE.length;O++)if(m===this.TABLE[O]){E=O;break}if(E>12)E+=195;if(R===-1)if(E<13)R=E;else _.p1(E);else if(E<13)_.p1((R<<4)+E),R=-1;else _.p1((R<<4)+(E>>4)),R=E&15}if(R!==-1)_.p1(R<<4)}}class f0{length=0;shapeDelta=null;shapePeak=null;start=0;end=0;form=0;threshold=0;position=0;delta=0;amplitude=0;ticks=0;unpack(_){this.form=_.g1(),this.start=_.g4(),this.end=_.g4(),this.length=_.g1(),this.shapeDelta=new Int32Array(this.length),this.shapePeak=new Int32Array(this.length);for(let u=0;u<this.length;u++)this.shapeDelta[u]=_.g2(),this.shapePeak[u]=_.g2()}reset(){this.threshold=0,this.position=0,this.delta=0,this.amplitude=0,this.ticks=0}evaluate(_){if(this.ticks>=this.threshold&&this.shapePeak&&this.shapeDelta){if(this.amplitude=this.shapePeak[this.position++]<<15,this.position>=this.length)this.position=this.length-1;if(this.threshold=this.shapeDelta[this.position]/65536*_|0,this.threshold>this.ticks)this.delta=((this.shapePeak[this.position]<<15)-this.amplitude)/(this.threshold-this.ticks)|0}return this.amplitude+=this.delta,this.ticks++,this.amplitude-this.delta>>15}}class m0{frequencyBase=null;amplitudeBase=null;frequencyModRate=null;frequencyModRange=null;amplitudeModRate=null;amplitudeModRange=null;release=null;attack=null;harmonicVolume=new Int32Array(5);harmonicSemitone=new Int32Array(5);harmonicDelay=new Int32Array(5);reverbDelay=0;reverbVolume=100;start=0;length=500;static buffer=null;static noise=null;static sin=null;static tmpPhases=new Int32Array(5);static tmpDelays=new Int32Array(5);static tmpVolumes=new Int32Array(5);static tmpSemitones=new Int32Array(5);static tmpStarts=new Int32Array(5);static init(){this.noise=new Int32Array(32768);for(let _=0;_<32768;_++)if(Math.random()>0.5)this.noise[_]=1;else this.noise[_]=-1;this.sin=new Int32Array(32768);for(let _=0;_<32768;_++)this.sin[_]=Math.sin(_/5215.1903)*16384|0;this.buffer=new Int32Array(220500)}generate(_,u){if(!this.frequencyBase||!this.amplitudeBase)return m0.buffer;for(let H=0;H<_;H++)m0.buffer[H]=0;if(u<10)return m0.buffer;let R=_/u|0;this.frequencyBase.reset(),this.amplitudeBase.reset();let b=0,m=0,E=0;if(this.frequencyModRate&&this.frequencyModRange)this.frequencyModRate.reset(),this.frequencyModRange.reset(),b=(this.frequencyModRate.end-this.frequencyModRate.start)*32.768/R|0,m=this.frequencyModRate.start*32.768/R|0;let O=0,I=0,L=0;if(this.amplitudeModRate&&this.amplitudeModRange)this.amplitudeModRate.reset(),this.amplitudeModRange.reset(),O=(this.amplitudeModRate.end-this.amplitudeModRate.start)*32.768/R|0,I=this.amplitudeModRate.start*32.768/R|0;for(let H=0;H<5;H++)if(this.frequencyBase&&this.harmonicVolume[H]!==0)m0.tmpPhases[H]=0,m0.tmpDelays[H]=this.harmonicDelay[H]*R,m0.tmpVolumes[H]=(this.harmonicVolume[H]<<14)/100|0,m0.tmpSemitones[H]=(this.frequencyBase.end-this.frequencyBase.start)*32.768*Math.pow(1.0057929410678534,this.harmonicSemitone[H])/R|0,m0.tmpStarts[H]=this.frequencyBase.start*32.768/R|0;for(let H=0;H<_;H++){let G=this.frequencyBase.evaluate(_),N=this.amplitudeBase.evaluate(_);if(this.frequencyModRate&&this.frequencyModRange){let T=this.frequencyModRate.evaluate(_),K=this.frequencyModRange.evaluate(_);G+=this.generate2(K,E,this.frequencyModRate.form)>>1,E+=(T*b>>16)+m}if(this.amplitudeModRate&&this.amplitudeModRange){let T=this.amplitudeModRate.evaluate(_),K=this.amplitudeModRange.evaluate(_);N=N*((this.generate2(K,L,this.amplitudeModRate.form)>>1)+32768)>>15,L+=(T*O>>16)+I}for(let T=0;T<5;T++)if(this.harmonicVolume[T]!==0){let K=H+m0.tmpDelays[T];if(K<_)m0.buffer[K]+=this.generate2(N*m0.tmpVolumes[T]>>15,m0.tmpPhases[T],this.frequencyBase.form),m0.tmpPhases[T]+=(G*m0.tmpSemitones[T]>>16)+m0.tmpStarts[T]}}if(this.release&&this.attack){this.release.reset(),this.attack.reset();let H=0,G=!0;for(let N=0;N<_;N++){let T=this.release.evaluate(_),K=this.attack.evaluate(_),Q;if(G)Q=this.release.start+((this.release.end-this.release.start)*T>>8);else Q=this.release.start+((this.release.end-this.release.start)*K>>8);if(H+=256,H>=Q)H=0,G=!G;if(G)m0.buffer[N]=0}}if(this.reverbDelay>0&&this.reverbVolume>0){let H=this.reverbDelay*R;for(let G=H;G<_;G++)m0.buffer[G]+=m0.buffer[G-H]*this.reverbVolume/100|0,m0.buffer[G]|=0}for(let H=0;H<_;H++){if(m0.buffer[H]<-32768)m0.buffer[H]=-32768;if(m0.buffer[H]>32767)m0.buffer[H]=32767}return m0.buffer}generate2(_,u,R){if(R===1)return(u&32767)<16384?_:-_;else if(R===2)return m0.sin[u&32767]*_>>14;else if(R===3)return((u&32767)*_>>14)-_;else if(R===4)return m0.noise[(u/2607|0)&32767]*_;else return 0}unpack(_){if(this.frequencyBase=new f0,this.frequencyBase.unpack(_),this.amplitudeBase=new f0,this.amplitudeBase.unpack(_),_.g1()!==0)_.pos--,this.frequencyModRate=new f0,this.frequencyModRate.unpack(_),this.frequencyModRange=new f0,this.frequencyModRange.unpack(_);if(_.g1()!==0)_.pos--,this.amplitudeModRate=new f0,this.amplitudeModRate.unpack(_),this.amplitudeModRange=new f0,this.amplitudeModRange.unpack(_);if(_.g1()!==0)_.pos--,this.release=new f0,this.release.unpack(_),this.attack=new f0,this.attack.unpack(_);for(let u=0;u<10;u++){let R=_.gsmarts();if(R===0)break;this.harmonicVolume[u]=R,this.harmonicSemitone[u]=_.gsmart(),this.harmonicDelay[u]=_.gsmarts()}this.reverbDelay=_.gsmarts(),this.reverbVolume=_.gsmarts(),this.length=_.g2(),this.start=_.g2()}}class b0{static tracks=new p(1000,null);static delays=new Int32Array(1000);static waveBytes=new Uint8Array(441000);static waveBuffer=null;tones=new p(10,null);loopBegin=0;loopEnd=0;static unpack(_){let u=new z(_.read("sounds.dat"));this.waveBytes=new Uint8Array(441000),this.waveBuffer=new z(this.waveBytes),m0.init();while(!0){let R=u.g2();if(R===65535)break;this.tracks[R]=new b0,this.tracks[R].read(u),this.delays[R]=this.tracks[R].trim()}}static generate(_,u){if(!this.tracks[_])return null;return this.tracks[_]?.getWave(u)??null}read(_){for(let u=0;u<10;u++)if(_.g1()!==0)_.pos--,this.tones[u]=new m0,this.tones[u]?.unpack(_);this.loopBegin=_.g2(),this.loopEnd=_.g2()}trim(){let _=9999999;for(let u=0;u<10;u++)if(this.tones[u]&&(this.tones[u].start/20|0)<_)_=this.tones[u].start/20|0;if(this.loopBegin<this.loopEnd&&(this.loopBegin/20|0)<_)_=this.loopBegin/20|0;if(_===9999999||_===0)return 0;for(let u=0;u<10;u++)if(this.tones[u])this.tones[u].start-=_*20;if(this.loopBegin<this.loopEnd)this.loopBegin-=_*20,this.loopEnd-=_*20;return _}getWave(_){if(!b0.waveBuffer)return null;let u=this.generate(_);return b0.waveBuffer.pos=0,b0.waveBuffer.p4(1380533830),b0.waveBuffer.ip4(u+36),b0.waveBuffer.p4(1463899717),b0.waveBuffer.p4(1718449184),b0.waveBuffer.ip4(16),b0.waveBuffer.ip2(1),b0.waveBuffer.ip2(1),b0.waveBuffer.ip4(22050),b0.waveBuffer.ip4(22050),b0.waveBuffer.ip2(1),b0.waveBuffer.ip2(8),b0.waveBuffer.p4(1684108385),b0.waveBuffer.ip4(u),b0.waveBuffer.pos+=u,b0.waveBuffer}generate(_){let u=0;for(let O=0;O<10;O++)if(this.tones[O]&&this.tones[O].length+this.tones[O].start>u)u=this.tones[O].length+this.tones[O].start;if(u===0)return 0;let R=u*22050/1000|0,b=this.loopBegin*22050/1000|0,m=this.loopEnd*22050/1000|0;if(b<0||m<0||m>R||b>=m)_=0;let E=R+(m-b)*(_-1);for(let O=44;O<E+44;O++)if(b0.waveBytes)b0.waveBytes[O]=-128;for(let O=0;O<10;O++)if(this.tones[O]){let I=this.tones[O].length*22050/1000|0,L=this.tones[O].start*22050/1000|0,H=this.tones[O].generate(I,this.tones[O].length);for(let G=0;G<I;G++)if(b0.waveBytes)b0.waveBytes[G+L+44]+=H[G]>>8<<24>>24}if(_>1){b+=44,m+=44,R+=44,E+=44;let O=E-R;for(let I=R-1;I>=m;I--)if(b0.waveBytes)b0.waveBytes[I+O]=b0.waveBytes[I];for(let I=1;I<_;I++){let L=(m-b)*I;for(let H=b;H<m;H++)if(b0.waveBytes)b0.waveBytes[H+L]=b0.waveBytes[H]}E-=44}return E}}class Q1{requestModel(_){}}class C0 extends V0{archive=0;file=0;data=null;cycle=0;urgent=!0}import{pako as g1}from"./deps.js";class K1 extends Q1{modernized=!0;versions=[];crcs=[];priorities=[];topPriority=0;models=[];mapIndex=[];mapLand=[];mapLoc=[];mapMembers=[];animIndex=[];midiIndex=[];running=!0;app;active=!1;importantCount=0;requestCount=0;requests=new s0;queue=new $0;missing=new $0;pending=new $0;completed=new $0;prefetches=new $0;message="";buf=new Uint8Array(500);data=new Uint8Array(65000);loadedPrefetchFiles=0;totalPrefetchFiles=0;partOffset=0;partAvailable=0;waitCycles=0;heartbeatCycle=0;cycle=0;socketOpenTime=0;current=null;stream=null;constructor(_,u){super();let R=["model_version","anim_version","midi_version","map_version"];for(let E=0;E<4;E++){let O=_.read(R[E]);if(!O)throw new Error;let I=O.length/2,L=new z(O);this.versions[E]=new Array(I),this.priorities[E]=new Array(I);for(let H=0;H<I;H++)this.versions[E][H]=L.g2()}let b=["model_crc","anim_crc","midi_crc","map_crc"];for(let E=0;E<4;E++){let O=_.read(b[E]);if(!O)throw new Error;let I=O.length/4,L=new z(O);this.crcs[E]=new Array(I);for(let H=0;H<I;H++)this.crcs[E][H]=L.g4()}let m=_.read("model_index");if(m){let E=this.versions[0].length;this.models=new Array(E);for(let O=0;O<E;O++)if(O<m.length)this.models[O]=m[O];else this.models[O]=0}if(m=_.read("map_index"),m){let E=m.length/7,O=new z(m);this.mapIndex=new Array(E),this.mapLand=new Array(E),this.mapLoc=new Array(E),this.mapMembers=new Array(E);for(let I=0;I<E;I++)this.mapIndex[I]=O.g2(),this.mapLand[I]=O.g2(),this.mapLoc[I]=O.g2(),this.mapMembers[I]=O.g1()}if(m=_.read("anim_index"),m){let E=m.length/2,O=new z(m);this.animIndex=new Array(E);for(let I=0;I<E;I++)this.animIndex[I]=O.g2()}if(m=_.read("midi_index"),m){let E=m.length,O=new z(m);this.midiIndex=new Array(E);for(let I=0;I<E;I++)this.midiIndex[I]=O.g1()}this.app=u,this.running=!0}stop(){this.running=!1}getFileCount(_){return this.versions[_].length}getAnimCount(){return this.animIndex.length}getMapFile(_,u,R){let b=(_<<8)+u;for(let m=0;m<this.mapIndex.length;m++)if(this.mapIndex[m]===b)if(R===0)return this.mapLand[m];else return this.mapLoc[m];return-1}async prefetchMaps(_){let u=this.mapIndex.length;for(let R=0;R<u;R++)if(_||this.mapMembers[R]!=0)await this.prefetchPriority(3,this.mapLoc[R],2),await this.prefetchPriority(3,this.mapLand[R],2)}hasMapLocFile(_){for(let u=0;u<this.mapIndex.length;u++)if(this.mapLoc[u]===_)return!0;return!1}getModelFlags(_){return this.models[_]&255}shouldPrefetchMidi(_){return this.midiIndex[_]===1}requestModel(_){this.request(0,_)}request(_,u){if(_<0||_>this.versions.length||u<0||u>this.versions[_].length||this.versions[_][u]==0)return;for(let b=this.requests.head();b!==null;b=this.requests.next())if(b.archive==_&&b.file==u)return;let R=new C0;R.archive=_,R.file=u,R.urgent=!0,this.queue.push(R),this.requests.push(R)}remaining(){return this.requests.size()}loop(){let _=this.completed.pop();if(_===null)return null;if(_.unlink2(),_.data===null)return _;return _.data=g1.inflate(_.data),_}async prefetchPriority(_,u,R){if(!this.app.db||this.versions[_][u]===0)return;let b=await this.app.db.read(_+1,u);if(this.validate(b,this.crcs[_][u],this.versions[_][u]))return;if(this.priorities[_][u]=R,R>this.topPriority)this.topPriority=R;this.totalPrefetchFiles++}clearPrefetches(){this.prefetches.clear()}prefetch(_,u){if(!this.app.db||this.versions[_][u]===0||this.priorities[_][u]===0||this.topPriority===0)return;let R=new C0;R.archive=_,R.file=u,R.urgent=!1,this.prefetches.push(R)}async run(){if(!this.running)return;this.cycle++,this.active=!0;for(let u=0;u<100&&this.active;u++){if(this.active=!1,await this.handleQueue(),await this.handlePending(),this.importantCount===0&&u>=5)break;await this.handleExtras(),await this.read()}let _=!1;for(let u=this.pending.head();u!==null;u=this.pending.next())if(u.urgent){if(_=!0,u.cycle++,u.cycle>50)u.cycle=0,this.send(u)}if(!_){for(let u=this.pending.head();u!==null;u=this.pending.next())if(_=!0,u.cycle++,u.cycle>50)u.cycle=0,this.send(u)}if(_){if(this.waitCycles++,this.waitCycles>750){if(this.stream)this.stream.close(),this.stream=null;this.partAvailable=0}}else this.waitCycles=0,this.message="";if(this.app.ingame&&this.stream&&(this.topPriority>0||!this.app.db)){if(this.heartbeatCycle++,this.heartbeatCycle>500)this.heartbeatCycle=0,this.buf[0]=0,this.buf[1]=0,this.buf[2]=0,this.buf[3]=10,this.stream.write(this.buf,4)}}async handleQueue(){let _=this.queue.pop();while(_!==null){this.active=!0;let u;if(this.app.db)u=await this.app.db.read(_.archive+1,_.file);if(!this.validate(u,this.crcs[_.archive][_.file],this.versions[_.archive][_.file]))u=void 0;if(!u)this.missing.push(_);else _.data=u,this.completed.push(_);_=this.queue.pop()}}async handlePending(){this.importantCount=0,this.requestCount=0;for(let _=this.pending.head();_!==null;_=this.pending.next())if(_.urgent)this.importantCount++;else this.requestCount++;while(this.importantCount<10){let _=this.missing.pop();if(_===null)break;if(this.priorities[_.archive][_.file]!==0)this.loadedPrefetchFiles++;this.priorities[_.archive][_.file]=0,this.pending.push(_),this.importantCount++,await this.send(_),this.active=!0}}async handleExtras(){while(this.importantCount===0&&this.requestCount<10){if(this.topPriority===0)return;let _=this.prefetches.pop();while(_!==null){if(this.priorities[_.archive][_.file]!=0){if(this.priorities[_.archive][_.file]=0,this.pending.push(_),await this.send(_),this.active=!0,this.loadedPrefetchFiles<this.totalPrefetchFiles)this.loadedPrefetchFiles++;if(this.message="Loading extra files - "+(this.loadedPrefetchFiles*100/this.totalPrefetchFiles|0)+"%",this.requestCount++,this.requestCount==10)return}_=this.prefetches.pop()}for(let u=0;u<4;u++){let R=this.priorities[u],b=R.length;for(let m=0;m<b;m++)if(R[m]==this.topPriority){R[m]=0;let E=new C0;if(E.archive=u,E.file=m,E.urgent=!1,this.pending.push(E),await this.send(E),this.active=!0,this.loadedPrefetchFiles<this.totalPrefetchFiles)this.loadedPrefetchFiles++;if(this.message="Loading extra files - "+(this.loadedPrefetchFiles*100/this.totalPrefetchFiles|0)+"%",this.requestCount++,this.requestCount==10)return}}this.topPriority--}}async read(){if(this.modernized){for(let _=this.pending.head();_!==null;_=this.pending.next()){this.current=_;break}if(this.current){if(this.current.data=await i0(`/${this.current.archive+1}/${this.current.file}`),this.app.db)this.app.db.write(this.current.archive+1,this.current.file,this.current.data);if(!this.current.urgent&&this.current.archive===3)this.current.urgent=!0,this.current.archive=93;if(this.current.urgent)this.completed.push(this.current);else this.current.unlink();this.current=null}}else{if(!this.stream)return;try{let _=this.stream.available;if(this.partAvailable===0&&_>=6){this.active=!0,await this.stream.readBytes(this.buf,0,6);let u=this.buf[0]&255,R=((this.buf[1]&255)<<8)+(this.buf[2]&255),b=((this.buf[3]&255)<<8)+(this.buf[4]&255),m=this.buf[5]&255;this.current=null;for(let E=this.pending.head();E!==null;E=this.pending.next()){if(E.archive==u&&E.file==R)this.current=E;if(this.current!=null)E.cycle=0}if(this.current)if(this.waitCycles=0,b===0){if(this.current.data=null,this.current.urgent)this.completed.push(this.current);else this.current.unlink();this.current=null}else{if(this.current.data===null&&m===0)this.current.data=new Uint8Array(b);if(this.current.data===null&&m!=0)throw new Error}if(this.partOffset=m*500,this.partAvailable=500,this.partAvailable>b-m*500)this.partAvailable=b-m*500}if(this.partAvailable>0&&_>=this.partAvailable){this.active=!0;let u=this.buf,R=0;if(this.current&&this.current.data)u=this.current.data,R=this.partOffset;if(await this.stream.readBytes(u,R,this.partAvailable),this.partAvailable+this.partOffset>=u.length&&this.current){if(this.app.db)this.app.db.write(this.current.archive+1,this.current.file,u);if(!this.current.urgent&&this.current.archive===3)this.current.urgent=!0,this.current.archive=93;if(this.current.urgent)this.completed.push(this.current);else this.current.unlink()}this.partAvailable=0}}catch(_){if(this.stream)this.stream.close();this.stream=null,this.partAvailable=0}}}validate(_,u,R){if(typeof _==="undefined"||_.length<2)return!1;let b=_.length-2,m=((_[b]&255)<<8)+(_[b+1]&255),E=z.crc32(_.subarray(0,_.length-2));return m===R&&E===u}async send(_){if(this.modernized)return;try{if(this.stream===null){let u=Date.now();if(u-this.socketOpenTime<5000)return;this.socketOpenTime=u,this.stream=new S0(await S0.openSocket(window.location.host,window.location.protocol==="https:")),this.buf[0]=15,this.stream.write(this.buf,1);for(let R=0;R<8;R++)await this.stream.read();this.waitCycles=0}if(this.buf[0]=_.archive,this.buf[1]=_.file>>8,this.buf[2]=_.file,_.urgent)this.buf[3]=2;else if(this.app.ingame)this.buf[3]=0;else this.buf[3]=1;this.stream.write(this.buf,4),this.heartbeatCycle=0}catch(u){this.stream=null,this.partAvailable=0}}}class v extends o0{static nodeId=10;static membersWorld=!0;static lowMemory=!1;static cyclelogic1=0;static cyclelogic2=0;static cyclelogic3=0;static cyclelogic4=0;static cyclelogic5=0;static cyclelogic6=0;static oplogic1=0;static oplogic2=0;static oplogic3=0;static oplogic4=0;static oplogic5=0;static oplogic6=0;static oplogic7=0;static oplogic8=0;static oplogic9=0;alreadyStarted=!1;errorStarted=!1;errorLoading=!1;errorHost=!1;errorMessage=null;db=null;loopCycle=0;jagChecksum=[];stream=null;in=z.alloc(1);out=z.alloc(1);loginout=z.alloc(1);serverSeed=0n;idleNetCycles=0;idleTimeout=0;systemUpdateTimer=0;randomIn=null;ptype=0;psize=0;ptype0=0;ptype1=0;ptype2=0;jagTitle=null;redrawFrame=!0;titleScreenState=0;titleLoginField=0;imageTitle2=null;imageTitle3=null;imageTitle4=null;imageTitle0=null;imageTitle1=null;imageTitle5=null;imageTitle6=null;imageTitle7=null;imageTitle8=null;imageTitlebox=null;imageTitlebutton=null;loginMessage0="";loginMessage1="";username="";password="";fontPlain11=null;fontPlain12=null;fontBold12=null;fontQuill8=null;imageRunes=[];flameActive=!1;imageFlamesLeft=null;imageFlamesRight=null;flameBuffer1=null;flameBuffer0=null;flameBuffer3=null;flameBuffer2=null;flameGradient=null;flameGradient0=null;flameGradient1=null;flameGradient2=null;flameLineOffset=new Int32Array(256);flameCycle0=0;flameGradientCycle0=0;flameGradientCycle1=0;flamesInterval=null;areaSidebar=null;areaMapback=null;areaViewport=null;areaChatback=null;areaBackbase1=null;areaBackbase2=null;areaBackhmid1=null;areaBackleft1=null;areaBackleft2=null;areaBackright1=null;areaBackright2=null;areaBacktop1=null;areaBackvmid1=null;areaBackvmid2=null;areaBackvmid3=null;areaBackhmid2=null;areaChatbackOffsets=null;areaSidebarOffsets=null;areaViewportOffsets=null;compassMaskLineOffsets=new Int32Array(33);compassMaskLineLengths=new Int32Array(33);minimapMaskLineOffsets=new Int32Array(151);minimapMaskLineLengths=new Int32Array(151);imageInvback=null;imageChatback=null;imageMapback=null;imageBackbase1=null;imageBackbase2=null;imageBackhmid1=null;imageSideicons=new p(13,null);imageMinimap=null;imageCompass=null;imageMapedge=null;imageMapscene=new p(50,null);imageMapfunction=new p(50,null);imageHitmarks=new p(20,null);imageHeadicon=new p(20,null);imageMapmarker0=null;imageMapmarker1=null;imageCrosses=new p(8,null);imageMapdot0=null;imageMapdot1=null;imageMapdot2=null;imageMapdot3=null;imageScrollbar0=null;imageScrollbar1=null;imageRedstone1=null;imageRedstone2=null;imageRedstone3=null;imageRedstone1h=null;imageRedstone2h=null;imageRedstone1v=null;imageRedstone2v=null;imageRedstone3v=null;imageRedstone1hv=null;imageRedstone2hv=null;genderButtonImage0=null;genderButtonImage1=null;activeMapFunctions=new p(1000,null);redrawSidebar=!1;redrawChatback=!1;redrawSideicons=!1;redrawPrivacySettings=!1;viewportInterfaceId=-1;dragCycles=0;crossMode=0;crossCycle=0;crossX=0;crossY=0;overrideChat=0;menuVisible=!1;menuArea=0;menuX=0;menuY=0;menuWidth=0;menuHeight=0;menuSize=0;menuOption=[];sidebarInterfaceId=-1;chatInterfaceId=-1;chatInterface=new s;chatScrollHeight=78;chatScrollOffset=0;ignoreCount=0;ignoreName37=[];hintType=0;hintNpc=0;hintOffsetX=0;hintOffsetZ=0;hintPlayer=0;hintTileX=0;hintTileZ=0;hintHeight=0;skillExperience=[];skillLevel=[];skillBaseLevel=[];levelExperience=[];modalMessage=null;flashingTab=-1;selectedTab=3;tabInterfaceId=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];chatPublicMode=0;chatPrivateMode=0;chatTradeMode=0;scrollGrabbed=!1;scrollInputPadding=0;showSocialInput=!1;socialMessage="";socialInput="";socialInputType=0;chatbackInput="";chatbackInputOpen=!1;stickyChatInterfaceId=-1;messageText=new p(100,null);messageSender=new p(100,null);messageType=new Int32Array(100);messageTextIds=new Int32Array(100);privateMessageCount=0;splitPrivateChat=0;chatEffects=0;chatTyped="";viewportHoveredInterfaceIndex=0;sidebarHoveredInterfaceIndex=0;chatHoveredInterfaceIndex=0;objDragInterfaceId=0;objDragSlot=0;objDragArea=0;objGrabX=0;objGrabY=0;objDragCycles=0;objGrabThreshold=!1;objSelected=0;objSelectedSlot=0;objSelectedInterface=0;objInterface=0;objSelectedName=null;selectedArea=0;selectedItem=0;selectedInterface=0;selectedCycle=0;pressedContinueOption=!1;varps=[];varCache=[];spellSelected=0;activeSpellId=0;activeSpellFlags=0;spellCaption=null;oneMouseButton=0;menuAction=new Int32Array(500);menuParamA=new Int32Array(500);menuParamB=new Int32Array(500);menuParamC=new Int32Array(500);hoveredSlotParentId=0;hoveredSlot=0;lastHoveredInterfaceId=0;reportAbuseInput="";reportAbuseMuteOption=!1;reportAbuseInterfaceId=-1;lastAddress=0;daysSinceLastLogin=0;daysSinceRecoveriesChanged=0;unreadMessages=0;activeMapFunctionCount=0;activeMapFunctionX=new Int32Array(1000);activeMapFunctionZ=new Int32Array(1000);scene=null;sceneState=0;sceneDelta=0;sceneCycle=0;flagSceneTileX=0;flagSceneTileZ=0;cutscene=!1;macroCameraCycle=0;macroCameraX=0;macroCameraZ=0;macroCameraAngle=0;macroCameraXModifier=2;macroCameraZModifier=2;macroCameraAngleModifier=1;cameraModifierCycle=new Int32Array(5);cameraModifierEnabled=new p(5,!1);cameraModifierJitter=new Int32Array(5);cameraModifierWobbleScale=new Int32Array(5);cameraModifierWobbleSpeed=new Int32Array(5);cameraX=0;cameraY=0;cameraZ=0;cameraPitch=0;cameraYaw=0;cameraPitchClamp=0;macroMinimapCycle=0;macroMinimapAngle=0;macroMinimapZoom=0;macroMinimapZoomModifier=1;macroMinimapAngleModifier=2;minimapLevel=-1;baseX=0;baseZ=0;sceneCenterZoneX=0;sceneCenterZoneZ=0;sceneBaseTileX=0;sceneBaseTileZ=0;sceneMapLandData=null;sceneMapLandFile=[];sceneMapLocData=null;sceneMapLocFile=[];sceneMapIndex=null;withinTutorialIsland=!1;awaitingSync=!1;scenePrevBaseTileX=0;scenePrevBaseTileZ=0;textureBuffer=new Int8Array(16384);levelCollisionMap=new p(4,null);currentLevel=0;orbitCameraPitch=128;orbitCameraYaw=0;orbitCameraYawVelocity=0;orbitCameraPitchVelocity=0;orbitCameraX=0;orbitCameraZ=0;levelHeightmap=null;levelTileFlags=null;tileLastOccupiedCycle=new X0(104,104);projectX=0;projectY=0;cutsceneDstLocalTileX=0;cutsceneDstLocalTileZ=0;cutsceneDstHeight=0;cutsceneRotateSpeed=0;cutsceneRotateAcceleration=0;cutsceneSrcLocalTileX=0;cutsceneSrcLocalTileZ=0;cutsceneSrcHeight=0;cutsceneMoveSpeed=0;cutsceneMoveAcceleration=0;players=new p(2048,null);playerCount=0;playerIds=new Int32Array(2048);entityUpdateCount=0;entityRemovalCount=0;entityUpdateIds=new Int32Array(2048);entityRemovalIds=new Int32Array(1000);playerAppearanceBuffer=new p(2048,null);npcs=new p(8192,null);npcCount=0;npcIds=new Int32Array(8192);projectiles=new $0;spotanims=new $0;objStacks=new t0(4,104,104,null);locChanges=new $0;bfsStepX=new Int32Array(4000);bfsStepZ=new Int32Array(4000);bfsDirection=new Int32Array(104*104);bfsCost=new Int32Array(104*104);tryMoveNearest=0;localPlayer=null;runenergy=0;inMultizone=0;localPid=-1;runweight=0;noTimeoutCycle=0;wildernessLevel=0;worldLocationState=0;staffmodlevel=0;designGender=!0;updateDesignModel=!1;designKits=new Int32Array(7);designColours=new Int32Array(5);static CHAT_COLORS=Int32Array.of(16776960,16711680,65280,65535,16711935,16777215);friendCount=0;chatCount=0;chatX=new Int32Array(50);chatY=new Int32Array(50);chatHeight=new Int32Array(50);chatWidth=new Int32Array(50);chatColors=new Int32Array(50);chatEffect=new Int32Array(50);chatTimers=new Int32Array(50);chats=new p(50,null);friendName=new p(200,null);friendName37=new BigInt64Array(200);friendWorld=new Int32Array(200);socialName37=null;waveCount=0;waveEnabled=!0;waveIds=new Int32Array(50);waveLoops=new Int32Array(50);waveDelay=new Int32Array(50);waveVolume=64;lastWaveId=-1;lastWaveLoops=-1;lastWaveLength=0;lastWaveStartTime=0;nextMusicDelay=0;midiActive=!0;midiVolume=64;midiSong=-1;midiFading=!1;nextMidiSong=-1;displayFps=!1;onDemand=null;ingame=!1;imageModIcons=[];lastProgressPercent=0;lastProgressMessage="";drawCycle=0;sceneLoadStartTime=0;viewportOverlayInterfaceId=-1;bankArrangeMode=0;field1264=0;warnMembersInNonMembers=0;membersAccount=0;flameCycle=0;initializeLevelExperience(){let _=0;for(let u=0;u<99;u++){let R=u+1,b=R+Math.pow(2,R/7)*300|0;_+=b,this.levelExperience[u]=_/4|0}}constructor(_,u,R){super();if(typeof _==="undefined"||typeof u==="undefined"||typeof R==="undefined")return;if(v.nodeId=_,v.membersWorld=R,u)v.setLowMemory();else v.setHighMemory();this.run()}static setLowMemory(){k.lowMemory=!0,A.lowMemory=!0,v.lowMemory=!0,i.lowMemory=!0}static setHighMemory(){k.lowMemory=!1,A.lowMemory=!1,v.lowMemory=!1,i.lowMemory=!1}saveMidi(_,u){v1(u,this.midiVolume,_)}async load(){if(this.isMobile&&v.lowMemory)this.setTargetedFramerate(30);if(this.alreadyStarted){this.errorStarted=!0;return}this.alreadyStarted=!0;try{this.db=new x0(await x0.openDatabase())}catch(_){this.db=null}try{await this.drawProgress(10,"Connecting to web server");let _=new z(await i0("/crc"));for(let j=0;j<9;j++)this.jagChecksum[j]=_.g4();this.jagTitle=await this.getJagFile("title","title screen",1,25),this.fontPlain11=k0.fromArchive(this.jagTitle,"p11"),this.fontPlain12=k0.fromArchive(this.jagTitle,"p12"),this.fontBold12=k0.fromArchive(this.jagTitle,"b12"),this.fontQuill8=k0.fromArchive(this.jagTitle,"q8"),await this.loadTitleBackground(),await this.loadTitleImages();let u=await this.getJagFile("config","config",2,30),R=await this.getJagFile("interface","interface",3,35),b=await this.getJagFile("media","2d graphics",4,40),m=await this.getJagFile("textures","textures",6,45),E=await this.getJagFile("wordenc","chat system",7,50),O=await this.getJagFile("sounds","sound effects",8,55);this.levelTileFlags=new M0(4,104,104),this.levelHeightmap=new D0(4,104+1,104+1),this.scene=new k(this.levelHeightmap,104,4,104);for(let j=0;j<4;j++)this.levelCollisionMap[j]=new o;this.imageMinimap=new R0(512,512);let I=await this.getJagFile("versionlist","update list",5,60);if(await this.drawProgress(60,"Connecting to update server"),this.onDemand=new K1(I,this),w0.init(this.onDemand.getAnimCount()),$.init(this.onDemand.getFileCount(0),this.onDemand),!v.lowMemory){this.midiSong=0,this.midiFading=!1,this.onDemand.request(2,this.midiSong);while(this.onDemand.remaining()>0)await this.updateOnDemand(),await Z0(100)}await this.drawProgress(65,"Requesting animations");let L=this.onDemand.getFileCount(1);for(let j=0;j<L;j++)this.onDemand.request(1,j);while(this.onDemand.remaining()>0){let j=L-this.onDemand.remaining();if(j>0)await this.drawProgress(65,"Loading animations - "+(j*100/L|0)+"%");await this.updateOnDemand(),await Z0(100)}await this.drawProgress(70,"Requesting models");let H=this.onDemand.getFileCount(0);for(let j=0;j<H;j++)if((this.onDemand.getModelFlags(j)&1)!=0)this.onDemand.request(0,j);let G=this.onDemand.remaining();while(this.onDemand.remaining()>0){let j=G-this.onDemand.remaining();if(j>0)await this.drawProgress(70,"Loading models - "+(j*100/G|0)+"%");await this.updateOnDemand(),await Z0(100)}if(this.db){await this.drawProgress(75,"Requesting maps"),this.onDemand.request(3,this.onDemand.getMapFile(47,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(47,48,1)),this.onDemand.request(3,this.onDemand.getMapFile(48,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(48,48,1)),this.onDemand.request(3,this.onDemand.getMapFile(49,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(49,48,1)),this.onDemand.request(3,this.onDemand.getMapFile(47,47,0)),this.onDemand.request(3,this.onDemand.getMapFile(47,47,1)),this.onDemand.request(3,this.onDemand.getMapFile(48,47,0)),this.onDemand.request(3,this.onDemand.getMapFile(48,47,1)),this.onDemand.request(3,this.onDemand.getMapFile(148,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(148,48,1));let j=this.onDemand.remaining();while(this.onDemand.remaining()>0){let W=j-this.onDemand.remaining();if(W>0)await this.drawProgress(75,"Loading maps - "+(W*100/j|0)+"%");await this.updateOnDemand(),await Z0(100)}}let N=this.onDemand.getFileCount(0);for(let j=0;j<N;j++){let W=this.onDemand.getModelFlags(j),M=0;if((W&8)!=0)M=10;else if((W&32)!=0)M=9;else if((W&16)!=0)M=8;else if((W&64)!=0)M=7;else if((W&128)!=0)M=6;else if((W&2)!=0)M=5;else if((W&4)!=0)M=4;if((W&1)!=0)M=3;if(M!=0)await this.onDemand.prefetchPriority(0,j,M)}if(await this.onDemand.prefetchMaps(v.membersWorld),!v.lowMemory){let j=this.onDemand.getFileCount(2);for(let W=0;W<j;W++)if(this.onDemand.shouldPrefetchMidi(W))this.onDemand.prefetchPriority(2,W,1)}await this.drawProgress(80,"Unpacking media"),this.imageInvback=O0.fromArchive(b,"invback",0),this.imageChatback=O0.fromArchive(b,"chatback",0),this.imageMapback=O0.fromArchive(b,"mapback",0),this.imageBackbase1=O0.fromArchive(b,"backbase1",0),this.imageBackbase2=O0.fromArchive(b,"backbase2",0),this.imageBackhmid1=O0.fromArchive(b,"backhmid1",0);for(let j=0;j<13;j++)this.imageSideicons[j]=O0.fromArchive(b,"sideicons",j);this.imageCompass=R0.fromArchive(b,"compass",0),this.imageMapedge=R0.fromArchive(b,"mapedge",0),this.imageMapedge.crop();try{for(let j=0;j<50;j++)this.imageMapscene[j]=O0.fromArchive(b,"mapscene",j)}catch(j){}try{for(let j=0;j<50;j++)this.imageMapfunction[j]=R0.fromArchive(b,"mapfunction",j)}catch(j){}try{for(let j=0;j<20;j++)this.imageHitmarks[j]=R0.fromArchive(b,"hitmarks",j)}catch(j){}try{for(let j=0;j<20;j++)this.imageHeadicon[j]=R0.fromArchive(b,"headicons",j)}catch(j){}this.imageMapmarker0=R0.fromArchive(b,"mapmarker",0),this.imageMapmarker1=R0.fromArchive(b,"mapmarker",1);for(let j=0;j<8;j++)this.imageCrosses[j]=R0.fromArchive(b,"cross",j);this.imageMapdot0=R0.fromArchive(b,"mapdots",0),this.imageMapdot1=R0.fromArchive(b,"mapdots",1),this.imageMapdot2=R0.fromArchive(b,"mapdots",2),this.imageMapdot3=R0.fromArchive(b,"mapdots",3),this.imageScrollbar0=O0.fromArchive(b,"scrollbar",0),this.imageScrollbar1=O0.fromArchive(b,"scrollbar",1),this.imageRedstone1=O0.fromArchive(b,"redstone1",0),this.imageRedstone2=O0.fromArchive(b,"redstone2",0),this.imageRedstone3=O0.fromArchive(b,"redstone3",0),this.imageRedstone1h=O0.fromArchive(b,"redstone1",0),this.imageRedstone1h?.flipHorizontally(),this.imageRedstone2h=O0.fromArchive(b,"redstone2",0),this.imageRedstone2h?.flipHorizontally(),this.imageRedstone1v=O0.fromArchive(b,"redstone1",0),this.imageRedstone1v?.flipVertically(),this.imageRedstone2v=O0.fromArchive(b,"redstone2",0),this.imageRedstone2v?.flipVertically(),this.imageRedstone3v=O0.fromArchive(b,"redstone3",0),this.imageRedstone3v?.flipVertically(),this.imageRedstone1hv=O0.fromArchive(b,"redstone1",0),this.imageRedstone1hv?.flipHorizontally(),this.imageRedstone1hv?.flipVertically(),this.imageRedstone2hv=O0.fromArchive(b,"redstone2",0),this.imageRedstone2hv?.flipHorizontally(),this.imageRedstone2hv?.flipVertically();for(let j=0;j<2;j++)this.imageModIcons[j]=O0.fromArchive(b,"mod_icons",j);let T=R0.fromArchive(b,"backleft1",0);this.areaBackleft1=new I0(T.cropRight,T.cropBottom),T.blitOpaque(0,0);let K=R0.fromArchive(b,"backleft2",0);this.areaBackleft2=new I0(K.cropRight,K.cropBottom),K.blitOpaque(0,0);let Q=R0.fromArchive(b,"backright1",0);this.areaBackright1=new I0(Q.cropRight,Q.cropBottom),Q.blitOpaque(0,0);let U=R0.fromArchive(b,"backright2",0);this.areaBackright2=new I0(U.cropRight,U.cropBottom),U.blitOpaque(0,0);let J=R0.fromArchive(b,"backtop1",0);this.areaBacktop1=new I0(J.cropRight,J.cropBottom),J.blitOpaque(0,0);let q=R0.fromArchive(b,"backvmid1",0);this.areaBackvmid1=new I0(q.cropRight,q.cropBottom),q.blitOpaque(0,0);let w=R0.fromArchive(b,"backvmid2",0);this.areaBackvmid2=new I0(w.cropRight,w.cropBottom),w.blitOpaque(0,0);let V=R0.fromArchive(b,"backvmid3",0);this.areaBackvmid3=new I0(V.cropRight,V.cropBottom),V.blitOpaque(0,0);let Y=R0.fromArchive(b,"backhmid2",0);this.areaBackhmid2=new I0(Y.cropRight,Y.cropBottom),Y.blitOpaque(0,0);let n=(Math.random()*21|0)-10,f=(Math.random()*21|0)-10,Z=(Math.random()*21|0)-10,h=(Math.random()*41|0)-20;for(let j=0;j<50;j++){if(this.imageMapfunction[j])this.imageMapfunction[j]?.translate2d(n+h,f+h,Z+h);if(this.imageMapscene[j])this.imageMapscene[j]?.translate2d(n+h,f+h,Z+h)}if(await this.drawProgress(83,"Unpacking textures"),A.unpackTextures(m),A.setBrightness(0.8),A.initPool(20),await this.drawProgress(86,"Unpacking config"),l.unpack(u),u0.unpack(u),h0.unpack(u),d.unpack(u,v.membersWorld),j0.unpack(u),J0.unpack(u),q0.unpack(u),B0.unpack(u),!v.lowMemory)await this.drawProgress(90,"Unpacking sounds"),b0.unpack(O);await this.drawProgress(95,"Unpacking interfaces"),s.unpack(R,b,[this.fontPlain11,this.fontPlain12,this.fontBold12,this.fontQuill8]),await this.drawProgress(100,"Preparing game engine");for(let j=0;j<33;j++){let W=999,M=0;for(let X=0;X<34;X++)if(this.imageMapback.pixels[X+j*this.imageMapback.width2d]===0){if(W===999)W=X}else if(W!==999){M=X;break}this.compassMaskLineOffsets[j]=W,this.compassMaskLineLengths[j]=M-W}for(let j=5;j<156;j++){let W=999,M=0;for(let X=25;X<172;X++)if(this.imageMapback.pixels[X+j*this.imageMapback.width2d]===0&&(X>34||j>34)){if(W===999)W=X}else if(W!==999){M=X;break}this.minimapMaskLineOffsets[j-5]=W-25,this.minimapMaskLineLengths[j-5]=M-W}A.init3D(479,96),this.areaChatbackOffsets=A.lineOffset,A.init3D(190,261),this.areaSidebarOffsets=A.lineOffset,A.init3D(512,334),this.areaViewportOffsets=A.lineOffset;let D=new Int32Array(9);for(let j=0;j<9;j++){let W=j*32+128+15,M=W*3+600,X=A.sin[W];D[j]=M*X>>16}k.init(512,334,500,800,D),W0.unpack(E),this.initializeLevelExperience()}catch(_){if(_ instanceof Error)this.errorMessage=`loaderror - ${this.lastProgressMessage} ${this.lastProgressPercent}%: ${_.message}`;this.errorLoading=!0}}async update(){if(this.errorStarted||this.errorLoading||this.errorHost)return;if(this.loopCycle++,this.ingame)await this.updateGame();else await this.updateTitle();await this.updateOnDemand()}async draw(){if(this.errorStarted||this.errorLoading||this.errorHost){this.drawError();return}if(this.drawCycle++,this.ingame)this.drawGame();else await this.drawTitle();this.dragCycles=0}async refresh(){this.redrawFrame=!0}async drawProgress(_,u){if(this.lastProgressPercent=_,this.lastProgressMessage=u,await this.loadTitle(),!this.jagTitle){await super.drawProgress(_,u);return}this.imageTitle4?.bind();let R=360,b=200,m=20;this.fontBold12?.drawStringCenter(R/2|0,(b/2|0)-m-26,"RuneScape is loading - please wait...",16777215);let E=(b/2|0)-18-m;if(F.drawRect((R/2|0)-152,E,304,34,9179409),F.drawRect((R/2|0)-151,E+1,302,32,0),F.fillRect2d((R/2|0)-150,E+2,_*3,30,9179409),F.fillRect2d((R/2|0)-150+_*3,E+2,300-_*3,30,0),this.fontBold12?.drawStringCenter(R/2|0,(b/2|0)+5-m,u,16777215),this.imageTitle4?.draw(202,171),this.redrawFrame){if(this.redrawFrame=!1,!this.flameActive)this.imageTitle0?.draw(0,0),this.imageTitle1?.draw(637,0);this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(202,371),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(562,265),this.imageTitle7?.draw(128,171),this.imageTitle8?.draw(562,171)}await Z0(5)}drawError(){y.fillStyle="black",y.fillRect(0,0,this.width,this.height),this.setFramerate(1),this.flameActive=!1;let _=0;if(this.errorLoading)y.font="bold 16px helvetica, sans-serif",y.textAlign="left",y.fillStyle="yellow",_=35,y.fillText("Sorry, an error has occured whilst loading RuneScape",30,_),_+=50,y.fillStyle="white",y.fillText("To fix this try the following (in order):",30,_),_+=50,y.font="bold 12px helvetica, sans-serif",y.fillText("1: Try closing ALL open web-browser windows, and reloading",30,_),_+=30,y.fillText("2: Try clearing your web-browsers cache",30,_),_+=30,y.fillText("3: Try using a different game-world",30,_),_+=30,y.fillText("4: Try rebooting your computer",30,_),_+=30,y.fillText("5: Try selecting a different method from the play-game menu",30,_);else if(this.errorHost)y.font="bold 20px helvetica, sans-serif",y.textAlign="left",y.fillStyle="white",_=50,y.fillText("Error - unable to load game!",50,_),_+=50,y.fillText("To play RuneScape make sure you play from",50,_),_+=50,y.fillText("An approved domain",50,_);else if(this.errorStarted)y.font="bold 13px helvetica, sans-serif",y.textAlign="left",y.fillStyle="yellow",_=35,y.fillText("Error a copy of RuneScape already appears to be loaded",30,_),_+=50,y.fillStyle="white",y.fillText("To fix this try the following (in order):",30,_),_+=50,y.font="bold 12px helvetica, sans-serif",y.fillText("1: Try closing ALL open web-browser windows, and reloading",30,_),_+=30,y.fillText("2: Try rebooting your computer, and reloading",30,_);if(this.errorMessage)_+=50,y.fillStyle="red",y.fillText(this.errorMessage,30,_)}async getJagFile(_,u,R,b){let m=this.jagChecksum[R],E,O=5;try{if(this.db)E=await this.db.read(0,R)}catch(L){}if(E&&z.crc32(E)!==m)E=void 0;if(E)return new r0(E);let I=0;while(!E){await this.drawProgress(b,`Requesting ${u}`);try{E=await i0(`/${_}${m}`);let L=z.crc32(E);if(m===L)try{if(this.db)await this.db.write(0,R,E)}catch(H){}else E=void 0,I++}catch(L){E=void 0}if(!E){for(let L=O;L>0;L--){if(I>=3)await this.drawProgress(b,"Game updated - please reload page"),L=10;else await this.drawProgress(b,`Error loading - Will retry in ${L} secs.`);await Z0(1000)}if(O*=2,O>60)O=60}}return new r0(E)}async updateOnDemand(){if(!this.onDemand)return;await this.onDemand.run();while(!0){let _=this.onDemand.loop();if(_===null)return;if(!_.data)continue;if(_.archive===0){if($.unpack(_.file,_.data),(this.onDemand.getModelFlags(_.file)&98)!=0){if(this.redrawSidebar=!0,this.chatInterfaceId!==-1)this.redrawChatback=!0}}else if(_.archive===1)w0.unpack(_.data);else if(_.archive===2){if(this.midiSong===_.file)this.saveMidi(this.midiFading,_.data)}else if(_.archive===3){if(this.sceneMapLandData&&this.sceneMapLocData&&this.sceneState===1)for(let u=0;u<this.sceneMapLandData.length;u++){if(this.sceneMapLandFile[u]==_.file){if(this.sceneMapLandData[u]=_.data,_.data==null)this.sceneMapLandFile[u]=-1;break}if(this.sceneMapLocFile[u]==_.file){if(this.sceneMapLocData[u]=_.data,_.data==null)this.sceneMapLocFile[u]=-1;break}}}else if(_.archive===93){if(this.onDemand.hasMapLocFile(_.file))i.prefetchLocs(new z(_.data),this.onDemand)}}}async updateTitle(){if(this.titleScreenState===0){let _=(this.width/2|0)-80,u=(this.height/2|0)+20;if(u+=20,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=u-20&&this.mouseClickY<=u+20)this.titleScreenState=3,this.titleLoginField=0;if(_=(this.width/2|0)+80,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=u-20&&this.mouseClickY<=u+20)this.loginMessage0="",this.loginMessage1="Enter your username & password.",this.titleScreenState=2,this.titleLoginField=0}else if(this.titleScreenState===2){let _=(this.height/2|0)-40;if(_+=30,_+=25,this.mouseClickButton===1&&this.mouseClickY>=_-15&&this.mouseClickY<_)this.titleLoginField=0;if(_+=15,this.mouseClickButton===1&&this.mouseClickY>=_-15&&this.mouseClickY<_)this.titleLoginField=1;let u=(this.width/2|0)-80;if(_=(this.height/2|0)+50,_+=20,this.mouseClickButton===1&&this.mouseClickX>=u-75&&this.mouseClickX<=u+75&&this.mouseClickY>=_-20&&this.mouseClickY<=_+20){if(await this.login(this.username,this.password,!1),this.ingame)return}if(u=(this.width/2|0)+80,this.mouseClickButton===1&&this.mouseClickX>=u-75&&this.mouseClickX<=u+75&&this.mouseClickY>=_-20&&this.mouseClickY<=_+20)this.titleScreenState=0,this.username="",this.password="";while(!0){let R=this.pollKey();if(R===-1)return;let b=!1;for(let m=0;m<k0.CHARSET.length;m++)if(String.fromCharCode(R)===k0.CHARSET.charAt(m)){b=!0;break}if(this.titleLoginField===0){if(R===8&&this.username.length>0)this.username=this.username.substring(0,this.username.length-1);if(R===9||R===10||R===13)this.titleLoginField=1;if(b)this.username=this.username+String.fromCharCode(R);if(this.username.length>12)this.username=this.username.substring(0,12)}else if(this.titleLoginField===1){if(R===8&&this.password.length>0)this.password=this.password.substring(0,this.password.length-1);if(R===9||R===10||R===13)this.titleLoginField=0;if(b)this.password=this.password+String.fromCharCode(R);if(this.password.length>20)this.password=this.password.substring(0,20)}}}else if(this.titleScreenState===3){let _=this.width/2|0,u=(this.height/2|0)+50;if(u+=20,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=u-20&&this.mouseClickY<=u+20)this.titleScreenState=0}}async login(_,u,R){try{if(!R)this.loginMessage0="",this.loginMessage1="Connecting to server...",await this.drawTitle();this.stream=new S0(await S0.openSocket(window.location.host,window.location.protocol==="https:"));let b=c.toBase37(_),m=Number(b>>16n)&31;this.out.pos=0,this.out.p1(14),this.out.p1(m),this.stream.write(this.out.data,2);for(let O=0;O<8;O++)await this.stream.read();let E=await this.stream.read();if(E===0){await this.stream.readBytes(this.in.data,0,8),this.in.pos=0,this.serverSeed=this.in.g8();let O=new Int32Array([Math.floor(Math.random()*99999999),Math.floor(Math.random()*99999999),Number(this.serverSeed>>32n),Number(this.serverSeed&BigInt(4294967295))]);if(this.out.pos=0,this.out.p1(10),this.out.p4(O[0]),this.out.p4(O[1]),this.out.p4(O[2]),this.out.p4(O[3]),this.out.p4(1337),this.out.pjstr(_),this.out.pjstr(u),this.out.rsaenc(BigInt("7162900525229798032761816791230527296329313291232324290237849263501208207972894053929065636522363163621000728841182238772712427862772219676577293600221789"),BigInt("58778699976184461502525193738213253649000149147835990136706041084440742975821")),this.loginout.pos=0,R)this.loginout.p1(18);else this.loginout.p1(16);this.loginout.p1(this.out.pos+36+1+1),this.loginout.p1(244),this.loginout.p1(v.lowMemory?1:0);for(let I=0;I<9;I++)this.loginout.p4(this.jagChecksum[I]);this.loginout.pdata(this.out.data,this.out.pos,0),this.out.random=new c0(O);for(let I=0;I<4;I++)O[I]+=50;this.randomIn=new c0(O),this.stream?.write(this.loginout.data,this.loginout.pos),E=await this.stream.read()}if(E===1)await Z0(2000),await this.login(_,u,R);else if(E===2||E===18||E===19){if(this.staffmodlevel=0,E===18)this.staffmodlevel=1;else if(E===19)this.staffmodlevel=2;N0.setDisabled(),this.hasFocus=!0,this.ingame=!0,this.out.pos=0,this.in.pos=0,this.ptype=-1,this.ptype0=-1,this.ptype1=-1,this.ptype2=-1,this.psize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.idleTimeout=0,this.hintType=0,this.field1264=0,this.menuSize=0,this.menuVisible=!1,this.idleCycles=Date.now();for(let O=0;O<100;O++)this.messageText[O]=null;this.objSelected=0,this.spellSelected=0,this.sceneState=0,this.waveCount=0,this.macroCameraX=(Math.random()*100|0)-50,this.macroCameraZ=(Math.random()*110|0)-55,this.macroCameraAngle=(Math.random()*80|0)-40,this.macroMinimapAngle=(Math.random()*120|0)-60,this.macroMinimapZoom=(Math.random()*30|0)-20,this.orbitCameraYaw=(Math.random()*20|0)-10&2047,this.minimapLevel=-1,this.flagSceneTileX=0,this.flagSceneTileZ=0,this.playerCount=0,this.npcCount=0;for(let O=0;O<2048;O++)this.players[O]=null,this.playerAppearanceBuffer[O]=null;for(let O=0;O<8192;O++)this.npcs[O]=null;this.localPlayer=this.players[2047]=new T0,this.projectiles.clear(),this.spotanims.clear();for(let O=0;O<4;O++)for(let I=0;I<104;I++)for(let L=0;L<104;L++)this.objStacks[O][I][L]=null;this.locChanges=new $0,this.friendCount=0,this.stickyChatInterfaceId=-1,this.chatInterfaceId=-1,this.viewportInterfaceId=-1,this.sidebarInterfaceId=-1,this.viewportOverlayInterfaceId=-1,this.pressedContinueOption=!1,this.selectedTab=3,this.chatbackInputOpen=!1,this.menuVisible=!1,this.showSocialInput=!1,this.modalMessage=null,this.inMultizone=0,this.flashingTab=-1,this.designGender=!0,this.validateCharacterDesign();for(let O=0;O<5;O++)this.designColours[O]=0;v.oplogic1=0,v.oplogic2=0,v.oplogic3=0,v.oplogic4=0,v.oplogic5=0,v.oplogic6=0,v.oplogic7=0,v.oplogic8=0,v.oplogic9=0,this.prepareGame()}else if(E===3)this.loginMessage0="",this.loginMessage1="Invalid username or password.";else if(E===4)this.loginMessage0="Your account has been disabled.",this.loginMessage1="Please check your message-centre for details.";else if(E===5)this.loginMessage0="Your account is already logged in.",this.loginMessage1="Try again in 60 secs...";else if(E===6)this.loginMessage0="RuneScape has been updated!",this.loginMessage1="Please reload this page.";else if(E===7)this.loginMessage0="This world is full.",this.loginMessage1="Please use a different world.";else if(E===8)this.loginMessage0="Unable to connect.",this.loginMessage1="Login server offline.";else if(E===9)this.loginMessage0="Login limit exceeded.",this.loginMessage1="Too many connections from your address.";else if(E===10)this.loginMessage0="Unable to connect.",this.loginMessage1="Bad session id.";else if(E===11)this.loginMessage1="Login server rejected session.",this.loginMessage1="Please try again.";else if(E===12)this.loginMessage0="You need a members account to login to this world.",this.loginMessage1="Please subscribe, or use a different world.";else if(E===13)this.loginMessage0="Could not complete login.",this.loginMessage1="Please try using a different world.";else if(E===14)this.loginMessage0="The server is being updated.",this.loginMessage1="Please wait 1 minute and try again.";else if(E===15)this.ingame=!0,this.out.pos=0,this.in.pos=0,this.ptype=-1,this.ptype0=-1,this.ptype1=-1,this.ptype2=-1,this.psize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.menuSize=0,this.menuVisible=!1,this.sceneLoadStartTime=Date.now();else if(E===16)this.loginMessage0="Login attempts exceeded.",this.loginMessage1="Please wait 1 minute and try again.";else if(E===17)this.loginMessage0="You are standing in a members-only area.",this.loginMessage1="To play on this world move to a free area first";else if(E===20)this.loginMessage0="Invalid loginserver requested",this.loginMessage1="Please try using a different world.";else this.loginMessage0="Unexpected server response",this.loginMessage1="Please try using a different world."}catch(b){this.loginMessage0="",this.loginMessage1="Error connecting to server."}}async logout(){if(this.stream)this.stream.close();this.stream=null,this.ingame=!1,this.titleScreenState=0,this.username="",this.password="",N0.setDisabled(),this.clearCache(),this.scene?.reset();for(let _=0;_<4;_++)this.levelCollisionMap[_]?.reset();B1(!1),this.nextMidiSong=-1,this.midiSong=-1,this.nextMusicDelay=0}clearCache(){u0.modelCacheStatic?.clear(),u0.modelCacheDynamic?.clear(),j0.modelCache?.clear(),d.modelCache?.clear(),d.iconCache?.clear(),T0.modelCache?.clear(),q0.modelCache?.clear()}prepareGame(){if(this.areaChatback)return;this.unloadTitle(),this.drawArea=null,this.imageTitle2=null,this.imageTitle3=null,this.imageTitle4=null,this.imageTitle0=null,this.imageTitle1=null,this.imageTitle5=null,this.imageTitle6=null,this.imageTitle7=null,this.imageTitle8=null,this.areaChatback=new I0(479,96),this.areaMapback=new I0(172,156),F.clear(),this.imageMapback?.draw(0,0),this.areaSidebar=new I0(190,261),this.areaViewport=new I0(512,334),F.clear(),this.areaBackbase1=new I0(496,50),this.areaBackbase2=new I0(269,37),this.areaBackhmid1=new I0(249,45),this.redrawFrame=!0}async updateGame(){if(this.players===null)return;if(this.systemUpdateTimer>1)this.systemUpdateTimer--;if(this.idleTimeout>0)this.idleTimeout--;if(this.field1264>0)this.field1264-=2;for(let _=0;_<5&&await this.readPacket();_++);if(this.ingame){this.updateSceneState(),this.updateLocChanges(),await this.updateAudio();let _=N0.flush();if(_)this.out.p1isaac(217),this.out.p2(_.pos),this.out.pdata(_.data,_.pos,0),_.release();if(this.idleNetCycles++,this.idleNetCycles>250)await this.tryReconnect();if(this.updatePlayers(),this.updateNpcs(),this.updateEntityChats(),this.sceneDelta++,this.crossMode!==0){if(this.crossCycle+=20,this.crossCycle>=400)this.crossMode=0}if(this.selectedArea!==0){if(this.selectedCycle++,this.selectedCycle>=15){if(this.selectedArea===2)this.redrawSidebar=!0;else if(this.selectedArea===3)this.redrawChatback=!0;this.selectedArea=0}}if(this.objDragArea!==0){if(this.objDragCycles++,this.mouseX>this.objGrabX+5||this.mouseX<this.objGrabX-5||this.mouseY>this.objGrabY+5||this.mouseY<this.objGrabY-5)this.objGrabThreshold=!0;if(this.mouseButton===0){if(this.objDragArea===2)this.redrawSidebar=!0;else if(this.objDragArea===3)this.redrawChatback=!0;if(this.objDragArea=0,this.objGrabThreshold&&this.objDragCycles>=5){if(this.hoveredSlotParentId=-1,this.handleInput(),this.hoveredSlotParentId===this.objDragInterfaceId&&this.hoveredSlot!==this.objDragSlot){let u=s.types[this.objDragInterfaceId],R=0;if(this.bankArrangeMode==1&&u.clientCode==206)R=1;if(u.invSlotObjId&&u.invSlotObjId[this.hoveredSlot]<=0)R=0;if(R==1){let b=this.objDragSlot,m=this.hoveredSlot;while(b!=m)if(b>m)u.swapObj(b,b-1),b--;else if(b<m)u.swapObj(b,b+1),b++}else u.swapObj(this.objDragSlot,this.hoveredSlot);this.out.p1isaac(81),this.out.p2(this.objDragInterfaceId),this.out.p2(this.objDragSlot),this.out.p2(this.hoveredSlot),this.out.p1(R)}}else if((this.oneMouseButton===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)this.showContextMenu();else if(this.menuSize>0)this.useMenuOption(this.menuSize-1);this.selectedCycle=10,this.mouseClickButton=0}}if(v.cyclelogic3++,v.cyclelogic3>127)v.cyclelogic3=0,this.out.p1isaac(144),this.out.p3(4991788);if(k.clickTileX!==-1){if(this.localPlayer){let u=k.clickTileX,R=k.clickTileZ,b=this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],u,R,0,0,0,0,0,0,!0);if(k.clickTileX=-1,b)this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=1,this.crossCycle=0}}if(this.mouseClickButton===1&&this.modalMessage)this.modalMessage=null,this.redrawChatback=!0,this.mouseClickButton=0;if(this.handleMouseInput(),this.handleMinimapInput(),this.handleTabInput(),this.handleChatModeInput(),this.mouseButton===1||this.mouseClickButton===1)this.dragCycles++;if(this.sceneState===2)this.updateOrbitCamera();if(this.sceneState===2&&this.cutscene)this.applyCutscene();for(let u=0;u<5;u++)this.cameraModifierCycle[u]++;if(await this.handleInputKey(),Date.now()-this.idleCycles>90000)this.idleTimeout=250,this.idleCycles=Date.now()-1e4,this.out.p1isaac(146);if(this.macroCameraCycle++,this.macroCameraCycle>500){this.macroCameraCycle=0;let u=Math.random()*8|0;if((u&1)===1)this.macroCameraX+=this.macroCameraXModifier;if((u&2)===2)this.macroCameraZ+=this.macroCameraZModifier;if((u&4)===4)this.macroCameraAngle+=this.macroCameraAngleModifier}if(this.macroCameraX<-50)this.macroCameraXModifier=2;else if(this.macroCameraX>50)this.macroCameraXModifier=-2;if(this.macroCameraZ<-55)this.macroCameraZModifier=2;else if(this.macroCameraZ>55)this.macroCameraZModifier=-2;if(this.macroCameraAngle<-40)this.macroCameraAngleModifier=1;else if(this.macroCameraAngle>40)this.macroCameraAngleModifier=-1;if(this.macroMinimapCycle++,this.macroMinimapCycle>500){this.macroMinimapCycle=0;let u=Math.random()*8|0;if((u&1)===1)this.macroMinimapAngle+=this.macroMinimapAngleModifier;if((u&2)===2)this.macroMinimapZoom+=this.macroMinimapZoomModifier}if(this.macroMinimapAngle<-60)this.macroMinimapAngleModifier=2;else if(this.macroMinimapAngle>60)this.macroMinimapAngleModifier=-2;if(this.macroMinimapZoom<-20)this.macroMinimapZoomModifier=1;else if(this.macroMinimapZoom>10)this.macroMinimapZoomModifier=-1;if(v.cyclelogic4++,v.cyclelogic4>110)v.cyclelogic4=0,this.out.p1isaac(41),this.out.p4(0);if(this.noTimeoutCycle++,this.noTimeoutCycle>50)this.out.p1isaac(107);try{if(this.stream&&this.out.pos>0)this.stream.write(this.out.data,this.out.pos),this.out.pos=0,this.noTimeoutCycle=0}catch(u){await this.tryReconnect()}}}async tryReconnect(){if(this.idleTimeout>0){await this.logout();return}if(this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,144,"Connection lost",0),this.fontPlain12?.drawStringCenter(256,143,"Connection lost",16777215),this.fontPlain12?.drawStringCenter(257,159,"Please wait - attempting to reestablish",0),this.fontPlain12?.drawStringCenter(256,158,"Please wait - attempting to reestablish",16777215),this.areaViewport?.draw(4,4),this.flagSceneTileX=0,this.stream?.close(),this.ingame=!1,await this.login(this.username,this.password,!0),!this.ingame)await this.logout()}updateSceneState(){if(v.lowMemory&&this.sceneState===2&&i.levelBuilt!==this.currentLevel)this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(4,4),this.sceneState=1;if(this.sceneState===1){if(this.checkScene()!=0&&Date.now()-this.sceneLoadStartTime>360000)this.sceneLoadStartTime=Date.now()}if(this.sceneState===2&&this.currentLevel!==this.minimapLevel)this.minimapLevel=this.currentLevel,this.createMinimap(this.currentLevel)}checkScene(){if(!this.sceneMapIndex||!this.sceneMapLandData||!this.sceneMapLocData)return-1000;for(let u=0;u<this.sceneMapLandData.length;u++){if(this.sceneMapLandData[u]==null&&this.sceneMapLandFile[u]!==-1)return-1;if(this.sceneMapLocData[u]==null&&this.sceneMapLocFile[u]!==-1)return-2}let _=!0;for(let u=0;u<this.sceneMapLandData.length;u++){let R=this.sceneMapLocData[u];if(R!=null){let b=(this.sceneMapIndex[u]>>8)*64-this.sceneBaseTileX,m=(this.sceneMapIndex[u]&255)*64-this.sceneBaseTileZ;_&&=i.locsAreReady(R,b,m)}}if(!_)return-3;else if(this.awaitingSync)return-4;return this.sceneState=2,i.levelBuilt=this.currentLevel,this.buildScene(),0}buildScene(){try{this.minimapLevel=-1,this.spotanims.clear(),this.projectiles.clear(),A.clearTexels(),this.clearCache(),this.scene?.reset();for(let O=0;O<4;O++)this.levelCollisionMap[O]?.reset();let m=new i(104,104,this.levelHeightmap,this.levelTileFlags);i.lowMemory=k.lowMemory;let E=this.sceneMapLandData?.length??0;if(this.sceneMapIndex)for(let O=0;O<E;O++){let I=this.sceneMapIndex[O]>>8,L=this.sceneMapIndex[O]&255;if(I===33&&L>=71&&L<=73){i.lowMemory=!1;break}}if(v.lowMemory)this.scene?.setMinLevel(this.currentLevel);else this.scene?.setMinLevel(0);if(this.sceneMapIndex&&this.sceneMapLandData){this.out.p1isaac(107);for(let O=0;O<E;O++){let I=(this.sceneMapIndex[O]>>8)*64-this.sceneBaseTileX,L=(this.sceneMapIndex[O]&255)*64-this.sceneBaseTileZ,H=this.sceneMapLandData[O];if(H)m.loadGround((this.sceneCenterZoneX-6)*8,(this.sceneCenterZoneZ-6)*8,I,L,H)}for(let O=0;O<E;O++){let I=(this.sceneMapIndex[O]>>8)*64-this.sceneBaseTileX,L=(this.sceneMapIndex[O]&255)*64-this.sceneBaseTileZ;if(!this.sceneMapLandData[O]&&this.sceneCenterZoneZ<800)m.spreadHeight(I,L,64,64)}}if(this.sceneMapIndex&&this.sceneMapLocData){this.out.p1isaac(107);for(let O=0;O<E;O++){let I=this.sceneMapLocData[O];if(I){let L=(this.sceneMapIndex[O]>>8)*64-this.sceneBaseTileX,H=(this.sceneMapIndex[O]&255)*64-this.sceneBaseTileZ;m.loadLocations(this.loopCycle,this.scene,this.levelCollisionMap,I,L,H)}}}this.out.p1isaac(107),m.build(this.scene,this.levelCollisionMap),this.areaViewport?.bind(),this.out.p1isaac(107);for(let O=0;O<104;O++)for(let I=0;I<104;I++)this.sortObjStacks(O,I);this.clearLocChanges()}catch(m){}if(u0.modelCacheStatic?.clear(),v.lowMemory&&this.db){let m=this.onDemand?.getFileCount(0)??0;for(let E=0;E<m;E++)if(((this.onDemand?.getModelFlags(E)??0)&121)==0)$.unload(E)}A.initPool(20),this.onDemand?.clearPrefetches();let _=(this.sceneCenterZoneX-6)/8-1,u=(this.sceneCenterZoneX+6)/8+1,R=(this.sceneCenterZoneZ-6)/8-1,b=(this.sceneCenterZoneZ+6)/8+1;if(this.withinTutorialIsland)_=49,u=50,R=49,b=50;for(let m=_;m<=u;m++)for(let E=R;E<=b;E++)if(_==m||u==m||R==E||b==E){let O=this.onDemand?.getMapFile(E,m,0)??-1;if(O!=-1)this.onDemand?.prefetch(3,O);let I=this.onDemand?.getMapFile(E,m,1)??-1;if(I!=-1)this.onDemand?.prefetch(3,I)}}clearLocChanges(){for(let _=this.locChanges.head();_;_=this.locChanges.next())if(_.endTime===-1)_.startTime=0,this.storeLoc(_);else _.unlink()}createMinimap(_){if(!this.imageMinimap)return;let u=this.imageMinimap.pixels,R=u.length;for(let E=0;E<R;E++)u[E]=0;for(let E=1;E<104-1;E++){let O=(104-1-E)*512*4+24628;for(let I=1;I<104-1;I++){if(this.levelTileFlags&&(this.levelTileFlags[_][I][E]&24)===0)this.scene?.drawMinimapTile(_,I,E,u,O,512);if(_<3&&this.levelTileFlags&&(this.levelTileFlags[_+1][I][E]&8)!==0)this.scene?.drawMinimapTile(_+1,I,E,u,O,512);O+=4}}let b=((Math.random()*20|0)+238-10<<16)+((Math.random()*20|0)+238-10<<8)+(Math.random()*20|0)+238-10,m=(Math.random()*20|0)+238-10<<16;this.imageMinimap.bind();for(let E=1;E<104-1;E++)for(let O=1;O<104-1;O++){if(this.levelTileFlags&&(this.levelTileFlags[_][O][E]&24)===0)this.drawMinimapLoc(O,E,_,b,m);if(_<3&&this.levelTileFlags&&(this.levelTileFlags[_+1][O][E]&8)!==0)this.drawMinimapLoc(O,E,_+1,b,m)}this.areaViewport?.bind(),this.activeMapFunctionCount=0;for(let E=0;E<104;E++)for(let O=0;O<104;O++){let I=this.scene?.getGroundDecorTypecode(this.currentLevel,E,O)??0;if(I===0)continue;let L=I>>14&32767,H=u0.get(L).mapfunction;if(H<0)continue;let G=E,N=O;if(H!==22&&H!==29&&H!==34&&H!==36&&H!==46&&H!==47&&H!==48){let T=104,K=104,Q=this.levelCollisionMap[this.currentLevel];if(Q){let U=Q.flags;for(let J=0;J<10;J++){let q=Math.random()*4|0;if(q===0&&G>0&&G>E-3&&(U[o.index(G-1,N)]&2621704)===0)G--;if(q===1&&G<T-1&&G<E+3&&(U[o.index(G+1,N)]&2621824)===0)G++;if(q===2&&N>0&&N>O-3&&(U[o.index(G,N-1)]&2621698)===0)N--;if(q===3&&N<K-1&&N<O+3&&(U[o.index(G,N+1)]&2621728)===0)N++}}}this.activeMapFunctions[this.activeMapFunctionCount]=this.imageMapfunction[H],this.activeMapFunctionX[this.activeMapFunctionCount]=G,this.activeMapFunctionZ[this.activeMapFunctionCount]=N,this.activeMapFunctionCount++}}updateLocChanges(){if(this.sceneState!==2)return;for(let _=this.locChanges.head();_;_=this.locChanges.next()){if(_.endTime>0)_.endTime--;if(_.endTime!=0){if(_.startTime>0)_.startTime--;if(_.startTime===0&&(_.newType<0||i.isLocReady(_.newType,_.newShape))){if(this.addLoc(_.level,_.x,_.z,_.newType,_.newAngle,_.newShape,_.layer),_.startTime=-1,_.oldType===_.newType&&_.oldType===-1)_.unlink();else if(_.oldType===_.newType&&_.oldAngle===_.newAngle&&_.oldShape===_.newShape)_.unlink()}}else if(_.oldType<0||i.isLocReady(_.oldType,_.oldShape))this.addLoc(_.level,_.x,_.z,_.oldType,_.oldAngle,_.oldShape,_.layer),_.unlink()}if(v.cyclelogic5++,v.cyclelogic5>85)v.cyclelogic5=0,this.out.p1isaac(232)}async updateAudio(){for(let _=0;_<this.waveCount;_++)if(this.waveDelay[_]<=0){try{let u=b0.generate(this.waveIds[_],this.waveLoops[_]);if(!u)throw new Error;if(Date.now()+(u.pos/22|0)>this.lastWaveStartTime+(this.lastWaveLength/22|0))this.lastWaveLength=u.pos,this.lastWaveStartTime=Date.now(),this.lastWaveId=this.waveIds[_],this.lastWaveLoops=this.waveLoops[_],await s1(u.data.slice(0,u.pos))}catch(u){}this.waveCount--;for(let u=_;u<this.waveCount;u++)this.waveIds[u]=this.waveIds[u+1],this.waveLoops[u]=this.waveLoops[u+1],this.waveDelay[u]=this.waveDelay[u+1];_--}else this.waveDelay[_]--;if(this.nextMusicDelay>0){if(this.nextMusicDelay-=20,this.nextMusicDelay<0)this.nextMusicDelay=0;if(this.nextMusicDelay===0&&this.midiActive&&!v.lowMemory)this.midiSong=this.nextMidiSong,this.midiFading=!1,this.onDemand?.request(2,this.midiSong)}}handleInput(){if(this.objDragArea!==0)return;if(this.menuOption[0]="Cancel",this.menuAction[0]=1252,this.menuSize=1,this.handlePrivateChatInput(),this.lastHoveredInterfaceId=0,this.mouseX>4&&this.mouseY>4&&this.mouseX<516&&this.mouseY<338)if(this.viewportInterfaceId===-1)this.handleViewportOptions();else this.handleInterfaceInput(s.types[this.viewportInterfaceId],this.mouseX,this.mouseY,4,4,0);if(this.lastHoveredInterfaceId!==this.viewportHoveredInterfaceIndex)this.viewportHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>553&&this.mouseY>205&&this.mouseX<743&&this.mouseY<466){if(this.sidebarInterfaceId!==-1)this.handleInterfaceInput(s.types[this.sidebarInterfaceId],this.mouseX,this.mouseY,553,205,0);else if(this.tabInterfaceId[this.selectedTab]!==-1)this.handleInterfaceInput(s.types[this.tabInterfaceId[this.selectedTab]],this.mouseX,this.mouseY,553,205,0)}if(this.lastHoveredInterfaceId!==this.sidebarHoveredInterfaceIndex)this.redrawSidebar=!0,this.sidebarHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>17&&this.mouseY>357&&this.mouseX<426&&this.mouseY<453){if(this.chatInterfaceId!==-1)this.handleInterfaceInput(s.types[this.chatInterfaceId],this.mouseX,this.mouseY,17,357,0);else if(this.mouseY<434)this.handleChatMouseInput(this.mouseX-17,this.mouseY-357)}if(this.chatInterfaceId!==-1&&this.lastHoveredInterfaceId!==this.chatHoveredInterfaceIndex)this.redrawChatback=!0,this.chatHoveredInterfaceIndex=this.lastHoveredInterfaceId;let _=!1;while(!_){_=!0;for(let u=0;u<this.menuSize-1;u++)if(this.menuAction[u]<1000&&this.menuAction[u+1]>1000){let R=this.menuOption[u];this.menuOption[u]=this.menuOption[u+1],this.menuOption[u+1]=R;let b=this.menuAction[u];this.menuAction[u]=this.menuAction[u+1],this.menuAction[u+1]=b;let m=this.menuParamB[u];this.menuParamB[u]=this.menuParamB[u+1],this.menuParamB[u+1]=m;let E=this.menuParamC[u];this.menuParamC[u]=this.menuParamC[u+1],this.menuParamC[u+1]=E;let O=this.menuParamA[u];this.menuParamA[u]=this.menuParamA[u+1],this.menuParamA[u+1]=O,_=!1}}}handlePrivateChatInput(){if(this.splitPrivateChat===0)return;let _=0;if(this.systemUpdateTimer!==0)_=1;for(let u=0;u<100;u++)if(this.messageText[u]!==null){let R=this.messageType[u],b=this.messageSender[u],m=!1;if(b&&b.startsWith("@cr1@"))b=b.substring(5),m=!0;else if(b&&b.startsWith("@cr2@"))b=b.substring(5),m=!0;if((R===3||R===7)&&(R===7||this.chatPrivateMode===0||this.chatPrivateMode===1&&this.isFriend(b))){let E=329-_*13;if(this.mouseX>4&&this.mouseX<516&&this.mouseY-4>E-10&&this.mouseY-4<=E+3){if(this.staffmodlevel)this.menuOption[this.menuSize]="Report abuse @whi@"+b,this.menuAction[this.menuSize]=2034,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+b,this.menuAction[this.menuSize]=2436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+b,this.menuAction[this.menuSize]=2406,this.menuSize++}if(_++,_>=5)return}else if((R===5||R===6)&&this.chatPrivateMode<2){if(_++,_>=5)return}}}handleChatMouseInput(_,u){let R=0;for(let b=0;b<100;b++){if(!this.messageText[b])continue;let m=this.messageType[b],E=this.chatScrollOffset+70+4-R*14;if(E<-20)break;let O=this.messageSender[b],I=!1;if(O&&O.startsWith("@cr1@"))O=O.substring(5),I=!0;else if(O&&O.startsWith("@cr2@"))O=O.substring(5),I=!0;if(m===0)R++;else if((m==1||m==2)&&(m==1||this.chatPublicMode==0||this.chatPublicMode==1&&this.isFriend(O))){if(u>E-14&&u<=E&&this.localPlayer&&O!==this.localPlayer.name){if(this.staffmodlevel>=1)this.menuOption[this.menuSize]="Report abuse @whi@"+O,this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+O,this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+O,this.menuAction[this.menuSize]=406,this.menuSize++}R++}else if((m===3||m===7)&&this.splitPrivateChat===0&&(m===7||this.chatPrivateMode===0||this.chatPrivateMode===1&&this.isFriend(O))){if(u>E-14&&u<=E){if(this.staffmodlevel>=1)this.menuOption[this.menuSize]="Report abuse @whi@"+O,this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+O,this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+O,this.menuAction[this.menuSize]=406,this.menuSize++}R++}else if(m===4&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(O))){if(u>E-14&&u<=E)this.menuOption[this.menuSize]="Accept trade @whi@"+O,this.menuAction[this.menuSize]=903,this.menuSize++;R++}else if((m===5||m===6)&&this.splitPrivateChat===0&&this.chatPrivateMode<2)R++;else if(m===8&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(O))){if(u>E-14&&u<=E)this.menuOption[this.menuSize]="Accept duel @whi@"+O,this.menuAction[this.menuSize]=363,this.menuSize++;R++}}}handleViewportOptions(){if(this.objSelected===0&&this.spellSelected===0)this.menuOption[this.menuSize]="Walk here",this.menuAction[this.menuSize]=660,this.menuParamB[this.menuSize]=this.mouseX,this.menuParamC[this.menuSize]=this.mouseY,this.menuSize++;let _=-1;for(let u=0;u<$.pickedCount;u++){let R=$.pickedBitsets[u],b=R&127,m=R>>7&127,E=R>>29&3,O=R>>14&32767;if(R===_)continue;if(_=R,E===2&&this.scene&&this.scene.getInfo(this.currentLevel,b,m,R)>=0){let I=u0.get(O);if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @cya@"+I.name,this.menuAction[this.menuSize]=450,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=m,this.menuSize++;else if(this.spellSelected!==1){if(I.op){for(let L=4;L>=0;L--)if(I.op[L]){if(this.menuOption[this.menuSize]=I.op[L]+" @cya@"+I.name,L===0)this.menuAction[this.menuSize]=285;else if(L===1)this.menuAction[this.menuSize]=504;else if(L===2)this.menuAction[this.menuSize]=364;else if(L===3)this.menuAction[this.menuSize]=581;else if(L===4)this.menuAction[this.menuSize]=1501;this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=m,this.menuSize++}}this.menuOption[this.menuSize]="Examine @cya@"+I.name,this.menuAction[this.menuSize]=1175,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=m,this.menuSize++}else if((this.activeSpellFlags&4)===4)this.menuOption[this.menuSize]=this.spellCaption+" @cya@"+I.name,this.menuAction[this.menuSize]=55,this.menuParamA[this.menuSize]=R,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=m,this.menuSize++}else if(E===1){let I=this.npcs[O];if(I&&I.type&&I.type.size===1&&(I.x&127)===64&&(I.z&127)===64)for(let L=0;L<this.npcCount;L++){let H=this.npcs[this.npcIds[L]];if(H&&H!==I&&H.type&&H.type.size===1&&H.x===I.x&&H.z===I.z)this.addNpcOptions(H.type,this.npcIds[L],b,m)}if(I&&I.type)this.addNpcOptions(I.type,O,b,m)}else if(E===0){let I=this.players[O];if(I&&(I.x&127)===64&&(I.z&127)===64){for(let L=0;L<this.npcCount;L++){let H=this.npcs[this.npcIds[L]];if(H&&H.type&&H.type.size===1&&H.x===I.x&&H.z===I.z)this.addNpcOptions(H.type,this.npcIds[L],b,m)}for(let L=0;L<this.playerCount;L++){let H=this.players[this.playerIds[L]];if(H&&H!==I&&H.x===I.x&&H.z===I.z)this.addPlayerOptions(H,this.playerIds[L],b,m)}}if(I)this.addPlayerOptions(I,O,b,m)}else if(E===3){let I=this.objStacks[this.currentLevel][b][m];if(!I)continue;for(let L=I.tail();L;L=I.prev()){let H=d.get(L.index);if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+H.name,this.menuAction[this.menuSize]=217,this.menuParamA[this.menuSize]=L.index,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=m,this.menuSize++;else if(this.spellSelected!==1){for(let G=4;G>=0;G--)if(H.op&&H.op[G]){if(this.menuOption[this.menuSize]=H.op[G]+" @lre@"+H.name,G===0)this.menuAction[this.menuSize]=224;else if(G===1)this.menuAction[this.menuSize]=993;else if(G===2)this.menuAction[this.menuSize]=99;else if(G===3)this.menuAction[this.menuSize]=746;else if(G===4)this.menuAction[this.menuSize]=877;this.menuParamA[this.menuSize]=L.index,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=m,this.menuSize++}else if(G===2)this.menuOption[this.menuSize]="Take @lre@"+H.name,this.menuAction[this.menuSize]=99,this.menuParamA[this.menuSize]=L.index,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=m,this.menuSize++;this.menuOption[this.menuSize]="Examine @lre@"+H.name,this.menuAction[this.menuSize]=1102,this.menuParamA[this.menuSize]=L.index,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=m,this.menuSize++}else if((this.activeSpellFlags&1)===1)this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+H.name,this.menuAction[this.menuSize]=965,this.menuParamA[this.menuSize]=L.index,this.menuParamB[this.menuSize]=b,this.menuParamC[this.menuSize]=m,this.menuSize++}}}}handleMouseInput(){if(this.objDragArea!==0)return;let _=this.mouseClickButton;if(this.spellSelected===1&&this.mouseClickX>=516&&this.mouseClickY>=160&&this.mouseClickX<=765&&this.mouseClickY<=205)_=0;if(!this.menuVisible){if(_===1&&this.menuSize>0){let u=this.menuAction[this.menuSize-1];if(u==602||u==596||u==22||u==892||u==415||u==405||u==38||u==422||u==478||u==347||u==188){let R=this.menuParamB[this.menuSize-1],b=this.menuParamC[this.menuSize-1];if(s.types[b].draggable){if(this.objGrabThreshold=!1,this.objDragCycles=0,this.objDragInterfaceId=b,this.objDragSlot=R,this.objDragArea=2,this.objGrabX=this.mouseClickX,this.objGrabY=this.mouseClickY,s.types[b].layer===this.viewportInterfaceId)this.objDragArea=1;if(s.types[b].layer===this.chatInterfaceId)this.objDragArea=3;return}}}if(_===1&&(this.oneMouseButton===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)_=2;if(_===1&&this.menuSize>0)this.useMenuOption(this.menuSize-1);else if(_==2&&this.menuSize>0)this.showContextMenu();return}if(_===1){let u=this.menuX,R=this.menuY,b=this.menuWidth,m=this.mouseClickX,E=this.mouseClickY;if(this.menuArea===0)m-=4,E-=4;else if(this.menuArea===1)m-=553,E-=205;else if(this.menuArea===2)m-=17,E-=357;let O=-1;for(let I=0;I<this.menuSize;I++){let L=R+(this.menuSize-1-I)*15+31;if(m>u&&m<u+b&&E>L-13&&E<L+3)O=I}if(O!==-1)this.useMenuOption(O);if(this.menuVisible=!1,this.menuArea===1)this.redrawSidebar=!0;else if(this.menuArea===2)this.redrawChatback=!0}else{let u=this.mouseX,R=this.mouseY;if(this.menuArea===0)u-=4,R-=4;else if(this.menuArea===1)u-=553,R-=205;else if(this.menuArea===2)u-=17,R-=357;if(u<this.menuX-10||u>this.menuX+this.menuWidth+10||R<this.menuY-10||R>this.menuY+this.menuHeight+10){if(this.menuVisible=!1,this.menuArea===1)this.redrawSidebar=!0;if(this.menuArea===2)this.redrawChatback=!0}}}handleMinimapInput(){if(this.mouseClickButton!==1||!this.localPlayer)return;let _=this.mouseClickX-25-550,u=this.mouseClickY-4-4;if(_<0||u<0||_>=146||u>=151)return;_-=73,u-=75;let R=this.orbitCameraYaw+this.macroMinimapAngle&2047,b=A.sin[R],m=A.cos[R];b=b*(this.macroMinimapZoom+256)>>8,m=m*(this.macroMinimapZoom+256)>>8;let E=u*b+_*m>>11,O=u*m-_*b>>11,I=this.localPlayer.x+E>>7,L=this.localPlayer.z-O>>7;if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],I,L,1,0,0,0,0,0,!0))this.out.p1(_),this.out.p1(u),this.out.p2(this.orbitCameraYaw),this.out.p1(57),this.out.p1(this.macroMinimapAngle),this.out.p1(this.macroMinimapZoom),this.out.p1(89),this.out.p2(this.localPlayer.x),this.out.p2(this.localPlayer.z),this.out.p1(this.tryMoveNearest),this.out.p1(63)}handleTabInput(){if(this.mouseClickButton!==1)return;if(this.mouseClickX>=539&&this.mouseClickX<=573&&this.mouseClickY>=169&&this.mouseClickY<205&&this.tabInterfaceId[0]!=-1)this.redrawSidebar=!0,this.selectedTab=0,this.redrawSideicons=!0;else if(this.mouseClickX>=569&&this.mouseClickX<=599&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[1]!=-1)this.redrawSidebar=!0,this.selectedTab=1,this.redrawSideicons=!0;else if(this.mouseClickX>=597&&this.mouseClickX<=627&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[2]!=-1)this.redrawSidebar=!0,this.selectedTab=2,this.redrawSideicons=!0;else if(this.mouseClickX>=625&&this.mouseClickX<=669&&this.mouseClickY>=168&&this.mouseClickY<203&&this.tabInterfaceId[3]!=-1)this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;else if(this.mouseClickX>=666&&this.mouseClickX<=696&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[4]!=-1)this.redrawSidebar=!0,this.selectedTab=4,this.redrawSideicons=!0;else if(this.mouseClickX>=694&&this.mouseClickX<=724&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[5]!=-1)this.redrawSidebar=!0,this.selectedTab=5,this.redrawSideicons=!0;else if(this.mouseClickX>=722&&this.mouseClickX<=756&&this.mouseClickY>=169&&this.mouseClickY<205&&this.tabInterfaceId[6]!=-1)this.redrawSidebar=!0,this.selectedTab=6,this.redrawSideicons=!0;else if(this.mouseClickX>=540&&this.mouseClickX<=574&&this.mouseClickY>=466&&this.mouseClickY<502&&this.tabInterfaceId[7]!=-1)this.redrawSidebar=!0,this.selectedTab=7,this.redrawSideicons=!0;else if(this.mouseClickX>=572&&this.mouseClickX<=602&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[8]!=-1)this.redrawSidebar=!0,this.selectedTab=8,this.redrawSideicons=!0;else if(this.mouseClickX>=599&&this.mouseClickX<=629&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[9]!=-1)this.redrawSidebar=!0,this.selectedTab=9,this.redrawSideicons=!0;else if(this.mouseClickX>=627&&this.mouseClickX<=671&&this.mouseClickY>=467&&this.mouseClickY<502&&this.tabInterfaceId[10]!=-1)this.redrawSidebar=!0,this.selectedTab=10,this.redrawSideicons=!0;else if(this.mouseClickX>=669&&this.mouseClickX<=699&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[11]!=-1)this.redrawSidebar=!0,this.selectedTab=11,this.redrawSideicons=!0;else if(this.mouseClickX>=696&&this.mouseClickX<=726&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[12]!=-1)this.redrawSidebar=!0,this.selectedTab=12,this.redrawSideicons=!0;else if(this.mouseClickX>=724&&this.mouseClickX<=758&&this.mouseClickY>=466&&this.mouseClickY<502&&this.tabInterfaceId[13]!=-1)this.redrawSidebar=!0,this.selectedTab=13,this.redrawSideicons=!0;if(v.cyclelogic1++,v.cyclelogic1>150)v.cyclelogic1=0,this.out.p1isaac(46),this.out.p1(43)}handleChatModeInput(){if(this.mouseClickButton!==1)return;if(this.mouseClickX>=6&&this.mouseClickX<=106&&this.mouseClickY>=467&&this.mouseClickY<=499)this.chatPublicMode=(this.chatPublicMode+1)%4,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(98),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode);else if(this.mouseClickX>=135&&this.mouseClickX<=235&&this.mouseClickY>=467&&this.mouseClickY<=499)this.chatPrivateMode=(this.chatPrivateMode+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(98),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode);else if(this.mouseClickX>=273&&this.mouseClickX<=373&&this.mouseClickY>=467&&this.mouseClickY<=499)this.chatTradeMode=(this.chatTradeMode+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(98),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode);else if(this.mouseClickX>=412&&this.mouseClickX<=512&&this.mouseClickY>=467&&this.mouseClickY<=499){this.closeInterfaces(),this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let _=0;_<s.types.length;_++)if(s.types[_]&&s.types[_].clientCode===600){this.reportAbuseInterfaceId=this.viewportInterfaceId=s.types[_].layer;return}}}closeInterfaces(){if(this.out.p1isaac(187),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.pressedContinueOption=!1,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0,this.pressedContinueOption=!1;this.viewportInterfaceId=-1}updateEntityChats(){for(let _=-1;_<this.playerCount;_++){let u;if(_===-1)u=2047;else u=this.playerIds[_];let R=this.players[u];if(R&&R.chatTimer>0){if(R.chatTimer--,R.chatTimer===0)R.chatMessage=null}}for(let _=0;_<this.npcCount;_++){let u=this.npcIds[_],R=this.npcs[u];if(R&&R.chatTimer>0){if(R.chatTimer--,R.chatTimer===0)R.chatMessage=null}}}updateOrbitCamera(){if(!this.localPlayer)return;let _=this.localPlayer.x+this.macroCameraX,u=this.localPlayer.z+this.macroCameraZ;if(this.orbitCameraX-_<-500||this.orbitCameraX-_>500||this.orbitCameraZ-u<-500||this.orbitCameraZ-u>500)this.orbitCameraX=_,this.orbitCameraZ=u;if(this.orbitCameraX!==_)this.orbitCameraX+=(_-this.orbitCameraX)/16|0;if(this.orbitCameraZ!==u)this.orbitCameraZ+=(u-this.orbitCameraZ)/16|0;if(this.actionKey[1]===1)this.orbitCameraYawVelocity+=(-this.orbitCameraYawVelocity-24)/2|0;else if(this.actionKey[2]===1)this.orbitCameraYawVelocity+=(24-this.orbitCameraYawVelocity)/2|0;else this.orbitCameraYawVelocity=this.orbitCameraYawVelocity/2|0;if(this.actionKey[3]===1)this.orbitCameraPitchVelocity+=(12-this.orbitCameraPitchVelocity)/2|0;else if(this.actionKey[4]===1)this.orbitCameraPitchVelocity+=(-this.orbitCameraPitchVelocity-12)/2|0;else this.orbitCameraPitchVelocity=this.orbitCameraPitchVelocity/2|0;if(this.orbitCameraYaw=(this.orbitCameraYaw+this.orbitCameraYawVelocity/2|0)&2047,this.orbitCameraPitch+=this.orbitCameraPitchVelocity/2|0,this.orbitCameraPitch<128)this.orbitCameraPitch=128;else if(this.orbitCameraPitch>383)this.orbitCameraPitch=383;let R=this.orbitCameraX>>7,b=this.orbitCameraZ>>7,m=this.getHeightmapY(this.currentLevel,this.orbitCameraX,this.orbitCameraZ),E=0;if(this.levelHeightmap){if(R>3&&b>3&&R<100&&b<100)for(let I=R-4;I<=R+4;I++)for(let L=b-4;L<=b+4;L++){let H=this.currentLevel;if(H<3&&this.levelTileFlags&&(this.levelTileFlags[1][I][L]&2)===2)H++;let G=m-this.levelHeightmap[H][I][L];if(G>E)E=G}}let O=E*192;if(O>98048)O=98048;else if(O<32768)O=32768;if(O>this.cameraPitchClamp)this.cameraPitchClamp+=(O-this.cameraPitchClamp)/24|0;else if(O<this.cameraPitchClamp)this.cameraPitchClamp+=(O-this.cameraPitchClamp)/80|0}applyCutscene(){let _=this.cutsceneSrcLocalTileX*128+64,u=this.cutsceneSrcLocalTileZ*128+64,R=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;if(this.cameraX<_){if(this.cameraX+=this.cutsceneMoveSpeed+((_-this.cameraX)*this.cutsceneMoveAcceleration/1000|0),this.cameraX>_)this.cameraX=_}if(this.cameraX>_){if(this.cameraX-=this.cutsceneMoveSpeed+((this.cameraX-_)*this.cutsceneMoveAcceleration/1000|0),this.cameraX<_)this.cameraX=_}if(this.cameraY<R){if(this.cameraY+=this.cutsceneMoveSpeed+((R-this.cameraY)*this.cutsceneMoveAcceleration/1000|0),this.cameraY>R)this.cameraY=R}if(this.cameraY>R){if(this.cameraY-=this.cutsceneMoveSpeed+((this.cameraY-R)*this.cutsceneMoveAcceleration/1000|0),this.cameraY<R)this.cameraY=R}if(this.cameraZ<u){if(this.cameraZ+=this.cutsceneMoveSpeed+((u-this.cameraZ)*this.cutsceneMoveAcceleration/1000|0),this.cameraZ>u)this.cameraZ=u}if(this.cameraZ>u){if(this.cameraZ-=this.cutsceneMoveSpeed+((this.cameraZ-u)*this.cutsceneMoveAcceleration/1000|0),this.cameraZ<u)this.cameraZ=u}_=this.cutsceneDstLocalTileX*128+64,u=this.cutsceneDstLocalTileZ*128+64,R=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight;let b=_-this.cameraX,m=R-this.cameraY,E=u-this.cameraZ,O=Math.sqrt(b*b+E*E)|0,I=(Math.atan2(m,O)*325.949|0)&2047,L=(Math.atan2(b,E)*-325.949|0)&2047;if(I<128)I=128;else if(I>383)I=383;if(this.cameraPitch<I){if(this.cameraPitch+=this.cutsceneRotateSpeed+((I-this.cameraPitch)*this.cutsceneRotateAcceleration/1000|0),this.cameraPitch>I)this.cameraPitch=I}if(this.cameraPitch>I){if(this.cameraPitch-=this.cutsceneRotateSpeed+((this.cameraPitch-I)*this.cutsceneRotateAcceleration/1000|0),this.cameraPitch<I)this.cameraPitch=I}let H=L-this.cameraYaw;if(H>1024)H-=2048;else if(H<-1024)H+=2048;if(H>0)this.cameraYaw+=this.cutsceneRotateSpeed+(H*this.cutsceneRotateAcceleration/1000|0),this.cameraYaw&=2047;if(H<0)this.cameraYaw-=this.cutsceneRotateSpeed+(-H*this.cutsceneRotateAcceleration/1000|0),this.cameraYaw&=2047;let G=L-this.cameraYaw;if(G>1024)G-=2048;else if(G<-1024)G+=2048;if(G<0&&H>0||G>0&&H<0)this.cameraYaw=L}async handleInputKey(){while(!0){let _;do while(!0){if(_=this.pollKey(),_===-1)return;if(this.viewportInterfaceId!==-1&&this.viewportInterfaceId===this.reportAbuseInterfaceId){if(_===8&&this.reportAbuseInput.length>0)this.reportAbuseInput=this.reportAbuseInput.substring(0,this.reportAbuseInput.length-1);break}if(this.showSocialInput){if(_>=32&&_<=122&&this.socialInput.length<80)this.socialInput=this.socialInput+String.fromCharCode(_),this.redrawChatback=!0;if(_===8&&this.socialInput.length>0)this.socialInput=this.socialInput.substring(0,this.socialInput.length-1),this.redrawChatback=!0;if(_===13||_===10){this.showSocialInput=!1,this.redrawChatback=!0;let u;if(this.socialInputType===1)u=c.toBase37(this.socialInput),this.addFriend(u);if(this.socialInputType===2&&this.friendCount>0)u=c.toBase37(this.socialInput),this.removeFriend(u);if(this.socialInputType===3&&this.socialInput.length>0&&this.socialName37){this.out.p1isaac(170),this.out.p1(0);let R=this.out.pos;if(this.out.p8(this.socialName37),P0.pack(this.out,this.socialInput),this.out.psize1(this.out.pos-R),this.socialInput=c.toSentenceCase(this.socialInput),this.socialInput=W0.filter(this.socialInput),this.addMessage(6,this.socialInput,c.formatName(c.fromBase37(this.socialName37))),this.chatPrivateMode===2)this.chatPrivateMode=1,this.redrawPrivacySettings=!0,this.out.p1isaac(98),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode)}if(this.socialInputType===4&&this.ignoreCount<100)u=c.toBase37(this.socialInput),this.addIgnore(u);if(this.socialInputType===5&&this.ignoreCount>0)u=c.toBase37(this.socialInput),this.removeIgnore(u)}}else if(this.chatbackInputOpen){if(_>=48&&_<=57&&this.chatbackInput.length<10)this.chatbackInput=this.chatbackInput+String.fromCharCode(_),this.redrawChatback=!0;if(_===8&&this.chatbackInput.length>0)this.chatbackInput=this.chatbackInput.substring(0,this.chatbackInput.length-1),this.redrawChatback=!0;if(_===13||_===10){if(this.chatbackInput.length>0){let u=0;try{u=parseInt(this.chatbackInput,10)}catch(R){}this.out.p1isaac(190),this.out.p4(u)}this.chatbackInputOpen=!1,this.redrawChatback=!0}}else if(this.chatInterfaceId===-1){if(_>=32&&(_<=122||this.chatTyped.startsWith("::")&&_<=126)&&this.chatTyped.length<80)this.chatTyped=this.chatTyped+String.fromCharCode(_),this.redrawChatback=!0;if(_===8&&this.chatTyped.length>0)this.chatTyped=this.chatTyped.substring(0,this.chatTyped.length-1),this.redrawChatback=!0;if((_===13||_===10)&&this.chatTyped.length>0){if(this.staffmodlevel===2){if(this.chatTyped==="::clientdrop")await this.tryReconnect();else if(this.chatTyped==="::prefetchmusic"){if(this.onDemand)for(let u=0;u<this.onDemand.getFileCount(2);u++)this.onDemand.prefetchPriority(2,u,1)}else if(this.chatTyped==="::lag")this.lag()}if(this.chatTyped==="::fpson")this.displayFps=!0;else if(this.chatTyped==="::fpsoff")this.displayFps=!1;else if(this.chatTyped.startsWith("::fps "))try{let u=parseInt(this.chatTyped.substring(6))||50;this.setTargetedFramerate(u)}catch(u){}else if(this.chatTyped.startsWith("::"))this.out.p1isaac(76),this.out.p1(this.chatTyped.length-1),this.out.pjstr(this.chatTyped.substring(2));else{let u=0;if(this.chatTyped.startsWith("yellow:"))u=0,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("red:"))u=1,this.chatTyped=this.chatTyped.substring(4);else if(this.chatTyped.startsWith("green:"))u=2,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("cyan:"))u=3,this.chatTyped=this.chatTyped.substring(5);else if(this.chatTyped.startsWith("purple:"))u=4,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("white:"))u=5,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("flash1:"))u=6,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash2:"))u=7,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash3:"))u=8,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("glow1:"))u=9,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow2:"))u=10,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow3:"))u=11,this.chatTyped=this.chatTyped.substring(6);let R=0;if(this.chatTyped.startsWith("wave:"))R=1,this.chatTyped=this.chatTyped.substring(5);if(this.chatTyped.startsWith("scroll:"))R=2,this.chatTyped=this.chatTyped.substring(7);this.out.p1isaac(171),this.out.p1(0);let b=this.out.pos;if(this.out.p1(u),this.out.p1(R),P0.pack(this.out,this.chatTyped),this.out.psize1(this.out.pos-b),this.chatTyped=c.toSentenceCase(this.chatTyped),this.chatTyped=W0.filter(this.chatTyped),this.localPlayer&&this.localPlayer.name)if(this.localPlayer.chatMessage=this.chatTyped,this.localPlayer.chatColour=u,this.localPlayer.chatEffect=R,this.localPlayer.chatTimer=150,this.staffmodlevel===2)this.addMessage(2,this.localPlayer.chatMessage,"@cr2@"+this.localPlayer.name);else if(this.staffmodlevel===1)this.addMessage(2,this.localPlayer.chatMessage,"@cr1@"+this.localPlayer.name);else this.addMessage(2,this.localPlayer.chatMessage,this.localPlayer.name);if(this.chatPublicMode===2)this.chatPublicMode=3,this.redrawPrivacySettings=!0,this.out.p1isaac(98),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode)}this.chatTyped="",this.redrawChatback=!0}}}while((_<97||_>122)&&(_<65||_>90)&&(_<48||_>57)&&_!==32);if(this.reportAbuseInput.length<12)this.reportAbuseInput=this.reportAbuseInput+String.fromCharCode(_)}}lag(){if(this.onDemand);}updatePlayers(){for(let _=-1;_<this.playerCount;_++){let u;if(_===-1)u=2047;else u=this.playerIds[_];let R=this.players[u];if(R)this.updateEntity(R)}if(v.cyclelogic6++,v.cyclelogic6>1406){v.cyclelogic6=0,this.out.p1isaac(215),this.out.p1(0);let _=this.out.pos;if(this.out.p1(162),this.out.p1(22),(Math.random()*2|0)===0)this.out.p1(84);if(this.out.p2(31824),this.out.p2(13490),(Math.random()*2|0)===0)this.out.p1(123);if((Math.random()*2|0)===0)this.out.p1(134);this.out.p1(100),this.out.p1(94),this.out.p2(35521),this.out.psize1(this.out.pos-_)}}updateNpcs(){for(let _=0;_<this.npcCount;_++){let u=this.npcIds[_],R=this.npcs[u];if(R&&R.type)this.updateEntity(R)}}updateEntity(_){if(_.x<128||_.z<128||_.x>=13184||_.z>=13184)_.primarySeqId=-1,_.spotanimId=-1,_.forceMoveEndCycle=0,_.forceMoveStartCycle=0,_.x=_.routeTileX[0]*128+_.size*64,_.z=_.routeTileZ[0]*128+_.size*64,_.clearRoute();if(_===this.localPlayer&&(_.x<1536||_.z<1536||_.x>=11776||_.z>=11776))_.primarySeqId=-1,_.spotanimId=-1,_.forceMoveEndCycle=0,_.forceMoveStartCycle=0,_.x=_.routeTileX[0]*128+_.size*64,_.z=_.routeTileZ[0]*128+_.size*64,_.clearRoute();if(_.forceMoveEndCycle>this.loopCycle)this.updateForceMovement(_);else if(_.forceMoveStartCycle>=this.loopCycle)this.startForceMovement(_);else this.updateMovement(_);this.updateFacingDirection(_),this.updateSequences(_)}updateForceMovement(_){let u=_.forceMoveEndCycle-this.loopCycle,R=_.forceMoveStartSceneTileX*128+_.size*64,b=_.forceMoveStartSceneTileZ*128+_.size*64;if(_.x+=(R-_.x)/u|0,_.z+=(b-_.z)/u|0,_.seqDelayMove=0,_.forceMoveFaceDirection===0)_.dstYaw=1024;else if(_.forceMoveFaceDirection===1)_.dstYaw=1536;else if(_.forceMoveFaceDirection===2)_.dstYaw=0;else if(_.forceMoveFaceDirection===3)_.dstYaw=512}startForceMovement(_){if(_.forceMoveStartCycle===this.loopCycle||_.primarySeqId===-1||_.primarySeqDelay!==0||_.primarySeqCycle+1>l.types[_.primarySeqId].getFrameDuration(_.primarySeqFrame)){let u=_.forceMoveStartCycle-_.forceMoveEndCycle,R=this.loopCycle-_.forceMoveEndCycle,b=_.forceMoveStartSceneTileX*128+_.size*64,m=_.forceMoveStartSceneTileZ*128+_.size*64,E=_.forceMoveEndSceneTileX*128+_.size*64,O=_.forceMoveEndSceneTileZ*128+_.size*64;_.x=(b*(u-R)+E*R)/u|0,_.z=(m*(u-R)+O*R)/u|0}if(_.seqDelayMove=0,_.forceMoveFaceDirection===0)_.dstYaw=1024;else if(_.forceMoveFaceDirection===1)_.dstYaw=1536;else if(_.forceMoveFaceDirection===2)_.dstYaw=0;else if(_.forceMoveFaceDirection===3)_.dstYaw=512;_.yaw=_.dstYaw}updateMovement(_){if(_.secondarySeqId=_.readyanim,_.routeLength===0){_.seqDelayMove=0;return}if(_.primarySeqId!==-1&&_.primarySeqDelay===0){let L=l.types[_.primarySeqId];if(_.preanimRouteLength>0&&L.preanim_move===0){_.seqDelayMove++;return}if(_.preanimRouteLength<=0&&L.postanim_move===0){_.seqDelayMove++;return}}let{x:u,z:R}=_,b=_.routeTileX[_.routeLength-1]*128+_.size*64,m=_.routeTileZ[_.routeLength-1]*128+_.size*64;if(b-u>256||b-u<-256||m-R>256||m-R<-256){_.x=b,_.z=m;return}if(u<b)if(R<m)_.dstYaw=1280;else if(R>m)_.dstYaw=1792;else _.dstYaw=1536;else if(u>b)if(R<m)_.dstYaw=768;else if(R>m)_.dstYaw=256;else _.dstYaw=512;else if(R<m)_.dstYaw=1024;else _.dstYaw=0;let E=_.dstYaw-_.yaw&2047;if(E>1024)E-=2048;let O=_.walkanim_b;if(E>=-256&&E<=256)O=_.walkanim;else if(E>=256&&E<768)O=_.walkanim_r;else if(E>=-768&&E<=-256)O=_.walkanim_l;if(O===-1)O=_.walkanim;_.secondarySeqId=O;let I=4;if(_.yaw!==_.dstYaw&&_.targetId===-1)I=2;if(_.routeLength>2)I=6;if(_.routeLength>3)I=8;if(_.seqDelayMove>0&&_.routeLength>1)I=8,_.seqDelayMove--;if(_.routeRun[_.routeLength-1])I<<=1;if(I>=8&&_.secondarySeqId===_.walkanim&&_.runanim!==-1)_.secondarySeqId=_.runanim;if(u<b){if(_.x+=I,_.x>b)_.x=b}else if(u>b){if(_.x-=I,_.x<b)_.x=b}if(R<m){if(_.z+=I,_.z>m)_.z=m}else if(R>m){if(_.z-=I,_.z<m)_.z=m}if(_.x===b&&_.z===m){if(_.routeLength--,_.preanimRouteLength>0)_.preanimRouteLength--}}updateFacingDirection(_){if(_.targetId!==-1&&_.targetId<32768){let R=this.npcs[_.targetId];if(R){let b=_.x-R.x,m=_.z-R.z;if(b!==0||m!==0)_.dstYaw=(Math.atan2(b,m)*325.949|0)&2047}}if(_.targetId>=32768){let R=_.targetId-32768;if(R===this.localPid)R=2047;let b=this.players[R];if(b){let m=_.x-b.x,E=_.z-b.z;if(m!==0||E!==0)_.dstYaw=(Math.atan2(m,E)*325.949|0)&2047}}if((_.targetTileX!==0||_.targetTileZ!==0)&&(_.routeLength===0||_.seqDelayMove>0)){let R=_.x-(_.targetTileX-this.sceneBaseTileX-this.sceneBaseTileX)*64,b=_.z-(_.targetTileZ-this.sceneBaseTileZ-this.sceneBaseTileZ)*64;if(R!==0||b!==0)_.dstYaw=(Math.atan2(R,b)*325.949|0)&2047;_.targetTileX=0,_.targetTileZ=0}let u=_.dstYaw-_.yaw&2047;if(u!==0){if(u<32||u>2016)_.yaw=_.dstYaw;else if(u>1024)_.yaw-=32;else _.yaw+=32;if(_.yaw&=2047,_.secondarySeqId===_.readyanim&&_.yaw!==_.dstYaw)if(_.turnanim!=-1)_.secondarySeqId=_.turnanim;else _.secondarySeqId=_.walkanim}}updateSequences(_){_.needsForwardDrawPadding=!1;let u;if(_.secondarySeqId!==-1){if(u=l.types[_.secondarySeqId],_.secondarySeqCycle++,_.secondarySeqFrame<u.frameCount&&_.secondarySeqCycle>u.getFrameDuration(_.secondarySeqFrame))_.secondarySeqCycle=0,_.secondarySeqFrame++;if(_.secondarySeqFrame>=u.frameCount)_.secondarySeqCycle=0,_.secondarySeqFrame=0}if(_.spotanimId!==-1&&this.loopCycle>=_.spotanimLastCycle){if(_.spotanimFrame<0)_.spotanimFrame=0;u=q0.types[_.spotanimId].seq,_.spotanimCycle++;while(u&&_.spotanimFrame<u.frameCount&&_.spotanimCycle>u.getFrameDuration(_.spotanimFrame))_.spotanimCycle-=u.getFrameDuration(_.spotanimFrame),_.spotanimFrame++;if(u&&_.spotanimFrame>=u.frameCount){if(_.spotanimFrame<0||_.spotanimFrame>=u.frameCount)_.spotanimId=-1}}if(_.primarySeqId!=-1&&_.primarySeqDelay<=1){if(u=l.types[_.primarySeqId],u.preanim_move===1&&_.preanimRouteLength>0&&this.loopCycle>=_.forceMoveStartCycle&&this.loopCycle>_.forceMoveEndCycle){_.primarySeqDelay=1;return}}if(_.primarySeqId!==-1&&_.primarySeqDelay===0){u=l.types[_.primarySeqId],_.primarySeqCycle++;while(_.primarySeqFrame<u.frameCount&&_.primarySeqCycle>u.getFrameDuration(_.primarySeqFrame))_.primarySeqCycle-=u.getFrameDuration(_.primarySeqFrame),_.primarySeqFrame++;if(_.primarySeqFrame>=u.frameCount){if(_.primarySeqFrame-=u.replayoff,_.primarySeqLoop++,_.primarySeqLoop>=u.replaycount)_.primarySeqId=-1;if(_.primarySeqFrame<0||_.primarySeqFrame>=u.frameCount)_.primarySeqId=-1}_.needsForwardDrawPadding=u.stretches}if(_.primarySeqDelay>0)_.primarySeqDelay--}async loadTitle(){if(this.imageTitle2)return;if(this.drawArea=null,this.areaChatback=null,this.areaMapback=null,this.areaSidebar=null,this.areaViewport=null,this.areaBackbase1=null,this.areaBackbase2=null,this.areaBackhmid1=null,this.imageTitle0=new I0(128,265),F.clear(),this.imageTitle1=new I0(128,265),F.clear(),this.imageTitle2=new I0(509,171),F.clear(),this.imageTitle3=new I0(360,132),F.clear(),this.imageTitle4=new I0(360,200),F.clear(),this.imageTitle5=new I0(202,238),F.clear(),this.imageTitle6=new I0(203,238),F.clear(),this.imageTitle7=new I0(74,94),F.clear(),this.imageTitle8=new I0(75,94),F.clear(),this.jagTitle)await this.loadTitleBackground(),await this.loadTitleImages();this.redrawFrame=!0}async loadTitleBackground(){if(!this.jagTitle)return;let _=await R0.fromJpeg(this.jagTitle,"title");this.imageTitle0?.bind(),_.blitOpaque(0,0),this.imageTitle1?.bind(),_.blitOpaque(-637,0),this.imageTitle2?.bind(),_.blitOpaque(-128,0),this.imageTitle3?.bind(),_.blitOpaque(-202,-371),this.imageTitle4?.bind(),_.blitOpaque(-202,-171),this.imageTitle5?.bind(),_.blitOpaque(0,-265),this.imageTitle6?.bind(),_.blitOpaque(-562,-265),this.imageTitle7?.bind(),_.blitOpaque(-128,-171),this.imageTitle8?.bind(),_.blitOpaque(-562,-171),_.flipHorizontally(),this.imageTitle0?.bind(),_.blitOpaque(382,0),this.imageTitle1?.bind(),_.blitOpaque(-255,0),this.imageTitle2?.bind(),_.blitOpaque(254,0),this.imageTitle3?.bind(),_.blitOpaque(180,-371),this.imageTitle4?.bind(),_.blitOpaque(180,-171),this.imageTitle5?.bind(),_.blitOpaque(382,-265),this.imageTitle6?.bind(),_.blitOpaque(-180,-265),this.imageTitle7?.bind(),_.blitOpaque(254,-171),this.imageTitle8?.bind(),_.blitOpaque(-180,-171);let u=R0.fromArchive(this.jagTitle,"logo");this.imageTitle2?.bind(),u.draw((this.width/2|0)-(u.cropRight/2|0)-128,18)}async loadTitleImages(){if(!this.jagTitle)return;this.imageTitlebox=O0.fromArchive(this.jagTitle,"titlebox"),this.imageTitlebutton=O0.fromArchive(this.jagTitle,"titlebutton");for(let _=0;_<12;_++)this.imageRunes[_]=O0.fromArchive(this.jagTitle,"runes",_);if(this.imageFlamesLeft=new R0(128,265),this.imageFlamesRight=new R0(128,265),this.imageTitle0)q1(this.imageTitle0.pixels,0,this.imageFlamesLeft.pixels,0,33920);if(this.imageTitle1)q1(this.imageTitle1.pixels,0,this.imageFlamesRight.pixels,0,33920);this.flameGradient0=new Int32Array(256);for(let _=0;_<64;_++)this.flameGradient0[_]=_*262144;for(let _=0;_<64;_++)this.flameGradient0[_+64]=_*1024+16711680;for(let _=0;_<64;_++)this.flameGradient0[_+128]=_*4+16776960;for(let _=0;_<64;_++)this.flameGradient0[_+192]=16777215;this.flameGradient1=new Int32Array(256);for(let _=0;_<64;_++)this.flameGradient1[_]=_*1024;for(let _=0;_<64;_++)this.flameGradient1[_+64]=_*4+65280;for(let _=0;_<64;_++)this.flameGradient1[_+128]=_*262144+65535;for(let _=0;_<64;_++)this.flameGradient1[_+192]=16777215;this.flameGradient2=new Int32Array(256);for(let _=0;_<64;_++)this.flameGradient2[_]=_*4;for(let _=0;_<64;_++)this.flameGradient2[_+64]=_*262144+255;for(let _=0;_<64;_++)this.flameGradient2[_+128]=_*1024+16711935;for(let _=0;_<64;_++)this.flameGradient2[_+192]=16777215;if(this.flameGradient=new Int32Array(256),this.flameBuffer0=new Int32Array(32768),this.flameBuffer1=new Int32Array(32768),this.updateFlameBuffer(null),this.flameBuffer3=new Int32Array(32768),this.flameBuffer2=new Int32Array(32768),await this.drawProgress(10,"Connecting to fileserver"),!this.flameActive)this.flameActive=!0,this.flamesInterval=setInterval(this.runFlames.bind(this),35)}async drawTitle(){await this.loadTitle(),this.imageTitle4?.bind(),this.imageTitlebox?.draw(0,0);let _=360,u=200;if(this.titleScreenState===0){let R=(u/2|0)+80,b=(u/2|0)-20;if(this.onDemand)this.fontPlain11?.drawStringTaggableCenter(_/2,R,this.onDemand.message,7711145,!0);this.fontBold12?.drawStringTaggableCenter(_/2,b,"Welcome to RuneScape",16776960,!0),b+=30;let m=(_/2|0)-80;b=(u/2|0)+20,this.imageTitlebutton?.draw(m-73,b-20),this.fontBold12?.drawStringTaggableCenter(m,b+5,"New user",16777215,!0),m=(_/2|0)+80,this.imageTitlebutton?.draw(m-73,b-20),this.fontBold12?.drawStringTaggableCenter(m,b+5,"Existing User",16777215,!0)}else if(this.titleScreenState===2){let R=(_/2|0)-80,b=(u/2|0)-40;if(this.loginMessage0.length>0)this.fontBold12?.drawStringTaggableCenter(_/2,b-15,this.loginMessage0,16776960,!0),this.fontBold12?.drawStringTaggableCenter(_/2,b,this.loginMessage1,16776960,!0),b+=30;else this.fontBold12?.drawStringTaggableCenter(_/2,b-7,this.loginMessage1,16776960,!0),b+=30;this.fontBold12?.drawStringTaggable(_/2-90,b,`Username: ${this.username}${this.titleLoginField===0&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),b+=15,this.fontBold12?.drawStringTaggable(_/2-88,b,`Password: ${c.toAsterisks(this.password)}${this.titleLoginField===1&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),b+=15,R=(_/2|0)-80,b=(u/2|0)+50,this.imageTitlebutton?.draw(R-73,b-20),this.fontBold12?.drawStringTaggableCenter(R,b+5,"Login",16777215,!0),R=(_/2|0)+80,this.imageTitlebutton?.draw(R-73,b-20),this.fontBold12?.drawStringTaggableCenter(R,b+5,"Cancel",16777215,!0)}else if(this.titleScreenState===3){let R=_/2|0,b=(u/2|0)-60;this.fontBold12?.drawStringTaggableCenter(R,b,"Create a free account",16776960,!0),b=(u/2|0)-35,this.fontBold12?.drawStringTaggableCenter(R,b,"To create a new account you need to",16777215,!0),b+=15,this.fontBold12?.drawStringTaggableCenter(R,b,"go back to the main RuneScape webpage",16777215,!0),b+=15,this.fontBold12?.drawStringTaggableCenter(R,b,"and choose the red 'create account'",16777215,!0),b+=15,this.fontBold12?.drawStringTaggableCenter(R,b,"button at the top right of that page.",16777215,!0),b+=15,R=_/2|0,b=(u/2|0)+50,this.imageTitlebutton?.draw(R-73,b-20),this.fontBold12?.drawStringTaggableCenter(R,b+5,"Cancel",16777215,!0)}if(this.imageTitle4?.draw(202,171),this.redrawFrame)this.redrawFrame=!1,this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(202,371),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(562,265),this.imageTitle7?.draw(128,171),this.imageTitle8?.draw(562,171)}drawGame(){if(this.players===null)return;if(this.redrawFrame){if(this.redrawFrame=!1,this.areaBackleft1?.draw(0,4),this.areaBackleft2?.draw(0,357),this.areaBackright1?.draw(722,4),this.areaBackright2?.draw(743,205),this.areaBacktop1?.draw(0,0),this.areaBackvmid1?.draw(516,4),this.areaBackvmid2?.draw(516,205),this.areaBackvmid3?.draw(496,357),this.areaBackhmid2?.draw(0,338),this.redrawSidebar=!0,this.redrawChatback=!0,this.redrawSideicons=!0,this.redrawPrivacySettings=!0,this.sceneState!==2)this.areaViewport?.draw(4,4),this.areaMapback?.draw(550,4)}if(this.sceneState===2)this.drawScene();if(this.menuVisible&&this.menuArea===1)this.redrawSidebar=!0;if(this.sidebarInterfaceId!==-1){if(this.updateInterfaceAnimation(this.sidebarInterfaceId,this.sceneDelta))this.redrawSidebar=!0}if(this.selectedArea===2)this.redrawSidebar=!0;if(this.objDragArea===2)this.redrawSidebar=!0;if(this.redrawSidebar)this.drawSidebar(),this.redrawSidebar=!1;if(this.chatInterfaceId===-1){if(this.chatInterface.scrollPosition=this.chatScrollHeight-this.chatScrollOffset-77,this.mouseX>448&&this.mouseX<560&&this.mouseY>332)this.handleScrollInput(this.mouseX-17,this.mouseY-357,this.chatScrollHeight,77,!1,463,0,this.chatInterface);let _=this.chatScrollHeight-this.chatInterface.scrollPosition-77;if(_<0)_=0;if(_>this.chatScrollHeight-77)_=this.chatScrollHeight-77;if(this.chatScrollOffset!==_)this.chatScrollOffset=_,this.redrawChatback=!0}if(this.chatInterfaceId!==-1){if(this.updateInterfaceAnimation(this.chatInterfaceId,this.sceneDelta))this.redrawChatback=!0}if(this.selectedArea===3)this.redrawChatback=!0;if(this.objDragArea===3)this.redrawChatback=!0;if(this.modalMessage)this.redrawChatback=!0;if(this.menuVisible&&this.menuArea===2)this.redrawChatback=!0;if(this.redrawChatback)this.drawChat(),this.redrawChatback=!1;if(this.sceneState===2)this.drawMinimap(),this.areaMapback?.draw(550,4);if(this.flashingTab!==-1)this.redrawSideicons=!0;if(this.redrawSideicons){if(this.flashingTab!==-1&&this.flashingTab===this.selectedTab)this.flashingTab=-1,this.out.p1isaac(233),this.out.p1(this.selectedTab);if(this.redrawSideicons=!1,this.areaBackhmid1?.bind(),this.imageBackhmid1?.draw(0,0),this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===0)this.imageRedstone1?.draw(22,10);else if(this.selectedTab===1)this.imageRedstone2?.draw(54,8);else if(this.selectedTab===2)this.imageRedstone2?.draw(82,8);else if(this.selectedTab===3)this.imageRedstone3?.draw(110,8);else if(this.selectedTab===4)this.imageRedstone2h?.draw(153,8);else if(this.selectedTab===5)this.imageRedstone2h?.draw(181,8);else if(this.selectedTab===6)this.imageRedstone1h?.draw(209,9)}if(this.tabInterfaceId[0]!==-1&&(this.flashingTab!==0||this.loopCycle%20<10))this.imageSideicons[0]?.draw(29,13);if(this.tabInterfaceId[1]!==-1&&(this.flashingTab!==1||this.loopCycle%20<10))this.imageSideicons[1]?.draw(53,11);if(this.tabInterfaceId[2]!==-1&&(this.flashingTab!==2||this.loopCycle%20<10))this.imageSideicons[2]?.draw(82,11);if(this.tabInterfaceId[3]!==-1&&(this.flashingTab!==3||this.loopCycle%20<10))this.imageSideicons[3]?.draw(115,12);if(this.tabInterfaceId[4]!==-1&&(this.flashingTab!==4||this.loopCycle%20<10))this.imageSideicons[4]?.draw(153,13);if(this.tabInterfaceId[5]!==-1&&(this.flashingTab!==5||this.loopCycle%20<10))this.imageSideicons[5]?.draw(180,11);if(this.tabInterfaceId[6]!==-1&&(this.flashingTab!==6||this.loopCycle%20<10))this.imageSideicons[6]?.draw(208,13)}if(this.areaBackhmid1?.draw(516,160),this.areaBackbase2?.bind(),this.imageBackbase2?.draw(0,0),this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===7)this.imageRedstone1v?.draw(42,0);else if(this.selectedTab===8)this.imageRedstone2v?.draw(74,0);else if(this.selectedTab===9)this.imageRedstone2v?.draw(102,0);else if(this.selectedTab===10)this.imageRedstone3v?.draw(130,1);else if(this.selectedTab===11)this.imageRedstone2hv?.draw(173,0);else if(this.selectedTab===12)this.imageRedstone2hv?.draw(201,0);else if(this.selectedTab===13)this.imageRedstone1hv?.draw(229,0)}if(this.tabInterfaceId[8]!==-1&&(this.flashingTab!==8||this.loopCycle%20<10))this.imageSideicons[7]?.draw(74,2);if(this.tabInterfaceId[9]!==-1&&(this.flashingTab!==9||this.loopCycle%20<10))this.imageSideicons[8]?.draw(102,3);if(this.tabInterfaceId[10]!==-1&&(this.flashingTab!==10||this.loopCycle%20<10))this.imageSideicons[9]?.draw(137,4);if(this.tabInterfaceId[11]!==-1&&(this.flashingTab!==11||this.loopCycle%20<10))this.imageSideicons[10]?.draw(174,2);if(this.tabInterfaceId[12]!==-1&&(this.flashingTab!==12||this.loopCycle%20<10))this.imageSideicons[11]?.draw(201,2);if(this.tabInterfaceId[13]!==-1&&(this.flashingTab!==13||this.loopCycle%20<10))this.imageSideicons[12]?.draw(226,2)}this.areaBackbase2?.draw(496,466),this.areaViewport?.bind()}if(this.redrawPrivacySettings){if(this.redrawPrivacySettings=!1,this.areaBackbase1?.bind(),this.imageBackbase1?.draw(0,0),this.fontPlain12?.drawStringTaggableCenter(55,28,"Public chat",16777215,!0),this.chatPublicMode===0)this.fontPlain12?.drawStringTaggableCenter(55,41,"On",65280,!0);if(this.chatPublicMode===1)this.fontPlain12?.drawStringTaggableCenter(55,41,"Friends",16776960,!0);if(this.chatPublicMode===2)this.fontPlain12?.drawStringTaggableCenter(55,41,"Off",16711680,!0);if(this.chatPublicMode===3)this.fontPlain12?.drawStringTaggableCenter(55,41,"Hide",65535,!0);if(this.fontPlain12?.drawStringTaggableCenter(184,28,"Private chat",16777215,!0),this.chatPrivateMode===0)this.fontPlain12?.drawStringTaggableCenter(184,41,"On",65280,!0);if(this.chatPrivateMode===1)this.fontPlain12?.drawStringTaggableCenter(184,41,"Friends",16776960,!0);if(this.chatPrivateMode===2)this.fontPlain12?.drawStringTaggableCenter(184,41,"Off",16711680,!0);if(this.fontPlain12?.drawStringTaggableCenter(324,28,"Trade/duel",16777215,!0),this.chatTradeMode===0)this.fontPlain12?.drawStringTaggableCenter(324,41,"On",65280,!0);if(this.chatTradeMode===1)this.fontPlain12?.drawStringTaggableCenter(324,41,"Friends",16776960,!0);if(this.chatTradeMode===2)this.fontPlain12?.drawStringTaggableCenter(324,41,"Off",16711680,!0);this.fontPlain12?.drawStringTaggableCenter(458,33,"Report abuse",16777215,!0),this.areaBackbase1?.draw(0,453),this.areaViewport?.bind()}this.sceneDelta=0}drawScene(){if(this.sceneCycle++,this.pushNpcs(!0),this.pushPlayers(),this.pushNpcs(!1),this.pushProjectiles(),this.pushSpotanims(),!this.cutscene){let I=this.orbitCameraPitch;if((this.cameraPitchClamp/256|0)>I)I=this.cameraPitchClamp/256|0;if(this.cameraModifierEnabled[4]&&this.cameraModifierWobbleScale[4]+128>I)I=this.cameraModifierWobbleScale[4]+128;let L=this.orbitCameraYaw+this.macroCameraAngle&2047;if(this.localPlayer)this.orbitCamera(this.orbitCameraX,this.getHeightmapY(this.currentLevel,this.localPlayer.x,this.localPlayer.z)-50,this.orbitCameraZ,L,I,I*3+600);if(v.cyclelogic2++,v.cyclelogic2>1802){v.cyclelogic2=0,this.out.p1isaac(148),this.out.p1(0);let H=this.out.pos;if(this.out.p2(29711),this.out.p1(70),this.out.p1(Math.random()*256|0),this.out.p1(242),this.out.p1(186),this.out.p1(39),this.out.p1(61),(Math.random()*2|0)===0)this.out.p1(13);if((Math.random()*2|0)===0)this.out.p2(57856);this.out.p2(Math.random()*65536|0),this.out.psize1(this.out.pos-H)}}let _;if(this.cutscene)_=this.getTopLevelCutscene();else _=this.getTopLevel();let u=this.cameraX,R=this.cameraY,b=this.cameraZ,m=this.cameraPitch,E=this.cameraYaw;for(let I=0;I<5;I++)if(this.cameraModifierEnabled[I]){let L=Math.random()*(this.cameraModifierJitter[I]*2+1)-this.cameraModifierJitter[I]+Math.sin(this.cameraModifierCycle[I]*(this.cameraModifierWobbleSpeed[I]/100))*this.cameraModifierWobbleScale[I]|0;if(I===0)this.cameraX+=L;else if(I===1)this.cameraY+=L;else if(I===2)this.cameraZ+=L;else if(I===3)this.cameraYaw=this.cameraYaw+L&2047;else if(I===4){if(this.cameraPitch+=L,this.cameraPitch<128)this.cameraPitch=128;if(this.cameraPitch>383)this.cameraPitch=383}}let O=A.cycle;$.checkHover=!0,$.pickedCount=0,$.mouseX=this.mouseX-4,$.mouseY=this.mouseY-4,F.clear(),this.scene?.draw(this.cameraX,this.cameraY,this.cameraZ,_,this.cameraYaw,this.cameraPitch,this.loopCycle),this.scene?.clearLocChanges(),this.draw2DEntityElements(),this.drawTileHint(),this.updateTextures(O),this.draw3DEntityElements(),this.areaViewport?.draw(4,4),this.cameraX=u,this.cameraY=R,this.cameraZ=b,this.cameraPitch=m,this.cameraYaw=E}pushPlayers(){if(!this.localPlayer)return;if(this.localPlayer.x>>7===this.flagSceneTileX&&this.localPlayer.z>>7===this.flagSceneTileZ)this.flagSceneTileX=0;for(let _=-1;_<this.playerCount;_++){let u,R;if(_===-1)u=this.localPlayer,R=33538048;else u=this.players[this.playerIds[_]],R=this.playerIds[_]<<14;if(!u||!u.isVisible())continue;if(u.lowMemory=!1,(v.lowMemory&&this.playerCount>50||this.playerCount>200)&&_!=-1&&u.secondarySeqId==u.readyanim)u.lowMemory=!0;let b=u.x>>7,m=u.z>>7;if(b<0||b>=104||m<0||m>=104)continue;if(!u.locModel||this.loopCycle<u.locStartCycle||this.loopCycle>=u.locStopCycle){if((u.x&127)===64&&(u.z&127)===64){if(this.tileLastOccupiedCycle[b][m]==this.sceneCycle&&_!=-1)continue;this.tileLastOccupiedCycle[b][m]=this.sceneCycle}u.y=this.getHeightmapY(this.currentLevel,u.x,u.z),this.scene?.addTemporary(this.currentLevel,u.x,u.y,u.z,u,R,u.yaw,60,u.needsForwardDrawPadding)}else u.lowMemory=!1,u.y=this.getHeightmapY(this.currentLevel,u.x,u.z),this.scene?.addTemporary2(this.currentLevel,u.x,u.y,u.z,u.minTileX,u.minTileZ,u.maxTileX,u.maxTileZ,u,R,u.yaw)}}pushNpcs(_){for(let u=0;u<this.npcCount;u++){let R=this.npcs[this.npcIds[u]],b=(this.npcIds[u]<<14)+536870912|0;if(!R||!R.isVisible()||R.type?.alwaysontop!==_)continue;let m=R.x>>7,E=R.z>>7;if(m<0||m>=104||E<0||E>=104)continue;if(R.size===1&&(R.x&127)===64&&(R.z&127)===64){if(this.tileLastOccupiedCycle[m][E]===this.sceneCycle)continue;this.tileLastOccupiedCycle[m][E]=this.sceneCycle}this.scene?.addTemporary(this.currentLevel,R.x,this.getHeightmapY(this.currentLevel,R.x,R.z),R.z,R,b,R.yaw,(R.size-1)*64+60,R.needsForwardDrawPadding)}}pushProjectiles(){for(let _=this.projectiles.head();_;_=this.projectiles.next())if(_.projLevel!==this.currentLevel||this.loopCycle>_.lastCycle)_.unlink();else if(this.loopCycle>=_.startCycle){if(_.projTarget>0){let u=this.npcs[_.projTarget-1];if(u)_.updateVelocity(u.x,this.getHeightmapY(_.projLevel,u.x,u.z)-_.projOffsetY,u.z,this.loopCycle)}if(_.projTarget<0){let u=-_.projTarget-1,R;if(u===this.localPid)R=this.localPlayer;else R=this.players[u];if(R)_.updateVelocity(R.x,this.getHeightmapY(_.projLevel,R.x,R.z)-_.projOffsetY,R.z,this.loopCycle)}_.update(this.sceneDelta),this.scene?.addTemporary(this.currentLevel,_.x|0,_.y|0,_.z|0,_,-1,_.yaw,60,!1)}}pushSpotanims(){for(let _=this.spotanims.head();_;_=this.spotanims.next())if(_.spotLevel!==this.currentLevel||_.seqComplete)_.unlink();else if(this.loopCycle>=_.startCycle)if(_.update(this.sceneDelta),_.seqComplete)_.unlink();else this.scene?.addTemporary(_.spotLevel,_.x,_.y,_.z,_,-1,0,60,!1)}orbitCamera(_,u,R,b,m,E){let O=2048-m&2047,I=2048-b&2047,L=0,H=0,G=E,N,T,K;if(O!==0)N=A.sin[O],T=A.cos[O],K=H*T-E*N>>16,G=H*N+E*T>>16,H=K;if(I!==0)N=A.sin[I],T=A.cos[I],K=G*N+L*T>>16,G=G*T-L*N>>16,L=K;this.cameraX=_-L,this.cameraY=u-H,this.cameraZ=R-G,this.cameraPitch=m,this.cameraYaw=b}getTopLevelCutscene(){if(!this.levelTileFlags)return 0;return this.getHeightmapY(this.currentLevel,this.cameraX,this.cameraZ)-this.cameraY>=800||(this.levelTileFlags[this.currentLevel][this.cameraX>>7][this.cameraZ>>7]&4)===0?3:this.currentLevel}getTopLevel(){let _=3;if(this.cameraPitch<310&&this.localPlayer){let u=this.cameraX>>7,R=this.cameraZ>>7,b=this.localPlayer.x>>7,m=this.localPlayer.z>>7;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][u][R]&4)!==0)_=this.currentLevel;let E;if(b>u)E=b-u;else E=u-b;let O;if(m>R)O=m-R;else O=R-m;if(E>O){let I=O*65536/E|0,L=32768;while(u!==b){if(u<b)u++;else if(u>b)u--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][u][R]&4)!==0)_=this.currentLevel;if(L+=I,L>=65536){if(L-=65536,R<m)R++;else if(R>m)R--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][u][R]&4)!==0)_=this.currentLevel}}}else{let I=E*65536/O|0,L=32768;while(R!==m){if(R<m)R++;else if(R>m)R--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][u][R]&4)!==0)_=this.currentLevel;if(L+=I,L>=65536){if(L-=65536,u<b)u++;else if(u>b)u--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][u][R]&4)!==0)_=this.currentLevel}}}}if(this.localPlayer&&this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][this.localPlayer.x>>7][this.localPlayer.z>>7]&4)!==0)_=this.currentLevel;return _}draw2DEntityElements(){this.chatCount=0;for(let _=-1;_<this.playerCount+this.npcCount;_++){let u=null;if(_===-1)u=this.localPlayer;else if(_<this.playerCount)u=this.players[this.playerIds[_]];else u=this.npcs[this.npcIds[_-this.playerCount]];if(!u||!u.isVisible())continue;if(_>=this.playerCount){let R=u.type;if(R&&R.headicon>=0&&R.headicon<this.imageHeadicon.length){if(this.projectFromEntity(u,u.height+15),this.projectX>-1)this.imageHeadicon[R.headicon]?.draw(this.projectX-12,this.projectY-30)}if(this.hintType===1&&this.hintNpc===this.npcIds[_-this.playerCount]&&this.loopCycle%20<10){if(this.projectFromEntity(u,u.height+15),this.projectX>-1)this.imageHeadicon[2]?.draw(this.projectX-12,this.projectY-28)}}else{let R=30,b=u;if(b.headicons!==0){if(this.projectFromEntity(u,u.height+15),this.projectX>-1){for(let m=0;m<8;m++)if((b.headicons&1<<m)!==0)this.imageHeadicon[m]?.draw(this.projectX-12,this.projectY-R),R-=25}}if(_>=0&&this.hintType===10&&this.hintPlayer===this.playerIds[_]){if(this.projectFromEntity(u,u.height+15),this.projectX>-1)this.imageHeadicon[7]?.draw(this.projectX-12,this.projectY-R)}}if(u.chatMessage&&(_>=this.playerCount||this.chatPublicMode===0||this.chatPublicMode===3||this.chatPublicMode===1&&this.isFriend(u.name))){if(this.projectFromEntity(u,u.height),this.projectX>-1&&this.chatCount<50&&this.fontBold12){if(this.chatWidth[this.chatCount]=this.fontBold12.stringWidth(u.chatMessage)/2|0,this.chatHeight[this.chatCount]=this.fontBold12.height2d,this.chatX[this.chatCount]=this.projectX,this.chatY[this.chatCount]=this.projectY,this.chatColors[this.chatCount]=u.chatColour,this.chatEffect[this.chatCount]=u.chatEffect,this.chatTimers[this.chatCount]=u.chatTimer,this.chats[this.chatCount++]=u.chatMessage,this.chatEffects===0&&u.chatEffect===1)this.chatHeight[this.chatCount]+=10,this.chatY[this.chatCount]+=5;if(this.chatEffects===0&&u.chatEffect===2)this.chatWidth[this.chatCount]=60}}if(u.combatCycle>this.loopCycle+100){if(this.projectFromEntity(u,u.height+15),this.projectX>-1){let R=u.health*30/u.totalHealth|0;if(R>30)R=30;F.fillRect2d(this.projectX-15,this.projectY-3,R,5,65280),F.fillRect2d(this.projectX-15+R,this.projectY-3,30-R,5,16711680)}}for(let R=0;R<4;++R)if(u.damageCycles[R]>this.loopCycle){if(this.projectFromEntity(u,u.height/2|0),this.projectX<=-1)continue;if(R==1)this.projectY-=20;else if(R==2)this.projectX-=15,this.projectY-=10;else if(R==3)this.projectX+=15,this.projectY-=10;this.imageHitmarks[u.damageTypes[R]]?.draw(this.projectX-12,this.projectY-12),this.fontPlain11?.drawStringCenter(this.projectX,this.projectY+4,u.damageValues[R].toString(),0),this.fontPlain11?.drawStringCenter(this.projectX-1,this.projectY+3,u.damageValues[R].toString(),16777215)}}for(let _=0;_<this.chatCount;_++){let u=this.chatX[_],R=this.chatY[_],b=this.chatWidth[_],m=this.chatHeight[_],E=!0;while(E){E=!1;for(let I=0;I<_;I++)if(R+2>this.chatY[I]-this.chatHeight[I]&&R-m<this.chatY[I]+2&&u-b<this.chatX[I]+this.chatWidth[I]&&u+b>this.chatX[I]-this.chatWidth[I]&&this.chatY[I]-this.chatHeight[I]<R)R=this.chatY[I]-this.chatHeight[I],E=!0}this.projectX=this.chatX[_],this.projectY=this.chatY[_]=R;let O=this.chats[_];if(this.chatEffects===0){let I=16776960;if(this.chatColors[_]<6)I=v.CHAT_COLORS[this.chatColors[_]];else if(this.chatColors[_]===6)I=this.sceneCycle%20<10?16711680:16776960;else if(this.chatColors[_]===7)I=this.sceneCycle%20<10?255:65535;else if(this.chatColors[_]===8)I=this.sceneCycle%20<10?45056:8454016;else if(this.chatColors[_]===9){let L=150-this.chatTimers[_];if(L<50)I=L*1280+16711680;else if(L<100)I=16776960-(L-50)*327680;else if(L<150)I=(L-100)*5+65280}else if(this.chatColors[_]===10){let L=150-this.chatTimers[_];if(L<50)I=L*5+16711680;else if(L<100)I=16711935-(L-50)*327680;else if(L<150)I=(L-100)*327680+255-(L-100)*5}if(this.chatColors[_]===11){let L=150-this.chatTimers[_];if(L<50)I=16777215-L*327685;else if(L<100)I=(L-50)*327685+65280;else if(L<150)I=16777215-(L-100)*327680}if(this.chatEffect[_]===0)this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,O,0),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,O,I);else if(this.chatEffect[_]===1)this.fontBold12?.drawCenteredWave(this.projectX,this.projectY+1,O,0,this.sceneCycle),this.fontBold12?.drawCenteredWave(this.projectX,this.projectY,O,I,this.sceneCycle);else if(this.chatEffect[_]===2){let L=this.fontBold12?.stringWidth(O)??0,H=(150-this.chatTimers[_])*(L+100)/150;F.setBounds(this.projectX-50,0,this.projectX+50,334),this.fontBold12?.drawString(this.projectX+50-H,this.projectY+1,O,0),this.fontBold12?.drawString(this.projectX+50-H,this.projectY,O,I),F.resetBounds()}}else this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,O,0),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,O,16776960)}}drawTileHint(){if(this.hintType!==2||!this.imageHeadicon[2])return;if(this.projectFromGround((this.hintTileX-this.sceneBaseTileX<<7)+this.hintOffsetX,this.hintHeight*2,(this.hintTileZ-this.sceneBaseTileZ<<7)+this.hintOffsetZ),this.projectX>-1&&this.loopCycle%20<10)this.imageHeadicon[2].draw(this.projectX-12,this.projectY-28)}projectFromEntity(_,u){this.projectFromGround(_.x,u,_.z)}projectFromGround(_,u,R){if(_<128||R<128||_>13056||R>13056){this.projectX=-1,this.projectY=-1;return}let b=this.getHeightmapY(this.currentLevel,_,R)-u;this.project(_,b,R)}project(_,u,R){let b=_-this.cameraX,m=u-this.cameraY,E=R-this.cameraZ,O=A.sin[this.cameraPitch],I=A.cos[this.cameraPitch],L=A.sin[this.cameraYaw],H=A.cos[this.cameraYaw],G=E*L+b*H>>16;if(E=E*H-b*L>>16,b=G,G=m*I-E*O>>16,E=m*O+E*I>>16,m=G,E>=50)this.projectX=A.centerX+((b<<9)/E|0),this.projectY=A.centerY+((m<<9)/E|0);else this.projectX=-1,this.projectY=-1}getHeightmapY(_,u,R){if(!this.levelHeightmap)return 0;let b=u>>7,m=R>>7;if(b<0||m<0||b>103||m>103)return 0;let E=_;if(_<3&&this.levelTileFlags&&(this.levelTileFlags[1][b][m]&2)===2)E=_+1;let O=u&127,I=R&127,L=this.levelHeightmap[E][b][m]*(128-O)+this.levelHeightmap[E][b+1][m]*O>>7,H=this.levelHeightmap[E][b][m+1]*(128-O)+this.levelHeightmap[E][b+1][m+1]*O>>7;return L*(128-I)+H*I>>7}updateTextures(_){if(!v.lowMemory){if(A.textureCycle[17]>=_){let u=A.textures[17];if(!u)return;let R=u.width2d*u.height2d-1,b=u.width2d*this.sceneDelta*2,m=u.pixels,E=this.textureBuffer;for(let O=0;O<=R;O++)E[O]=m[O-b&R];u.pixels=E,this.textureBuffer=m,A.pushTexture(17)}if(A.textureCycle[24]>=_){let u=A.textures[24];if(!u)return;let R=u.width2d*u.height2d-1,b=u.width2d*this.sceneDelta*2,m=u.pixels,E=this.textureBuffer;for(let O=0;O<=R;O++)E[O]=m[O-b&R];u.pixels=E,this.textureBuffer=m,A.pushTexture(24)}}}draw3DEntityElements(){if(this.drawPrivateMessages(),this.crossMode===1)this.imageCrosses[this.crossCycle/100|0]?.draw(this.crossX-8-4,this.crossY-8-4);else if(this.crossMode===2)this.imageCrosses[(this.crossCycle/100|0)+4]?.draw(this.crossX-8-4,this.crossY-8-4);if(this.viewportOverlayInterfaceId!==-1)this.updateInterfaceAnimation(this.viewportOverlayInterfaceId,this.sceneDelta),this.drawInterface(s.types[this.viewportOverlayInterfaceId],0,0,0);if(this.field1264>0){let _=302-(Math.abs(Math.sin(this.field1264/10)*10)|0);for(let u=0;u<30;u++){let R=(30-u)*16;F.drawHorizontalLineAlpha(256-R/2,_+u,16776960,R,this.field1264)}}if(this.viewportInterfaceId!==-1)this.updateInterfaceAnimation(this.viewportInterfaceId,this.sceneDelta),this.drawInterface(s.types[this.viewportInterfaceId],0,0,0);if(this.updateWorldLocation(),!this.menuVisible)this.handleInput(),this.drawTooltip();else if(this.menuArea===0)this.drawMenu();if(this.inMultizone===1)if(this.wildernessLevel>0||this.worldLocationState===1)this.imageHeadicon[1]?.draw(472,258);else this.imageHeadicon[1]?.draw(472,296);if(this.wildernessLevel>0)this.imageHeadicon[0]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Level: "+this.wildernessLevel,16776960);if(this.worldLocationState===1)this.imageHeadicon[6]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Arena",16776960);if(this.displayFps){let _=507,u=20,R=16776960;if(this.fps<15)R=16711680;this.fontPlain12?.drawStringRight(_,u,"Fps:"+this.fps,R),u+=15;let b=-1;if(typeof window.performance.memory!=="undefined")b=window.performance.memory.usedJSHeapSize/1024|0;if(b!==-1)this.fontPlain12?.drawStringRight(_,u,"Mem:"+b+"k",16776960)}if(this.systemUpdateTimer!==0){let _=this.systemUpdateTimer/50|0,u=_/60|0;if(_%=60,_<10)this.fontPlain12?.drawString(4,329,"System update in: "+u+":0"+_,16776960);else this.fontPlain12?.drawString(4,329,"System update in: "+u+":"+_,16776960)}}drawPrivateMessages(){if(this.splitPrivateChat===0)return;let _=this.fontPlain12,u=0;if(this.systemUpdateTimer!==0)u=1;for(let R=0;R<100;R++){if(!this.messageText[R])continue;let b=this.messageType[R],m=this.messageSender[R],E=0;if(m&&m.startsWith("@cr1@"))m=m.substring(5),E=1;else if(m&&m.startsWith("@cr2@"))m=m.substring(5),E=2;if((b==3||b==7)&&(b==7||this.chatPrivateMode==0||this.chatPrivateMode==1&&this.isFriend(m))){let O=329-u*13,I=4;if(_?.drawString(4,O,"From",0),_?.drawString(4,O-1,"From",65535),I+=_?.stringWidth("From ")??0,E==1)this.imageModIcons[0].draw(I,O-12),I+=14;else if(E==2)this.imageModIcons[1].draw(I,O-12),I+=14;if(_?.drawString(I,O,m+": "+this.messageText[R],0),_?.drawString(I,O-1,m+": "+this.messageText[R],65535),u++,u>=5)return}else if(b===5&&this.chatPrivateMode<2){let O=329-u*13;if(_?.drawString(4,O,this.messageText[R],0),_?.drawString(4,O-1,this.messageText[R],65535),u++,u>=5)return}else if(b===6&&this.chatPrivateMode<2){let O=329-u*13;if(_?.drawString(4,O,"To "+m+": "+this.messageText[R],0),_?.drawString(4,O-1,"To "+m+": "+this.messageText[R],65535),u++,u>=5)return}}}updateWorldLocation(){if(!this.localPlayer)return;let _=(this.localPlayer.x>>7)+this.sceneBaseTileX,u=(this.localPlayer.z>>7)+this.sceneBaseTileZ;if(_>=2944&&_<3392&&u>=3520&&u<6400)this.wildernessLevel=((u-3520)/8|0)+1;else if(_>=2944&&_<3392&&u>=9920&&u<12800)this.wildernessLevel=((u-9920)/8|0)+1;else this.wildernessLevel=0;if(this.worldLocationState=0,_>=3328&&_<3392&&u>=3200&&u<3264){let R=_&63,b=u&63;if(R>=4&&R<=29&&b>=44&&b<=58)this.worldLocationState=1;else if(R>=36&&R<=61&&b>=44&&b<=58)this.worldLocationState=1;else if(R>=4&&R<=29&&b>=25&&b<=39)this.worldLocationState=1;else if(R>=36&&R<=61&&b>=25&&b<=39)this.worldLocationState=1;else if(R>=4&&R<=29&&b>=6&&b<=20)this.worldLocationState=1;else if(R>=36&&R<=61&&b>=6&&b<=20)this.worldLocationState=1}if(this.worldLocationState===0&&_>=3328&&_<=3393&&u>=3203&&u<=3325)this.worldLocationState=2;if(this.overrideChat=0,_>=3053&&_<=3156&&u>=3056&&u<=3136)this.overrideChat=1;else if(_>=3072&&_<=3118&&u>=9492&&u<=9535)this.overrideChat=1;if(this.overrideChat===1&&_>=3139&&_<=3199&&u>=3008&&u<=3062)this.overrideChat=0}drawTooltip(){if(this.menuSize<2&&this.objSelected===0&&this.spellSelected===0)return;let _;if(this.objSelected===1&&this.menuSize<2)_="Use "+this.objSelectedName+" with...";else if(this.spellSelected===1&&this.menuSize<2)_=this.spellCaption+"...";else _=this.menuOption[this.menuSize-1];if(this.menuSize>2)_=_+"@whi@ / "+(this.menuSize-2)+" more options";this.fontBold12?.drawStringTooltip(4,15,_,16777215,!0,this.loopCycle/1000|0)}drawMenu(){let _=this.menuX,u=this.menuY,R=this.menuWidth,b=this.menuHeight,m=6116423;F.fillRect2d(_,u,R,b,m),F.fillRect2d(_+1,u+1,R-2,16,0),F.drawRect(_+1,u+18,R-2,b-19,0),this.fontBold12?.drawString(_+3,u+14,"Choose Option",m);let E=this.mouseX,O=this.mouseY;if(this.menuArea===0)E-=4,O-=4;else if(this.menuArea===1)E-=553,O-=205;else if(this.menuArea===2)E-=17,O-=357;for(let I=0;I<this.menuSize;I++){let L=u+(this.menuSize-1-I)*15+31,H=16777215;if(E>_&&E<_+R&&O>L-13&&O<L+3)H=16776960;this.fontBold12?.drawStringTaggable(_+3,L,this.menuOption[I],H,!0)}}drawMinimapLoc(_,u,R,b,m){if(!this.scene||!this.imageMinimap)return;let E=this.scene.getWallTypecode(R,_,u);if(E!==0){let O=this.scene.getInfo(R,_,u,E),I=O>>6&3,L=O&31,H=b;if(E>0)H=m;let G=this.imageMinimap.pixels,N=_*4+(103-u)*512*4+24624,T=E>>14&32767,K=u0.get(T);if(K.mapscene===-1){if(L===g.WALL_STRAIGHT.id||L===g.WALL_L.id){if(I===0)G[N]=H,G[N+512]=H,G[N+1024]=H,G[N+1536]=H;else if(I===1)G[N]=H,G[N+1]=H,G[N+2]=H,G[N+3]=H;else if(I===2)G[N+3]=H,G[N+3+512]=H,G[N+3+1024]=H,G[N+3+1536]=H;else if(I===3)G[N+1536]=H,G[N+1536+1]=H,G[N+1536+2]=H,G[N+1536+3]=H}if(L===g.WALL_SQUARE_CORNER.id){if(I===0)G[N]=H;else if(I===1)G[N+3]=H;else if(I===2)G[N+3+1536]=H;else if(I===3)G[N+1536]=H}if(L===g.WALL_L.id){if(I===3)G[N]=H,G[N+512]=H,G[N+1024]=H,G[N+1536]=H;else if(I===0)G[N]=H,G[N+1]=H,G[N+2]=H,G[N+3]=H;else if(I===1)G[N+3]=H,G[N+3+512]=H,G[N+3+1024]=H,G[N+3+1536]=H;else if(I===2)G[N+1536]=H,G[N+1536+1]=H,G[N+1536+2]=H,G[N+1536+3]=H}}else{let Q=this.imageMapscene[K.mapscene];if(Q){let U=(K.width*4-Q.width2d)/2|0,J=(K.length*4-Q.height2d)/2|0;Q.draw(_*4+48+U,(104-u-K.length)*4+J+48)}}}if(E=this.scene.getLocTypecode(R,_,u),E!==0){let O=this.scene.getInfo(R,_,u,E),I=O>>6&3,L=O&31,H=E>>14&32767,G=u0.get(H);if(G.mapscene===-1){if(L===g.WALL_DIAGONAL.id){let N=15658734;if(E>0)N=15597568;let T=this.imageMinimap.pixels,K=_*4+(104-1-u)*512*4+24624;if(I===0||I===2)T[K+1536]=N,T[K+1024+1]=N,T[K+512+2]=N,T[K+3]=N;else T[K]=N,T[K+512+1]=N,T[K+1024+2]=N,T[K+1536+3]=N}}else{let N=this.imageMapscene[G.mapscene];if(N){let T=(G.width*4-N.width2d)/2|0,K=(G.length*4-N.height2d)/2|0;N.draw(_*4+48+T,(104-u-G.length)*4+K+48)}}}if(E=this.scene.getGroundDecorTypecode(R,_,u),E!==0){let O=E>>14&32767,I=u0.get(O);if(I.mapscene!==-1){let L=this.imageMapscene[I.mapscene];if(L){let H=(I.width*4-L.width2d)/2|0,G=(I.length*4-L.height2d)/2|0;L.draw(_*4+48+H,(104-u-I.length)*4+G+48)}}}}interactWithLoc(_,u,R,b){if(!this.localPlayer||!this.scene)return!1;let m=b>>14&32767,E=this.scene.getInfo(this.currentLevel,u,R,b);if(E===-1)return!1;let O=E&31,I=E>>6&3;if(O===g.CENTREPIECE_STRAIGHT.id||O===g.CENTREPIECE_DIAGONAL.id||O===g.GROUND_DECOR.id){let L=u0.get(m),H,G;if(I===0||I===2)H=L.width,G=L.length;else H=L.length,G=L.width;let N=L.forceapproach;if(I!==0)N=(N<<I&15)+(N>>4-I);this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],u,R,2,H,G,0,0,N,!1)}else this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],u,R,2,0,0,I,O+1,0,!1);return this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(_),this.out.p2(u+this.sceneBaseTileX),this.out.p2(R+this.sceneBaseTileZ),this.out.p2(m),!0}tryMove(_,u,R,b,m,E,O,I,L,H,G){let N=this.levelCollisionMap[this.currentLevel];if(!N)return!1;let T=104,K=104;for(let h=0;h<T;h++)for(let D=0;D<K;D++){let j=o.index(h,D);this.bfsDirection[j]=0,this.bfsCost[j]=99999999}let Q=_,U=u,J=o.index(_,u);this.bfsDirection[J]=99,this.bfsCost[J]=0;let q=0,w=0;this.bfsStepX[q]=_,this.bfsStepZ[q++]=u;let V=!1,Y=this.bfsStepX.length,n=N.flags;while(w!==q){if(Q=this.bfsStepX[w],U=this.bfsStepZ[w],w=(w+1)%Y,Q===R&&U===b){V=!0;break}if(L!==g.WALL_STRAIGHT.id){if((L<g.WALLDECOR_STRAIGHT_OFFSET.id||L===g.CENTREPIECE_STRAIGHT.id)&&N.reachedWall(Q,U,R,b,L-1,I)){V=!0;break}if(L<g.CENTREPIECE_STRAIGHT.id&&N.reachedWallDecoration(Q,U,R,b,L-1,I)){V=!0;break}}if(E!==0&&O!==0&&N.reachedLoc(Q,U,R,b,E,O,H)){V=!0;break}let h=this.bfsCost[o.index(Q,U)]+1,D=o.index(Q-1,U);if(Q>0&&this.bfsDirection[D]===0&&(n[D]&2621704)===0)this.bfsStepX[q]=Q-1,this.bfsStepZ[q]=U,q=(q+1)%Y,this.bfsDirection[D]=2,this.bfsCost[D]=h;if(D=o.index(Q+1,U),Q<T-1&&this.bfsDirection[D]===0&&(n[D]&2621824)===0)this.bfsStepX[q]=Q+1,this.bfsStepZ[q]=U,q=(q+1)%Y,this.bfsDirection[D]=8,this.bfsCost[D]=h;if(D=o.index(Q,U-1),U>0&&this.bfsDirection[D]===0&&(n[D]&2621698)===0)this.bfsStepX[q]=Q,this.bfsStepZ[q]=U-1,q=(q+1)%Y,this.bfsDirection[D]=1,this.bfsCost[D]=h;if(D=o.index(Q,U+1),U<K-1&&this.bfsDirection[D]===0&&(n[D]&2621728)===0)this.bfsStepX[q]=Q,this.bfsStepZ[q]=U+1,q=(q+1)%Y,this.bfsDirection[D]=4,this.bfsCost[D]=h;if(D=o.index(Q-1,U-1),Q>0&&U>0&&this.bfsDirection[D]===0&&(n[D]&2621710)===0&&(n[o.index(Q-1,U)]&2621704)===0&&(n[o.index(Q,U-1)]&2621698)===0)this.bfsStepX[q]=Q-1,this.bfsStepZ[q]=U-1,q=(q+1)%Y,this.bfsDirection[D]=3,this.bfsCost[D]=h;if(D=o.index(Q+1,U-1),Q<T-1&&U>0&&this.bfsDirection[D]===0&&(n[D]&2621827)===0&&(n[o.index(Q+1,U)]&2621824)===0&&(n[o.index(Q,U-1)]&2621698)===0)this.bfsStepX[q]=Q+1,this.bfsStepZ[q]=U-1,q=(q+1)%Y,this.bfsDirection[D]=9,this.bfsCost[D]=h;if(D=o.index(Q-1,U+1),Q>0&&U<K-1&&this.bfsDirection[D]===0&&(n[D]&2621752)===0&&(n[o.index(Q-1,U)]&2621704)===0&&(n[o.index(Q,U+1)]&2621728)===0)this.bfsStepX[q]=Q-1,this.bfsStepZ[q]=U+1,q=(q+1)%Y,this.bfsDirection[D]=6,this.bfsCost[D]=h;if(D=o.index(Q+1,U+1),Q<T-1&&U<K-1&&this.bfsDirection[D]===0&&(n[D]&2621920)===0&&(n[o.index(Q+1,U)]&2621824)===0&&(n[o.index(Q,U+1)]&2621728)===0)this.bfsStepX[q]=Q+1,this.bfsStepZ[q]=U+1,q=(q+1)%Y,this.bfsDirection[D]=12,this.bfsCost[D]=h}if(this.tryMoveNearest=0,!V){if(G){let h=100;for(let D=1;D<2;D++){for(let j=R-D;j<=R+D;j++)for(let W=b-D;W<=b+D;W++){let M=o.index(j,W);if(j>=0&&W>=0&&j<104&&W<104&&this.bfsCost[M]<h)h=this.bfsCost[M],Q=j,U=W,this.tryMoveNearest=1,V=!0}if(V)break}}if(!V)return!1}w=0,this.bfsStepX[w]=Q,this.bfsStepZ[w++]=U;let f=this.bfsDirection[o.index(Q,U)],Z=f;while(Q!==_||U!==u){if(Z!==f)f=Z,this.bfsStepX[w]=Q,this.bfsStepZ[w++]=U;if((Z&2)!==0)Q++;else if((Z&8)!==0)Q--;if((Z&1)!==0)U++;else if((Z&4)!==0)U--;Z=this.bfsDirection[o.index(Q,U)]}if(w>0){Y=Math.min(w,25),w--;let h=this.bfsStepX[w],D=this.bfsStepZ[w];if(m===0)this.out.p1isaac(63),this.out.p1(Y+Y+3);else if(m===1)this.out.p1isaac(56),this.out.p1(Y+Y+3+14);else if(m===2)this.out.p1isaac(167),this.out.p1(Y+Y+3);if(this.actionKey[5]===1)this.out.p1(1);else this.out.p1(0);this.out.p2(h+this.sceneBaseTileX),this.out.p2(D+this.sceneBaseTileZ),this.flagSceneTileX=this.bfsStepX[0],this.flagSceneTileZ=this.bfsStepZ[0];for(let j=1;j<Y;j++)w--,this.out.p1(this.bfsStepX[w]-h),this.out.p1(this.bfsStepZ[w]-D);return!0}return m!==1}async readPacket(){if(!this.stream)return!1;try{let _=this.stream.available;if(_===0)return!1;if(this.ptype===-1){if(await this.stream.readBytes(this.in.data,0,1),this.ptype=this.in.data[0]&255,this.randomIn)this.ptype=this.ptype-this.randomIn.nextInt&255;this.psize=M1[this.ptype],_--}if(this.psize===-1){if(_<=0)return!1;await this.stream.readBytes(this.in.data,0,1),this.psize=this.in.data[0]&255,_--}if(this.psize===-2){if(_<=1)return!1;await this.stream.readBytes(this.in.data,0,2),this.in.pos=0,this.psize=this.in.g2(),_-=2}if(_<this.psize)return!1;if(this.in.pos=0,await this.stream.readBytes(this.in.data,0,this.psize),this.idleNetCycles=0,this.ptype2=this.ptype1,this.ptype1=this.ptype0,this.ptype0=this.ptype,this.ptype===44){if(this.lastAddress=this.in.g4(),this.daysSinceLastLogin=this.in.g2(),this.daysSinceRecoveriesChanged=this.in.g1(),this.unreadMessages=this.in.g2(),this.warnMembersInNonMembers=this.in.g1(),this.lastAddress!==0&&this.viewportInterfaceId===-1){this.closeInterfaces();let u=650;if(this.daysSinceRecoveriesChanged!==201||this.warnMembersInNonMembers==1)u=655;this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let R=0;R<s.types.length;R++)if(s.types[R]&&s.types[R].clientCode===u){this.viewportInterfaceId=s.types[R].layer;break}}return this.ptype=-1,!0}if(this.ptype===72){this.redrawSidebar=!0;let u=this.in.g2(),R=s.types[u],b=this.in.g1();if(R.invSlotObjId&&R.invSlotObjCount){for(let m=0;m<b;m++){R.invSlotObjId[m]=this.in.g2();let E=this.in.g1();if(E===255)E=this.in.g4();R.invSlotObjCount[m]=E}for(let m=b;m<R.invSlotObjId.length;m++)R.invSlotObjId[m]=0,R.invSlotObjCount[m]=0}else for(let m=0;m<b;m++)if(this.in.g2(),this.in.g1()===255)this.in.g4();return this.ptype=-1,!0}if(this.ptype===164){let u=this.in.g2(),R=this.in.g2(),b=this.in.g2(),m=d.get(R);return s.types[u].modelType=4,s.types[u].model=R,s.types[u].xan=m.xan2d,s.types[u].yan=m.yan2d,s.types[u].zoom=m.zoom2d*100/b|0,this.ptype=-1,!0}if(this.ptype===207){let u=this.in.g2(),R=this.in.g2();if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=u,this.sidebarInterfaceId=R,this.redrawSidebar=!0,this.redrawSideicons=!0,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype==192)return this.field1264=255,this.ptype=-1,!0;if(this.ptype===70){let u=this.in.g8(),R=this.in.g1(),b=c.formatName(c.fromBase37(u));for(let E=0;E<this.friendCount;E++)if(u===this.friendName37[E]){if(this.friendWorld[E]!==R){if(this.friendWorld[E]=R,this.redrawSidebar=!0,R>0)this.addMessage(5,b+" has logged in.","");if(R===0)this.addMessage(5,b+" has logged out.","")}b=null;break}if(b&&this.friendCount<100)this.friendName37[this.friendCount]=u,this.friendName[this.friendCount]=b,this.friendWorld[this.friendCount]=R,this.friendCount++,this.redrawSidebar=!0;let m=!1;while(!m){m=!0;for(let E=0;E<this.friendCount-1;E++)if(this.friendWorld[E]!==v.nodeId&&this.friendWorld[E+1]===v.nodeId||this.friendWorld[E]===0&&this.friendWorld[E+1]!==0){let O=this.friendWorld[E];this.friendWorld[E]=this.friendWorld[E+1],this.friendWorld[E+1]=O;let I=this.friendName[E];this.friendName[E]=this.friendName[E+1],this.friendName[E+1]=I;let L=this.friendName37[E];this.friendName37[E]=this.friendName37[E+1],this.friendName37[E+1]=L,this.redrawSidebar=!0,m=!1}}return this.ptype=-1,!0}if(this.ptype===17)return await this.logout(),this.ptype=-1,!1;if(this.ptype===50){let u=this.in.g1(),R=this.in.g1(),b=this.in.g1(),m=this.in.g1();return this.cameraModifierEnabled[u]=!0,this.cameraModifierJitter[u]=R,this.cameraModifierWobbleScale[u]=b,this.cameraModifierWobbleSpeed[u]=m,this.cameraModifierCycle[u]=0,this.ptype=-1,!0}if(this.ptype===22)return N0.setEnabled(),this.ptype=-1,!0;if(this.ptype===160){if(this.selectedTab===12)this.redrawSidebar=!0;return this.runweight=this.in.g2b(),this.ptype=-1,!0}if(this.ptype===94)return this.baseX=this.in.g1(),this.baseZ=this.in.g1(),this.ptype=-1,!0;if(this.ptype===78){let u=this.in.g2(),R=this.in.g2(),b=R>>10&31,m=R>>5&31,E=R&31;return s.types[u].colour=(b<<19)+(m<<11)+(E<<3),this.ptype=-1,!0}if(this.ptype===152)return this.showSocialInput=!1,this.chatbackInputOpen=!0,this.chatbackInput="",this.redrawChatback=!0,this.ptype=-1,!0;if(this.ptype===53){this.cutscene=!1;for(let u=0;u<5;u++)this.cameraModifierEnabled[u]=!1;return this.ptype=-1,!0}if(this.ptype===240){let u=this.in.g2();if(u==65535)u=-1;if(this.nextMidiSong!=u&&this.midiActive&&!v.lowMemory)this.midiSong=u,this.midiFading=!0,this.onDemand?.request(2,this.midiSong);return this.nextMidiSong=u,this.nextMusicDelay=0,this.ptype=-1,!0}if(this.ptype===173){let u=this.in.g2(),R=this.in.g2();if(this.midiActive&&!v.lowMemory)this.midiSong=u,this.midiFading=!1,this.onDemand?.request(2,this.midiSong),this.nextMusicDelay=R;return this.ptype=-1,!0}if(this.ptype==158){let u=this.in.g2b();return this.viewportOverlayInterfaceId=u,this.ptype=-1,!0}if(this.ptype===9)return this.chatPublicMode=this.in.g1(),this.chatPrivateMode=this.in.g1(),this.chatTradeMode=this.in.g1(),this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.ptype=-1,!0;if(this.ptype===209||this.ptype===29||this.ptype===69||this.ptype===198||this.ptype===137||this.ptype===39||this.ptype===234||this.ptype===155||this.ptype===125||this.ptype===232)return this.readZonePacket(this.in,this.ptype),this.ptype=-1,!0;if(this.ptype===241){let u=this.in.g2(),R=this.in.g2b(),b=this.in.g2b(),m=s.types[u];return m.x=R,m.y=b,this.ptype=-1,!0}if(this.ptype===226){let u=this.in.g2(),R=this.in.g4();if(this.varCache[u]=R,this.varps[u]!==R){if(this.varps[u]=R,this.updateVarp(u),this.redrawSidebar=!0,this.stickyChatInterfaceId!==-1)this.redrawChatback=!0}return this.ptype=-1,!0}if(this.ptype===210)return this.localPid=this.in.g2(),this.membersAccount=this.in.g1(),this.ptype=-1,!0;if(this.ptype===97)return this.inMultizone=this.in.g1(),this.ptype=-1,!0;if(this.ptype===85)return this.systemUpdateTimer=this.in.g2()*30,this.ptype=-1,!0;if(this.ptype===245){let u=this.in.g2(),R=this.in.g2();return s.types[u].modelType=1,s.types[u].model=R,this.ptype=-1,!0}if(this.ptype===151){let u=this.in.g2(),R=this.in.g1(),b=this.in.g2();if(this.waveEnabled&&!v.lowMemory&&this.waveCount<50)this.waveIds[this.waveCount]=u,this.waveLoops[this.waveCount]=R,this.waveDelay[this.waveCount]=b+b0.delays[u],this.waveCount++;return this.ptype=-1,!0}if(this.ptype===87){for(let u=0;u<this.varps.length;u++)if(this.varps[u]!==this.varCache[u])this.varps[u]=this.varCache[u],this.updateVarp(u),this.redrawSidebar=!0;return this.ptype=-1,!0}if(this.ptype===165){let u=this.in.g2(),R=this.in.g2();if(this.sceneCenterZoneX===u&&this.sceneCenterZoneZ===R&&this.sceneState!==0)return this.ptype=-1,!0;if(this.sceneCenterZoneX=u,this.sceneCenterZoneZ=R,this.sceneBaseTileX=(this.sceneCenterZoneX-6)*8,this.sceneBaseTileZ=(this.sceneCenterZoneZ-6)*8,this.withinTutorialIsland=!1,(this.sceneCenterZoneX/8==48||this.sceneCenterZoneX/8==49)&&this.sceneCenterZoneZ/8==48)this.withinTutorialIsland=!0;else if(this.sceneCenterZoneX/8==48&&this.sceneCenterZoneZ/8==148)this.withinTutorialIsland=!0;this.sceneState=1,this.sceneLoadStartTime=Date.now(),this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(4,4);let b=0;for(let K=(this.sceneCenterZoneX-6)/8|0;K<=((this.sceneCenterZoneX+6)/8|0);K++)for(let Q=(this.sceneCenterZoneZ-6)/8|0;Q<=((this.sceneCenterZoneZ+6)/8|0);Q++)b++;this.sceneMapLandData=new p(b,null),this.sceneMapLocData=new p(b,null),this.sceneMapIndex=new Int32Array(b),this.sceneMapLandFile=new Array(b),this.sceneMapLocFile=new Array(b);let m=0;for(let K=(this.sceneCenterZoneX-6)/8|0;K<=((this.sceneCenterZoneX+6)/8|0);K++)for(let Q=(this.sceneCenterZoneZ-6)/8|0;Q<=((this.sceneCenterZoneZ+6)/8|0);Q++)if(this.sceneMapIndex[m]=(K<<8)+Q,this.withinTutorialIsland&&(Q==49||Q==149||Q==147||K==50||K==49&&Q==47))this.sceneMapLandFile[m]=-1,this.sceneMapLocFile[m]=-1,m++;else if(this.onDemand){let U=this.sceneMapLandFile[m]=this.onDemand.getMapFile(K,Q,0);if(U!=-1)this.onDemand.request(3,U);let J=this.sceneMapLocFile[m]=this.onDemand.getMapFile(K,Q,1);if(J!=-1)this.onDemand.request(3,J);m++}let E=this.sceneBaseTileX-this.scenePrevBaseTileX,O=this.sceneBaseTileZ-this.scenePrevBaseTileZ;this.scenePrevBaseTileX=this.sceneBaseTileX,this.scenePrevBaseTileZ=this.sceneBaseTileZ;for(let K=0;K<8192;K++){let Q=this.npcs[K];if(Q){for(let U=0;U<10;U++)Q.routeTileX[U]-=E,Q.routeTileZ[U]-=O;Q.x-=E*128,Q.z-=O*128}}for(let K=0;K<2048;K++){let Q=this.players[K];if(Q){for(let U=0;U<10;U++)Q.routeTileX[U]-=E,Q.routeTileZ[U]-=O;Q.x-=E*128,Q.z-=O*128}}this.awaitingSync=!0;let I=0,L=104,H=1;if(E<0)I=104-1,L=-1,H=-1;let G=0,N=104,T=1;if(O<0)G=104-1,N=-1,T=-1;for(let K=I;K!==L;K+=H)for(let Q=G;Q!==N;Q+=T){let U=K+E,J=Q+O;for(let q=0;q<4;q++)if(U>=0&&J>=0&&U<104&&J<104)this.objStacks[q][K][Q]=this.objStacks[q][U][J];else this.objStacks[q][K][Q]=null}for(let K=this.locChanges.head();K;K=this.locChanges.next())if(K.x-=E,K.z-=O,K.x<0||K.z<0||K.x>=104||K.z>=104)K.unlink();if(this.flagSceneTileX!==0)this.flagSceneTileX-=E,this.flagSceneTileZ-=O;return this.cutscene=!1,this.ptype=-1,!0}if(this.ptype===214){if(this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===219){let u=this.in.g2();return s.types[u].anim=this.in.g2(),this.ptype=-1,!0}if(this.ptype===95){let u=this.in.gjstr();if(u.endsWith(":tradereq:")){let R=u.substring(0,u.indexOf(":")),b=c.toBase37(R),m=!1;for(let E=0;E<this.ignoreCount;E++)if(this.ignoreName37[E]===b){m=!0;break}if(!m&&this.overrideChat===0)this.addMessage(4,"wishes to trade with you.",R)}else if(u.endsWith(":duelreq:")){let R=u.substring(0,u.indexOf(":")),b=c.toBase37(R),m=!1;for(let E=0;E<this.ignoreCount;E++)if(this.ignoreName37[E]===b){m=!0;break}if(!m&&this.overrideChat===0)this.addMessage(8,"wishes to duel with you.",R)}else this.addMessage(0,u,"");return this.ptype=-1,!0}if(this.ptype===24){this.redrawSidebar=!0;let u=this.in.g1(),R=this.in.g4(),b=this.in.g1();this.skillExperience[u]=R,this.skillLevel[u]=b,this.skillBaseLevel[u]=1;for(let m=0;m<98;m++)if(R>=this.levelExperience[m])this.skillBaseLevel[u]=m+2;return this.ptype=-1,!0}if(this.ptype===60){let u=N0.stop();if(u)this.out.p1isaac(217),this.out.p2(u.pos),this.out.pdata(u.data,u.pos,0),u.release();return this.ptype=-1,!0}if(this.ptype===242){for(let u=0;u<this.players.length;u++){let R=this.players[u];if(!R)continue;R.primarySeqId=-1}for(let u=0;u<this.npcs.length;u++){let R=this.npcs[u];if(!R)continue;R.primarySeqId=-1}return this.ptype=-1,!0}if(this.ptype===108){let u=this.in.g2();if(this.localPlayer)s.types[u].modelType=3,s.types[u].model=(this.localPlayer.appearance[8]<<6)+(this.localPlayer.appearance[0]<<12)+(this.localPlayer.colour[0]<<24)+(this.localPlayer.colour[4]<<18)+this.localPlayer.appearance[11];return this.ptype=-1,!0}if(this.ptype===86)return this.getPlayerPos(this.in,this.psize),this.awaitingSync=!1,this.ptype=-1,!0;if(this.ptype===176){let u=this.in.g2();if(this.resetInterfaceAnimation(u),this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.sidebarInterfaceId=u,this.redrawSidebar=!0,this.redrawSideicons=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===168){if(this.flashingTab=this.in.g1(),this.flashingTab===this.selectedTab){if(this.flashingTab===3)this.selectedTab=1;else this.selectedTab=3;this.redrawSidebar=!0}return this.ptype=-1,!0}if(this.ptype===174)return this.stickyChatInterfaceId=this.in.g2b(),this.redrawChatback=!0,this.ptype=-1,!0;if(this.ptype===154){let u=this.in.g2(),R=this.in.gjstr();if(s.types[u].text=R,s.types[u].layer===this.tabInterfaceId[this.selectedTab])this.redrawSidebar=!0;return this.ptype=-1,!0}if(this.ptype===200){let u=this.in.g2(),R=this.in.g1();if(u===65535)u=-1;return this.tabInterfaceId[R]=u,this.redrawSidebar=!0,this.redrawSideicons=!0,this.ptype=-1,!0}if(this.ptype===56)return this.selectedTab=this.in.g1(),this.redrawSidebar=!0,this.redrawSideicons=!0,this.ptype=-1,!0;if(this.ptype===129){let u=this.in.g2(),R=this.in.g2();return s.types[u].modelType=2,s.types[u].model=R,this.ptype=-1,!0}if(this.ptype===222){if(this.cutscene=!0,this.cutsceneDstLocalTileX=this.in.g1(),this.cutsceneDstLocalTileZ=this.in.g1(),this.cutsceneDstHeight=this.in.g2(),this.cutsceneRotateSpeed=this.in.g1(),this.cutsceneRotateAcceleration=this.in.g1(),this.cutsceneRotateAcceleration>=100){let u=this.cutsceneDstLocalTileX*128+64,R=this.cutsceneDstLocalTileZ*128+64,b=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight,m=u-this.cameraX,E=b-this.cameraY,O=R-this.cameraZ,I=Math.sqrt(m*m+O*O)|0;if(this.cameraPitch=(Math.atan2(E,I)*325.949|0)&2047,this.cameraYaw=(Math.atan2(m,O)*-325.949|0)&2047,this.cameraPitch<128)this.cameraPitch=128;else if(this.cameraPitch>383)this.cameraPitch=383}return this.ptype=-1,!0}if(this.ptype===177){if(this.selectedTab===12)this.redrawSidebar=!0;return this.runenergy=this.in.g1(),this.ptype=-1,!0}if(this.ptype===62)return this.flagSceneTileX=0,this.ptype=-1,!0;if(this.ptype===162){let u=this.in.g2(),R=s.types[u];if(R.invSlotObjId)for(let b=0;b<R.invSlotObjId.length;b++)R.invSlotObjId[b]=-1,R.invSlotObjId[b]=0;return this.ptype=-1,!0}if(this.ptype===49){if(this.hintType=this.in.g1(),this.hintType===1)this.hintNpc=this.in.g2();if(this.hintType>=2&&this.hintType<=6){if(this.hintType===2)this.hintOffsetX=64,this.hintOffsetZ=64;else if(this.hintType===3)this.hintOffsetX=0,this.hintOffsetZ=64;else if(this.hintType===4)this.hintOffsetX=128,this.hintOffsetZ=64;else if(this.hintType===5)this.hintOffsetX=64,this.hintOffsetZ=0;else if(this.hintType===6)this.hintOffsetX=64,this.hintOffsetZ=128;this.hintType=2,this.hintTileX=this.in.g2(),this.hintTileZ=this.in.g2(),this.hintHeight=this.in.g1()}if(this.hintType===10)this.hintPlayer=this.in.g2();return this.ptype=-1,!0}if(this.ptype===10){let u=this.in.g2();if(this.resetInterfaceAnimation(u),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=u,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===189){let u=this.in.g2();if(this.resetInterfaceAnimation(u),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;return this.chatInterfaceId=u,this.redrawChatback=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===244)return this.getNpcPos(this.in,this.psize),this.ptype=-1,!0;if(this.ptype===132){this.redrawSidebar=!0;let u=this.in.g2(),R=s.types[u];while(this.in.pos<this.psize){let b=this.in.g1(),m=this.in.g2(),E=this.in.g1();if(E===255)E=this.in.g4();if(R.invSlotObjId&&R.invSlotObjCount&&b>=0&&b<R.invSlotObjId.length)R.invSlotObjId[b]=m,R.invSlotObjCount[b]=E}return this.ptype=-1,!0}if(this.ptype===12){if(this.cutscene=!0,this.cutsceneSrcLocalTileX=this.in.g1(),this.cutsceneSrcLocalTileZ=this.in.g1(),this.cutsceneSrcHeight=this.in.g2(),this.cutsceneMoveSpeed=this.in.g1(),this.cutsceneMoveAcceleration=this.in.g1(),this.cutsceneMoveAcceleration>=100)this.cameraX=this.cutsceneSrcLocalTileX*128+64,this.cameraZ=this.cutsceneSrcLocalTileZ*128+64,this.cameraY=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;return this.ptype=-1,!0}if(this.ptype===233){this.baseX=this.in.g1(),this.baseZ=this.in.g1();while(this.in.pos<this.psize){let u=this.in.g1();this.readZonePacket(this.in,u)}return this.ptype=-1,!0}if(this.ptype===131){this.baseX=this.in.g1(),this.baseZ=this.in.g1();for(let u=this.baseX;u<this.baseX+8;u++)for(let R=this.baseZ;R<this.baseZ+8;R++)if(this.objStacks[this.currentLevel][u][R])this.objStacks[this.currentLevel][u][R]=null,this.sortObjStacks(u,R);for(let u=this.locChanges.head();u;u=this.locChanges.next())if(u.x>=this.baseX&&u.x<this.baseX+8&&u.z>=this.baseZ&&u.z<this.baseZ+8&&u.level===this.currentLevel)u.endTime=0;return this.ptype=-1,!0}if(this.ptype===30){let u=this.in.g8(),R=this.in.g4(),b=this.in.g1(),m=!1;for(let E=0;E<100;E++)if(this.messageTextIds[E]===R){m=!0;break}if(b<=1){for(let E=0;E<this.ignoreCount;E++)if(this.ignoreName37[E]===u){m=!0;break}}if(!m&&this.overrideChat===0)try{this.messageTextIds[this.privateMessageCount]=R,this.privateMessageCount=(this.privateMessageCount+1)%100;let E=P0.unpack(this.in,this.psize-13),O=W0.filter(E);if(b===2||b===3)this.addMessage(7,O,"@cr2@"+c.formatName(c.fromBase37(u)));else if(b===1)this.addMessage(7,O,"@cr1@"+c.formatName(c.fromBase37(u)));else this.addMessage(3,O,c.formatName(c.fromBase37(u)))}catch(E){}return this.ptype=-1,!0}if(this.ptype===123){let u=this.in.g2(),R=this.in.g1()===1;return s.types[u].hide=R,this.ptype=-1,!0}if(this.ptype===236){let u=this.in.g2(),R=this.in.g1b();if(this.varCache[u]=R,this.varps[u]!==R){if(this.varps[u]=R,this.updateVarp(u),this.redrawSidebar=!0,this.stickyChatInterfaceId!==-1)this.redrawChatback=!0}return this.ptype=-1,!0}if(this.ptype===7){this.ignoreCount=this.psize/8|0;for(let u=0;u<this.ignoreCount;u++)this.ignoreName37[u]=this.in.g8();return this.ptype=-1,!0}await this.logout()}catch(_){let u=`T1 - ${this.ptype},${this.psize} - ${this.ptype1},${this.ptype2} - ${this.psize},${(this.localPlayer?.routeTileX[0]??0)+this.sceneBaseTileX},${(this.localPlayer?.routeTileZ[0]??0)+this.sceneBaseTileZ} -`;for(let R=0;R<this.psize&&R<50;R++)u+=this.in.data[R]+",";await this.logout()}return!0}readZonePacket(_,u){let R=_.g1(),b=this.baseX+(R>>4&7),m=this.baseZ+(R&7);if(u===232){let E=_.g1(),O=E>>2,I=E&3,L=g.of(O).layer,H=_.g2();if(b>=0&&m>=0&&b<104&&m<104)this.appendLoc(-1,H,I,L,m,O,this.currentLevel,b,0)}else if(u===125){let E=_.g1(),O=E>>2,I=E&3,L=g.of(O).layer;if(b>=0&&m>=0&&b<104&&m<104)this.appendLoc(-1,-1,I,L,m,O,this.currentLevel,b,0)}else if(u===155){let E=_.g1(),O=E>>2,I=E&3,L=g.of(O).layer,H=_.g2();if(b>=0&&m>=0&&b<104&&m<104&&this.scene&&this.levelHeightmap){let G=this.levelHeightmap[this.currentLevel][b][m],N=this.levelHeightmap[this.currentLevel][b+1][m],T=this.levelHeightmap[this.currentLevel][b+1][m+1],K=this.levelHeightmap[this.currentLevel][b][m+1];if(L==0){let Q=this.scene.getWall(b,m,this.currentLevel);if(Q){let U=Q.typecode>>14&32767;if(O==2)Q.model1=new e(this.loopCycle,U,2,I+4,G,N,T,K,H,!1),Q.model2=new e(this.loopCycle,U,2,I+1&3,G,N,T,K,H,!1);else Q.model1=new e(this.loopCycle,U,O,I,G,N,T,K,H,!1)}}else if(L==1){let Q=this.scene.getDecor(b,this.currentLevel,m);if(Q)Q.model=new e(this.loopCycle,Q.typecode>>14&32767,4,0,G,T,T,K,H,!1)}else if(L==2){let Q=this.scene.getLoc(this.currentLevel,m,b);if(O==11)O=10;if(Q)Q.model=new e(this.loopCycle,Q.typecode>>14&32767,O,I,G,N,T,K,H,!1)}else if(L==3){let Q=this.scene.getGroundDecor(b,m,this.currentLevel);if(Q)Q.model=new e(this.loopCycle,Q.typecode>>14&32767,22,I,G,N,T,K,H,!1)}}}else if(u===234){let E=_.g2(),O=_.g2();if(b>=0&&m>=0&&b<104&&m<104){let I=new y0(E,O);if(!this.objStacks[this.currentLevel][b][m])this.objStacks[this.currentLevel][b][m]=new $0;this.objStacks[this.currentLevel][b][m]?.push(I),this.sortObjStacks(b,m)}}else if(u===39){let E=_.g2();if(b>=0&&m>=0&&b<104&&m<104){let O=this.objStacks[this.currentLevel][b][m];if(O){for(let I=O.head();I;I=O.next())if(I.index===(E&32767)){I.unlink();break}if(!O.head())this.objStacks[this.currentLevel][b][m]=null;this.sortObjStacks(b,m)}}}else if(u===137){let E=b+_.g1b(),O=m+_.g1b(),I=_.g2b(),L=_.g2(),H=_.g1(),G=_.g1(),N=_.g2(),T=_.g2(),K=_.g1(),Q=_.g1();if(b>=0&&m>=0&&b<104&&m<104&&E>=0&&O>=0&&E<104&&O<104){b=b*128+64,m=m*128+64,E=E*128+64,O=O*128+64;let U=new G1(L,this.currentLevel,b,this.getHeightmapY(this.currentLevel,b,m)-H,m,N+this.loopCycle,T+this.loopCycle,K,Q,I,G);U.updateVelocity(E,this.getHeightmapY(this.currentLevel,E,O)-G,O,N+this.loopCycle),this.projectiles.push(U)}}else if(u===198){let E=_.g2(),O=_.g1(),I=_.g2();if(b>=0&&m>=0&&b<104&&m<104){b=b*128+64,m=m*128+64;let L=new N1(E,this.currentLevel,b,m,this.getHeightmapY(this.currentLevel,b,m)-O,this.loopCycle,I);this.spotanims.push(L)}}else if(u===69){let E=_.g2(),O=_.g2(),I=_.g2();if(b>=0&&m>=0&&b<104&&m<104&&I!==this.localPid){let L=new y0(E,O);if(!this.objStacks[this.currentLevel][b][m])this.objStacks[this.currentLevel][b][m]=new $0;this.objStacks[this.currentLevel][b][m]?.push(L),this.sortObjStacks(b,m)}}else if(u===29){let E=_.g1(),O=E>>2,I=E&3,L=g.of(O).layer,H=_.g2(),G=_.g2(),N=_.g2(),T=_.g2(),K=_.g1b(),Q=_.g1b(),U=_.g1b(),J=_.g1b(),q;if(T===this.localPid)q=this.localPlayer;else q=this.players[T];if(q&&this.levelHeightmap){let w=u0.get(H),V=this.levelHeightmap[this.currentLevel][b][m],Y=this.levelHeightmap[this.currentLevel][b+1][m],n=this.levelHeightmap[this.currentLevel][b+1][m+1],f=this.levelHeightmap[this.currentLevel][b][m+1],Z=w.getModel(O,I,V,Y,n,f,-1);if(Z){this.appendLoc(G+this.loopCycle,-1,I,L,m,O,this.currentLevel,b,N+this.loopCycle),q.locStartCycle=G+this.loopCycle,q.locStopCycle=N+this.loopCycle,q.locModel=Z;let{width:h,length:D}=w;if(I===1||I===3)h=w.length,D=w.width;q.locOffsetX=b*128+h*64,q.locOffsetZ=m*128+D*64,q.locOffsetY=this.getHeightmapY(this.currentLevel,q.locOffsetX,q.locOffsetZ);let j;if(K>U)j=K,K=U,U=j;if(Q>J)j=Q,Q=J,J=j;q.minTileX=b+K,q.maxTileX=b+U,q.minTileZ=m+Q,q.maxTileZ=m+J}}}else if(u===209){let E=_.g2(),O=_.g2(),I=_.g2();if(b>=0&&m>=0&&b<104&&m<104){let L=this.objStacks[this.currentLevel][b][m];if(L){for(let H=L.head();H;H=L.next())if(H.index===(E&32767)&&H.count===O){H.count=I;break}this.sortObjStacks(b,m)}}}}appendLoc(_,u,R,b,m,E,O,I,L){let H=null;for(let G=this.locChanges.head();G;G=this.locChanges.next())if(G.level===this.currentLevel&&G.x===I&&G.z===m&&G.layer===b){H=G;break}if(!H)H=new H1,H.level=O,H.layer=b,H.x=I,H.z=m,this.storeLoc(H),this.locChanges.push(H);H.newType=u,H.newShape=E,H.newAngle=R,H.startTime=L,H.endTime=_}storeLoc(_){if(!this.scene)return;let u=0,R=-1,b=0,m=0;if(_.layer===0)u=this.scene.getWallTypecode(_.level,_.x,_.z);else if(_.layer===1)u=this.scene.getDecorTypecode(_.level,_.z,_.x);else if(_.layer===2)u=this.scene.getLocTypecode(_.level,_.x,_.z);else if(_.layer===3)u=this.scene.getGroundDecorTypecode(_.level,_.x,_.z);if(u!==0){let E=this.scene.getInfo(_.level,_.x,_.z,u);R=u>>14&32767,b=E&31,m=E>>6}_.oldType=R,_.oldShape=b,_.oldAngle=m}addLoc(_,u,R,b,m,E,O){if(u<1||R<1||u>102||R>102)return;if(v.lowMemory&&_!==this.currentLevel)return;if(!this.scene)return;let I=0;if(O===0)I=this.scene.getWallTypecode(_,u,R);else if(O===1)I=this.scene.getDecorTypecode(_,R,u);else if(O===2)I=this.scene.getLocTypecode(_,u,R);else if(O===3)I=this.scene.getGroundDecorTypecode(_,u,R);if(I!==0){let L=this.scene.getInfo(_,u,R,I),H=I>>14&32767,G=L&31,N=L>>6;if(O===0){this.scene?.removeWall(_,u,R,1);let T=u0.get(H);if(T.blockwalk)this.levelCollisionMap[_]?.removeWall(u,R,G,N,T.blockrange)}else if(O===1)this.scene?.removeWallDecoration(_,u,R);else if(O===2){this.scene.removeLoc(_,u,R);let T=u0.get(H);if(u+T.width>104-1||R+T.width>104-1||u+T.length>104-1||R+T.length>104-1)return;if(T.blockwalk)this.levelCollisionMap[_]?.removeLoc(u,R,T.width,T.length,N,T.blockrange)}else if(O===3){this.scene?.removeGroundDecoration(_,u,R);let T=u0.get(H);if(T.blockwalk&&T.active)this.levelCollisionMap[_]?.removeFloor(u,R)}}if(b>=0){let L=_;if(this.levelTileFlags&&_<3&&(this.levelTileFlags[1][u][R]&2)===2)L=_+1;if(this.levelHeightmap)i.addLoc(this.loopCycle,_,u,R,this.scene,this.levelHeightmap,this.levelCollisionMap[_],b,E,m,L)}}sortObjStacks(_,u){let R=this.objStacks[this.currentLevel][_][u];if(!R){this.scene?.removeGroundObject(this.currentLevel,_,u);return}let b=-99999999,m=null;for(let L=R.head();L;L=R.next()){let H=d.get(L.index),G=H.cost;if(H.stackable)G*=L.count+1;if(G>b)b=G,m=L}if(!m)return;R.addHead(m);let E=null,O=null;for(let L=R.head();L;L=R.next()){if(L.index!==m.index&&E===null)E=L;if(L.index!==m.index&&E&&L.index!==E.index&&O===null)O=L}let I=_+(u<<7)+1610612736|0;this.scene?.addGroundObject(_,u,this.getHeightmapY(this.currentLevel,_*128+64,u*128+64),this.currentLevel,I,m,O,E)}getPlayerPos(_,u){this.entityRemovalCount=0,this.entityUpdateCount=0,this.getPlayerLocal(_),this.getPlayerOldVis(_),this.getPlayerNewVis(_,u),this.getPlayerExtended(_);for(let R=0;R<this.entityRemovalCount;R++){let b=this.entityRemovalIds[R],m=this.players[b];if(!m)continue;if(m.cycle!==this.loopCycle)this.players[b]=null}if(_.pos!==u)throw new Error("eek");for(let R=0;R<this.playerCount;R++)if(!this.players[this.playerIds[R]])throw new Error("eek")}getPlayerLocal(_){if(_.bits(),_.gBit(1)!==0){let R=_.gBit(2);if(R===0)this.entityUpdateIds[this.entityUpdateCount++]=2047;else if(R===1){let b=_.gBit(3);if(this.localPlayer?.step(!1,b),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}else if(R===2){let b=_.gBit(3);this.localPlayer?.step(!0,b);let m=_.gBit(3);if(this.localPlayer?.step(!0,m),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}else if(R===3){this.currentLevel=_.gBit(2);let b=_.gBit(7),m=_.gBit(7),E=_.gBit(1);if(this.localPlayer?.move(E===1,b,m),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}}}getPlayerOldVis(_){let u=_.gBit(8);if(u<this.playerCount)for(let R=u;R<this.playerCount;R++)this.entityRemovalIds[this.entityRemovalCount++]=this.playerIds[R];if(u>this.playerCount)throw new Error;this.playerCount=0;for(let R=0;R<u;R++){let b=this.playerIds[R],m=this.players[b];if(_.gBit(1)===0){if(this.playerIds[this.playerCount++]=b,m)m.cycle=this.loopCycle}else{let O=_.gBit(2);if(O===0){if(this.playerIds[this.playerCount++]=b,m)m.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=b}else if(O===1){if(this.playerIds[this.playerCount++]=b,m)m.cycle=this.loopCycle;let I=_.gBit(3);if(m?.step(!1,I),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=b}else if(O===2){if(this.playerIds[this.playerCount++]=b,m)m.cycle=this.loopCycle;let I=_.gBit(3);m?.step(!0,I);let L=_.gBit(3);if(m?.step(!0,L),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=b}else if(O===3)this.entityRemovalIds[this.entityRemovalCount++]=b}}}getPlayerNewVis(_,u){while(_.bitPos+10<u*8){let R=_.gBit(11);if(R===2047)break;if(!this.players[R]){this.players[R]=new T0;let L=this.playerAppearanceBuffer[R];if(L)this.players[R]?.read(L)}this.playerIds[this.playerCount++]=R;let b=this.players[R];if(b)b.cycle=this.loopCycle;let m=_.gBit(5);if(m>15)m-=32;let E=_.gBit(5);if(E>15)E-=32;let O=_.gBit(1);if(this.localPlayer)b?.move(O===1,this.localPlayer.routeTileX[0]+m,this.localPlayer.routeTileZ[0]+E);if(_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=R}_.bytes()}getPlayerExtended(_){for(let u=0;u<this.entityUpdateCount;u++){let R=this.entityUpdateIds[u],b=this.players[R];if(!b)continue;let m=_.g1();if((m&128)!==0)m+=_.g1()<<8;this.getPlayerExtendedInfo(b,R,m,_)}}getPlayerExtendedInfo(_,u,R,b){if((R&1)!==0){let m=b.g1(),E=new Uint8Array(m),O=new z(E);b.gdata(m,0,E),this.playerAppearanceBuffer[u]=O,_.read(O)}if((R&2)!==0){let m=b.g2();if(m===65535)m=-1;if(m===_.primarySeqId)_.primarySeqLoop=0;let E=b.g1();if(_.primarySeqId===m&&m!==-1){let O=l.types[m].restart_mode;if(O==1)_.primarySeqFrame=0,_.primarySeqCycle=0,_.primarySeqDelay=E,_.primarySeqLoop=0;else if(O==2)_.primarySeqLoop=0}else if(m===-1||_.primarySeqId===-1||l.types[m].priority>l.types[_.primarySeqId].priority||l.types[_.primarySeqId].priority===0)_.primarySeqId=m,_.primarySeqFrame=0,_.primarySeqCycle=0,_.primarySeqDelay=E,_.primarySeqLoop=0,_.preanimRouteLength=_.routeLength}if((R&4)!==0){if(_.targetId=b.g2(),_.targetId===65535)_.targetId=-1}if((R&8)!==0){if(_.chatMessage=b.gjstr(),_.chatColour=0,_.chatEffect=0,_.chatTimer=150,_.name)this.addMessage(2,_.chatMessage,_.name)}if((R&16)!==0){let m=b.g1(),E=b.g1();_.hit(this.loopCycle,E,m),_.combatCycle=this.loopCycle+400,_.health=b.g1(),_.totalHealth=b.g1()}if((R&32)!==0)_.targetTileX=b.g2(),_.targetTileZ=b.g2();if((R&64)!==0){let m=b.g2(),E=b.g1(),O=b.g1(),I=b.pos;if(_.name&&_.visible){let L=c.toBase37(_.name),H=!1;if(E<=1){for(let G=0;G<this.ignoreCount;G++)if(this.ignoreName37[G]===L){H=!0;break}}if(!H&&this.overrideChat===0)try{let G=P0.unpack(b,O),N=W0.filter(G);if(_.chatMessage=N,_.chatColour=m>>8,_.chatEffect=m&255,_.chatTimer=150,E===2||E===3)this.addMessage(1,N,"@cr2@"+_.name);else if(E===1)this.addMessage(1,N,"@cr1@"+_.name);else this.addMessage(2,N,_.name)}catch(G){}}b.pos=I+O}if((R&256)!==0){_.spotanimId=b.g2();let m=b.g4();if(_.spotanimHeight=m>>16,_.spotanimLastCycle=this.loopCycle+(m&65535),_.spotanimFrame=0,_.spotanimCycle=0,_.spotanimLastCycle>this.loopCycle)_.spotanimFrame=-1;if(_.spotanimId===65535)_.spotanimId=-1}if((R&512)!==0)_.forceMoveStartSceneTileX=b.g1(),_.forceMoveStartSceneTileZ=b.g1(),_.forceMoveEndSceneTileX=b.g1(),_.forceMoveEndSceneTileZ=b.g1(),_.forceMoveEndCycle=b.g2()+this.loopCycle,_.forceMoveStartCycle=b.g2()+this.loopCycle,_.forceMoveFaceDirection=b.g1(),_.clearRoute();if((R&1024)!==0){let m=b.g1(),E=b.g1();_.hit(this.loopCycle,E,m),_.combatCycle=this.loopCycle+400,_.health=b.g1(),_.totalHealth=b.g1()}}getNpcPos(_,u){this.entityRemovalCount=0,this.entityUpdateCount=0,this.getNpcPosOldVis(_),this.getNpcPosNewVis(_,u),this.getNpcPosExtended(_);for(let R=0;R<this.entityRemovalCount;R++){let b=this.entityRemovalIds[R],m=this.npcs[b];if(!m)continue;if(m.cycle!==this.loopCycle)m.type=null,this.npcs[b]=null}if(_.pos!==u)throw new Error("eek");for(let R=0;R<this.npcCount;R++)if(!this.npcs[this.npcIds[R]])throw new Error("eek")}getNpcPosOldVis(_){_.bits();let u=_.gBit(8);if(u<this.npcCount)for(let R=u;R<this.npcCount;R++)this.entityRemovalIds[this.entityRemovalCount++]=this.npcIds[R];if(u>this.npcCount)throw new Error("eek");this.npcCount=0;for(let R=0;R<u;R++){let b=this.npcIds[R],m=this.npcs[b];if(_.gBit(1)===0){if(this.npcIds[this.npcCount++]=b,m)m.cycle=this.loopCycle}else{let O=_.gBit(2);if(O===0){if(this.npcIds[this.npcCount++]=b,m)m.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=b}else if(O===1){if(this.npcIds[this.npcCount++]=b,m)m.cycle=this.loopCycle;let I=_.gBit(3);if(m?.step(!1,I),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=b}else if(O===2){if(this.npcIds[this.npcCount++]=b,m)m.cycle=this.loopCycle;let I=_.gBit(3);m?.step(!0,I);let L=_.gBit(3);if(m?.step(!0,L),_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=b}else if(O===3)this.entityRemovalIds[this.entityRemovalCount++]=b}}}getNpcPosNewVis(_,u){while(_.bitPos+21<u*8){let R=_.gBit(13);if(R===8191)break;if(!this.npcs[R])this.npcs[R]=new L1;let b=this.npcs[R];if(this.npcIds[this.npcCount++]=R,b)b.cycle=this.loopCycle,b.type=j0.get(_.gBit(11)),b.size=b.type.size,b.walkanim=b.type.walkanim,b.walkanim_b=b.type.walkanim_b,b.walkanim_l=b.type.walkanim_r,b.walkanim_r=b.type.walkanim_l,b.readyanim=b.type.readyanim;else _.gBit(11);let m=_.gBit(5);if(m>15)m-=32;let E=_.gBit(5);if(E>15)E-=32;if(this.localPlayer)b?.move(!1,this.localPlayer.routeTileX[0]+m,this.localPlayer.routeTileZ[0]+E);if(_.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=R}_.bytes()}getNpcPosExtended(_){for(let u=0;u<this.entityUpdateCount;u++){let R=this.entityUpdateIds[u],b=this.npcs[R];if(!b)continue;let m=_.g1();if((m&1)!==0){let E=_.g1(),O=_.g1();b.hit(this.loopCycle,O,E),b.combatCycle=this.loopCycle+400,b.health=_.g1(),b.totalHealth=_.g1()}if((m&2)!==0){let E=_.g2();if(E===65535)E=-1;if(E===b.primarySeqId)b.primarySeqLoop=0;let O=_.g1();if(b.primarySeqId===E&&E!==-1){let I=l.types[E].restart_mode;if(I==1)b.primarySeqFrame=0,b.primarySeqCycle=0,b.primarySeqDelay=O,b.primarySeqLoop=0;else if(I==2)b.primarySeqLoop=0}else if(E===-1||b.primarySeqId===-1||l.types[E].priority>l.types[b.primarySeqId].priority||l.types[b.primarySeqId].priority===0)b.primarySeqId=E,b.primarySeqFrame=0,b.primarySeqCycle=0,b.primarySeqDelay=O,b.primarySeqLoop=0,b.preanimRouteLength=b.routeLength}if((m&4)!==0){if(b.targetId=_.g2(),b.targetId===65535)b.targetId=-1}if((m&8)!==0)b.chatMessage=_.gjstr(),b.chatTimer=100;if((m&16)!==0){let E=_.g1(),O=_.g1();b.hit(this.loopCycle,O,E),b.combatCycle=this.loopCycle+400,b.health=_.g1(),b.totalHealth=_.g1()}if((m&32)!==0)b.type=j0.get(_.g2()),b.walkanim=b.type.walkanim,b.walkanim_b=b.type.walkanim_b,b.walkanim_l=b.type.walkanim_r,b.walkanim_r=b.type.walkanim_l,b.readyanim=b.type.readyanim;if((m&64)!==0){b.spotanimId=_.g2();let E=_.g4();if(b.spotanimHeight=E>>16,b.spotanimLastCycle=this.loopCycle+(E&65535),b.spotanimFrame=0,b.spotanimCycle=0,b.spotanimLastCycle>this.loopCycle)b.spotanimFrame=-1;if(b.spotanimId===65535)b.spotanimId=-1}if((m&128)!==0)b.targetTileX=_.g2(),b.targetTileZ=_.g2()}}showContextMenu(){let _=0;if(this.fontBold12){_=this.fontBold12.stringWidth("Choose Option");let m;for(let E=0;E<this.menuSize;E++)if(m=this.fontBold12.stringWidth(this.menuOption[E]),m>_)_=m}_+=8;let u=this.menuSize*15+21,R,b;if(this.mouseClickX>4&&this.mouseClickY>4&&this.mouseClickX<516&&this.mouseClickY<338){if(R=this.mouseClickX-(_/2|0)-8,R+_>512)R=512-_;if(R<0)R=0;if(b=this.mouseClickY-11,b+u>334)b=334-u;if(b<0)b=0;this.menuVisible=!0,this.menuArea=0,this.menuX=R,this.menuY=b,this.menuWidth=_,this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>553&&this.mouseClickY>205&&this.mouseClickX<743&&this.mouseClickY<466){if(R=this.mouseClickX-(_/2|0)-553,R<0)R=0;else if(R+_>190)R=190-_;if(b=this.mouseClickY-205,b<0)b=0;else if(b+u>261)b=261-u;this.menuVisible=!0,this.menuArea=1,this.menuX=R,this.menuY=b,this.menuWidth=_,this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>17&&this.mouseClickY>357&&this.mouseClickX<496&&this.mouseClickY<453){if(R=this.mouseClickX-(_/2|0)-17,R<0)R=0;else if(R+_>479)R=479-_;if(b=this.mouseClickY-357,b<0)b=0;else if(b+u>96)b=96-u;this.menuVisible=!0,this.menuArea=2,this.menuX=R,this.menuY=b,this.menuWidth=_,this.menuHeight=this.menuSize*15+22}}isAddFriendOption(_){if(_<0)return!1;let u=this.menuAction[_];if(u>=2000)u-=2000;return u===406}useMenuOption(_){if(_<0)return;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;let u=this.menuAction[_],R=this.menuParamA[_],b=this.menuParamB[_],m=this.menuParamC[_];if(u>=2000)u-=2000;if(u===1501){if(v.oplogic6+=this.sceneBaseTileZ,v.oplogic6>=92)this.out.p1isaac(177),this.out.p4(0);this.interactWithLoc(243,b,m,R)}else if(u===34){let E=this.menuOption[_],O=E.indexOf("@whi@");if(O!==-1){this.closeInterfaces(),this.reportAbuseInput=E.substring(O+5).trim(),this.reportAbuseMuteOption=!1;for(let I=0;I<s.types.length;I++)if(s.types[I]&&s.types[I].clientCode===600){this.reportAbuseInterfaceId=this.viewportInterfaceId=s.types[I].layer;break}}}else if(u===367){let E=this.players[R];if(E&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(48),this.out.p2(R),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(u===951){let E=s.types[m],O=!0;if(E.clientCode>0)O=this.handleInterfaceAction(E);if(O)this.out.p1isaac(39),this.out.p2(m)}else if(u===217){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],b,m,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],b,m,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(111),this.out.p2(b+this.sceneBaseTileX),this.out.p2(m+this.sceneBaseTileZ),this.out.p2(R),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}}else if(u===450){if(this.interactWithLoc(106,b,m,R))this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(u===265){let E=this.npcs[R];if(E&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(101),this.out.p2(R),this.out.p2(this.activeSpellId)}else if(u===364)this.interactWithLoc(19,b,m,R);else if(u===55){if(this.interactWithLoc(182,b,m,R))this.out.p2(this.activeSpellId)}else if(u===224||u===993||u===99||u===746||u===877){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],b,m,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],b,m,2,1,1,0,0,0,!1);if(this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,u===99)this.out.p1isaac(27);else if(u===993)this.out.p1isaac(110);else if(u===224)this.out.p1isaac(231);else if(u===877)this.out.p1isaac(225);else if(u===746)this.out.p1isaac(17);this.out.p2(b+this.sceneBaseTileX),this.out.p2(m+this.sceneBaseTileZ),this.out.p2(R)}}else if(u===581){if((R&3)===0)v.oplogic1++;if(v.oplogic1>=99)this.out.p1isaac(47),this.out.p4(0);this.interactWithLoc(55,b,m,R)}else if(u===679){let E=this.menuOption[_],O=E.indexOf("@whi@");if(O!==-1){let I=c.toBase37(E.substring(O+5).trim()),L=-1;for(let H=0;H<this.friendCount;H++)if(this.friendName37[H]===I){L=H;break}if(L!==-1&&this.friendWorld[L]>0)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=3,this.socialName37=this.friendName37[L],this.socialMessage="Enter message to send to "+this.friendName[L]}}else if(u===960){this.out.p1isaac(39),this.out.p2(m);let E=s.types[m];if(E.scripts&&E.scripts[0]&&E.scripts[0][0]===5){let O=E.scripts[0][1];if(E.scriptOperand&&this.varps[O]!==E.scriptOperand[0])this.varps[O]=E.scriptOperand[0],this.updateVarp(O),this.redrawSidebar=!0}}else if(u===1175){let E=R>>14&32767,O=u0.get(E),I;if(!O.desc)I="It's a "+O.name+".";else I=O.desc;this.addMessage(0,I,"")}else if(u===881){if(this.out.p1isaac(58),this.out.p2(R),this.out.p2(b),this.out.p2(m),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface),this.selectedCycle=0,this.selectedInterface=m,this.selectedItem=b,this.selectedArea=2,s.types[m].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.types[m].layer===this.chatInterfaceId)this.selectedArea=3}else if(u===44){if(!this.pressedContinueOption)this.out.p1isaac(11),this.out.p2(m),this.pressedContinueOption=!0}else if(u===285)this.interactWithLoc(238,b,m,R);else if(u===406||u===436||u===557||u===556){let E=this.menuOption[_],O=E.indexOf("@whi@");if(O!==-1){let I=c.toBase37(E.substring(O+5).trim());if(u===406)this.addFriend(I);else if(u===436)this.addIgnore(I);else if(u===557)this.removeFriend(I);else if(u===556)this.removeIgnore(I)}}else if(u===947)this.closeInterfaces();else if(u===405||u===38||u===422||u===478||u===347){if(u===347)this.out.p1isaac(133);else if(u===422)this.out.p1isaac(221);else if(u===478){if((b&3)===0)v.oplogic5++;if(v.oplogic5>=90)this.out.p1isaac(7);this.out.p1isaac(6)}else if(u===405){if(v.oplogic3+=R,v.oplogic3>=97)this.out.p1isaac(37),this.out.p3(14953816);this.out.p1isaac(228)}else if(u===38)this.out.p1isaac(166);if(this.out.p2(R),this.out.p2(b),this.out.p2(m),this.selectedCycle=0,this.selectedInterface=m,this.selectedItem=b,this.selectedArea=2,s.types[m].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.types[m].layer===this.chatInterfaceId)this.selectedArea=3}else if(u===965){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],b,m,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],b,m,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(25),this.out.p2(b+this.sceneBaseTileX),this.out.p2(m+this.sceneBaseTileZ),this.out.p2(R),this.out.p2(this.activeSpellId)}}else if(u===602||u===596||u===22||u===892||u===415){if(u===415){if((m&3)===0)v.oplogic7++;if(v.oplogic7>=55)this.out.p1isaac(50),this.out.p4(0);this.out.p1isaac(212)}else if(u===22)this.out.p1isaac(158);else if(u===596)this.out.p1isaac(193);else if(u===892){if((b&3)===0)v.oplogic9++;if(v.oplogic9>=130)this.out.p1isaac(169),this.out.p1(177);this.out.p1isaac(204)}else if(u===602)this.out.p1isaac(153);if(this.out.p2(R),this.out.p2(b),this.out.p2(m),this.selectedCycle=0,this.selectedInterface=m,this.selectedItem=b,this.selectedArea=2,s.types[m].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.types[m].layer===this.chatInterfaceId)this.selectedArea=3}else if(u===465){this.out.p1isaac(39),this.out.p2(m);let E=s.types[m];if(E.scripts&&E.scripts[0]&&E.scripts[0][0]===5){let O=E.scripts[0][1];this.varps[O]=1-this.varps[O],this.updateVarp(O),this.redrawSidebar=!0}}else if(u===900){let E=this.npcs[R];if(E&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(52),this.out.p2(R),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(u===188){this.objSelected=1,this.objSelectedSlot=b,this.objSelectedInterface=m,this.objInterface=R,this.objSelectedName=d.get(R).name,this.spellSelected=0,this.redrawSidebar=!0;return}else if(u===728||u===542||u===6||u===963||u===245){let E=this.npcs[R];if(E&&this.localPlayer){if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,u===963)this.out.p1isaac(229);else if(u===6){if((R&3)===0)v.oplogic2++;if(v.oplogic2>=124)this.out.p1isaac(218),this.out.p4(0);this.out.p1isaac(132)}else if(u===245){if((R&3)===0)v.oplogic4++;if(v.oplogic4>=85)this.out.p1isaac(34),this.out.p2(39596);this.out.p1isaac(102)}else if(u===728)this.out.p1isaac(222);else if(u===542)this.out.p1isaac(84);this.out.p2(R)}}else if(u===391){if(this.out.p1isaac(143),this.out.p2(R),this.out.p2(b),this.out.p2(m),this.out.p2(this.activeSpellId),this.selectedCycle=0,this.selectedInterface=m,this.selectedItem=b,this.selectedArea=2,s.types[m].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.types[m].layer===this.chatInterfaceId)this.selectedArea=3}else if(u===930){let E=s.types[m];this.spellSelected=1,this.activeSpellId=m,this.activeSpellFlags=E.targetMask,this.objSelected=0,this.redrawSidebar=!0;let O=E.targetVerb;if(O&&O.indexOf(" ")!==-1)O=O.substring(0,O.indexOf(" "));let I=E.targetVerb;if(I&&I.indexOf(" ")!==-1)I=I.substring(I.indexOf(" ")+1);if(this.spellCaption=O+" "+E.targetText+" "+I,this.activeSpellFlags===16)this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;return}else if(u===660)if(this.menuVisible)this.scene?.click(b-8,m-11);else this.scene?.click(this.mouseClickX-8,this.mouseClickY-11);else if(u===903||u===363){let E=this.menuOption[_],O=E.indexOf("@whi@");if(O!==-1){E=E.substring(O+5).trim();let I=c.formatName(c.fromBase37(c.toBase37(E))),L=!1;for(let H=0;H<this.playerCount;H++){let G=this.players[this.playerIds[H]];if(G&&G.name&&G.name.toLowerCase()===I.toLowerCase()&&this.localPlayer){if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],G.routeTileX[0],G.routeTileZ[0],2,1,1,0,0,0,!1),u===903)this.out.p1isaac(43);else if(u===363)this.out.p1isaac(211);this.out.p2(this.playerIds[H]),L=!0;break}}if(!L)this.addMessage(0,"Unable to find "+I,"")}}else if(u===1607){let E=this.npcs[R];if(E&&E.type){let O;if(!E.type.desc)O="It's a "+E.type.name+".";else O=E.type.desc;this.addMessage(0,O,"")}}else if(u===651){let E=this.players[R];if(E&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(73),this.out.p2(R),this.out.p2(this.activeSpellId)}else if(u===1102){let E=d.get(R),O;if(!E.desc)O="It's a "+E.name+".";else O=E.desc;this.addMessage(0,O,"")}else if(u===1373||u===1544||u===151||u===1101){let E=this.players[R];if(E&&this.localPlayer){if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,u===1544)this.out.p1isaac(64);else if(u===1373)this.out.p1isaac(43);else if(u===151){if(v.oplogic8++,v.oplogic8>=90)this.out.p1isaac(100),this.out.p2(31114);this.out.p1isaac(219)}else if(u===1101)this.out.p1isaac(211);this.out.p2(R)}}else if(u===504)this.interactWithLoc(38,b,m,R);else if(u===1773){let E=d.get(R),O;if(m>=1e5)O=m+" x "+E.name;else if(!E.desc)O="It's a "+E.name+".";else O=E.desc;this.addMessage(0,O,"")}this.objSelected=0,this.spellSelected=0,this.redrawSidebar=!0}addNpcOptions(_,u,R,b){if(this.menuSize>=400)return;let m=_.name;if(_.vislevel!==0&&this.localPlayer)m=m+this.getCombatLevelTag(this.localPlayer.combatLevel,_.vislevel)+" (level-"+_.vislevel+")";if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @yel@"+m,this.menuAction[this.menuSize]=900,this.menuParamA[this.menuSize]=u,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++;else if(this.spellSelected!==1){let E;if(_.op){for(E=4;E>=0;E--)if(_.op[E]&&_.op[E]?.toLowerCase()!=="attack"){if(this.menuOption[this.menuSize]=_.op[E]+" @yel@"+m,E===0)this.menuAction[this.menuSize]=728;else if(E===1)this.menuAction[this.menuSize]=542;else if(E===2)this.menuAction[this.menuSize]=6;else if(E===3)this.menuAction[this.menuSize]=963;else if(E===4)this.menuAction[this.menuSize]=245;this.menuParamA[this.menuSize]=u,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++}}if(_.op){for(E=4;E>=0;E--)if(_.op[E]&&_.op[E]?.toLowerCase()==="attack"){let O=0;if(this.localPlayer&&_.vislevel>this.localPlayer.combatLevel)O=2000;if(this.menuOption[this.menuSize]=_.op[E]+" @yel@"+m,E===0)this.menuAction[this.menuSize]=O+728;else if(E===1)this.menuAction[this.menuSize]=O+542;else if(E===2)this.menuAction[this.menuSize]=O+6;else if(E===3)this.menuAction[this.menuSize]=O+963;else if(E===4)this.menuAction[this.menuSize]=O+245;this.menuParamA[this.menuSize]=u,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++}}this.menuOption[this.menuSize]="Examine @yel@"+m,this.menuAction[this.menuSize]=1607,this.menuParamA[this.menuSize]=u,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++}else if((this.activeSpellFlags&2)===2)this.menuOption[this.menuSize]=this.spellCaption+" @yel@"+m,this.menuAction[this.menuSize]=265,this.menuParamA[this.menuSize]=u,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++}addPlayerOptions(_,u,R,b){if(_===this.localPlayer||this.menuSize>=400)return;let m=null;if(this.localPlayer)m=_.name+this.getCombatLevelTag(this.localPlayer.combatLevel,_.combatLevel)+" (level-"+_.combatLevel+")";if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @whi@"+m,this.menuAction[this.menuSize]=367,this.menuParamA[this.menuSize]=u,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++;else if(this.spellSelected!==1){if(this.menuOption[this.menuSize]="Follow @whi@"+m,this.menuAction[this.menuSize]=1544,this.menuParamA[this.menuSize]=u,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++,this.overrideChat===0)this.menuOption[this.menuSize]="Trade with @whi@"+m,this.menuAction[this.menuSize]=1373,this.menuParamA[this.menuSize]=u,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++;if(this.wildernessLevel>0){if(this.menuOption[this.menuSize]="Attack @whi@"+m,this.localPlayer&&this.localPlayer.combatLevel>=_.combatLevel)this.menuAction[this.menuSize]=151;else this.menuAction[this.menuSize]=2151;this.menuParamA[this.menuSize]=u,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++}if(this.worldLocationState===1)this.menuOption[this.menuSize]="Fight @whi@"+m,this.menuAction[this.menuSize]=151,this.menuParamA[this.menuSize]=u,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++;if(this.worldLocationState===2)this.menuOption[this.menuSize]="Duel-with @whi@"+m,this.menuAction[this.menuSize]=1101,this.menuParamA[this.menuSize]=u,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++}else if((this.activeSpellFlags&8)===8)this.menuOption[this.menuSize]=this.spellCaption+" @whi@"+m,this.menuAction[this.menuSize]=651,this.menuParamA[this.menuSize]=u,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++;for(let E=0;E<this.menuSize;E++)if(this.menuAction[E]===660){this.menuOption[E]="Walk here @whi@"+m;break}}getCombatLevelTag(_,u){let R=_-u;if(R<-9)return"@red@";else if(R<-6)return"@or3@";else if(R<-3)return"@or2@";else if(R<0)return"@or1@";else if(R>9)return"@gre@";else if(R>6)return"@gr3@";else if(R>3)return"@gr2@";else if(R>0)return"@gr1@";else return"@yel@"}drawInterface(_,u,R,b){if(_.type!==0||!_.children||_.hide&&this.viewportHoveredInterfaceIndex!==_.id&&this.sidebarHoveredInterfaceIndex!==_.id&&this.chatHoveredInterfaceIndex!==_.id)return;let m=F.left,E=F.top,O=F.right,I=F.bottom;F.setBounds(u,R,u+_.width,R+_.height);let L=_.children.length;for(let H=0;H<L;H++){if(!_.childX||!_.childY)continue;let G=_.childX[H]+u,N=_.childY[H]+R-b,T=s.types[_.children[H]];if(G+=T.x,N+=T.y,T.clientCode>0)this.updateInterfaceContent(T);if(T.type===0){if(T.scrollPosition>T.scroll-T.height)T.scrollPosition=T.scroll-T.height;if(T.scrollPosition<0)T.scrollPosition=0;if(this.drawInterface(T,G,N,T.scrollPosition),T.scroll>T.height)this.drawScrollbar(G+T.width,N,T.scrollPosition,T.scroll,T.height)}else if(T.type===2){let K=0;for(let Q=0;Q<T.height;Q++)for(let U=0;U<T.width;U++){if(!T.invSlotOffsetX||!T.invSlotOffsetY||!T.invSlotObjId||!T.invSlotObjCount)continue;let J=G+U*(T.marginX+32),q=N+Q*(T.marginY+32);if(K<20)J+=T.invSlotOffsetX[K],q+=T.invSlotOffsetY[K];if(T.invSlotObjId[K]>0){let w=0,V=0,Y=T.invSlotObjId[K]-1;if(J>F.left-32&&J<F.right&&q>F.top-32&&q<F.bottom||this.objDragArea!==0&&this.objDragSlot===K){let n=0;if(this.objSelected==1&&this.objSelectedSlot==K&&this.objSelectedInterface==T.id)n=16777215;let f=d.getIcon(Y,T.invSlotObjCount[K],n);if(f){if(this.objDragArea!==0&&this.objDragSlot===K&&this.objDragInterfaceId===T.id){if(w=this.mouseX-this.objGrabX,V=this.mouseY-this.objGrabY,w<5&&w>-5)w=0;if(V<5&&V>-5)V=0;if(this.objDragCycles<5)w=0,V=0;if(f.drawAlpha(128,J+w,q+V),q+V<F.top&&_.scrollPosition>0){let Z=(F.top-q-V)*this.sceneDelta/3;if(Z>this.sceneDelta*10)Z=this.sceneDelta*10;if(Z>_.scrollPosition)Z=_.scrollPosition;_.scrollPosition-=Z,this.objGrabY+=Z}if(q+V+32>F.bottom&&_.scrollPosition<_.scroll-_.height){let Z=(q+V+32-F.bottom)*this.sceneDelta/3;if(Z>this.sceneDelta*10)Z=this.sceneDelta*10;if(Z>_.scroll-_.height-_.scrollPosition)Z=_.scroll-_.height-_.scrollPosition;_.scrollPosition+=Z,this.objGrabY-=Z}}else if(this.selectedArea!==0&&this.selectedItem===K&&this.selectedInterface===T.id)f.drawAlpha(128,J,q);else f.draw(J,q);if(f.width===33||T.invSlotObjCount[K]!==1){let Z=T.invSlotObjCount[K];this.fontPlain11?.drawString(J+w+1,q+10+V,this.formatObjCount(Z),0),this.fontPlain11?.drawString(J+w,q+9+V,this.formatObjCount(Z),16776960)}}}}else if(T.invSlotGraphic&&K<20)T.invSlotGraphic[K]?.draw(J,q);K++}}else if(T.type===3)if(T.alpha===0)if(T.fill)F.fillRect2d(G,N,T.width,T.height,T.colour);else F.drawRect(G,N,T.width,T.height,T.colour);else if(T.fill)F.fillRectAlpha(G,N,T.width,T.height,T.colour,256-(T.alpha&255));else F.drawRect(G,N,T.width,T.height,T.colour),F.drawRectAlpha(G,N,T.width,T.height,T.colour,256-(T.alpha&255));else if(T.type===4){let{font:K,colour:Q,text:U}=T;if((this.chatHoveredInterfaceIndex===T.id||this.sidebarHoveredInterfaceIndex===T.id||this.viewportHoveredInterfaceIndex===T.id)&&T.overColour!==0)Q=T.overColour;if(this.executeInterfaceScript(T)){if(Q=T.activeColour,T.activeText&&T.activeText.length>0)U=T.activeText}if(T.buttonType===6&&this.pressedContinueOption)U="Please wait...",Q=T.colour;if(F.width2d==479){if(Q==16776960)Q=255;if(Q==49152)Q=16777215}if(!K||!U)continue;for(let J=N+K.height2d;U.length>0;J+=K.height2d){if(U.indexOf("%")!==-1){do{let V=U.indexOf("%1");if(V===-1)break;U=U.substring(0,V)+this.getIntString(this.executeClientScript(T,0))+U.substring(V+2)}while(!0);do{let V=U.indexOf("%2");if(V===-1)break;U=U.substring(0,V)+this.getIntString(this.executeClientScript(T,1))+U.substring(V+2)}while(!0);do{let V=U.indexOf("%3");if(V===-1)break;U=U.substring(0,V)+this.getIntString(this.executeClientScript(T,2))+U.substring(V+2)}while(!0);do{let V=U.indexOf("%4");if(V===-1)break;U=U.substring(0,V)+this.getIntString(this.executeClientScript(T,3))+U.substring(V+2)}while(!0);do{let V=U.indexOf("%5");if(V===-1)break;U=U.substring(0,V)+this.getIntString(this.executeClientScript(T,4))+U.substring(V+2)}while(!0)}let q=U.indexOf("\\n"),w;if(q!==-1)w=U.substring(0,q),U=U.substring(q+2);else w=U,U="";if(T.center)K.drawStringTaggableCenter(G+(T.width/2|0),J,w,Q,T.shadowed);else K.drawStringTaggable(G,J,w,Q,T.shadowed)}}else if(T.type===5){let K;if(this.executeInterfaceScript(T))K=T.activeGraphic;else K=T.graphic;K?.draw(G,N)}else if(T.type===6){let K=A.centerX,Q=A.centerY;A.centerX=G+(T.width/2|0),A.centerY=N+(T.height/2|0);let U=A.sin[T.xan]*T.zoom>>16,J=A.cos[T.xan]*T.zoom>>16,q=this.executeInterfaceScript(T),w;if(q)w=T.activeAnim;else w=T.anim;let V=null;if(w===-1)V=T.getModel(-1,-1,q,this.localPlayer);else{let Y=l.types[w];if(Y.frames&&Y.iframes)V=T.getModel(Y.frames[T.seqFrame],Y.iframes[T.seqFrame],q,this.localPlayer)}if(V)V.drawSimple(0,T.yan,0,T.xan,0,U,J);A.centerX=K,A.centerY=Q}else if(T.type===7){let K=T.font;if(!K||!T.invSlotObjId||!T.invSlotObjCount)continue;let Q=0;for(let U=0;U<T.height;U++)for(let J=0;J<T.width;J++){if(T.invSlotObjId[Q]>0){let q=d.get(T.invSlotObjId[Q]-1),w=q.name;if(q.stackable||T.invSlotObjCount[Q]!==1)w=w+" x"+this.formatObjCountTagged(T.invSlotObjCount[Q]);if(!w)continue;let V=G+J*(T.marginX+115),Y=N+U*(T.marginY+12);if(T.center)K.drawStringTaggableCenter(V+(T.width/2|0),Y,w,T.colour,T.shadowed);else K.drawStringTaggable(V,Y,w,T.colour,T.shadowed)}Q++}}}F.setBounds(m,E,O,I)}drawScrollbar(_,u,R,b,m){this.imageScrollbar0?.draw(_,u),this.imageScrollbar1?.draw(_,u+m-16),F.fillRect2d(_,u+16,16,m-32,2301979);let E=(m-32)*m/b|0;if(E<8)E=8;let O=(m-E-32)*R/(b-m)|0;F.fillRect2d(_,u+O+16,16,E,5063219),F.drawVerticalLine(_,u+O+16,7759444,E),F.drawVerticalLine(_+1,u+O+16,7759444,E),F.drawHorizontalLine(_,u+O+16,7759444,16),F.drawHorizontalLine(_,u+O+17,7759444,16),F.drawVerticalLine(_+15,u+O+16,3353893,E),F.drawVerticalLine(_+14,u+O+17,3353893,E-1),F.drawHorizontalLine(_,u+O+E+15,3353893,16),F.drawHorizontalLine(_+1,u+O+E+14,3353893,15)}formatObjCount(_){if(_<1e5)return String(_);else if(_<1e7)return(_/1000|0)+"K";else return(_/1e6|0)+"M"}formatObjCountTagged(_){let u=String(_);for(let R=u.length-3;R>0;R-=3)u=u.substring(0,R)+","+u.substring(R);if(u.length>8)u="@gre@"+u.substring(0,u.length-8)+" million @whi@("+u+")";else if(u.length>4)u="@cya@"+u.substring(0,u.length-4)+"K @whi@("+u+")";return" "+u}handleScrollInput(_,u,R,b,m,E,O,I){if(this.scrollGrabbed)this.scrollInputPadding=32;else this.scrollInputPadding=0;if(this.scrollGrabbed=!1,_>=E&&_<E+16&&u>=O&&u<O+16){if(I.scrollPosition-=this.dragCycles*4,m)this.redrawSidebar=!0}else if(_>=E&&_<E+16&&u>=O+b-16&&u<O+b){if(I.scrollPosition+=this.dragCycles*4,m)this.redrawSidebar=!0}else if(_>=E-this.scrollInputPadding&&_<E+this.scrollInputPadding+16&&u>=O+16&&u<O+b-16&&this.dragCycles>0){let L=(b-32)*b/R|0;if(L<8)L=8;let H=u-O-(L/2|0)-16,G=b-L-32;if(I.scrollPosition=(R-b)*H/G|0,m)this.redrawSidebar=!0;this.scrollGrabbed=!0}}getIntString(_){return _<999999999?String(_):"*"}executeInterfaceScript(_){if(!_.scriptComparator)return!1;for(let u=0;u<_.scriptComparator.length;u++){if(!_.scriptOperand)return!1;let R=this.executeClientScript(_,u),b=_.scriptOperand[u];if(_.scriptComparator[u]===2){if(R>=b)return!1}else if(_.scriptComparator[u]===3){if(R<=b)return!1}else if(_.scriptComparator[u]===4){if(R===b)return!1}else if(R!==b)return!1}return!0}executeClientScript(_,u){if(!_.scripts||u>=_.scripts.length)return-2;try{let R=_.scripts[u];if(!R)return-1;let b=0,m=0;while(!0){let E=R[m++];if(E===0)return b;if(E===1)b+=this.skillLevel[R[m++]];else if(E===2)b+=this.skillBaseLevel[R[m++]];else if(E===3)b+=this.skillExperience[R[m++]];else if(E===4){let O=s.types[R[m++]],I=R[m++]+1;if(O.invSlotObjId&&O.invSlotObjCount){for(let L=0;L<O.invSlotObjId.length;L++)if(O.invSlotObjId[L]===I)b+=O.invSlotObjCount[L]}else b+=0}else if(E===5)b+=this.varps[R[m++]];else if(E===6)b+=this.levelExperience[this.skillBaseLevel[R[m++]]-1];else if(E===7)b+=this.varps[R[m++]]*100/46875|0;else if(E===8)b+=this.localPlayer?.combatLevel||0;else if(E===9)for(let O=0;O<19;O++){if(O===18)O=20;b+=this.skillBaseLevel[O]}else if(E===10){let O=s.types[R[m++]],I=R[m++]+1;if(O.invSlotObjId){for(let L=0;L<O.invSlotObjId.length;L++)if(O.invSlotObjId[L]===I){b+=999999999;break}}}else if(E===11)b+=this.runenergy;else if(E===12)b+=this.runweight;else if(E===13){let O=this.varps[R[m++]],I=R[m++];b+=(O&1<<I)===0?0:1}}}catch(R){return-1}}handleInterfaceInput(_,u,R,b,m,E){if(_.type!==0||!_.children||_.hide||u<b||R<m||u>b+_.width||R>m+_.height||!_.childX||!_.childY)return;let O=_.children.length;for(let I=0;I<O;I++){let L=_.childX[I]+b,H=_.childY[I]+m-E,G=s.types[_.children[I]];if(L+=G.x,H+=G.y,(G.overlayer>=0||G.overColour!==0)&&u>=L&&R>=H&&u<L+G.width&&R<H+G.height)if(G.overlayer>=0)this.lastHoveredInterfaceId=G.overlayer;else this.lastHoveredInterfaceId=G.id;if(G.type===0){if(this.handleInterfaceInput(G,u,R,L,H,G.scrollPosition),G.scroll>G.height)this.handleScrollInput(u,R,G.scroll,G.height,!0,L+G.width,H,G)}else if(G.type===2){let N=0;for(let T=0;T<G.height;T++)for(let K=0;K<G.width;K++){let Q=L+K*(G.marginX+32),U=H+T*(G.marginY+32);if(N<20&&G.invSlotOffsetX&&G.invSlotOffsetY)Q+=G.invSlotOffsetX[N],U+=G.invSlotOffsetY[N];if(u<Q||R<U||u>=Q+32||R>=U+32){N++;continue}if(this.hoveredSlot=N,this.hoveredSlotParentId=G.id,!G.invSlotObjId||G.invSlotObjId[N]<=0){N++;continue}let J=d.get(G.invSlotObjId[N]-1);if(this.objSelected===1&&G.interactable){if(G.id!==this.objSelectedInterface||N!==this.objSelectedSlot)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+J.name,this.menuAction[this.menuSize]=881,this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=N,this.menuParamC[this.menuSize]=G.id,this.menuSize++}else if(this.spellSelected===1&&G.interactable){if((this.activeSpellFlags&16)===16)this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+J.name,this.menuAction[this.menuSize]=391,this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=N,this.menuParamC[this.menuSize]=G.id,this.menuSize++}else{if(G.interactable){for(let q=4;q>=3;q--)if(J.iop&&J.iop[q]){if(this.menuOption[this.menuSize]=J.iop[q]+" @lre@"+J.name,q===3)this.menuAction[this.menuSize]=478;else if(q===4)this.menuAction[this.menuSize]=347;this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=N,this.menuParamC[this.menuSize]=G.id,this.menuSize++}else if(q===4)this.menuOption[this.menuSize]="Drop @lre@"+J.name,this.menuAction[this.menuSize]=347,this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=N,this.menuParamC[this.menuSize]=G.id,this.menuSize++}if(G.usable)this.menuOption[this.menuSize]="Use @lre@"+J.name,this.menuAction[this.menuSize]=188,this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=N,this.menuParamC[this.menuSize]=G.id,this.menuSize++;if(G.interactable&&J.iop){for(let q=2;q>=0;q--)if(J.iop[q]){if(this.menuOption[this.menuSize]=J.iop[q]+" @lre@"+J.name,q===0)this.menuAction[this.menuSize]=405;else if(q===1)this.menuAction[this.menuSize]=38;else if(q===2)this.menuAction[this.menuSize]=422;this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=N,this.menuParamC[this.menuSize]=G.id,this.menuSize++}}if(G.iop){for(let q=4;q>=0;q--)if(G.iop[q]){if(this.menuOption[this.menuSize]=G.iop[q]+" @lre@"+J.name,q===0)this.menuAction[this.menuSize]=602;else if(q===1)this.menuAction[this.menuSize]=596;else if(q===2)this.menuAction[this.menuSize]=22;else if(q===3)this.menuAction[this.menuSize]=892;else if(q===4)this.menuAction[this.menuSize]=415;this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=N,this.menuParamC[this.menuSize]=G.id,this.menuSize++}}if(this.menuOption[this.menuSize]="Examine @lre@"+J.name,this.menuAction[this.menuSize]=1773,this.menuParamA[this.menuSize]=J.id,G.invSlotObjCount)this.menuParamC[this.menuSize]=G.invSlotObjCount[N];this.menuSize++}N++}}else if(u>=L&&R>=H&&u<L+G.width&&R<H+G.height){if(G.buttonType===1){let N=!1;if(G.clientCode!==0)N=this.handleSocialMenuOption(G);if(!N&&G.option)this.menuOption[this.menuSize]=G.option,this.menuAction[this.menuSize]=951,this.menuParamC[this.menuSize]=G.id,this.menuSize++}else if(G.buttonType===2&&this.spellSelected===0){let N=G.targetVerb;if(N&&N.indexOf(" ")!==-1)N=N.substring(0,N.indexOf(" "));this.menuOption[this.menuSize]=N+" @gre@"+G.targetText,this.menuAction[this.menuSize]=930,this.menuParamC[this.menuSize]=G.id,this.menuSize++}else if(G.buttonType===3)this.menuOption[this.menuSize]="Close",this.menuAction[this.menuSize]=947,this.menuParamC[this.menuSize]=G.id,this.menuSize++;else if(G.buttonType===4&&G.option)this.menuOption[this.menuSize]=G.option,this.menuAction[this.menuSize]=465,this.menuParamC[this.menuSize]=G.id,this.menuSize++;else if(G.buttonType===5&&G.option)this.menuOption[this.menuSize]=G.option,this.menuAction[this.menuSize]=960,this.menuParamC[this.menuSize]=G.id,this.menuSize++;else if(G.buttonType===6&&!this.pressedContinueOption&&G.option)this.menuOption[this.menuSize]=G.option,this.menuAction[this.menuSize]=44,this.menuParamC[this.menuSize]=G.id,this.menuSize++}}}handleSocialMenuOption(_){let u=_.clientCode;if(u>=1&&u<=200||u>=701&&u<=900){if(u>=801)u-=701;else if(u>=701)u-=601;else if(u>=101)u-=101;else u--;return this.menuOption[this.menuSize]="Remove @whi@"+this.friendName[u],this.menuAction[this.menuSize]=557,this.menuSize++,this.menuOption[this.menuSize]="Message @whi@"+this.friendName[u],this.menuAction[this.menuSize]=679,this.menuSize++,!0}else if(u>=401&&u<=500)return this.menuOption[this.menuSize]="Remove @whi@"+_.text,this.menuAction[this.menuSize]=556,this.menuSize++,!0;return!1}resetInterfaceAnimation(_){let u=s.types[_];if(!u.children)return;for(let R=0;R<u.children.length&&u.children[R]!==-1;R++){let b=s.types[u.children[R]];if(b.type===1)this.resetInterfaceAnimation(b.id);b.seqFrame=0,b.seqCycle=0}}updateInterfaceAnimation(_,u){let R=s.types[_];if(!R.children)return!1;let b=!1;for(let m=0;m<R.children.length&&R.children[m]!==-1;m++){let E=s.types[R.children[m]];if(E.type===1)b||=this.updateInterfaceAnimation(E.id,u);if(E.type===6&&(E.anim!==-1||E.activeAnim!==-1)){let O=this.executeInterfaceScript(E),I;if(O)I=E.activeAnim;else I=E.anim;if(I!==-1){let L=l.types[I];E.seqCycle+=u;while(E.seqCycle>L.getFrameDuration(E.seqFrame)){if(E.seqCycle-=L.getFrameDuration(E.seqFrame)+1,E.seqFrame++,E.seqFrame>=L.frameCount){if(E.seqFrame-=L.replayoff,E.seqFrame<0||E.seqFrame>=L.frameCount)E.seqFrame=0}b=!0}}}}return b}updateVarp(_){let u=B0.types[_].clientcode;if(u===0)return;let R=this.varps[_];if(u===1){if(R===1)A.setBrightness(0.9);else if(R===2)A.setBrightness(0.8);else if(R===3)A.setBrightness(0.7);else if(R===4)A.setBrightness(0.6);d.iconCache?.clear(),this.redrawFrame=!0}else if(u===3){let b=this.midiActive;if(R===0)this.midiVolume=128,J1(128),this.midiActive=!0;else if(R===1)this.midiVolume=96,J1(96),this.midiActive=!0;else if(R===2)this.midiVolume=64,J1(64),this.midiActive=!0;else if(R===3)this.midiVolume=32,J1(32),this.midiActive=!0;else if(R===4)this.midiActive=!1;if(this.midiActive!==b){if(this.midiActive)this.midiSong=this.nextMidiSong,this.midiFading=!1,this.onDemand?.request(2,this.midiSong);else B1(!1);this.nextMusicDelay=0}}else if(u===4){if(R===0)this.waveVolume=128,$1(128),this.waveEnabled=!0;else if(R===1)this.waveVolume=96,$1(96),this.waveEnabled=!0;else if(R===2)this.waveVolume=64,$1(64),this.waveEnabled=!0;else if(R===3)this.waveVolume=32,$1(32),this.waveEnabled=!0;else if(R===4)this.waveEnabled=!1}else if(u===5)this.oneMouseButton=R;else if(u===6)this.chatEffects=R;else if(u===8)this.splitPrivateChat=R,this.redrawChatback=!0;else if(u===9)this.bankArrangeMode=R}updateInterfaceContent(_){let u=_.clientCode;if(u>=1&&u<=100||u>=701&&u<=800){if(u>700)u-=601;else u--;if(u>=this.friendCount)_.text="",_.buttonType=0;else _.text=this.friendName[u],_.buttonType=1}else if(u>=101&&u<=200||u>=801&&u<=900){if(u>800)u-=701;else u-=101;if(u>=this.friendCount)_.text="",_.buttonType=0;else{if(this.friendWorld[u]===0)_.text="@red@Offline";else if(this.friendWorld[u]===v.nodeId)_.text="@gre@World-"+(this.friendWorld[u]-9);else _.text="@yel@World-"+(this.friendWorld[u]-9);_.buttonType=1}}else if(u===203){if(_.scroll=this.friendCount*15+20,_.scroll<=_.height)_.scroll=_.height+1}else if(u>=401&&u<=500)if(u-=401,u>=this.ignoreCount)_.text="",_.buttonType=0;else _.text=c.formatName(c.fromBase37(this.ignoreName37[u])),_.buttonType=1;else if(u===503){if(_.scroll=this.ignoreCount*15+20,_.scroll<=_.height)_.scroll=_.height+1}else if(u===327){if(_.xan=150,_.yan=(Math.sin(this.loopCycle/40)*256|0)&2047,this.updateDesignModel){for(let E=0;E<7;E++){let O=this.designKits[E];if(O>=0&&!J0.types[O].modelIsReady())return}this.updateDesignModel=!1;let R=new p(7,null),b=0;for(let E=0;E<7;E++){let O=this.designKits[E];if(O>=0)R[b++]=J0.types[O].getModel()}let m=$.modelFromModels(R,b);for(let E=0;E<5;E++)if(this.designColours[E]!==0){if(m.recolour(T0.DESIGN_IDK_COLORS[E][0],T0.DESIGN_IDK_COLORS[E][this.designColours[E]]),E===1)m.recolour(T0.TORSO_RECOLORS[0],T0.TORSO_RECOLORS[this.designColours[E]])}if(m.createLabelReferences(),m.calculateNormals(64,850,-30,-50,-30,!0),this.localPlayer){let E=l.types[this.localPlayer.readyanim].frames;if(E)m.applyTransform(E[0])}_.modelType=5,_.model=0,s.cacheModel(m,5,0)}}else if(u===324){if(!this.genderButtonImage0)this.genderButtonImage0=_.graphic,this.genderButtonImage1=_.activeGraphic;if(this.designGender)_.graphic=this.genderButtonImage1;else _.graphic=this.genderButtonImage0}else if(u===325){if(!this.genderButtonImage0)this.genderButtonImage0=_.graphic,this.genderButtonImage1=_.activeGraphic;if(this.designGender)_.graphic=this.genderButtonImage0;else _.graphic=this.genderButtonImage1}else if(u===600)if(_.text=this.reportAbuseInput,this.loopCycle%20<10)_.text=_.text+"|";else _.text=_.text+" ";else if(u===613)if(this.staffmodlevel<1)_.text="";else if(this.reportAbuseMuteOption)_.colour=16711680,_.text="Moderator option: Mute player for 48 hours: <ON>";else _.colour=16777215,_.text="Moderator option: Mute player for 48 hours: <OFF>";else if(u===650||u===655)if(this.lastAddress===0)_.text="";else{let R;if(this.daysSinceLastLogin===0)R="earlier today";else if(this.daysSinceLastLogin===1)R="yesterday";else R=this.daysSinceLastLogin+" days ago";let b=c.formatIPv4(this.lastAddress);_.text="You last logged in "+R+(b==="127.0.0.1"?".":" from: "+b)}else if(u===651){if(this.unreadMessages===0)_.text="0 unread messages",_.colour=16776960;else if(this.unreadMessages===1)_.text="1 unread message",_.colour=65280;else if(this.unreadMessages>1)_.text=this.unreadMessages+" unread messages",_.colour=65280}else if(u===652)if(this.daysSinceRecoveriesChanged===201)if(this.warnMembersInNonMembers==1)_.text="@yel@This is a non-members world: @whi@Since you are a member we";else _.text="";else if(this.daysSinceRecoveriesChanged===200)_.text="You have not yet set any password recovery questions.";else{let R;if(this.daysSinceRecoveriesChanged===0)R="Earlier today";else if(this.daysSinceRecoveriesChanged===1)R="Yesterday";else R=this.daysSinceRecoveriesChanged+" days ago";_.text=R+" you changed your recovery questions"}else if(u===653)if(this.daysSinceRecoveriesChanged===201)if(this.warnMembersInNonMembers==1)_.text="@whi@recommend you use a members world instead. You may use";else _.text="";else if(this.daysSinceRecoveriesChanged===200)_.text="We strongly recommend you do so now to secure your account.";else _.text="If you do not remember making this change then cancel it immediately";else if(u===654)if(this.daysSinceRecoveriesChanged===201)if(this.warnMembersInNonMembers==1)_.text="@whi@this world but member benefits are unavailable whilst here.";else _.text="";else if(this.daysSinceRecoveriesChanged===200)_.text="Do this from the 'account management' area on our front webpage";else _.text="Do this from the 'account management' area on our front webpage"}handleInterfaceAction(_){let u=_.clientCode;if(u===201)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=1,this.socialMessage="Enter name of friend to add to list";else if(u===202)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=2,this.socialMessage="Enter name of friend to delete from list";else if(u===205)return this.idleTimeout=250,!0;else if(u===501)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=4,this.socialMessage="Enter name of player to add to list";else if(u===502)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=5,this.socialMessage="Enter name of player to delete from list";else if(u>=300&&u<=313){let R=(u-300)/2|0,b=u&1,m=this.designKits[R];if(m!==-1)while(!0){if(b===0){if(m--,m<0)m=J0.count-1}if(b===1){if(m++,m>=J0.count)m=0}if(!J0.types[m].disable&&J0.types[m].type===R+(this.designGender?0:7)){this.designKits[R]=m,this.updateDesignModel=!0;break}}}else if(u>=314&&u<=323){let R=(u-314)/2|0,b=u&1,m=this.designColours[R];if(b===0){if(m--,m<0)m=T0.DESIGN_IDK_COLORS[R].length-1}if(b===1){if(m++,m>=T0.DESIGN_IDK_COLORS[R].length)m=0}this.designColours[R]=m,this.updateDesignModel=!0}else if(u===324&&!this.designGender)this.designGender=!0,this.validateCharacterDesign();else if(u===325&&this.designGender)this.designGender=!1,this.validateCharacterDesign();else if(u===326){this.out.p1isaac(8),this.out.p1(this.designGender?0:1);for(let R=0;R<7;R++)this.out.p1(this.designKits[R]);for(let R=0;R<5;R++)this.out.p1(this.designColours[R]);return!0}else if(u===613)this.reportAbuseMuteOption=!this.reportAbuseMuteOption;else if(u>=601&&u<=612){if(this.closeInterfaces(),this.reportAbuseInput.length>0)this.out.p1isaac(251),this.out.p8(c.toBase37(this.reportAbuseInput)),this.out.p1(u-601),this.out.p1(this.reportAbuseMuteOption?1:0)}return!1}validateCharacterDesign(){this.updateDesignModel=!0;for(let _=0;_<7;_++){this.designKits[_]=-1;for(let u=0;u<J0.count;u++)if(!J0.types[u].disable&&J0.types[u].type===_+(this.designGender?0:7)){this.designKits[_]=u;break}}}drawSidebar(){if(this.areaSidebar?.bind(),this.areaSidebarOffsets)A.lineOffset=this.areaSidebarOffsets;if(this.imageInvback?.draw(0,0),this.sidebarInterfaceId!==-1)this.drawInterface(s.types[this.sidebarInterfaceId],0,0,0);else if(this.tabInterfaceId[this.selectedTab]!==-1)this.drawInterface(s.types[this.tabInterfaceId[this.selectedTab]],0,0,0);if(this.menuVisible&&this.menuArea===1)this.drawMenu();if(this.areaSidebar?.draw(553,205),this.areaViewport?.bind(),this.areaViewportOffsets)A.lineOffset=this.areaViewportOffsets}drawChat(){if(this.areaChatback?.bind(),this.areaChatbackOffsets)A.lineOffset=this.areaChatbackOffsets;if(this.imageChatback?.draw(0,0),this.showSocialInput)this.fontBold12?.drawStringCenter(239,40,this.socialMessage,0),this.fontBold12?.drawStringCenter(239,60,this.socialInput+"*",128);else if(this.chatbackInputOpen)this.fontBold12?.drawStringCenter(239,40,"Enter amount:",0),this.fontBold12?.drawStringCenter(239,60,this.chatbackInput+"*",128);else if(this.modalMessage)this.fontBold12?.drawStringCenter(239,40,this.modalMessage,0),this.fontBold12?.drawStringCenter(239,60,"Click to continue",128);else if(this.chatInterfaceId!==-1)this.drawInterface(s.types[this.chatInterfaceId],0,0,0);else if(this.stickyChatInterfaceId!==-1)this.drawInterface(s.types[this.stickyChatInterfaceId],0,0,0);else{let _=this.fontPlain12,u=0;F.setBounds(0,0,463,77);for(let b=0;b<100;b++){let m=this.messageText[b];if(!m)continue;let E=this.messageType[b],O=this.chatScrollOffset+70-u*14,I=this.messageSender[b],L=0;if(I&&I.startsWith("@cr1@"))I=I.substring(5),L=1;else if(I&&I.startsWith("@cr2@"))I=I.substring(5),L=2;if(E===0){if(O>0&&O<110)_?.drawString(4,O,m,0);u++}else if((E===1||E===2)&&(this.chatPublicMode===0||this.chatPublicMode===1&&this.isFriend(I))){if(O>0&&O<110){let H=4;if(L==1)this.imageModIcons[0].draw(H,O-12),H+=14;else if(L==2)this.imageModIcons[1].draw(H,O-12),H+=14;_?.drawString(H,O,I+":",0),H+=(_?.stringWidth(I)??0)+8,_?.drawString(H,O,m,255)}u++}else if((E===3||E===7)&&this.splitPrivateChat===0&&(E===7||this.chatPrivateMode===0||this.chatPrivateMode===1&&this.isFriend(I))){if(O>0&&O<110){let H=4;if(_?.drawString(H,O,"From ",0),H+=_?.stringWidth("From ")??0,L==1)this.imageModIcons[0].draw(H,O-12),H+=14;else if(L==2)this.imageModIcons[1].draw(H,O-12),H+=14;_?.drawString(H,O,I+":",0),H+=(_?.stringWidth(I)??0)+8,_?.drawString(H,O,m,8388608)}u++}else if(E===4&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(I))){if(O>0&&O<110)_?.drawString(4,O,I+" "+this.messageText[b],8388736);u++}else if(E===5&&this.splitPrivateChat===0&&this.chatPrivateMode<2){if(O>0&&O<110)_?.drawString(4,O,m,8388608);u++}else if(E===6&&this.splitPrivateChat===0&&this.chatPrivateMode<2){if(O>0&&O<110)_?.drawString(4,O,"To "+I+":",0),_?.drawString(_.stringWidth("To "+I)+12,O,m,8388608);u++}else if(E===8&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(I))){if(O>0&&O<110)_?.drawString(4,O,I+" "+this.messageText[b],8270336);u++}}if(F.resetBounds(),this.chatScrollHeight=u*14+7,this.chatScrollHeight<78)this.chatScrollHeight=78;this.drawScrollbar(463,0,this.chatScrollHeight-this.chatScrollOffset-77,this.chatScrollHeight,77);let R;if(this.localPlayer==null||this.localPlayer.name==null)R=c.formatName(this.username);else R=this.localPlayer.name;_?.drawString(4,90,R+":",0),_?.drawString(_.stringWidth(R+": ")+6,90,this.chatTyped+"*",255),F.drawHorizontalLine(0,77,0,479)}if(this.menuVisible&&this.menuArea===2)this.drawMenu();if(this.areaChatback?.draw(17,357),this.areaViewport?.bind(),this.areaViewportOffsets)A.lineOffset=this.areaViewportOffsets}drawMinimap(){if(!this.localPlayer)return;this.areaMapback?.bind();let _=this.orbitCameraYaw+this.macroMinimapAngle&2047,u=(this.localPlayer.x/32|0)+48,R=464-(this.localPlayer.z/32|0);this.imageMinimap?.drawRotatedMasked(25,5,146,151,this.minimapMaskLineOffsets,this.minimapMaskLineLengths,u,R,_,this.macroMinimapZoom+256),this.imageCompass?.drawRotatedMasked(0,0,33,33,this.compassMaskLineOffsets,this.compassMaskLineLengths,25,25,this.orbitCameraYaw,256);for(let b=0;b<this.activeMapFunctionCount;b++)u=this.activeMapFunctionX[b]*4+2-(this.localPlayer.x/32|0),R=this.activeMapFunctionZ[b]*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(R,this.activeMapFunctions[b],u);for(let b=0;b<104;b++)for(let m=0;m<104;m++)if(this.objStacks[this.currentLevel][b][m])u=b*4+2-(this.localPlayer.x/32|0),R=m*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(R,this.imageMapdot0,u);for(let b=0;b<this.npcCount;b++){let m=this.npcs[this.npcIds[b]];if(m&&m.isVisible()&&m.type&&m.type.minimap)u=(m.x/32|0)-(this.localPlayer.x/32|0),R=(m.z/32|0)-(this.localPlayer.z/32|0),this.drawOnMinimap(R,this.imageMapdot1,u)}for(let b=0;b<this.playerCount;b++){let m=this.players[this.playerIds[b]];if(m&&m.isVisible()&&m.name){u=(m.x/32|0)-(this.localPlayer.x/32|0),R=(m.z/32|0)-(this.localPlayer.z/32|0);let E=!1,O=c.toBase37(m.name);for(let I=0;I<this.friendCount;I++)if(O===this.friendName37[I]&&this.friendWorld[I]!==0){E=!0;break}if(E)this.drawOnMinimap(R,this.imageMapdot3,u);else this.drawOnMinimap(R,this.imageMapdot2,u)}}if(this.hintType!=0&&this.loopCycle%20<10){if(this.hintType==1&&this.hintNpc>=0&&this.hintNpc<this.npcs.length){let b=this.npcs[this.hintNpc];if(b!=null){let m=(b.x/32|0)-(this.localPlayer.x/32|0),E=(b.z/32|0)-(this.localPlayer.z/32|0);this.drawMinimapHint(m,E,this.imageMapmarker1)}}else if(this.hintType==2){let b=(this.hintTileX-this.sceneBaseTileX)*4+2-(this.localPlayer.x/32|0),m=(this.hintTileZ-this.sceneBaseTileZ)*4+2-(this.localPlayer.z/32|0);this.drawMinimapHint(b,m,this.imageMapmarker1)}else if(this.hintType==10&&this.hintPlayer>=0&&this.hintPlayer<this.players.length){let b=this.players[this.hintPlayer];if(b!=null){let m=(b.x/32|0)-(this.localPlayer.x/32|0),E=(b.z/32|0)-(this.localPlayer.z/32|0);this.drawMinimapHint(m,E,this.imageMapmarker1)}}}if(this.flagSceneTileX!==0)u=this.flagSceneTileX*4+2-(this.localPlayer.x/32|0),R=this.flagSceneTileZ*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(R,this.imageMapmarker0,u);F.fillRect2d(97,78,3,3,16777215),this.areaViewport?.bind()}drawMinimapHint(_,u,R){if(!R)return;let b=_*_+u*u;if(b<=4225||b>=90000){this.drawOnMinimap(u,R,_);return}let m=this.orbitCameraYaw+this.macroMinimapAngle&2047,E=A.sin[m],O=A.cos[m];E=E*256/(this.macroMinimapZoom+256)|0,O=O*256/(this.macroMinimapZoom+256)|0;let I=u*E+_*O>>16,L=u*O-_*E>>16,H=Math.atan2(I,L),G=Math.sin(H)*63|0,N=Math.cos(H)*57|0;this.imageMapedge?.drawRotated(83-N-20,H,256,15,15,20,20,G+94+4-10)}drawOnMinimap(_,u,R){if(!u)return;let b=R*R+_*_;if(b>6400)return;let m=this.orbitCameraYaw+this.macroMinimapAngle&2047,E=A.sin[m],O=A.cos[m];E=E*256/(this.macroMinimapZoom+256)|0,O=O*256/(this.macroMinimapZoom+256)|0;let I=_*E+R*O>>16,L=_*O-R*E>>16;if(b>2500&&this.imageMapback)u.drawMasked(I+94-(u.width/2|0)+4,83-L-(u.height/2|0)-4,this.imageMapback);else u.draw(I+94-(u.width/2|0)+4,83-L-(u.height/2|0)-4)}addMessage(_,u,R){if(_===0&&this.stickyChatInterfaceId!==-1)this.modalMessage=u,this.mouseClickButton=0;if(this.chatInterfaceId===-1)this.redrawChatback=!0;for(let b=99;b>0;b--)this.messageType[b]=this.messageType[b-1],this.messageSender[b]=this.messageSender[b-1],this.messageText[b]=this.messageText[b-1];this.messageType[0]=_,this.messageSender[0]=R,this.messageText[0]=u}isFriend(_){if(!_)return!1;for(let u=0;u<this.friendCount;u++)if(_.toLowerCase()===this.friendName[u]?.toLowerCase())return!0;if(!this.localPlayer)return!1;return _.toLowerCase()===this.localPlayer.name?.toLowerCase()}addFriend(_){if(_===0n)return;if(this.friendCount>=100&&this.membersAccount!=1){this.addMessage(0,"Your friendlist is full. Max of 100 for free users, and 200 for members","");return}else if(this.friendCount>=200){this.addMessage(0,"Your friendlist is full. Max of 100 for free users, and 200 for members","");return}let u=c.formatName(c.fromBase37(_));for(let R=0;R<this.friendCount;R++)if(this.friendName37[R]===_){this.addMessage(0,u+" is already on your friend list","");return}for(let R=0;R<this.ignoreCount;R++)if(this.ignoreName37[R]===_){this.addMessage(0,"Please remove "+u+" from your ignore list first","");return}if(!this.localPlayer||!this.localPlayer.name)return;if(u!==this.localPlayer.name)this.friendName[this.friendCount]=u,this.friendName37[this.friendCount]=_,this.friendWorld[this.friendCount]=0,this.friendCount++,this.redrawSidebar=!0,this.out.p1isaac(9),this.out.p8(_)}removeFriend(_){if(_===0n)return;for(let u=0;u<this.friendCount;u++)if(this.friendName37[u]===_){this.friendCount--,this.redrawSidebar=!0;for(let R=u;R<this.friendCount;R++)this.friendName[R]=this.friendName[R+1],this.friendWorld[R]=this.friendWorld[R+1],this.friendName37[R]=this.friendName37[R+1];this.out.p1isaac(69),this.out.p8(_);return}}addIgnore(_){if(_===0n)return;if(this.ignoreCount>=100){this.addMessage(0,"Your ignore list is full. Max of 100 hit","");return}let u=c.formatName(c.fromBase37(_));for(let R=0;R<this.ignoreCount;R++)if(this.ignoreName37[R]===_){this.addMessage(0,u+" is already on your ignore list","");return}for(let R=0;R<this.friendCount;R++)if(this.friendName37[R]===_){this.addMessage(0,"Please remove "+u+" from your friend list first","");return}this.ignoreName37[this.ignoreCount++]=_,this.redrawSidebar=!0,this.out.p1isaac(203),this.out.p8(_)}removeIgnore(_){if(_===0n)return;for(let u=0;u<this.ignoreCount;u++)if(this.ignoreName37[u]===_){this.ignoreCount--,this.redrawSidebar=!0;for(let R=u;R<this.ignoreCount;R++)this.ignoreName37[R]=this.ignoreName37[R+1];this.out.p1isaac(207),this.out.p8(_);return}}unloadTitle(){if(this.flameActive=!1,this.flamesInterval)clearInterval(this.flamesInterval),this.flamesInterval=null;this.imageTitlebox=null,this.imageTitlebutton=null,this.imageRunes=[],this.flameGradient=null,this.flameGradient0=null,this.flameGradient1=null,this.flameGradient2=null,this.flameBuffer0=null,this.flameBuffer1=null,this.flameBuffer3=null,this.flameBuffer2=null,this.imageFlamesLeft=null,this.imageFlamesRight=null}runFlames(){if(!this.flameActive)return;this.flameCycle++,this.updateFlames(),this.updateFlames(),this.drawFlames()}updateFlames(){if(!this.flameBuffer3||!this.flameBuffer2||!this.flameBuffer0||!this.flameLineOffset)return;let _=256;for(let u=10;u<117;u++)if((Math.random()*100|0)<50)this.flameBuffer3[u+(_-2<<7)]=255;for(let u=0;u<100;u++){let R=(Math.random()*124|0)+2,b=(Math.random()*128|0)+128,m=R+(b<<7);this.flameBuffer3[m]=192}for(let u=1;u<_-1;u++)for(let R=1;R<127;R++){let b=R+(u<<7);this.flameBuffer2[b]=(this.flameBuffer3[b-1]+this.flameBuffer3[b+1]+this.flameBuffer3[b-128]+this.flameBuffer3[b+128])/4|0}if(this.flameCycle0+=128,this.flameCycle0>this.flameBuffer0.length)this.flameCycle0-=this.flameBuffer0.length,this.updateFlameBuffer(this.imageRunes[Math.random()*12|0]);for(let u=1;u<_-1;u++)for(let R=1;R<127;R++){let b=R+(u<<7),m=this.flameBuffer2[b+128]-(this.flameBuffer0[b+this.flameCycle0&this.flameBuffer0.length-1]/5|0);if(m<0)m=0;this.flameBuffer3[b]=m}for(let u=0;u<_-1;u++)this.flameLineOffset[u]=this.flameLineOffset[u+1];if(this.flameLineOffset[_-1]=Math.sin(this.loopCycle/14)*16+Math.sin(this.loopCycle/15)*14+Math.sin(this.loopCycle/16)*12|0,this.flameGradientCycle0>0)this.flameGradientCycle0-=4;if(this.flameGradientCycle1>0)this.flameGradientCycle1-=4;if(this.flameGradientCycle0===0&&this.flameGradientCycle1===0){let u=Math.random()*2000|0;if(u===0)this.flameGradientCycle0=1024;else if(u===1)this.flameGradientCycle1=1024}}updateFlameBuffer(_){if(!this.flameBuffer0||!this.flameBuffer1)return;let u=256;this.flameBuffer0.fill(0);for(let R=0;R<5000;R++){let b=Math.random()*128*u|0;this.flameBuffer0[b]=Math.random()*256|0}for(let R=0;R<20;R++){for(let m=1;m<u-1;m++)for(let E=1;E<127;E++){let O=E+(m<<7);this.flameBuffer1[O]=(this.flameBuffer0[O-1]+this.flameBuffer0[O+1]+this.flameBuffer0[O-128]+this.flameBuffer0[O+128])/4|0}let b=this.flameBuffer0;this.flameBuffer0=this.flameBuffer1,this.flameBuffer1=b}if(_){let R=0;for(let b=0;b<_.height2d;b++)for(let m=0;m<_.width2d;m++)if(_.pixels[R++]!==0){let E=m+_.cropX+16,O=b+_.cropY+16,I=E+(O<<7);this.flameBuffer0[I]=0}}}drawFlames(){if(!this.flameGradient||!this.flameGradient0||!this.flameGradient1||!this.flameGradient2||!this.flameLineOffset||!this.flameBuffer3)return;let _=256;if(this.flameGradientCycle0>0)for(let b=0;b<256;b++)if(this.flameGradientCycle0>768)this.flameGradient[b]=this.mix(this.flameGradient0[b],1024-this.flameGradientCycle0,this.flameGradient1[b]);else if(this.flameGradientCycle0>256)this.flameGradient[b]=this.flameGradient1[b];else this.flameGradient[b]=this.mix(this.flameGradient1[b],256-this.flameGradientCycle0,this.flameGradient0[b]);else if(this.flameGradientCycle1>0)for(let b=0;b<256;b++)if(this.flameGradientCycle1>768)this.flameGradient[b]=this.mix(this.flameGradient0[b],1024-this.flameGradientCycle1,this.flameGradient2[b]);else if(this.flameGradientCycle1>256)this.flameGradient[b]=this.flameGradient2[b];else this.flameGradient[b]=this.mix(this.flameGradient2[b],256-this.flameGradientCycle1,this.flameGradient0[b]);else for(let b=0;b<256;b++)this.flameGradient[b]=this.flameGradient0[b];for(let b=0;b<33920;b++)if(this.imageTitle0&&this.imageFlamesLeft)this.imageTitle0.pixels[b]=this.imageFlamesLeft.pixels[b];let u=0,R=1152;for(let b=1;b<_-1;b++){let E=(this.flameLineOffset[b]*(_-b)/_|0)+22;if(E<0)E=0;u+=E;for(let O=E;O<128;O++){let I=this.flameBuffer3[u++];if(I===0)R++;else{let L=I,H=256-I;if(I=this.flameGradient[I],this.imageTitle0){let G=this.imageTitle0.pixels[R];this.imageTitle0.pixels[R++]=((I&16711935)*L+(G&16711935)*H&4278255360)+((I&65280)*L+(G&65280)*H&16711680)>>8}}}R+=E}this.imageTitle0?.draw(0,0);for(let b=0;b<33920;b++)if(this.imageTitle1&&this.imageFlamesRight)this.imageTitle1.pixels[b]=this.imageFlamesRight.pixels[b];u=0,R=1176;for(let b=1;b<_-1;b++){let m=this.flameLineOffset[b]*(_-b)/_|0,E=103-m;R+=m;for(let O=0;O<E;O++){let I=this.flameBuffer3[u++];if(I===0)R++;else{let L=I,H=256-I;if(I=this.flameGradient[I],this.imageTitle1){let G=this.imageTitle1.pixels[R];this.imageTitle1.pixels[R++]=((I&16711935)*L+(G&16711935)*H&4278255360)+((I&65280)*L+(G&65280)*H&16711680)>>8}}}u+=128-E,R+=128-E-m}this.imageTitle1?.draw(637,0)}mix(_,u,R){let b=256-u;return((_&16711935)*b+(R&16711935)*u&4278255360)+((_&65280)*b+(R&65280)*u&16711680)>>8}getTitleScreenState(){return this.titleScreenState}isChatBackInputOpen(){return this.chatbackInputOpen}isShowSocialInput(){return this.showSocialInput}getChatInterfaceId(){return this.chatInterfaceId}getViewportInterfaceId(){return this.viewportInterfaceId}getReportAbuseInterfaceId(){return this.reportAbuseInterfaceId}}export{v as Client};

//# debugId=5A3E2E076112698D64756E2164756E21
